<html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Phone Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600&family=Varela+Round&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        :root { 
    /* Âü∫Á°ÄÂèòÈáè */
    --screen-width: 350px; 
    --screen-height: 740px; 
    --secondary-bg: #ffffff; 
    --border-color: #e0e0e0; 
    --text-primary: #1f1f1f; 
    --text-secondary: #8a8a8a; 
    --accent-color: rgb(74, 132, 193); 
    
    /* ÂæÆÂçöÁõ∏ÂÖ≥ÂèòÈáè */
    --weibo-bg: #fff; 
    --weibo-main: #222; 
    --weibo-accent: #ff69b4; 
    --weibo-card-bg: #fff; 
    --weibo-card-border: #eee; 
    --weibo-content-color: #222; 
    --weibo-secondary: #888; 
    --weibo-card-opacity: 1.0;
    
    /* ‰∏ªÈ¢òÁõ∏ÂÖ≥ÂèòÈáè - ÁÆÄÁ∫¶È£éÊ†º (ÈªòËÆ§) */
    --theme-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    --theme-button-bg: rgba(245, 245, 247, 0.8);
    --theme-button-color: #333;
    --theme-button-border: 1px solid rgba(0,0,0,0.1);
    --theme-header-bg: rgba(247, 247, 247, 0.8);
    --theme-form-bg: #ffffff;
    --theme-input-border: 1px solid #e0e0e0;
    --theme-input-radius: 12px;
    --theme-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

/* ÂèØÁà±È£éÊ†º‰∏ªÈ¢ò */
body[data-theme="cute"] {
    --theme-font-family: 'Varela Round', 'Quicksand', sans-serif;
    --theme-button-bg: rgba(255, 182, 193, 0.8);
    --theme-button-color: #d44d5c;
    --theme-button-border: 1px solid rgba(255, 182, 193, 0.5);
    --theme-header-bg: rgba(255, 230, 240, 0.85);
    --theme-form-bg: #fff9fc;
    --theme-input-border: 1px solid #ffccd5;
    --theme-input-radius: 20px;
    --theme-shadow: 0 4px 10px rgba(255, 105, 180, 0.15);
}
        html { height: 100%; overflow: hidden; }
        body {
    height: 100%;
    overflow: hidden;
    margin: 0;
    padding: 20px;
    font-family: var(--theme-font-family);
    font-weight: normal;
    background-color: #dcdcdc;
    display: flex;
    justify-content: center;
    align-items: center;
    box-sizing: border-box;
    transition: all 0.3s ease;
}

        /* Êó†ËæπÊ°ÜÊ®°ÂºèÊ†∑Âºè */
        body.borderless-mode {
            padding: 0;
            background-color: #000;
        }

        body.borderless-mode #phone-frame {
            padding: 0;
            background-color: transparent;
            border-radius: 0;
            box-shadow: none;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        body.borderless-mode #phone-screen {
            width: 100vw;
            height: 100vh;
            border-radius: 0;
            border: none;
            max-width: none;
            max-height: none;
        }

        /* Êó†ËæπÊ°ÜÊ®°ÂºèÂºÄÂÖ≥Ê†∑ÂºèÁæéÂåñ */
        .borderless-mode-label {
            transition: all 0.3s ease;
        }

        .borderless-mode-label:hover {
            border-color: var(--accent-color) !important;
            box-shadow: 0 4px 12px rgba(74, 132, 193, 0.15);
            transform: translateY(-2px);
        }

        .borderless-mode-label input[type="checkbox"]:checked + div {
            color: var(--accent-color);
        }

        .borderless-mode-label input[type="checkbox"]:checked {
            accent-color: var(--accent-color);
        }


        body[data-weibo-theme="white"] { --weibo-bg: #fff; --weibo-main: #222; --weibo-accent: #ff69b4; --weibo-card-bg: #fff; --weibo-card-border: #eee; --weibo-content-color: #222; }
        body[data-weibo-theme="pink"] { --weibo-bg: #ffe4ec; --weibo-main: #c2185b; --weibo-accent: #e91e63; --weibo-card-bg: #fff0f6; --weibo-card-border: #f8bbd0; --weibo-content-color: #c2185b; }
        body[data-weibo-theme="blue"] { --weibo-bg: #e3f0ff; --weibo-main: #1565c0; --weibo-accent: #2196f3; --weibo-card-bg: #f0f8ff; --weibo-card-border: #b3e5fc; --weibo-content-color: #1565c0; }
        body[data-weibo-theme="purple"] { --weibo-bg: #f3e8ff; --weibo-main: #6a1b9a; --weibo-accent: #ab47bc; --weibo-card-bg: #f8f0ff; --weibo-card-border: #e1bee7; --weibo-content-color: #6a1b9a; }
        body[data-weibo-theme="green"] { --weibo-bg: #eaffea; --weibo-main: #388e3c; --weibo-accent: #43a047; --weibo-card-bg: #f0fff0; --weibo-card-border: #b2dfdb; --weibo-content-color: #388e3c; }
        body[data-weibo-theme="yellow"] { --weibo-bg: #fffbe4; --weibo-main: #bfa100; --weibo-accent: #ffd600; --weibo-card-bg: #fffde7; --weibo-card-border: #fff9c4; --weibo-content-color: #bfa100; }
        #phone-frame { padding: 12px; background-color: #fff; border-radius: 50px; box-shadow: 0 20px 50px rgba(0,0,0,0.25), inset 0 2px 4px rgba(0,0,0,0.1); position: relative; }
        /* .notch { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); width: 130px; height: 28px; background-color: #1f1f1f; border-radius: 0 0 15px 15px; z-index: 20; } */
        #phone-screen { width: var(--screen-width); height: var(--screen-height); background-color: #000; border-radius: 40px; position: relative; overflow: hidden; display: flex; flex-direction: column; border: 2px solid #333; }
        #status-bar { position: absolute; top: 0; left: 0; width: 100%; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; color: white; z-index: 10; font-size: 14px; box-sizing: border-box; pointer-events: none; }
        #status-bar-time { font-weight: 600; display: flex; align-items: center; }
        #status-bar-time::after { content: "üêæ"; margin-left: 4px; font-size: 12px; }
        #concurrent-status { position: absolute; top: 35px; left: 50%; transform: translateX(-50%); z-index: 15; background: transparent; color: #999; padding: 0; border-radius: 0; font-size: 11px; display: none; font-weight: normal; }
        #ai-heartrate-display { 
            position: absolute; 
            top: 12px; 
            left: 50%; 
            transform: translateX(-50%); 
            font-size: 12px; 
            color: #ff6b6b; 
            display: none; 
            z-index: 15;
            font-weight: normal;
            transition: all 0.3s ease;
        }
        #ai-heartrate-display .heartrate-number {
            color: #000;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        #ai-heartrate-display .heartrate-unit {
            color: #888;
            font-weight: normal;
        }
        
        /* ÂøÉÁéáËøáÈ´òÊó∂ÁöÑÁâπÊÆäÊïàÊûú */
        #ai-heartrate-display.high-heartrate {
            animation: heartbeat-pulse 1s infinite;
        }
        #ai-heartrate-display.high-heartrate .heartrate-number {
            color: #ff3366;
        }
        #ai-heartrate-display.very-high-heartrate {
            animation: heartbeat-intense 0.6s infinite;
        }
        #ai-heartrate-display.very-high-heartrate .heartrate-number {
            color: #ff1144;
            font-weight: 900;
        }
        
        @keyframes heartbeat-pulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }
        
        @keyframes heartbeat-intense {
            0%, 100% { transform: translateX(-50%) scale(1); }
            25% { transform: translateX(-50%) scale(1.08); }
            75% { transform: translateX(-50%) scale(1.03); }
        }
        .battery-container { display: flex; align-items: center; gap: 4px; font-size: 14px; }
        .battery-icon { width: 20px; height: 10px; border: 1px solid white; border-radius: 4px; position: relative; padding: 1px; }
        .battery-icon::after { content: ''; position: absolute; right: -2px; top: 2px; width: 1.5px; height: 4px; background-color: white; border-radius: 0 1px 1px 0; }
        .battery-level { height: 100%; background-color: white; border-radius: 2px; transition: width 0.5s ease; }
        .battery-container.charging .battery-level { background-color: #4cd964; animation: charge-breath 2s infinite; }
        .battery-container.charging .battery-text { color: #4cd964; }
        @keyframes charge-breath { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; overflow: hidden; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .screen.active { opacity: 1; visibility: visible; z-index: 1; }
        .header { 
    position: relative; 
    z-index: 15; 
    flex-shrink: 0; 
    padding: 15px 60px; 
    padding-top: 45px; 
    background-color: var(--theme-header-bg); 
    backdrop-filter: blur(10px); 
    -webkit-backdrop-filter: blur(10px); 
    border-bottom: 1px solid var(--border-color); 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    font-size: 18px; 
    font-weight: 600; 
    transition: all 0.3s ease;
}
        .header .header-actions { display: flex; align-items: center; gap: 15px; position: absolute; right: 20px; }
        .header .back-btn, .header .action-btn { font-size: 24px; cursor: pointer; width: 30px; text-align: center; color: #000000; display: flex; align-items: center; justify-content: center; }
        .header .back-btn { position: absolute; left: 20px; }
        .header .header-title { text-align: center; flex: 1; color: #000000; }
        .header .action-btn img { height: 26px; }
        .header .save-btn { font-size: 16px; color: #000000; font-weight: 600; cursor: pointer; position: absolute; right: 20px; }
        #home-screen { display: flex; flex-direction: column; justify-content: flex-start; align-items: center; padding: 20px; padding-top: 80px; padding-bottom: 50px; box-sizing: border-box; background-size: cover; background-position: center; height: 100%; }
        #clock-container { text-align: center; color: white; text-shadow: 0 3px 8px rgba(0,0,0,0.4); margin-bottom: 20px; flex-shrink: 0; }
        #main-time { font-size: 80px; font-weight: 200; }
        #main-date { font-size: 18px; font-weight: 500; }
        #app-grid { margin-top: auto; margin-bottom: auto; display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; padding: 20px; transition: margin 0.3s ease; }
        .app-row { display: flex; justify-content: center; gap: 25px; width: 100%; }
        .app-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); font-size: 14px; font-weight: 500; text-align: center; }
        .app-icon .icon-bg { width: 65px; height: 65px; border-radius: 18px; background-color: var(--secondary-bg); display: flex; justify-content: center; align-items: center; font-size: 32px; margin-bottom: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: transform 0.2s ease; overflow: hidden; }
        .app-icon:active .icon-bg { transform: scale(0.9); }
        .app-icon .icon-bg img { width: 100%; height: 100%; object-fit: cover; }
        .app-icon .label { color: white; }
        .form-container, .list-container { padding: 20px; overflow-y: auto; flex-grow: 1; display:flex; flex-direction: column; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { 
    width: 100%; 
    padding: 12px; 
    border: var(--theme-input-border); 
    border-radius: var(--theme-input-radius); 
    font-size: 16px; 
    box-sizing: border-box; 
    background-color: var(--theme-form-bg); 
    color: #333; 
    transition: all 0.2s ease;
    font-family: var(--theme-font-family);
}
.form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #c0c0c0; outline: none; box-shadow: 0 0 0 2px rgba(0,0,0,0.05); }
        .form-group textarea { min-height: 80px; resize: vertical; }
        #world-book-content-input { height: calc(100% - 120px); }
        .form-button { 
    width: 100%; 
    padding: 15px; 
    background-color: var(--theme-button-bg); 
    color: var(--theme-button-color); 
    border: var(--theme-button-border); 
    border-radius: var(--theme-input-radius); 
    font-size: 16px; 
    font-weight: 600; 
    cursor: pointer; 
    margin-top: 10px; 
    backdrop-filter: blur(10px); 
    -webkit-backdrop-filter: blur(10px); 
    box-shadow: var(--theme-shadow); 
    transition: all 0.2s ease;
    font-family: var(--theme-font-family);
}
        .form-button:hover { background-color: rgba(245, 245, 247, 0.9); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .form-button-secondary { background-color: rgba(240, 240, 240, 0.8); color: #333; border: 1px solid rgba(0,0,0,0.1); }
        #wallpaper-screen .form-container { align-items: center; }
        #wallpaper-preview { width: 180px; height: 320px; border: 2px dashed var(--border-color); background-color: #f0f2f5; margin-bottom: 20px; background-size: cover; background-position: center; border-radius: 10px; display: flex; justify-content: center; align-items: center; color: var(--text-secondary); }
        #wallpaper-upload-input { display: none; }
        #chat-list, #world-book-list { flex-grow: 1; overflow-y: auto; background-color: var(--secondary-bg); padding-top: 80px; margin-top: -80px; }
        .list-item { display: flex; flex-direction: column; padding: 12px 20px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .list-item:hover { background-color: #f5f5f5; }
        .list-item .item-title { font-weight: 500; font-size: 16px; margin-bottom: 5px; }
        .list-item .item-content { font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); position: relative; }
        .chat-list-item:hover { background-color: #f5f5f5; }
        .chat-list-item .avatar { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; object-fit: cover; background-color: #ccc; }
        .chat-list-item .info { flex-grow: 1; overflow: hidden; }
        .chat-list-item .name-line { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .chat-list-item .name { font-weight: 500; color: var(--text-primary); }
        .chat-list-item .group-tag { font-size: 10px; color: var(--accent-color); background-color: #e7f3ff; padding: 2px 6px; border-radius: 4px; font-weight: bold; flex-shrink: 0; }
        .chat-list-item .last-msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        .chat-status-indicator { position: absolute; top: 8px; right: 8px; font-size: 12px; display: none; }
        #chat-interface-screen { background-size: cover; background-position: center; position: relative; }
        #chat-interface-screen .header .default-controls, #chat-interface-screen .header .selection-controls { display: contents; }
        #chat-interface-screen.selection-mode .default-controls { display: none; }
        #chat-interface-screen:not(.selection-mode) .selection-controls { display: none; }
        #selection-cancel-btn, #selection-delete-btn { font-size: 16px; color: var(--accent-color); cursor: pointer; padding: 5px; }
        #selection-delete-btn { color: #ff3b30; }
        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px; padding-top: 80px; margin-top: -80px; display: flex; flex-direction: column; gap: 12px; }
        #load-more-btn { text-align: center; padding: 10px; color: var(--accent-color); font-size: 14px; cursor: pointer; background-color: transparent; border: none; width: 100%; }
        #load-more-btn:hover { text-decoration: underline; }
        .message-wrapper { display: flex; flex-direction: column; max-width: 85%; }
        .message-wrapper.user { align-self: flex-end; align-items: flex-end; }
        .message-wrapper.ai { align-self: flex-start; align-items: flex-start; }
        .sender-name { font-size: 11px; color: #666; margin-bottom: 3px; }
        .message-wrapper.ai .sender-name { margin-left: 37px; }
        .message-bubble { display: flex; align-items: flex-start; gap: 5px; position: relative; width: -webkit-fit-content; width: -moz-fit-content; width: fit-content; max-width: 100%; }
        .message-bubble.selected::after { content: '‚úî'; position: absolute; left: -10px; top: 50%; transform: translateY(-50%); background-color: var(--accent-color); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .message-bubble.user.selected::after { left: auto; right: -10px; }
        .avatar-group { display: flex; flex-direction: column; align-items: center; gap: 4px; flex-shrink: 0; width: 32px; }
        .message-bubble .avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
        .timestamp { font-size: 10px; color: #b0b0b0; display: none; }
        
        /* Êó∂Èó¥ÂàÜÈöîÁ¨¶Ê†∑Âºè */
        .time-separator {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin: 15px 0 8px 0;
            padding: 5px 0;
        }
        .message-bubble .content { padding: 8px 12px; word-break: break-word; line-height: 1.5; font-size: 15px; position: relative; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.6), 0 3px 6px rgba(0,0,0,0.15); border: 1px solid rgba(255, 255, 255, 0.2); transition: background-color 0.3s, color 0.3s; }
        
        /* Â≠óÂè∑Â§ßÂ∞èËÆæÁΩÆ */
        body[data-font-size="xsmall"] .message-bubble .content { font-size: 10px; }
        body[data-font-size="tiny"] .message-bubble .content { font-size: 12px; }
        body[data-font-size="small"] .message-bubble .content { font-size: 14px; }
        body[data-font-size="medium"] .message-bubble .content { font-size: 15px; }
        body[data-font-size="large"] .message-bubble .content { font-size: 16px; }
        body[data-font-size="xlarge"] .message-bubble .content { font-size: 18px; }
        
        /* ËÅäÂ§©Ê®°ÂºèÂàáÊç¢ÊåâÈíÆÊ†∑Âºè */
        .chat-mode-switch {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 4px;
            margin: 10px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .chat-mode-option {
            flex: 1;
            position: relative;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .chat-mode-option input[type="radio"] {
            display: none;
        }
        
        .chat-mode-option label {
            display: block;
            padding: 12px 16px;
            text-align: center;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: transparent;
            color: rgba(0, 0, 0, 0.6);
            position: relative;
            overflow: hidden;
        }
        
        .chat-mode-option input[type="radio"]:checked + label {
            background: rgba(255, 255, 255, 0.9);
            color: rgb(74, 132, 193);
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(74, 132, 193, 0.2);
            transform: translateY(-1px);
        }
        
        .chat-mode-option label:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        .chat-mode-option input[type="radio"]:checked + label:hover {
            background: rgba(255, 255, 255, 0.95);
            color: rgb(74, 132, 193);
        }
        
        /* Â≠óÊï∞ÈôêÂà∂ËæìÂÖ•Ê°ÜÊ†∑Âºè */
        .offline-length-control {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .offline-length-control input[type="number"] {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .offline-length-control input[type="number"]:focus {
            outline: none;
            border-color: rgb(74, 132, 193);
            box-shadow: 0 0 0 2px rgba(74, 132, 193, 0.2);
        }
        
        /* Ê®°ÊÄÅÊ°ÜÊåâÈíÆÁæéÂåñ */
        .modal-footer button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .modal-footer .cancel {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
            border: 1px solid rgba(108, 117, 125, 0.3);
        }
        
        .modal-footer .cancel:hover {
            background: rgba(108, 117, 125, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.2);
        }
        
        .modal-footer .save {
            background: rgba(74, 132, 193, 0.9);
            color: white;
            border: 1px solid rgba(74, 132, 193, 0.3);
        }
        
        .modal-footer .save:hover {
            background: rgba(74, 132, 193, 1);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 132, 193, 0.3);
        }
        
        /* ÂèØÁà±È£é‰∏ªÈ¢òÊ†∑Âºè */
        body.cute-theme .chat-mode-switch {
            background: linear-gradient(135deg, rgba(240, 170, 180, 0.3), rgba(245, 200, 175, 0.3));
            border: 1px solid rgba(235, 180, 185, 0.4);
        }
        
        body.cute-theme .chat-mode-option input[type="radio"]:checked + label {
            background: linear-gradient(135deg, #e585a3, #e5a3d6);
            color: white;
            box-shadow: 0 4px 12px rgba(235, 155, 175, 0.3);
        }
        
        body.cute-theme .offline-length-control {
            background: linear-gradient(135deg, rgba(240, 170, 180, 0.2), rgba(245, 200, 175, 0.2));
            border: 1px solid rgba(235, 180, 185, 0.3);
        }
        
        body.cute-theme .modal-footer .cancel {
            background: linear-gradient(135deg, rgba(240, 170, 180, 0.3), rgba(245, 200, 175, 0.3));
            color: #c55579;
            border: 1px solid rgba(240, 170, 180, 0.5);
        }
        
        body.cute-theme .modal-footer .cancel:hover {
            background: linear-gradient(135deg, rgba(240, 170, 180, 0.5), rgba(245, 200, 175, 0.5));
            box-shadow: 0 4px 12px rgba(240, 170, 180, 0.4);
        }
        
        body.cute-theme .modal-footer .save {
            background: linear-gradient(135deg, #e585a3, #e5a3d6);
            color: white;
            border: 1px solid rgba(235, 155, 175, 0.3);
        }
        
        body.cute-theme .modal-footer .save:hover {
            background: linear-gradient(135deg, #d6758f, #e585a3);
            box-shadow: 0 4px 16px rgba(235, 155, 175, 0.4);
        }
        
        /* ÂæÆÂçöÂèëÂ∏ÉÊåâÈíÆÊ†∑Âºè */
        .weibo-publish-btn:hover {
            background: rgba(74, 132, 193, 1) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 132, 193, 0.3);
        }
        
        body.cute-theme .weibo-publish-btn {
            background: linear-gradient(135deg, #e585a3, #e5a3d6) !important;
        }
        
        body.cute-theme .weibo-publish-btn:hover {
            background: linear-gradient(135deg, #d6758f, #e585a3) !important;
            box-shadow: 0 4px 16px rgba(235, 155, 175, 0.4);
        }
        .message-bubble.user { flex-direction: row-reverse; }
        #typing-indicator { align-self: flex-start; display: none; margin: 0 10px 10px; color: var(--text-secondary); }
        #chat-input-area { flex-shrink: 0; padding: 8px; background-color: rgba(247, 247, 247, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 5px; }
        #chat-input-main-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; }
        #chat-input { flex-grow: 1; border: none; padding: 10px 15px; border-radius: 20px; background-color: var(--secondary-bg); font-size: 16px; max-height: 100px; resize: none; }
        
        /* @ÂäüËÉΩÊ†∑Âºè */
        .mention-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: var(--secondary-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .mention-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .mention-item:hover,
        .mention-item.selected {
            background-color: var(--hover-bg);
        }
        
        /* ‰∏∫‰∏çÂêå‰∏ªÈ¢òÈÄÇÈÖç@‰∏ãÊãâÊ°ÜËÉåÊôØ */
        body[data-theme="dark"] .mention-dropdown {
            background: rgba(45, 45, 45, 0.95);
        }
        
        body[data-theme="cute"] .mention-dropdown {
            background: rgba(255, 240, 245, 0.95);
        }
        
        body[data-theme="tech"] .mention-dropdown {
            background: rgba(15, 23, 42, 0.95);
        }
        
        .mention-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        
        .mention-name {
            font-size: 14px;
            color: var(--text-color);
        }
        
        .mention-tag {
            color: #4a84c1;
            font-weight: 500;
        }
        
        #chat-input-container {
            position: relative;
            flex-grow: 1;
        }
        .action-button { border: none; color: white; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px; flex-shrink: 0; }
        #send-btn { 
    background-color: rgb(74, 132, 193); /* Èôç‰ΩéÈ•±ÂíåÂ∫¶‰ΩÜÊèêÈ´ò‰∏çÈÄèÊòéÂ∫¶ */
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    height: 40px; 
    padding: 0 15px;
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    color: white;
    font-weight: 600; /* Âä†Á≤óÂ≠ó‰Ωì */
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); /* Ê∑ªÂä†ÊñáÂ≠óÈò¥ÂΩ±ÊèêÈ´òÂèØËØªÊÄß */
    letter-spacing: 0.5px; /* Â¢ûÂä†Â≠óÈó¥Ë∑ù */
    transition: all 0.2s ease;
}

#send-btn:hover {
    background-color: rgba(72, 125, 178, 0.95);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal.visible { display: flex; }
        .modal-content { width: 90%; max-height: 90%; background-color: white; border-radius: 15px; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; font-weight: 600; border-bottom: 1px solid var(--border-color); text-align: center; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 15px; overflow-y: auto; }
        .modal-footer { padding: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; }
        .modal-footer button { width: 45%; padding: 12px; border-radius: 8px; border: 1px solid var(--accent-color); cursor: pointer; font-size: 16px; }
        .modal-footer .save { background-color: var(--accent-color); color: white; }
        .modal-footer .cancel { background-color: white; color: var(--accent-color); }
        .avatar-upload { display: flex; align-items: center; gap: 15px; }
        .avatar-upload img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: #eee; }
        .avatar-upload button { padding: 8px 12px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; }
        #open-persona-library-btn { font-size: 14px; padding: 6px 10px; margin-left: auto; }
        .avatar-upload input[type="file"] { display: none; }
        .theme-selector label { display: inline-flex; align-items: center; margin-right: 15px; margin-bottom: 5px; cursor: pointer; }
        #reset-theme-btn { background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #group-members-settings { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 15px; }
        .member-editor { text-align: center; cursor: pointer; }
        .member-editor img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background-color: #eee; margin-bottom: 5px; }
        .member-editor .member-name { font-size: 12px; }
        .member-action-btn { 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.2s ease;
        }
        .member-action-btn .btn-avatar { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            background: rgba(240, 240, 240, 0.8); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 24px; 
            color: #666; 
            margin-bottom: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .member-action-btn .btn-label { 
            font-size: 12px; 
            color: #666;
        }
        .member-action-btn:hover .btn-avatar { 
            background: rgba(220, 220, 220, 0.9); 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        #notification-bar { position: absolute; top: 40px; left: 5%; width: 90%; z-index: 500; background-color: rgba(250, 250, 250, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 16px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; cursor: pointer; transform: translateY(-150%); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); visibility: hidden; }
        #notification-bar.visible { transform: translateY(0); visibility: visible; }
        #notification-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        #notification-content .name { font-weight: 600; font-size: 15px; color: #000; }
        #notification-content .message { font-size: 14px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .sticker-image { max-width: 100px; max-height: 100px; display: block; object-fit: contain; }
        .message-bubble.is-sticker .content, .message-bubble.is-voice-message .content { padding: 0; background-color: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        
        /* ËØ≠Èü≥Ê∂àÊÅØÂÆπÂô® */
        .voice-message-container {
            width: 100%;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        
        /* Áî®Êà∑ËØ≠Èü≥Ê∂àÊÅØÂÆπÂô®Âè≥ÂØπÈΩê */
        .voice-message-container.user {
            align-self: flex-end;
            align-items: flex-end;
        }
        
        /* AIËØ≠Èü≥Ê∂àÊÅØÂÆπÂô®Â∑¶ÂØπÈΩê */
        .voice-message-container.ai {
            align-self: flex-start;
            align-items: flex-start;
        }
        
        /* AIËØ≠Èü≥ÊñáÊú¨Ê°Ü‰∏éAIËØ≠Èü≥Êù°Â∑¶ËæπÁºòÂØπÈΩê */
        .voice-message-container.ai .voice-text-content {
            margin-left: 44px; /* Â§¥ÂÉè(32px) + Èó¥Ë∑ù(12px) */
        }
        
        /* Áî®Êà∑ËØ≠Èü≥ÊñáÊú¨Ê°Ü‰∏éÁî®Êà∑ËØ≠Èü≥Êù°Âè≥ËæπÁºòÂØπÈΩê */
        .voice-message-container.user .voice-text-content {
            margin-right: 44px; /* Â§¥ÂÉè(32px) + Èó¥Ë∑ù(12px) */
            align-self: flex-end;
        }
        #chat-input-actions-top { display: flex; gap: 8px; padding: 0 5px; }
        .chat-action-icon-btn { font-size: 24px; padding: 0; width: 38px; height: 38px; line-height: 38px; text-align: center; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); color: var(--text-primary); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.05); cursor: pointer; display:flex; justify-content:center; align-items:center; }
        #sticker-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background-color: rgba(242, 242, 247, 0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 200; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #sticker-panel.visible { transform: translateY(0); visibility: visible; }
        #sticker-panel-header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
        #sticker-panel-header .title { font-weight: 600; }
        #sticker-panel-header .panel-btn { font-size: 16px; padding: 5px 10px; cursor: pointer; color: var(--accent-color); }
        #sticker-grid { flex-grow: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
        .sticker-item { position: relative; aspect-ratio: 1 / 1; background-color: white; border-radius: 10px; background-size: contain; background-repeat: no-repeat; background-position: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .sticker-item .delete-btn { display: none; position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background-color: #ff3b30; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 14px; cursor: pointer; border: 2px solid white; }
        #input-actions-wrapper { position: static; display: flex; align-items: flex-end; gap: 8px; flex-shrink: 0; }
        #wait-reply-btn { position: static; bottom: auto; right: auto; width: auto; height: 40px; padding: 0 10px; border-radius: 20px; display: flex; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: opacity 0.2s, transform 0.1s; cursor: pointer;}
        #wait-reply-btn:hover { opacity: 0.8; }
        #wait-reply-btn:active { transform: scale(0.9); }
        #wait-reply-btn img { height: 22px; display: block; margin: auto; }
        
        /* Á≠âÂæÖÂõûÂ§çÊåâÈíÆÁöÑ‰∏ªÈ¢òÂàáÊç¢ */
        body[data-theme="cute"] #wait-reply-btn img {
            content: url('https://i.postimg.cc/HxmLGLfk/IMG-5103.png');
        }
        
        /* ÂèëÈÄÅÊåâÈíÆÂú®ÂèØÁà±È£é‰∏ªÈ¢ò‰∏ãÁöÑÊ†∑Âºè */
        body[data-theme="cute"] #send-btn {
            background-color: rgb(248, 187, 208) !important; /* Ê∑°Á≤âËâ≤ */
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        body[data-theme="cute"] #send-btn:hover {
            background-color: rgba(246, 173, 198, 0.95) !important;
        }
        .chat-image { max-width: 100%; border-radius: 10px; display: block; }
        .message-bubble.has-image .content { padding: 5px; }
        
        /* Áî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâáÁº©Áï•ÂõæÊ†∑Âºè */
        .message-bubble.user .chat-image {
            max-width: 120px;
            max-height: 120px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .message-bubble.user .chat-image:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        /* AIÂèëÈÄÅÁöÑÂõæÁâá‰øùÊåÅÂéüÊ†∑ */
        .message-bubble.ai .chat-image {
            max-width: 100%;
            border-radius: 10px;
        }
        
        /* ÂõæÁâáÊü•ÁúãÂô®Ê®°ÊÄÅÊ°Ü */
        #image-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        #image-viewer-modal.visible {
            display: flex;
            opacity: 1;
        }
        
        .image-viewer-content {
            position: relative;
            max-width: 85vw;
            max-height: 85vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #viewer-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        
        .image-viewer-close {
            position: absolute;
            top: -45px;
            right: -5px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            transition: all 0.2s ease;
            z-index: 2001;
        }
        
        .image-viewer-close:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }
        #custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.2s ease-in-out; }
        #custom-modal-overlay.visible { display: flex; opacity: 1; }
        #custom-modal { background-color: #fff; width: 280px; border-radius: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        #custom-modal-overlay.visible #custom-modal { transform: scale(1); }
        .custom-modal-header { padding: 16px; font-size: 17px; font-weight: 600; text-align: center; }
        .custom-modal-body { padding: 0 16px 16px; text-align: center; font-size: 14px; color: #333; line-height: 1.5; }
        .custom-modal-body p { margin: 0; margin-bottom: 12px; }
        .custom-modal-body input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
        .custom-modal-footer { border-top: 1px solid #dbdbdb; display: flex; }
        .custom-modal-footer button { flex: 1; background: none; border: none; padding: 12px; font-size: 17px; cursor: pointer; color: var(--accent-color); }
        .custom-modal-footer button:first-child { border-right: 1px solid #dbdbdb; }
        .custom-modal-footer .confirm-btn { font-weight: 600; }
        .custom-modal-footer .confirm-btn.btn-danger { color: #ff3b30; }
        #preset-actions-modal .custom-modal-footer { flex-direction: column; }
        #preset-actions-modal .custom-modal-footer button { width: 100%; border: none; border-bottom: 1px solid #dbdbdb; padding: 14px; font-size: 18px; }
        #preset-actions-modal .custom-modal-footer button:last-child { border-bottom: none; }
        .custom-multiselect { position: relative; user-select: none; }
        .select-box { display: flex; align-items: center; width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; background-color: #fff; cursor: pointer; }
        .select-box .selected-options-text { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
        .select-box .arrow-down { margin-left: auto; font-size: 10px; color: var(--text-secondary); transition: transform 0.2s; }
        .select-box.expanded .arrow-down { transform: rotate(180deg); }
        .checkboxes-container { display: none; position: absolute; top: 105%; left: 0; right: 0; max-height: 150px; overflow-y: auto; background-color: #fff; border: 1px solid var(--border-color); border-radius: 8px; z-index: 101; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .checkboxes-container.visible { display: block; }
        .checkboxes-container label { display: block; padding: 10px 12px; cursor: pointer; font-weight: normal; color: var(--text-primary); }
        .checkboxes-container label:hover { background-color: #f5f5f5; }
        .checkboxes-container input { margin-right: 10px; vertical-align: middle; }
        .bg-upload-container { display: flex; align-items: center; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
        .bg-preview-img { max-width: 120px; max-height: 80px; border-radius: 8px; border: 1px solid var(--border-color); object-fit: cover; display: none; }
        #remove-bg-btn { padding: 8px 12px; border: 1px solid #ff3b30; color: #ff3b30; background-color: #fff; border-radius: 5px; cursor: pointer; font-size: 14px; display: none; }
        .message-bubble.is-ai-image .content { padding: 5px; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        .ai-generated-image { max-width: 180px; border-radius: 12px; display: block; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .ai-generated-image:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .voice-message-body { display: flex; align-items: center; cursor: pointer; padding: 8px 12px; min-width: 80px; max-width: 200px; }
        .message-bubble.user .voice-message-body { color: #1a3d00; flex-direction: row-reverse; }
        .message-bubble.ai .voice-message-body { color: var(--text-primary); }
        .voice-waveform { display: flex; align-items: center; height: 20px; gap: 2px; flex-grow: 1; margin: 0 10px; }
        .voice-waveform div { width: 3px; background-color: currentColor; border-radius: 2px; animation: wave-quiet 1.5s ease-in-out infinite; }
        @keyframes wave-quiet { 0%, 100% { height: 2px; } 50% { height: 10px; } }
        .voice-waveform div:nth-child(2) { animation-delay: 0.2s; } .voice-waveform div:nth-child(3) { animation-delay: 0.4s; } .voice-waveform div:nth-child(4) { animation-delay: 0.6s; } .voice-waveform div:nth-child(5) { animation-delay: 0.8s; }
        .voice-duration { font-size: 13px; font-weight: 500; color: var(--text-secondary); }
        .message-bubble.user .voice-duration { color: #3e6224; }
        
        /* ËØ≠Èü≥ÂÜÖÂÆπÂ±ïÂºÄÊ†∑Âºè */
        .voice-text-content {
            display: none;
            margin-top: 12px;
            padding: 10px 15px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            font-size: 14px;
            line-height: 1.5;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            word-break: break-word;
            width: fit-content;
            max-width: 200px;
            animation: voiceTextFadeIn 0.3s ease-in-out;
            border: 1px solid rgba(0,0,0,0.08);
        }
        
        .voice-text-content.visible {
            display: block;
        }
        
        @keyframes voiceTextFadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Êà≥‰∏ÄÊà≥Ê∂àÊÅØÊ†∑Âºè */
        .poke-message {
            text-align: center;
            color: #999;
            font-size: 13px;
            margin: 0;
            padding: 5px 15px;
            background: rgba(0,0,0,0.05);
            border-radius: 15px;
            max-width: 200px;
            align-self: center;
            animation: pokeShake 0.5s ease-in-out;
        }
        
        /* Êí§ÂõûÊ∂àÊÅØÊ†∑Âºè */
        .recalled-message {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin: 5px 0;
            padding: 5px 0;
            width: 100%;
            animation: recallFadeIn 0.5s ease-in-out;
        }
        
        .message-wrapper.system {
            display: flex;
            justify-content: center;
            width: 100%;
            margin: 5px 0;
        }
        
        @keyframes recallFadeIn {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pokeShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }

        /* === Ê∞îÊ≥°‰∏ªÈ¢òÊ†∑Âºè === */
        .message-bubble.user .content { background-color: rgba(160, 233, 86, 0.75); color: #1a3d00; border-radius: 20px 8px 20px 20px; }
        .message-bubble.ai .content { background-color: rgba(255, 255, 255, 0.7); color: var(--text-primary); border-radius: 8px 20px 20px 20px; }
        #chat-messages[data-theme="pink_blue"] .message-bubble.user .content { background-color: #FADADD; color: #5D3A3A; }
        #chat-messages[data-theme="pink_blue"] .message-bubble.ai .content { background-color: #D6EAF8; color: #283747; }
        #chat-messages[data-theme="blue_white"] .message-bubble.user .content { background-color: #cce5ff; color: #004085; }
        #chat-messages[data-theme="blue_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.user .content { background-color: #E6E6FA; color: #4B0082; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.ai .content { background-color: #FFFACD; color: #5C4033; }
        #chat-messages[data-theme="black_white"] .message-bubble.user .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="black_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #343a40; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.user .content { background-color: #FFEB3B; color: #5D4037; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="red_black"] .message-bubble.user .content { background-color: #C62828; color: #FFFFFF; }
        #chat-messages[data-theme="red_black"] .message-bubble.ai .content { background-color: #212121; color: #FFFFFF; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.user .content { background-color: #A0D2EB; color: #153243; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.ai .content { background-color: #E6E6FA; color: #4B0082; }
        #chat-messages[data-theme="gray_white"] .message-bubble.user .content { background-color: #e9ecef; color: #495057; }
        #chat-messages[data-theme="gray_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="blue_green"] .message-bubble.user .content { background-color: #d1ecf1; color: #0c5460; }
        #chat-messages[data-theme="blue_green"] .message-bubble.ai .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="pink_white"] .message-bubble.user .content { background-color: #fce4ec; color: #880e4f; }
        #chat-messages[data-theme="pink_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="pink_black"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="pink_green"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_green"] .message-bubble.ai .content { background-color: #C8E6C9; color: #1B5E20; }
        #chat-messages[data-theme="green_black"] .message-bubble.user .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="green_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }

        /* Ëá™ÂÆö‰πâÊ†∑ÂºèÂÆπÂô® - Áî®Êà∑Ëá™ÂÆö‰πâÁöÑCSSÊ†∑ÂºèÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÊ≥®ÂÖ• */

        #transfer-btn { font-weight: bold; }
        #transfer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1001; }
        #transfer-modal.visible { display: flex; }
        .transfer-content { background-color: #fff0f5; border-radius: 20px; width: 290px; padding: 20px; box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); text-align: center; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" opacity="0.05"><path d="M50,4 C35,4 28,15 28,24 C28,33 35,32 35,40 C35,48 28,49 28,57 C28,65 35,66 35,74 C35,82 28,83 28,91 C28,99 35,100 50,100 C65,100 72,99 72,91 C72,83 65,82 65,74 C65,66 72,65 72,57 C72,49 65,48 65,40 C65,32 72,33 72,24 C72,15 65,4 50,4 Z" fill="%23FF69B4"/></svg>'); background-repeat: no-repeat; background-position: top right; background-size: 80px; }
        .transfer-header { font-size: 20px; font-weight: bold; color: #a35c7b; margin-bottom: 20px; }
        .transfer-input-group { margin-bottom: 15px; text-align: left; }
        .transfer-input-group label { display: block; font-size: 14px; color: #ff85b3; margin-bottom: 5px; font-weight: 500; }
        .transfer-input-group input { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #ffcce0; background-color: #fff; font-size: 16px; box-sizing: border-box; }
        .transfer-input-group input:focus { border-color: #ff85b3; outline: none; }
        .transfer-actions { display: flex; justify-content: space-between; gap: 10px; }
        .transfer-actions button { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .transfer-actions button:active { transform: scale(0.95); }
        #transfer-cancel-btn { background-color: #ffdde9; color: #a35c7b; }
        #transfer-confirm-btn { background-color: #ff85b3; color: white; }
        .message-bubble.is-transfer .content { padding: 0; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; cursor: pointer; }
        .transfer-card { width: 200px; border-radius: 12px; padding: 12px; color: white; position: relative; overflow: hidden; transition: opacity 0.3s ease; }
        .transfer-card::before { content: 'üêæ'; position: absolute; right: 10px; top: 5px; font-size: 30px; opacity: 0.2; transform: rotate(15deg); }
        .message-bubble.user .transfer-card { background: radial-gradient(circle at top left, #ffc5d5, #ff85b3); }
        .message-bubble.ai .transfer-card { background: radial-gradient(circle at top left, #a1c4fd, #c2e9fb); }
        .transfer-card.accepted { opacity: 0.6; }
        .transfer-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
        .transfer-amount { font-size: 28px; font-weight: bold; margin-bottom: 4px; }
        .transfer-note { font-size: 13px; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; margin-top: 8px; word-break: break-all; }
        .transfer-status { font-size: 12px; text-align: right; margin-top: 8px; font-weight: 500; }
        
        /* ËΩ¨Ë¥¶Á°ÆËÆ§ÂºπÁ™ó */
        #transfer-confirm-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1002; }
        #transfer-confirm-modal.visible { display: flex; }
        .transfer-confirm-content { background-color: #fff; border-radius: 20px; width: 280px; padding: 20px; box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2); text-align: center; }
        .transfer-confirm-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; }
        .transfer-confirm-info { margin-bottom: 20px; }
        .transfer-confirm-amount { font-size: 24px; font-weight: bold; color: #ff85b3; margin: 10px 0; }
        .transfer-confirm-note { font-size: 14px; color: #666; margin-bottom: 10px; }
        .transfer-confirm-actions { display: flex; justify-content: space-between; gap: 10px; }
        .transfer-confirm-actions button { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .transfer-confirm-actions button:active { transform: scale(0.95); }
        #transfer-reject-btn { background-color: #f0f0f0; color: #666; }
        #transfer-accept-btn { background-color: #ff85b3; color: white; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #listen-together-btn img.rotating { animation: spin 2s linear infinite; }
        #listen-together-btn img.paused { animation-play-state: paused; }
        #music-player-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: none; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.3); }
        #music-player-overlay.visible { display: flex; }
        .music-player-window { width: 90%; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); border: 1px solid rgba(255, 255, 255, 0.18); padding: 25px; display: flex; flex-direction: column; align-items: center; color: #1f1f1f; position: relative; }
        #music-playlist-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #333; }
        #music-time-counter { font-size: 12px; color: #555; margin-bottom: 20px; }
        #music-player-song-title { font-size: 20px; font-weight: 600; margin-bottom: 5px; text-align: center; }
        #music-player-artist { font-size: 14px; color: #666; margin-bottom: 25px; }
        .music-controls { display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%; margin-bottom: 30px; }
        .music-controls button { background: none; border: none; font-size: 16px; font-weight: bold; cursor: pointer; color: #333; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; transition: transform 0.2s; }
        .music-controls button:active { transform: scale(0.9); }
        .music-controls .play-pause-btn { font-size: 24px; width: 60px; height: 60px; border-radius: 50%; background-color: rgba(0,0,0,0.05); }
        .music-bottom-actions { display: flex; justify-content: space-between; width: 100%; }
        .music-bottom-actions button { flex: 1; padding: 12px 0; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; }
        #music-exit-btn { background-color: rgba(255, 100, 100, 0.7); color: white; margin-right: 5px; }
        #music-return-btn { background-color: rgba(0, 123, 255, 0.7); color: white; margin-left: 5px; }
        
        #music-playlist-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; background-color: rgba(242, 242, 247, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 210; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #music-playlist-panel.visible { transform: translateY(0); visibility: visible; }
        .playlist-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .playlist-header .panel-btn { font-size: 16px; cursor: pointer; color: var(--accent-color); }
        .playlist-body { flex-grow: 1; overflow-y: auto; padding: 10px 0; }
        .playlist-item { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; }
        .playlist-item.playing { background-color: rgba(0, 123, 255, 0.1); }
        .playlist-item-info .title { font-weight: 500; font-size: 15px; }
        .playlist-item-info .artist { font-size: 12px; color: #666; }
        .playlist-item .delete-track-btn { color: #ff3b30; font-size: 20px; padding: 5px; }

        /* APIÈÖçÁΩÆÂç°ÁâáÊ†∑Âºè */
        .config-card {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            position: relative;
            overflow: hidden;
        }
        .config-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: rgba(102, 126, 234, 0.3);
        }
        .config-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }
        .config-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .config-card.active::before {
            opacity: 1;
        }
        .config-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .config-name {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .config-actions {
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .config-card:hover .config-actions {
            opacity: 1;
        }
        .config-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .config-action-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }
        .config-details {
            display: grid;
            gap: 8px;
            font-size: 13px;
        }
        .config-detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 6px;
        }
        .config-detail-label {
            color: #666;
            font-weight: 500;
            min-width: 40px;
        }
        .config-detail-value {
            color: #333;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            background: rgba(102, 126, 234, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .config-use-btn {
            width: 100%;
            padding: 10px;
            margin-top: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        .config-use-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .config-use-btn:active {
            transform: translateY(0);
        }

        /* Persona Library Styles */
        #persona-library-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 10px; }
        .persona-preset-item { aspect-ratio: 1 / 1; border-radius: 12px; background-size: cover; background-position: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid rgba(0,0,0,0.1); }
        .persona-preset-item:hover { transform: scale(1.08); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .modal-header .action-button { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; background: none; border: none; padding: 5px; }
        
        /* Battery Alert Modal Styles */
        #battery-alert-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        #battery-alert-modal.visible { display: flex; opacity: 1; }
        .battery-alert-content { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); width: 280px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center; padding: 20px; cursor: pointer; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #battery-alert-modal.visible .battery-alert-content { transform: scale(1); }
        #battery-alert-image { max-width: 100px; max-height: 100px; margin-bottom: 15px; }
        #battery-alert-text { font-size: 16px; font-weight: 500; color: #333; margin: 0; line-height: 1.4; }

        /* Á§æ‰∫§‰∏ªÈ°µÊ®°ÊÄÅÂºπÁ™óÊ†∑Âºè */
        .social-profile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .social-profile-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #f5f5f5;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }



        .social-profile-content {
            height: 100%;
            display: flex;
            flex-direction: column;
            max-height: 80vh; /* Á°Æ‰øù‰∏çË∂ÖÂá∫Ê®°ÊÄÅÂºπÁ™ó */
        }

        /* È°∂ÈÉ®ÂØºËà™Ê†è */
        .social-profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }

        .social-profile-back {
            background: none;
            border: none;
            font-size: 24px;
            color: #333;
            cursor: pointer;
            padding: 5px;
        }

        .social-profile-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .social-profile-edit-btn {
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: #7b9faf; /* ÈªòËÆ§ÈõæÈúæËìùËÉåÊôØ */
        }

        /* Ê†πÊçÆ‰∏ªÈ¢òËÆæÁΩÆÁºñËæëÊåâÈíÆÈ¢úËâ≤ */
        [data-weibo-theme="white"] .social-profile-edit-btn {
            background: #7b9faf; /* ÈõæÈúæËìù */
        }

        [data-weibo-theme="white"] .social-profile-edit-btn:hover {
            background: #6a96ab;
            transform: translateY(-1px);
        }

        [data-weibo-theme="pink"] .social-profile-edit-btn {
            background: #d4a5a5; /* ÈõæÈúæÁ≤â */
        }

        [data-weibo-theme="pink"] .social-profile-edit-btn:hover {
            background: #c99494;
            transform: translateY(-1px);
        }

        [data-weibo-theme="dark"] .social-profile-edit-btn {
            background: #7b9faf; /* ÈõæÈúæËìù */
        }

        [data-weibo-theme="dark"] .social-profile-edit-btn:hover {
            background: #6a96ab;
            transform: translateY(-1px);
        }

        /* Áî®Êà∑‰ø°ÊÅØÂå∫Âüü */
        .social-profile-user-section {
            flex-shrink: 0;
            margin-bottom: -10px; /* ËÆ©Áî®Êà∑‰ø°ÊÅØÂå∫ÂüüÊõ¥Ë¥¥ËøëÊ†áÁ≠æÈ°µ */
        }

        .social-profile-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: cover;
            background-position: center;
            padding: 30px 20px 50px; /* ‰∏äËæπË∑ùÂ∞è‰∏Ä‰∫õÔºå‰∏ãËæπË∑ùÂ§ß‰∏Ä‰∫õÔºåËÆ©ÂÜÖÂÆπÂÅè‰∏ã */
            display: flex;
            align-items: flex-end; /* ËÆ©ÂÜÖÂÆπÈù†ËøëÂ∫ïÈÉ® */
            gap: 20px;
            min-height: 160px; /* ‰øùÊåÅÂéüÊù•ÁöÑÈ´òÂ∫¶ */
        }

        .social-profile-avatar {
            width: 90px; /* ÊÅ¢Â§çÂéüÊù•ÁöÑÂ§¥ÂÉèÂ§ßÂ∞è */
            height: 90px;
            border-radius: 50%;
            border: 4px solid rgba(255,255,255,0.8);
            object-fit: cover;
            flex-shrink: 0;
        }

        .social-profile-user-info {
            flex: 1;
            color: white;
        }

        .social-profile-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 5px;
            color: white;
        }

        .social-profile-signature {
            font-size: 14px;
            color: rgba(255,255,255,0.9);
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .social-profile-stats {
            display: flex;
            gap: 15px;
        }

        .social-profile-stat {
            font-size: 13px;
            color: rgba(255,255,255,0.9);
        }

        /* Ê†áÁ≠æÈ°µÊ†∑Âºè */
        .social-profile-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }

        .social-profile-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .social-profile-tab.active {
            color: #ff6b6b;
            border-bottom-color: #ff6b6b;
        }

        /* ÂÜÖÂÆπÂå∫Âüü */
        .social-profile-tab-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            background: white;
            min-height: 0; /* Á°Æ‰øùflexÂ≠êÂÖÉÁ¥†ÂèØ‰ª•Áº©Â∞è */
            -webkit-overflow-scrolling: touch; /* iOSÂπ≥ÊªëÊªöÂä® */
            height: 0; /* Âº∫Âà∂flexÂ≠êÂÖÉÁ¥†ËÆ°ÁÆóÈ´òÂ∫¶ */
        }

        .social-profile-posts-list {
            padding: 20px;
            min-height: 100%; /* Á°Æ‰øùÊúâË∂≥Â§üÈ´òÂ∫¶Ëß¶ÂèëÊªöÂä® */
        }

        .social-profile-post-item {
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .social-profile-post-content {
            font-size: 14px;
            color: #333;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .social-profile-post-time {
            font-size: 12px;
            color: #999;
        }


        .retry-btn {
          display: inline-flex;
          align-items: center;
          gap: 4px;
          background: #f0f0f0;
          color: rgb(74, 132, 193);
          border: none;
          border-radius: 16px;
          padding: 4px 12px;
          font-size: 14px;
          cursor: pointer;
          margin-left: 6px;
          transition: background 0.2s;
        }
        .retry-btn[disabled] {
          opacity: 0.5;
          cursor: not-allowed;
        }
        .retry-btn:hover:not([disabled]) {
          background: #e0eaff;
        }
        .retry-icon {
          width: 18px;
          height: 18px;
          display: inline-block;
          vertical-align: middle;
        }
        
        /* Ëá™ÂÆö‰πâÂõæÊ†áÂºπÁ™óÊ†∑Âºè */
        #custom-icon-modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.4); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
        }
        #custom-icon-modal.visible { 
            display: flex; 
        }
        #custom-icon-modal .modal-content { 
            width: 320px; 
            max-width: 90%; 
            background-color: white; 
            border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transform: scale(0.95);
            transition: transform 0.2s ease-in-out;
        }
        #custom-icon-modal.visible .modal-content { 
            transform: scale(1); 
        }

        /* ÈÄöËØùÂäüËÉΩÊ†∑Âºè */
        #call-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .call-window {
            background: linear-gradient(135deg, #f8e6e6 0%, #f0d0d0 50%, #e8c4c4 100%);
            width: 90%;
            max-width: 320px;
            border-radius: 20px;
            padding: 25px 15px;
            color: #333333;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 8px 32px rgba(167, 163, 163, 0.3);
            display: flex;
            flex-direction: column;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        #call-overlay.visible {
            display: flex;
            opacity: 1;
        }
        
        #call-overlay.visible .call-window {
            transform: scale(1);
        }
        
        .call-header {
            text-align: center;
            margin-bottom: 15px;
            margin-top: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .call-contact-name {
            font-size: 20px;
            font-weight: 600;
            color: #333333;
            margin: 10px 0 8px 0;
        }
        
        .call-contact-name::before {
            content: "‚ú® ";
        }
        
        .call-contact-name::after {
            content: " ‚ú®";
        }
        
        .call-avatar {
            width: 80px;
            height: 80px;
            border-radius: 40px;
            border: 3px solid rgba(255,255,255,0.8);
            object-fit: cover;
            display: block;
            animation: breathing 2s ease-in-out infinite;
        }
        
        @keyframes breathing {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(255,255,255,0.5);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(255,255,255,0.8);
            }
        }
        
        .call-timer {
            font-size: 14px;
            margin-bottom: 15px;
            color: #333333;
            text-align: center;
            background: rgba(255,255,255,0.6);
            padding: 6px 12px;
            border-radius: 20px;
            display: inline-block;
            width: fit-content;
            margin: auto;
        }
        
        .call-messages {
            width: calc(100% - 10px);
            height: 150px;
            overflow-y: auto;
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            padding: 8px 10px;
            margin-bottom: 10px;
            margin-left: 1px;
            margin-right: 40px;
            display: flex;
            flex-direction: column;
        }
        
        .call-message {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 14px;
            line-height: 1.4;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .call-message.user {
            background: rgba(245, 229, 229, 0.5);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            color: #222222;
            border: 1px solid rgba(255,255,255,0.6);
            align-self: flex-end;
            border-radius: 15px 5px 15px 15px;
        }
        
        .call-message.ai {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            color: #222222;
            border: 1px solid rgba(255,255,255,0.5);
            align-self: flex-start;
            border-radius: 5px 15px 15px 15px;
        }
        
        .call-message.description {
            background: transparent;
            color: #1c1a1a;
            font-style: italic;
            font-size: 13px;
            align-self: center;
            text-align: center;
            padding: 4px 8px;
            max-width: 90%;
        }
        
        .call-input-area {
            width: 100%;
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .call-input {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            background: rgba(255,255,255,0.6);
            color: #333333;
            font-size: 15px;
        }
        
        .call-input::placeholder {
            color: #888888;
        }
        
        .call-send-btn {
            background: rgba(255,255,255,0.6);
            border: none;
            color: #333333;
            padding: 10px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }
        
        .call-controls {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            justify-content: center;
        }
        
        .call-control-btn {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: transform 0.2s;
        }
        
        .call-control-btn:active {
            transform: scale(0.9);
        }
        
        .call-hangup-btn {
            background: #e8a8a8;
            color: white;
        }
        
        /* ÈÄöËØùÈÄâÊã©ÂºπÁ™ó */
        #call-type-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        #call-type-modal.visible {
            display: flex;
        }
        
        .call-type-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            width: 280px;
        }
        
        .call-type-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }
        
        .call-type-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .call-type-btn {
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .call-type-btn:active {
            transform: scale(0.95);
        }
        
        .call-voice-btn {
            background: rgba(255, 182, 193, 0.8);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            color: #ff1493;
            border: 1px solid rgba(255, 182, 193, 0.3);
            box-shadow: 0 4px 15px rgba(255, 182, 193, 0.4);
            transition: all 0.3s ease;
        }
        
        .call-voice-btn:hover {
            background: rgba(255, 182, 193, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 182, 193, 0.5);
        }
        
        .call-video-btn {
            background: rgba(173, 216, 230, 0.8);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            color: #4169e1;
            border: 1px solid rgba(173, 216, 230, 0.3);
            box-shadow: 0 4px 15px rgba(173, 216, 230, 0.4);
            transition: all 0.3s ease;
        }
        
        .call-video-btn:hover {
            background: rgba(173, 216, 230, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(173, 216, 230, 0.5);
        }
        
        .call-cancel-btn {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            color: #666;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .call-cancel-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        /* ÈÄöËØùÂä†ËΩΩÊåáÁ§∫Âô® */
        .call-typing-indicator {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            color: #222222;
            border: 1px solid rgba(255,255,255,0.5);
            align-self: flex-start;
            border-radius: 5px 15px 15px 15px;
            font-size: 14px;
            max-width: 80%;
        }

        .call-typing-dots {
            display: flex;
            gap: 4px;
            margin-left: 8px;
        }

        .call-typing-dot {
            width: 6px;
            height: 6px;
            background-color: #666;
            border-radius: 50%;
            animation: callTypingBounce 1.4s infinite ease-in-out;
        }

        .call-typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .call-typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .call-typing-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes callTypingBounce {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* ‰∏ªÈ¢òÈÄâÊã©Âô®Ê†∑Âºè */
        .theme-style-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .theme-style-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .theme-style-option:hover {
            transform: translateY(-5px);
        }

        .theme-style-option.active {
            position: relative;
        }

        .theme-style-option.active::after {
            content: "‚úì";
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .theme-preview {
            width: 100px;
            height: 160px;
            border-radius: 15px;
            border: 2px solid #ddd;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .theme-preview::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 30px;
            background-color: rgba(247, 247, 247, 0.8);
        }

        .theme-preview::after {
            content: "";
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background-color: #000;
            border-radius: 2px;
            opacity: 0.2;
        }

        .simple-theme {
            background-color: #f7f7f7;
        }

        .simple-theme::before {
            background-color: rgba(247, 247, 247, 0.8);
        }

        .cute-theme {
            background-color: #fff9fc;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M50 50 L80 80 L50 100 L20 80 Z' fill='%23ffccd5' fill-opacity='0.2'/%3E%3Cpath d='M0 0 L50 0 L50 50 L0 50 Z' fill='%23ffb6c1' fill-opacity='0.1'/%3E%3Cpath d='M50 0 L100 0 L100 50 L50 50 Z' fill='%23ffb6c1' fill-opacity='0.1'/%3E%3C/svg%3E");
        }

        .cute-theme::before {
            background-color: rgba(255, 230, 240, 0.85);
        }

        /* ÂèØÁà±È£éÊ†ºÁâπÊúâÂÖÉÁ¥† */
        body[data-theme="cute"] .form-button {
            border-radius: 30px;
            background-image: linear-gradient(to right, rgba(255, 182, 193, 0.8), rgba(255, 192, 203, 0.8));
            letter-spacing: 0.5px;
        }

        body[data-theme="cute"] .form-button:hover {
            background-image: linear-gradient(to right, rgba(255, 182, 193, 0.9), rgba(255, 192, 203, 0.9));
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 5px 15px rgba(255, 105, 180, 0.3);
        }

        body[data-theme="cute"] .header {
            border-bottom: 1px solid #ffccd5;
        }

        body[data-theme="cute"] .header-title {
            letter-spacing: 0.5px;
        }

        body[data-theme="cute"] #phone-frame {
            box-shadow: 0 20px 50px rgba(255, 105, 180, 0.25), inset 0 2px 4px rgba(0,0,0,0.1);
        }

        body[data-theme="cute"] #app-grid .app-icon .icon-bg {
            border-radius: 25px;
            box-shadow: 0 4px 8px rgba(255, 105, 180, 0.2);
        }

        body[data-theme="cute"] .app-icon .label {
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        
        /* ÂèØÁà±È£éÊ†ºÁöÑËæìÂÖ•Ê°ÜÊ†∑Âºè */
        body[data-theme="cute"] input, 
        body[data-theme="cute"] textarea, 
        body[data-theme="cute"] select {
            font-family: 'Quicksand', sans-serif;
            font-weight: 500;
        }
        
        /* ÂèØÁà±È£éÊ†ºÁöÑËÅäÂ§©ËæìÂÖ•Ê°Ü */
        body[data-theme="cute"] #chat-input {
            font-family: 'Quicksand', sans-serif;
            font-weight: 500;
            border-radius: 20px;
            border: 1px solid #ffccd5;
            background-color: rgba(255, 250, 250, 0.9);
        }
        
        /* ÂèØÁà±È£éÊ†ºÁöÑÂæÆÂçöÂç°Áâá */
        body[data-theme="cute"] .weibo-post {
            border-radius: 20px;
            border: 1.5px solid #ffccd5;
            box-shadow: 0 3px 10px rgba(255, 105, 180, 0.1);
        }

        /* ÂèØÁà±È£éÊ†ºÁöÑËÅäÂ§©ÂíåÂæÆÂçöÊ≠£ÊñáÊ†∑Âºè */
        body[data-theme="cute"] .message-bubble .content {
            font-family: 'Quicksand', sans-serif;
            font-weight: 500;
            letter-spacing: 0.3px;
            line-height: 1.6;
        }
        
        body[data-theme="cute"] .post-content {
            font-family: 'Quicksand', sans-serif;
            font-weight: 500;
            letter-spacing: 0.3px;
            line-height: 1.6;
        }
        
        /* ÂèØÁà±È£éÊ†ºÁöÑÊ†áÈ¢òÊ†∑Âºè */
        body[data-theme="cute"] .header-title {
            font-family: 'Varela Round', sans-serif;
            font-weight: 600;
        }
        
        /* ÂèØÁà±È£éÊ†ºÁöÑÊåâÈíÆÊñáÂ≠ó */
        body[data-theme="cute"] .form-button {
            font-family: 'Varela Round', sans-serif;
            font-weight: 600;
        }

        /* AIÊù•ÁîµÂºπÁ™ó */
        #incoming-call-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        #incoming-call-modal.visible {
            display: flex;
            opacity: 1;
        }
        
        .incoming-call-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 85%;
            max-width: 280px;
            border-radius: 20px;
            padding: 25px 20px;
            text-align: center;
            color: white;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            animation: callRing 2s infinite;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        #incoming-call-modal.visible .incoming-call-content {
            transform: scale(1);
        }
        
        @keyframes callRing {
            0%, 100% { box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
            50% { box-shadow: 0 12px 40px rgba(102, 126, 234, 0.4); }
        }
        
        .incoming-call-type {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 8px;
        }
        
        .incoming-call-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .incoming-call-avatar {
            width: 80px;
            height: 80px;
            border-radius: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            margin-bottom: 20px;
            object-fit: cover;
            animation: avatarPulse 2s infinite;
        }
        
        @keyframes avatarPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .incoming-call-controls {
            display: flex;
            gap: 40px;
            align-items: center;
            justify-content: center;
        }
        
        .incoming-call-btn {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: transform 0.2s;
        }
        
        .incoming-call-btn:active {
            transform: scale(0.9);
        }
        
        .call-answer-btn {
            background: #4cd964;
            color: white;
        }
        
        .call-decline-btn {
            background: #ff3b30;
            color: white;
        }

.weibo-nav {
    position: fixed;  /* Êîπ‰∏∫Áõ∏ÂØπÂÆö‰Ωç */
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0; 
    display: flex;
    padding: 12px 0;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    border-top: 1px solid #eee;
    z-index: 10;
}

/* Êõ¥Êñ∞ÂæÆÂçöÂÜÖÂÆπÂå∫ÂüüÁöÑÂÜÖËæπË∑ùÔºåÁ°Æ‰øùÂÜÖÂÆπ‰∏çË¢´ÂØºËà™Ê†èÈÅÆÊå° */
.weibo-container {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    padding-bottom: 80px; /* Â¢ûÂä†Â∫ïÈÉ®ÂÜÖËæπË∑ùÔºå‰∏∫ÂØºËà™Ê†èÁïôÂá∫Á©∫Èó¥ */
}

.weibo-nav .nav-item {
    flex: 1;
    text-align: center;
    font-size: 16px;
    color: #666;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    cursor: pointer;
    padding: 8px 4px;
    transition: all 0.2s;
}

/* ÁßªÈô§ÂéüÊù•ÁöÑÂõæÊ†áÊ†∑Âºè */

.weibo-nav .nav-item.active {
    color: #ff6b81;
}

.weibo-container {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    padding-bottom: 70px;
}

.weibo-post {
    background: var(--weibo-card-bg);
    border-radius: 16px;
    border: 1.5px solid var(--weibo-card-border);
    color: var(--weibo-content-color);
    margin-bottom: 18px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    padding: 18px 40px 12px 18px;
    font-size: 16px;
    position: relative;
    opacity: var(--weibo-card-opacity);
    transition: opacity 0.3s ease;
}

.post-header {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.post-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 10px;
}

.post-info {
    flex: 1;
}

.post-name {
    font-weight: 500;
    font-size: 15px;
}

.post-time {
    font-size: 12px;
    color: #999;
}

.post-visibility {
    font-size: 12px;
    color: #666;
    margin-left: 5px;
}

        .post-content {
            margin: 10px 0;
            font-size: 14px;
            line-height: 1.5;
        }

.post-actions {
    display: flex;
    justify-content: space-around;
    color: #666;
    font-size: 14px;
    border-top: 1px solid #eee;
    padding-top: 10px;
    margin-top: 10px;
}

.action-btn {
    display: flex;
    align-items: center;
    gap: 4px;
}
.posting-times {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

.time-input-group {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    gap: 8px;
}

.posting-time-input {
    width: 120px;
    padding: 6px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.add-time-btn {
    color: rgb(74, 132, 193);
    background: none;
    border: none;
    padding: 4px 0;
    cursor: pointer;
    font-size: 14px;
}

.remove-time-btn {
    background: #ff3b30;
    color: white;
    border: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
}

        /* ÂæÆÂçö‰∏ªÈ¢òÈÄâÊã©Âô®Ê†∑Âºè */
        #weibo-theme-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px 0;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
        }

        .theme-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            display: inline-block;
        }

        .theme-dot:hover {
            transform: scale(1.1);
            border-color: var(--accent-color);
        }

        .theme-dot.active {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.3);
        }

        /* ÂæÆÂçöÂ§öÈÄâÂà†Èô§Ê†∑Âºè */
        .weibo-selection-mode .weibo-post {
            position: relative;
        }
        
        .weibo-selection-mode .weibo-post.selected {
            background-color: rgba(0, 123, 255, 0.1);
            border-color: var(--accent-color);
        }
        
        .weibo-selection-mode .weibo-post.selected::before {
            content: '‚úì';
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--accent-color);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
        }
        
        .weibo-selection-toolbar {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 10px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 100;
        }
        
        .weibo-selection-toolbar.visible {
            display: flex;
        }
        
        .weibo-selection-toolbar .selection-count {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .weibo-selection-toolbar .selection-btn {
            background: none;
            border: none;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .weibo-selection-toolbar .selection-cancel-btn {
            color: var(--text-secondary);
            background: rgba(0,0,0,0.05);
        }
        
        .weibo-selection-toolbar .selection-delete-btn {
            color: #ff3b30;
            background: rgba(255,59,48,0.1);
        }
        
        .weibo-selection-toolbar .selection-btn:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div id="phone-frame">
        <!-- <div class="notch"></div> -->
        <div id="phone-screen">
            <div id="status-bar">
                <span id="status-bar-time">21:11</span>
                <div id="ai-heartrate-display">‚ô•Ô∏è 72 bpm</div>
                <div id="status-bar-battery" class="battery-container">
                    <span class="battery-text">·∞î·©ö</span>
                    <div class="battery-icon">
                        <div class="battery-level"></div>
                    </div>
                </div>
            </div>
            <div id="notification-bar"><img id="notification-avatar" src=""><div id="notification-content"><div class="name"></div><div class="message"></div></div></div>
            
            <div id="home-screen" class="screen active" style="background-image: linear-gradient(135deg, rgb(137, 247, 254), rgb(102, 166, 255));">
                <div id="clock-container"><div id="main-time">21:11</div><div id="main-date">6Êúà14Êó• ÊòüÊúüÂÖ≠</div></div>
                                <div id="app-grid">
                    <div class="app-row">
                        <div class="app-icon" onclick="showScreen('world-book-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/Xqz3zPz7/IMG-3080.jpg" alt="‰∏ñÁïå‰π¶"></div><span class="label">‰∏ñÁïå‰π¶</span></div>
                         <div class="app-icon" onclick="showScreen('weibo-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/8cHffTcX/IMG-3064.jpg" alt="ÂæÆÂçö"></div><span class="label">ÂæÆÂçö</span></div>
                    </div>
                    <div class="app-row">
                        <div class="app-icon" onclick="showScreen('chat-list-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/dVSd9QBz/IMG-3063.jpg" alt="QQ"></div><span class="label">QQ</span></div>
                        <div class="app-icon" onclick="showScreen('api-settings-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/764L3jpF/IMG-3079.jpg" alt="APIËÆæÁΩÆ"></div><span class="label">APIËÆæÁΩÆ</span></div>
                        <div class="app-icon" onclick="showScreen('wallpaper-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/DyS7X2SW/IMG-3081.jpg" alt="Â£ÅÁ∫∏"></div><span class="label">Â£ÅÁ∫∏</span></div>
                    </div>
                </div>
            </div>

            <div id="world-book-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span><span class="header-title">‰∏ñÁïå‰π¶</span><div class="header-actions"><span class="action-btn" id="add-world-book-btn">+</span></div></div><div id="world-book-list"></div></div>
            <div id="world-book-editor-screen" class="screen">
                <div class="header">
                    <span class="back-btn" onclick="showScreen('world-book-screen')">‚Äπ</span>
                    <span id="world-book-editor-title" class="header-title">ÁºñËæë‰∏ñÁïå‰π¶</span>
                    <span class="save-btn" id="save-world-book-btn">‰øùÂ≠ò</span>
                </div>
                <div class="form-container">
                    <div class="form-group">
                        <label for="world-book-name-input">‰π¶Âêç</label>
                        <input type="text" id="world-book-name-input" placeholder="ËØ∑ËæìÂÖ•‰∏ñÁïå‰π¶ÁöÑÂêçÁß∞...">
                    </div>
                    <div class="form-group" style="height: 100%;">
                        <label for="world-book-content-input">ÂÜÖÂÆπ</label>
                        <textarea id="world-book-content-input" placeholder="Âú®Ê≠§Â§ÑËæìÂÖ•ËØ¶ÁªÜÁöÑ‰∏ñÁïåËßÇËÆæÂÆö..."></textarea>
                    </div>
                </div>
            </div>

            <div id="weibo-screen" class="screen" style="background-color: var(--weibo-bg);">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span>
        <span class="header-title">ÂæÆÂçö</span>
        <div class="header-actions">
            <span class="action-btn" id="weibo-theme-btn" title="‰∏ªÈ¢òËÆæÁΩÆ">‚öôÔ∏è</span>
            <span class="action-btn" id="post-weibo-btn">+</span>
        </div>
    </div>
    
    <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
    <div class="weibo-nav">
        <div class="nav-item active">‚âΩ^ ‚¶Å ‚©ä ‚¶Å ^‚âº</div>
        <div class="nav-item">‚Çç^À∂ ‚ï∏ñ•¶  ‚ï∏Àµ^‚Çé‚üÜ</div>
    </div>
    
    <!-- ÂæÆÂçöÂä®ÊÄÅÂàóË°®ÂÆπÂô® -->
    <div id="weibo-timeline" class="weibo-container"></div>
    
    <!-- ÂæÆÂçöÂ§öÈÄâÂà†Èô§Â∑•ÂÖ∑Ê†è -->
    <div id="weibo-selection-toolbar" class="weibo-selection-toolbar">
        <span class="selection-count">Â∑≤ÈÄâÊã© 0 Êù°Âä®ÊÄÅ</span>
        <button class="selection-btn selection-cancel-btn" id="weibo-selection-cancel">ÂèñÊ∂à</button>
        <button class="selection-btn selection-delete-btn" id="weibo-selection-delete">Âà†Èô§</button>
    </div>
</div>
<!-- ÂèëÂ∏ÉÂæÆÂçöÁöÑÂºπÁ™ó -->
<div id="post-weibo-modal" class="modal">
    <div class="modal-content" style="border-radius: 20px; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2);">
        <div class="modal-header" style="padding: 20px 20px 0; border-bottom: none;">
            <span style="font-size: 18px; font-weight: 600;">ÂèëÂ∏ÉÂä®ÊÄÅ</span>
            <select id="post-visibility" style="background: rgba(255,255,255,0.8); border: 1px solid rgba(0,0,0,0.1); border-radius: 15px; padding: 5px 10px; font-size: 12px;">
                <option value="public">ÂÖ¨ÂºÄ</option>
                <option value="friends">‰ªÖÂ•ΩÂèã</option>
                <option value="private">ÁßÅÂØÜ</option>
            </select>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <textarea id="weibo-content" placeholder="ÂàÜ‰∫´Êñ∞È≤ú‰∫ã..." style="width: 100%; min-height: 120px; border: none; background: rgba(255,255,255,0.6); border-radius: 15px; padding: 15px; font-size: 16px; resize: none; box-sizing: border-box; outline: none; transition: all 0.3s ease;" onfocus="this.style.background='rgba(255,255,255,0.8)'; this.style.boxShadow='0 0 15px rgba(102,126,234,0.3)'" onblur="this.style.background='rgba(255,255,255,0.6)'; this.style.boxShadow='none'"></textarea>
            <div class="post-media-btns" style="margin-top: 15px; display: flex; gap: 10px;">
                <button id="add-weibo-photo" style="background: rgba(100,200,255,0.2); backdrop-filter: blur(10px); border: none; color: rgb(74, 132, 193); padding: 8px 16px; border-radius: 20px; font-size: 14px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 5px;" onmouseover="this.style.background='rgba(100,200,255,0.3)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='rgba(100,200,255,0.2)'; this.style.transform='scale(1)'">üì∑ Ê∑ªÂä†ÂõæÁâá</button>
            </div>
            <input type="file" id="weibo-image-input" accept="image/*" style="display: none;">
            <div id="weibo-image-preview" style="margin-top: 10px; display: none;">
                <img id="weibo-preview-img" style="max-width: 100%; max-height: 200px; border-radius: 10px; object-fit: cover;">
                <button id="remove-weibo-image" style="margin-top: 5px; background: rgba(255,0,0,0.1); color: #ff4757; border: none; padding: 5px 10px; border-radius: 10px; font-size: 12px; cursor: pointer;">ÁßªÈô§ÂõæÁâá</button>
            </div>
        </div>
        <div class="modal-footer" style="padding: 0 20px 20px; border-top: none; display: flex; gap: 10px;">
            <button class="cancel" style="flex: 1; background: rgba(0,0,0,0.05); backdrop-filter: blur(10px); border: none; color: #666; padding: 12px; border-radius: 20px; font-size: 16px; cursor: pointer; transition: all 0.2s;">ÂèñÊ∂à</button>
            <button class="save weibo-publish-btn" style="flex: 1; background: rgba(74, 132, 193, 0.9); border: none; color: white; padding: 12px; border-radius: 20px; font-size: 16px; cursor: pointer; transition: all 0.2s; font-weight: 600;">ÂèëÂ∏É</button>
        </div>
    </div>
</div>

<!-- ÂæÆÂçö‰∏ªÈ¢òËÆæÁΩÆÂºπÁ™ó -->
<div id="weibo-theme-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>ÂæÆÂçö‰∏ªÈ¢òËÆæÁΩÆ</span>
            <span class="action-btn" onclick="document.getElementById('weibo-theme-modal').classList.remove('visible')">√ó</span>
        </div>
        <div class="modal-body">
            <div id="weibo-theme-selector" style="display: flex; justify-content: center; gap: 15px; margin: 15px 0;">
                <div class="theme-dot" data-theme="white" style="width: 30px; height: 30px; border-radius: 50%; background: #fff; border: 2px solid #ddd; cursor: pointer;"></div>
                <div class="theme-dot" data-theme="pink" style="width: 30px; height: 30px; border-radius: 50%; background: #ffe4ec; border: 2px solid #f8bbd0; cursor: pointer;"></div>
                <div class="theme-dot" data-theme="blue" style="width: 30px; height: 30px; border-radius: 50%; background: #e3f0ff; border: 2px solid #b3e5fc; cursor: pointer;"></div>
                <div class="theme-dot" data-theme="purple" style="width: 30px; height: 30px; border-radius: 50%; background: #f3e8ff; border: 2px solid #e1bee7; cursor: pointer;"></div>
                <div class="theme-dot" data-theme="green" style="width: 30px; height: 30px; border-radius: 50%; background: #eaffea; border: 2px solid #b2dfdb; cursor: pointer;"></div>
                <div class="theme-dot" data-theme="yellow" style="width: 30px; height: 30px; border-radius: 50%; background: #fffbe4; border: 2px solid #fff9c4; cursor: pointer;"></div>
            </div>
            <div id="weibo-bg-preview" style="width: 100%; height: 120px; border: 2px dashed #ccc; border-radius: 8px; margin: 10px 0; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; color: #999;">ÁÇπÂáª‰∏ãÊñπ‰∏ä‰º†ËÉåÊôØÂõæÁâá</div>
            <button class="form-button form-button-secondary" onclick="document.getElementById('weibo-bg-upload-input').click();">‰∏ä‰º†ËÉåÊôØÂõæÁâá</button>
            <input type="file" id="weibo-bg-upload-input" accept="image/*" style="display: none;">
            <button class="form-button form-button-secondary" id="remove-weibo-bg-btn" style="display: none;">ÁßªÈô§ËÉåÊôØ</button>
            
            <div style="margin-top: 20px;">
                <label for="card-opacity-slider" style="display: block; margin-bottom: 10px; font-weight: 500;">Âä®ÊÄÅÂç°ÁâáÈÄèÊòéÂ∫¶: <span id="card-opacity-value">1.0</span></label>
                <input type="range" id="card-opacity-slider" min="0.1" max="1.0" step="0.05" value="1.0" style="width: 100%;">
                <p style="font-size: 12px; color: #777; margin-top: 5px;">
                    ÈÄèÊòéÂ∫¶Ë∂ä‰ΩéÔºåÂä®ÊÄÅÂç°ÁâáË∂äÈÄèÊòéÔºõÈÄèÊòéÂ∫¶Ë∂äÈ´òÔºåÂä®ÊÄÅÂç°ÁâáË∂ä‰∏çÈÄèÊòé„ÄÇ
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel">ÂèñÊ∂à</button>
            <button class="save">‰øùÂ≠ò</button>
        </div>
    </div>
</div>

<!-- Áî®Êà∑ËµÑÊñôÂç°ÂºπÁ™ó -->
<div id="weibo-profile-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>ÁºñËæë‰∏™‰∫∫ËµÑÊñô</span>
            <span class="action-btn" onclick="document.getElementById('weibo-profile-modal').classList.remove('visible')">√ó</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Â§¥ÂÉè</label>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <img id="profile-avatar-preview" src="https://i.postimg.cc/PxZrFFFL/o-o-1.jpg" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--weibo-accent);">
                    <button class="form-button form-button-secondary" onclick="document.getElementById('profile-avatar-input').click();">Êõ¥Êç¢Â§¥ÂÉè</button>
                    <input type="file" id="profile-avatar-input" accept="image/*" style="display: none;">
                </div>
            </div>
            <div class="form-group">
                <label for="profile-name-input">ÊòµÁß∞</label>
                <input type="text" id="profile-name-input" placeholder="ËØ∑ËæìÂÖ•ÊòµÁß∞" value="ÊàëÁöÑÂæÆÂçö">
            </div>
            <div class="form-group">
                <label for="profile-signature-input">‰∏™ÊÄßÁ≠æÂêç</label>
                <textarea id="profile-signature-input" placeholder="ËØ∑ËæìÂÖ•‰∏™ÊÄßÁ≠æÂêç" rows="3">ÂàÜ‰∫´ÁîüÊ¥ª‰∏≠ÁöÑÁæéÂ•ΩÁû¨Èó¥</textarea>
            </div>
            <div class="form-group">
                <label for="profile-email-input">ÈÇÆÁÆ±</label>
                <input type="email" id="profile-email-input" placeholder="ËØ∑ËæìÂÖ•ÈÇÆÁÆ±Âú∞ÂùÄ">
            </div>
            <div class="form-group">
                <label>Á§æ‰∫§‰∏ªÈ°µËÉåÊôØ</label>
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <div id="user-profile-bg-preview" style="width: 120px; height: 80px; border: 2px dashed #ccc; border-radius: 8px; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ÈªòËÆ§Ê∏êÂèòËÉåÊôØ</div>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button type="button" class="form-button form-button-secondary" onclick="document.getElementById('user-profile-bg-input').click();" style="width: auto; padding: 8px 12px; margin: 0; font-size: 14px;">‰∏ä‰º†ËÉåÊôØ</button>
                        <button type="button" id="remove-user-profile-bg-btn" style="width: auto; padding: 8px 12px; background: rgba(255,0,0,0.1); color: #ff4757; border: none; border-radius: 5px; font-size: 14px; cursor: pointer; display: none;">ÁßªÈô§ËÉåÊôØ</button>
                    </div>
                    <input type="file" id="user-profile-bg-input" accept="image/*" style="display: none;">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel">ÂèñÊ∂à</button>
            <button class="save">‰øùÂ≠ò</button>
        </div>
    </div>
</div>

<!-- AIËµÑÊñôÂç°ÂºπÁ™ó -->
<div id="ai-profile-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span id="ai-profile-title">AIËµÑÊñôÂç°</span>
            <span class="action-btn" onclick="document.getElementById('ai-profile-modal').classList.remove('visible')">√ó</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Â§¥ÂÉè</label>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <img id="ai-profile-avatar-preview" src="https://i.postimg.cc/PxZrFFFL/o-o-1.jpg" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--weibo-accent);">
                    <button class="form-button form-button-secondary" onclick="document.getElementById('ai-profile-avatar-input').click();">Êõ¥Êç¢Â§¥ÂÉè</button>
                    <input type="file" id="ai-profile-avatar-input" accept="image/*" style="display: none;">
                </div>
            </div>
            <div class="form-group">
                <label for="ai-profile-name-input">ÊòµÁß∞</label>
                <input type="text" id="ai-profile-name-input" placeholder="ËØ∑ËæìÂÖ•ÊòµÁß∞">
            </div>
            <div class="form-group">
                <label for="ai-profile-signature-input">‰∏™ÊÄßÁ≠æÂêç</label>
                <textarea id="ai-profile-signature-input" placeholder="ËØ∑ËæìÂÖ•‰∏™ÊÄßÁ≠æÂêç" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="ai-profile-persona-input">ËßíËâ≤ËÆæÂÆö</label>
                <textarea id="ai-profile-persona-input" placeholder="ËØ∑ËæìÂÖ•ËßíËâ≤ËÆæÂÆö" rows="5"></textarea>
            </div>
            <div class="form-group">
                <label>Á§æ‰∫§‰∏ªÈ°µËÉåÊôØ</label>
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <div id="ai-profile-bg-preview" style="width: 120px; height: 80px; border: 2px dashed #ccc; border-radius: 8px; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ÈªòËÆ§Ê∏êÂèòËÉåÊôØ</div>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button type="button" class="form-button form-button-secondary" onclick="document.getElementById('ai-profile-bg-input').click();" style="width: auto; padding: 8px 12px; margin: 0; font-size: 14px;">‰∏ä‰º†ËÉåÊôØ</button>
                        <button type="button" id="remove-ai-profile-bg-btn" style="width: auto; padding: 8px 12px; background: rgba(255,0,0,0.1); color: #ff4757; border: none; border-radius: 5px; font-size: 14px; cursor: pointer; display: none;">ÁßªÈô§ËÉåÊôØ</button>
                    </div>
                    <input type="file" id="ai-profile-bg-input" accept="image/*" style="display: none;">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel">ÂèñÊ∂à</button>
            <button class="save">‰øùÂ≠ò</button>
        </div>
    </div>
</div>

            <div id="api-settings-screen" class="screen" style="background-color: #ffffff;"><div class="header" style="background-color: rgba(255, 255, 255, 0.9); border-bottom: 1px solid #eaeaea;"><span class="back-btn" onclick="showScreen('home-screen')" style="color: #000000;">‚Äπ</span><span class="header-title" style="color: #000000;">API ËÆæÁΩÆ</span><span style="width: 30px;"></span></div><div class="form-container" style="color: #000000;"><p style="font-size: 14px; color: #555; background-color: #f9f9f9; padding: 15px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">ÊèêÁ§∫: Ëã•Ë¶Å‰ΩøÁî®"ÂèëÈÄÅÂõæÁâá"ÂäüËÉΩ, ËØ∑Âä°ÂøÖÈÄâÊã©ÊîØÊåÅVision(ËßÜËßâ)ÁöÑÊ®°Âûã, Â¶Ç<code style="background-color: #f0f0f0; padding: 2px 4px; border-radius: 4px; color: #333;">gpt-4o</code>Êàñ<code style="background-color: #f0f0f0; padding: 2px 4px; border-radius: 4px; color: #333;">gpt-4-vision-preview</code>„ÄÇ</p><div class="form-group"><label for="proxy-url" style="color: #333;">Âèç‰ª£Âú∞ÂùÄ (‰∏çÈúÄË¶ÅÊ∑ªÂä†/v1Âô¢~)</label><input type="text" id="proxy-url" placeholder="‰æãÂ¶Ç: https://api.openai.com" style="border: 1px solid #e0e0e0; background-color: #ffffff; color: #333;">
<div style="margin-top: 10px; padding: 12px; background-color: #f0f8ff; border-radius: 8px; border: 1px solid #e1f0ff;">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
        <span style="font-size: 14px; font-weight: 500; color: #333;">Âø´ÈÄüËÆæÁΩÆ Gemini Áõ¥Ëøû</span>
        <button type="button" id="set-gemini-direct-btn" style="padding: 6px 12px; background-color: #4285f4; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; transition: background-color 0.2s;">
            ‰ΩøÁî® Gemini
        </button>
    </div>
    <div style="font-size: 12px; color: #666; line-height: 1.4;">
        ÁÇπÂáª"‰ΩøÁî® Gemini"Â∞ÜËá™Âä®Â°´ÂÜôÔºöhttps://generativelanguage.googleapis.com/v1beta<br>
        <strong>Ê≥®ÊÑèÔºö</strong>‰ΩøÁî®GeminiÊó∂ÔºåÂØÜÈí•Â∫îÂ°´ÂÜôGoogle AI StudioÁöÑAPI Key<br>
        <span style="color: #ff6b6b;">‚ö†Ô∏è CORSÈóÆÈ¢òËß£ÂÜ≥ÔºöÂ¶ÇÊûú‰ΩøÁî®GeminiÂÆòÊñπAPIÈÅáÂà∞Ë∑®ÂüüÈîôËØØÔºåËØ∑ÈÄöËøáÊú¨Âú∞HTTPÊúçÂä°Âô®ËøêË°åÊ≠§HTMLÊñá‰ª∂ÔºåÊàñ‰ΩøÁî®‰ª£ÁêÜAPIÊúçÂä°„ÄÇ</span>
    </div>
</div>
</div><div class="form-group"><label for="api-key" style="color: #333;">ÂØÜÈí• (API Key)</label><input type="password" id="api-key" placeholder="sk-... Êàñ Google AI Studio API Key" style="border: 1px solid #e0e0e0; background-color: #ffffff; color: #333;"></div><div class="form-group"><label for="model-select" style="color: #333;">Ê®°Âûã</label><select id="model-select" style="border: 1px solid #e0e0e0; background-color: #ffffff; color: #333;"></select></div>
<div class="form-group">
    <label for="temperature-slider" style="color: #333;">Ê∏©Â∫¶ (<span id="temperature-value">0.75</span>)</label>
    <input type="range" id="temperature-slider" min="0" max="2" step="0.05" value="0.75" style="width: 100%;">
    <p style="font-size: 12px; color: #777; margin-top: 5px;">
        Ê∏©Â∫¶Ë∂ä‰ΩéÔºåÂõûÁ≠îË∂ä‰øùÂÆàÁ®≥ÂÆöÔºõÊ∏©Â∫¶Ë∂äÈ´òÔºåÂõûÁ≠îË∂äÊúâÂàõÊÑèÂ§öÊ†∑„ÄÇ
    </p>
</div>
<button class="form-button" id="fetch-models-btn" style="background-color: rgba(245, 245, 247, 0.8); color: #333; border: 1px solid rgba(0,0,0,0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0,0,0,0.05);">ÊãâÂèñÊ®°Âûã</button>
<button class="form-button form-button-secondary" id="test-api-connection-btn" style="background-color: rgba(245, 245, 247, 0.8); color: #333; border: 1px solid rgba(0,0,0,0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0,0,0,0.05);">ÊµãËØïËøûÊé•</button>
<button class="form-button" id="save-api-settings-btn" style="background-color: rgba(245, 245, 247, 0.8); color: #333; border: 1px solid rgba(0,0,0,0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0,0,0,0.05);">‰øùÂ≠òËÆæÁΩÆ</button>

<!-- APIÈÖçÁΩÆ‰øùÂ≠òÂç°ÁâáÂäüËÉΩ -->
<hr style="margin: 20px 0; border: none; border-top: 1px solid #eaeaea;">
<div class="api-config-manager" style="background: rgba(248, 249, 250, 0.8); border-radius: 16px; padding: 20px; margin: 15px 0; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(0,0,0,0.05);">
    <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
        <span>üíæ</span> APIÈÖçÁΩÆÁÆ°ÁêÜ
    </h4>
    <p style="font-size: 13px; color: #666; margin: 0 0 15px 0; line-height: 1.5;">‰øùÂ≠òÂΩìÂâçÈÖçÁΩÆ‰∏∫È¢ÑËÆæÔºåÊñπ‰æøÂø´ÈÄüÂàáÊç¢‰∏çÂêåÁöÑAPIÊúçÂä°</p>
    
    <div class="save-config-section" style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.6); border-radius: 12px; border: 1px solid rgba(0,0,0,0.05);">
        <div style="display: flex; gap: 10px; margin-bottom: 12px;">
            <input type="text" id="config-name-input" placeholder="ËæìÂÖ•ÈÖçÁΩÆÂêçÁß∞ (Â¶Ç: OpenAI„ÄÅGemini„ÄÅClaudeÁ≠â)" style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.9);">
            <button id="save-current-config-btn" class="config-action-btn" style="padding: 10px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                üíæ ‰øùÂ≠òÈÖçÁΩÆ
            </button>
        </div>
        <div style="font-size: 12px; color: #888;">ÂΩìÂâçÈÖçÁΩÆÂ∞Ü‰øùÂ≠ò‰∏∫: <span style="color: #333; font-weight: 500;">URL + Ê®°Âûã + Ê∏©Â∫¶ËÆæÁΩÆ</span></div>
    </div>
    
    <div class="saved-configs-section">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <label style="font-size: 14px; font-weight: 500; color: #333;">Â∑≤‰øùÂ≠òÁöÑÈÖçÁΩÆ</label>
            <button id="clear-all-configs-btn" class="config-action-btn" style="padding: 6px 12px; background: rgba(255, 107, 107, 0.1); color: #ff6b6b; border: 1px solid rgba(255, 107, 107, 0.3); border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.2s ease;">
                üóëÔ∏è Ê∏ÖÁ©∫ÂÖ®ÈÉ®
            </button>
        </div>
        <div id="saved-configs-container" style="display: grid; gap: 10px; max-height: 300px; overflow-y: auto;">
            <!-- ‰øùÂ≠òÁöÑÈÖçÁΩÆÂç°ÁâáÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
        </div>
        <div id="no-configs-message" style="text-align: center; color: #999; padding: 30px 20px; font-size: 14px; display: none;">
            <div style="font-size: 24px; margin-bottom: 8px;">üìù</div>
            <div>ËøòÊ≤°Êúâ‰øùÂ≠ò‰ªª‰ΩïÈÖçÁΩÆ</div>
            <div style="font-size: 12px; margin-top: 4px;">Âú®‰∏äÊñπËæìÂÖ•ÈÖçÁΩÆÂêçÁß∞Âπ∂ÁÇπÂáª"‰øùÂ≠òÈÖçÁΩÆ"</div>
        </div>
    </div>
</div>

<!-- ‚úÖ Êñ∞Â¢ûÁöÑÂÆåÊï¥Â§á‰ªΩÂäüËÉΩÂºÄÂßã -->
<hr style="margin: 20px 0; border: none; border-top: 1px solid #eaeaea;">
                <h4 style="margin-bottom: 10px; color: #333;">Êï∞ÊçÆÂ§á‰ªΩ</h4>
                <p style="font-size: 12px; color: #666; margin-bottom: 15px; line-height: 1.4;">Â§á‰ªΩÂåÖÂê´ÔºöËÅäÂ§©ËÆ∞ÂΩï„ÄÅAI‰∫∫ËÆæ„ÄÅ‰∏ñÁïå‰π¶„ÄÅËÅäÂ§©Â£ÅÁ∫∏„ÄÅÊâãÊú∫Â£ÅÁ∫∏„ÄÅÂæÆÂçöÂä®ÊÄÅÂèäËØÑËÆ∫„ÄÅÁî®Êà∑Ë°®ÊÉÖÂåÖ„ÄÅÈü≥‰πêÂ∫ì‰ª•ÂèäAPIËÆæÁΩÆÁ≠âÊâÄÊúâÊï∞ÊçÆ</p>
                <button class="form-button form-button-secondary" id="export-full-backup-btn" style="background-color: rgba(245, 245, 247, 0.8); color: #333; border: 1px solid rgba(0,0,0,0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0,0,0,0.05);">ÂØºÂá∫ÊâÄÊúâÊï∞ÊçÆ</button>
<button class="form-button form-button-secondary" id="import-full-backup-btn" style="background-color: rgba(245, 245, 247, 0.8); color: #333; border: 1px solid rgba(0,0,0,0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0,0,0,0.05);">ÂØºÂÖ•ÊâÄÊúâÊï∞ÊçÆ</button>
<input type="file" id="import-full-backup-input" accept=".json" style="display: none;">

<div id="import-confirm-modal" class="modal">
  <div class="modal-content" style="background-color: #ffffff; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
    <div class="modal-header" style="border-bottom: 1px solid #eaeaea;"><span style="color: #333;">Á°ÆËÆ§ÂØºÂÖ•</span></div>
    <div class="modal-body">
                      <p style="font-size: 14px; color: #333;">ÂØºÂÖ•Â§á‰ªΩÂ∞ÜË¶ÜÁõñÂΩìÂâçÊâÄÊúâÊï∞ÊçÆÔºåÂåÖÊã¨ËÅäÂ§©ËÆ∞ÂΩï„ÄÅAI‰∫∫ËÆæ„ÄÅ‰∏ñÁïå‰π¶„ÄÅËÅäÂ§©Â£ÅÁ∫∏„ÄÅÊâãÊú∫Â£ÅÁ∫∏„ÄÅÂæÆÂçöÂä®ÊÄÅ„ÄÅÁî®Êà∑Ë°®ÊÉÖÂåÖ‰ª•ÂèäAPIËÆæÁΩÆÔºåÁ°ÆÂÆöÁªßÁª≠ÂêóÔºü</p>
    </div>
    <div class="modal-footer" style="border-top: 1px solid #eaeaea;">
      <button class="cancel" id="cancel-import-btn" style="background-color: rgba(245, 245, 247, 0.8); color: #333; border: 1px solid rgba(0,0,0,0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);">ÂèñÊ∂à</button>
      <button class="save" id="confirm-import-btn" style="background-color: rgba(245, 245, 247, 0.8); color: #333; border: 1px solid rgba(0,0,0,0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);">Á°ÆËÆ§ÂØºÂÖ•</button>
    </div>
  </div>
</div>
<!-- ‚úÖ Êñ∞Â¢ûÂ§á‰ªΩÂäüËÉΩÁªìÊùü -->

</div>
</div>
            <div id="chat-list-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span><span class="header-title">Ê∂àÊÅØ</span><div class="header-actions"><span class="action-btn" id="add-group-chat-btn" title="ÂàõÂª∫Áæ§ËÅä"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M21 21L19 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></span><span class="action-btn" id="add-chat-btn">+</span></div></div><div id="chat-list"></div></div>
            
            <div id="chat-interface-screen" class="screen">
                <div class="header">
                    <div class="default-controls">
                        <span class="back-btn" id="back-to-list-btn">‚Äπ</span>
                        <span id="chat-header-title" class="header-title">ËÅäÂ§©ÂØπË±°</span>
                        <div class="header-actions">
                            <span class="action-btn" id="listen-together-btn" title="‰∏ÄËµ∑Âê¨"><img src="https://i.postimg.cc/8kYShvrJ/90-UI-2.png" alt="‰∏ÄËµ∑Âê¨"></span>
                            <span class="action-btn" id="chat-settings-btn" title="ËÅäÂ§©ËÆæÁΩÆ"><img src="https://i.postimg.cc/wRDhh491/image.png" alt="ËÆæÁΩÆ"></span>
                        </div>
                    </div>
                    <div class="selection-controls">
                        <span id="selection-cancel-btn">ÂèñÊ∂à</span>
                        <span id="selection-count"></span>
                        <span id="selection-delete-btn">Âà†Èô§</span>
                    </div>
                </div>
                <div id="chat-messages"><div id="typing-indicator">ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...</div></div>
            
                <div id="chat-input-area">
                    <div id="chat-input-actions-top">
                        <button id="open-sticker-panel-btn" class="chat-action-icon-btn action-button" title="Ë°®ÊÉÖÈù¢Êùø">+</button>
                        <button id="send-photo-btn" class="chat-action-icon-btn action-button" title="ÂèëÈÄÅÁÖßÁâá"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg></button>
                        <button id="upload-image-btn" class="chat-action-icon-btn action-button" title="‰∏ä‰º†ÂõæÁâá"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--text-primary);"><path d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><path d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></button>
                        <button id="transfer-btn" class="chat-action-icon-btn action-button" title="ËΩ¨Ë¥¶">Ôø•</button>
                        <button id="voice-message-btn" class="chat-action-icon-btn action-button" title="ÂèëÈÄÅËØ≠Èü≥"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><path d="M12 19v4"></path><path d="M8 23h8"></path></svg></button>
                        <button id="regenerate-btn" class="chat-action-icon-btn action-button" title="ÈáçÊñ∞ÁîüÊàê">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M21 2v6h-6" />
    <path d="M3 12a9 9 0 0 1 15-7.7L21 8" />
  </svg>
</button>
                        <button id="call-btn" class="chat-action-icon-btn action-button" title="ÈÄöËØù">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
  </svg>
</button>
                    </div>
                                    <div id="chat-input-main-row">
                    <div id="chat-input-container">
                        <textarea id="chat-input" rows="1" placeholder="ËæìÂÖ•Ê∂àÊÅØ..."></textarea>
                        <div id="mention-dropdown" class="mention-dropdown"></div>
                    </div>
                        <div id="input-actions-wrapper">
                            <button id="wait-reply-btn" title="Á≠âÂæÖÂõûÂ§ç"><img src="https://i.postimg.cc/qzdckrGy/image.png" alt="Á≠âÂæÖÂõûÂ§ç"></button>
                            <button id="retry-btn" class="retry-btn" style="display:none;" title="ÈáçËØïÊú¨ËΩÆAIÂõûÂ§ç">
                              <span class="retry-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                  <path d="M21 2v6h-6" />
                                  <path d="M3 12a9 9 0 0 1 15-7.7L21 8" />
                                </svg>
                              </span>ÈáçËØï
                            </button>
                            <button id="send-btn" class="action-button">ÂèëÈÄÅ</button>
                        </div>
                    </div>
                </div>

                <div id="sticker-panel">
                    <div id="sticker-panel-header">
                        <span class="panel-btn" id="close-sticker-panel-btn">ÂèñÊ∂à</span>
                        <span class="title">ÊàëÁöÑË°®ÊÉÖ</span>
                        <div style="display: flex; gap: 10px;">
                          <span class="panel-btn" id="add-sticker-btn">Ê∑ªÂä†</span>
                          <span class="panel-btn" id="upload-sticker-btn">‰∏ä‰º†</span>
                        </div>
                    </div>
                    <div id="sticker-grid"></div>
                </div>
                <input type="file" id="sticker-upload-input" accept="image/*" style="display: none;">
                <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
                
                <div id="music-player-overlay">
                    <div class="music-player-window">
                        <span id="music-playlist-btn">‚ò∞</span>
                        <div id="music-time-counter">Â∑≤Áªè‰∏ÄËµ∑Âê¨‰∫Ü0.0Â∞èÊó∂</div>
                        <div id="music-player-song-title">ËØ∑Ê∑ªÂä†Ê≠åÊõ≤</div>
                        <div id="music-player-artist">...</div>
                        <div class="music-controls">
                            <button id="music-prev-btn">‚óÄ</button>
                            <button id="music-play-pause-btn" class="play-pause-btn">‚ñ∂</button>
                            <button id="music-next-btn">‚ñ∂</button>
                            <button id="music-mode-btn">È°∫Â∫è</button>
                        </div>
                        <div class="music-bottom-actions">
                            <button id="music-exit-btn">ÈÄÄÂá∫‰∏ÄËµ∑Âê¨</button>
                            <button id="music-return-btn">ËøîÂõûËÅäÂ§©</button>
                        </div>
                    </div>
                </div>
                
                <div id="music-playlist-panel">
                    <div class="playlist-header">
                        <span class="panel-btn" id="close-playlist-btn">ËøîÂõû</span>
                        <span>Êí≠ÊîæÂàóË°®</span>
                        <div>
                            <span class="panel-btn" id="add-song-local-btn">Êú¨Âú∞</span>
                            <span class="panel-btn" id="add-song-url-btn">URL</span>
                        </div>
                    </div>
                    <div class="playlist-body" id="playlist-body"></div>
                </div>
                <input type="file" id="local-song-upload-input" accept="audio/*" multiple="" style="display: none;">

            </div>

            <div id="wallpaper-screen" class="screen" style="background-color: white;">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span>
        <span class="header-title">Â£ÅÁ∫∏‰∏é‰∏ªÈ¢ò</span>
        <span style="width: 30px;"></span>
    </div>
    <div class="form-container">
        <div class="theme-selector-container" style="background-color: #f9f9f9; padding: 20px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <h3 style="text-align: center; margin-bottom: 15px;">ÈÄâÊã©‰∏ªÈ¢òÈ£éÊ†º</h3>
            <div class="theme-style-selector">
                <div class="theme-style-option" data-theme="simple" onclick="selectThemeStyle('simple')">
                    <div class="theme-preview simple-theme"></div>
                    <span>ÁÆÄÁ∫¶È£é</span>
                </div>
                <div class="theme-style-option" data-theme="cute" onclick="selectThemeStyle('cute')">
                    <div class="theme-preview cute-theme"></div>
                    <span>ÂèØÁà±È£é</span>
                </div>
            </div>
            
            <div style="margin-top: 15px; text-align: center;">
                <button class="form-button" style="width: 80%; background-color: var(--accent-color); color: white;" onclick="applySelectedTheme()">Á°ÆËÆ§Â∫îÁî®‰∏ªÈ¢ò</button>
            </div>
        </div>
        
        <div style="margin-top: 30px; background-color: #f9f9f9; padding: 20px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <h3 style="text-align: center; margin-bottom: 15px;">ÊòæÁ§∫Ê®°ÂºèËÆæÁΩÆ</h3>
            <div class="form-group">
                <label class="borderless-mode-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 15px; background-color: white; border-radius: 10px; border: 2px solid #e0e0e0; transition: all 0.3s ease;">
                    <input type="checkbox" id="borderless-mode-toggle" style="width: 20px; height: 20px; cursor: pointer;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 16px; color: #333; margin-bottom: 5px;">Êó†ËæπÊ°ÜÊ®°Âºè</div>
                        <div style="font-size: 14px; color: #666; line-height: 1.4;">ÂºÄÂêØÂêéÊâãÊú∫Â∞ÜÂéªÊéâÂ§ñÂ£≥Ê°ÜÊû∂ÔºåÂ±èÂπïÂ§ßÂ∞èË∑üÈöèÊµèËßàÂô®Á™óÂè£Ëá™ÈÄÇÂ∫îÔºåÈÄÇÂêà‰∏çÂêåËÆæÂ§áÂíåÂ±èÂπïÂ∞∫ÂØ∏</div>
                    </div>
                </label>
            </div>
        </div>

        <div style="margin-top: 30px; background-color: #f9f9f9; padding: 20px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <h3 style="text-align: center; margin-bottom: 15px;">Ëá™ÂÆö‰πâÂ£ÅÁ∫∏</h3>
            <div id="wallpaper-preview" style="border: 2px dashed #ddd;">ÁÇπÂáª‰∏ãÊñπ‰∏ä‰º†</div>
            <button class="form-button" onclick="document.getElementById('wallpaper-upload-input').click();">‰∏ä‰º†Â£ÅÁ∫∏</button>
            <input type="file" id="wallpaper-upload-input" accept="image/*">
            <button class="form-button" id="save-wallpaper-btn">‰øùÂ≠òÂπ∂Â∫îÁî®</button>
        </div>
        
        <div style="margin-top: 30px; background-color: #f9f9f9; padding: 20px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <h3 style="text-align: center; margin-bottom: 15px;">Ëá™ÂÆö‰πâAIÂõæÊ†á</h3>
            <div class="form-group">
                <label>Ëá™ÂÆö‰πâÂêÑ‰∏™Â∫îÁî®ÁöÑAIÂõæÊ†áÔºö</label>
                <div id="custom-icons-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 15px 0;">
                    <!-- ÂõæÊ†áËá™ÂÆö‰πâÈ°πÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    <button class="form-button" id="reset-all-icons-btn" style="background-color: #ff6b6b; color: white;">ÈáçÁΩÆÊâÄÊúâÂõæÊ†á</button>
                </div>
            </div>
        </div>

        <div style="margin-top: 30px; background-color: #f9f9f9; padding: 20px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <h3 style="text-align: center; margin-bottom: 15px;">Ëá™ÂÆö‰πâËÅäÂ§©Ê∞îÊ≥°Ê†∑Âºè</h3>
            <div class="form-group">
                <label>Ëá™ÂÆö‰πâCSSÊ†∑Âºè‰ª£Á†Å</label>
                <textarea id="custom-bubble-css" placeholder="ËæìÂÖ•CSS‰ª£Á†ÅÊù•Ëá™ÂÆö‰πâËÅäÂ§©Ê∞îÊ≥°Ê†∑ÂºèÔºåÂèØ‰ª•‰øÆÊîπÈ¢úËâ≤„ÄÅÂ§ßÂ∞è„ÄÅÂΩ¢Áä∂„ÄÅÈò¥ÂΩ±Á≠âÔºå‰æãÂ¶ÇÔºö

/* Áî®Êà∑Ê∞îÊ≥° - ÂèØËá™ÂÆö‰πâÂ§ßÂ∞è„ÄÅÂΩ¢Áä∂„ÄÅÈò¥ÂΩ± */
.message-bubble.user .content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 25px 25px 8px 25px;
    font-size: 16px;
    padding: 15px 20px;
    min-width: 60px;
    max-width: 250px;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.2);
    transform: scale(1.02);
    backdrop-filter: none;
}

/* AIÊ∞îÊ≥° - ‰∏çÂêåÁöÑÈÄ†ÂûãËÆæËÆ° */
.message-bubble.ai .content {
    background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
    color: white;
    border-radius: 25px 25px 25px 8px;
    font-size: 16px;
    padding: 15px 20px;
    min-width: 60px;
    max-width: 250px;
    box-shadow: 0 8px 25px rgba(116, 185, 255, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.2);
    transform: scale(1.02);
    backdrop-filter: none;
}" style="width: 100%; height: 280px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px; resize: vertical;"></textarea>
            </div>
            <div class="form-group">
                <label>Ëá™ÂÆö‰πâÂ≠ó‰ΩìURLÈìæÊé•</label>
                <input type="text" id="custom-font-url" placeholder="ËæìÂÖ•Google FontsÊàñÂÖ∂‰ªñÂ≠ó‰ΩìCSSÈìæÊé•Ôºå‰æãÂ¶ÇÔºö
https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
            </div>
            <div class="form-group">
                <label>Â≠ó‰ΩìÊóèÂêçÁß∞</label>
                <input type="text" id="custom-font-family" placeholder="ËæìÂÖ•Â≠ó‰ΩìÊóèÂêçÁß∞Ôºå‰æãÂ¶ÇÔºö'Noto Sans SC', sans-serif" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
            </div>
            <button class="form-button" id="apply-custom-styles-btn">Â∫îÁî®Ëá™ÂÆö‰πâÊ†∑Âºè</button>
            <button class="form-button form-button-secondary" id="reset-custom-styles-btn">ÈáçÁΩÆ‰∏∫ÈªòËÆ§Ê†∑Âºè</button>
            <button class="form-button form-button-secondary" id="preview-custom-styles-btn">È¢ÑËßàÊïàÊûú</button>

            <!-- È¢ÑËßàÂå∫Âüü -->
            <div id="bubble-preview-container" style="margin-top: 20px; padding: 20px; background-color: #f0f2f5; border-radius: 12px; border: 2px dashed #ddd; display: none;">
                <h4 style="text-align: center; margin-bottom: 15px; color: #666;">Ê†∑ÂºèÈ¢ÑËßà</h4>
                <div id="preview-chat-area" style="display: flex; flex-direction: column; gap: 12px; max-width: 280px; margin: 0 auto;">
                    <!-- AIÊ∂àÊÅØ -->
                    <div class="message-wrapper ai" style="align-self: flex-start; align-items: flex-start; max-width: 85%;">
                        <div class="message-bubble ai" style="display: flex; align-items: flex-start; gap: 5px;">
                            <div class="avatar-group" style="display: flex; flex-direction: column; align-items: center; gap: 4px; flex-shrink: 0; width: 32px;">
                                <img class="avatar" src="https://i.postimg.cc/dVSd9QBz/IMG-3063.jpg" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;" alt="AIÂ§¥ÂÉè">
                            </div>
                            <div class="content preview-ai-bubble" style="padding: 8px 12px; word-break: break-word; line-height: 1.5; font-size: 15px; background-color: rgba(255, 255, 255, 0.7); color: var(--text-primary); border-radius: 8px 20px 20px 20px;">
                                ‰Ω†Â•ΩÔºÅËøôÊòØAIÁöÑÊ∂àÊÅØÊ∞îÊ≥°È¢ÑËßàÊïàÊûú
                            </div>
                        </div>
                    </div>

                    <!-- Áî®Êà∑Ê∂àÊÅØ -->
                    <div class="message-wrapper user" style="align-self: flex-end; align-items: flex-end; max-width: 85%;">
                        <div class="message-bubble user" style="display: flex; align-items: flex-start; gap: 5px; flex-direction: row-reverse;">
                            <div class="avatar-group" style="display: flex; flex-direction: column; align-items: center; gap: 4px; flex-shrink: 0; width: 32px;">
                                <img class="avatar" src="https://i.postimg.cc/dVSd9QBz/IMG-3063.jpg" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;" alt="Áî®Êà∑Â§¥ÂÉè">
                            </div>
                            <div class="content preview-user-bubble" style="padding: 8px 12px; word-break: break-word; line-height: 1.5; font-size: 15px; background-color: rgba(160, 233, 86, 0.75); color: #1a3d00; border-radius: 20px 8px 20px 20px;">
                                ËøôÊòØÊàëÂèëÈÄÅÁöÑÊ∂àÊÅØÊ∞îÊ≥°È¢ÑËßà
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div style="margin-top: 30px; background-color: #f9f9f9; padding: 20px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <h3 style="text-align: center; margin-bottom: 15px;">ÂõæÊ†áÊëÜÊîæ‰ΩçÁΩÆ</h3>
            <div class="form-group">
                <label for="icon-position">ÈÄâÊã©ÂõæÊ†áÊëÜÊîæ‰ΩçÁΩÆÔºö</label>
                <select id="icon-position" class="form-control">
                    <option value="top">Èù†‰∏ä</option>
                    <option value="center" selected>Â±Ö‰∏≠</option>
                    <option value="bottom">Èù†‰∏ã</option>
                </select>
                <div style="margin-top: 15px; text-align: center;">
                    <button class="form-button" id="save-icon-position-btn">‰øùÂ≠òÂπ∂Â∫îÁî®</button>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 30px; background-color: #f9f9f9; padding: 20px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <h3 style="text-align: center; margin-bottom: 15px;">Â≠óÂè∑Â§ßÂ∞èËÆæÁΩÆ</h3>
            <div class="form-group">
                <label for="font-size-select">ÈÄâÊã©Â≠óÂè∑Â§ßÂ∞èÔºö</label>
                <select id="font-size-select" class="form-control">
                    <option value="xsmall">Ë∂ÖÂ∞èÂ≠óÂè∑ (10px)</option>
                    <option value="tiny">ÊûÅÂ∞èÂ≠óÂè∑ (12px)</option>
                    <option value="small">Â∞èÂ≠óÂè∑ (14px)</option>
                    <option value="medium" selected>‰∏≠Â≠óÂè∑ (15px)</option>
                    <option value="large">Â§ßÂ≠óÂè∑ (16px)</option>
                    <option value="xlarge">Ë∂ÖÂ§ßÂ≠óÂè∑ (18px)</option>
                </select>
                <div style="margin-top: 15px; text-align: center;">
                    <button class="form-button" id="save-font-size-btn">‰øùÂ≠òÂπ∂Â∫îÁî®</button>
                </div>
                <div style="margin-top: 8px; padding: 10px; background: #e3f2fd; border-radius: 5px; font-size: 12px; color: #666;">
                    <strong>ËØ¥ÊòéÔºö</strong><br>
                    ‚Ä¢ Â≠óÂè∑ËÆæÁΩÆ‰ºöÂΩ±ÂìçËÅäÂ§©ÁïåÈù¢‰∏≠ÊâÄÊúâÊ∂àÊÅØÊ∞îÊ≥°ÁöÑÊñáÂ≠óÂ§ßÂ∞è<br>
                    ‚Ä¢ Ê∂àÊÅØÊ∞îÊ≥°ÁöÑÈ´òÂ∫¶‰ºöÊ†πÊçÆÂ≠óÂè∑Ëá™Âä®Ë∞ÉÊï¥<br>
                    ‚Ä¢ Êé®Ëçê‰ΩøÁî®‰∏≠Â≠óÂè∑ÔºåÂèØÊ†πÊçÆ‰∏™‰∫∫ÂñúÂ•ΩË∞ÉÊï¥
                </div>
            </div>
        </div>
    </div>
</div>
        </div>
    </div>

    
    <div id="chat-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>ËÅäÂ§©ËÆæÁΩÆ</span></div><div class="modal-body"><div class="form-group" id="chat-name-group"><label for="chat-name-input">Â§áÊ≥®Âêç / Áæ§Âêç</label><input type="text" id="chat-name-input"></div><div class="form-group" id="my-group-nickname-group"><label for="my-group-nickname-input">ÊàëÁöÑÁæ§ÊòµÁß∞</label><input type="text" id="my-group-nickname-input"></div><div class="form-group" id="group-avatar-group"><label>Áæ§Â§¥ÂÉè</label><div class="avatar-upload"><img id="group-avatar-preview"><button onclick="document.getElementById('group-avatar-input').click()">‰∏ä‰º†Áæ§Â§¥ÂÉè</button><input type="file" id="group-avatar-input" accept="image/*"></div></div>
            <div class="form-group" id="world-book-link-group">
                <label>ÂÖ≥ËÅî‰∏ñÁïå‰π¶ (ÂèØÂ§öÈÄâ)</label>
                <div class="custom-multiselect">
                    <div class="select-box">
                        <span class="selected-options-text">-- ÁÇπÂáªÈÄâÊã© --</span>
                        <span class="arrow-down">‚ñº</span>
                    </div>
                    <div id="world-book-checkboxes-container" class="checkboxes-container">
                    </div>
                </div>
            </div>
            <div class="form-group" id="ai-persona-group"><label for="ai-persona">ÂØπÊñπ‰∫∫ËÆæ (AI Persona)</label><textarea id="ai-persona" rows="3"></textarea></div><div class="form-group" id="ai-avatar-group"><label>ÂØπÊñπÂ§¥ÂÉè</label><div class="avatar-upload"><img id="ai-avatar-preview"><button onclick="document.getElementById('ai-avatar-input').click()">‰∏ä‰º†ÂØπÊñπÂ§¥ÂÉè</button><input type="file" id="ai-avatar-input" accept="image/*"></div></div><div class="form-group" id="my-persona-group"><label for="my-persona">ÊàëÁöÑ‰∫∫ËÆæ (My Persona)</label><textarea id="my-persona" rows="3"></textarea></div><div class="form-group" id="my-avatar-group"><label>ÊàëÁöÑÂ§¥ÂÉè</label><div class="avatar-upload"><img id="my-avatar-preview"><button onclick="document.getElementById('my-avatar-input').click()">‰∏ä‰º†ÊàëÁöÑÂ§¥ÂÉè</button><button id="open-persona-library-btn">È¢ÑËÆæ</button><input type="file" id="my-avatar-input" accept="image/*"></div></div>
            <div class="form-group" id="poke-suffix-group"><label for="my-poke-suffix">ÊàëÁöÑÊà≥‰∏ÄÊà≥ÂêéÁºÄ</label><input type="text" id="my-poke-suffix" placeholder="‰æãÂ¶ÇÔºöÁöÑËÑëË¢ã„ÄÅÁöÑÊâã„ÄÅÁöÑËÑ∏È¢ä" maxlength="20"></div>
            <div class="form-group" id="ai-poke-suffix-group"><label for="ai-poke-suffix">ÂØπÊñπÁöÑÊà≥‰∏ÄÊà≥ÂêéÁºÄ</label><input type="text" id="ai-poke-suffix" placeholder="‰æãÂ¶ÇÔºöÁöÑÂ∞èÈºªÂ≠ê„ÄÅÁöÑÈ¢ùÂ§¥„ÄÅÁöÑËÑ∏Ëõã" maxlength="20"></div>
            <div class="form-group" id="group-members-group">
                <label>Áæ§ÊàêÂëò‰∫∫ËÆæ</label>
                <div id="group-members-settings"></div>
            </div>
            <div class="form-group">
                <label for="max-memory">ÂéÜÂè≤ËÆ∞ÂøÜËΩÆÊï∞</label>
                <input type="number" id="max-memory" value="10">
                <div style="margin-top: 8px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px; color: #666;">
                    <strong>ËØ¥ÊòéÔºö</strong><br>
                    Ê≠§ËÆæÁΩÆÂ∞ÜÂêåÊó∂ÂΩ±ÂìçÔºö<br>
                    ‚Ä¢ AIÂèØËßÅÁöÑËÅäÂ§©ËÆ∞ÂΩïËΩÆÊï∞Ôºà‰∏ÄËΩÆ = Áî®Êà∑ÂèëÊ∂àÊÅØ + AIÂõûÂ§çÂÆåÊØïÔºâ<br>
                    ‚Ä¢ AIÂú®ÂæÆÂçö‰∫íÂä®Êó∂ËÉΩÁúãÂà∞ÁöÑËÅäÂ§©ÂéÜÂè≤ËΩÆÊï∞<br>
                    ‚Ä¢ AI‰∏ªÂä®ËÅäÂ§©Êó∂ÁöÑ‰∏ä‰∏ãÊñáËÆ∞ÂøÜËΩÆÊï∞<br>
                    ‚Ä¢ Âª∫ËÆÆËÆæÁΩÆ‰∏∫5-15ËΩÆÔºåËøáÂ§öÂèØËÉΩÂΩ±ÂìçÂìçÂ∫îÈÄüÂ∫¶
                </div>
            </div>
            
            <div class="form-group" id="memory-mount-group">
                <label>
                    <input type="checkbox" id="memory-mount-enabled" name="memory-mount-enabled">
                    ÊåÇËΩΩÂÖ∂‰ªñËÅäÂ§©ËÆ∞ÂøÜ
                </label>
                <div id="memory-mount-settings" style="display: none; margin-top: 15px;">
                    <label>ÈÄâÊã©Ë¶ÅÊåÇËΩΩËÆ∞ÂøÜÁöÑËÅäÂ§© (ÂèØÂ§öÈÄâ):</label>
                    <div class="custom-multiselect" id="memory-mount-multiselect">
                        <div class="select-box">
                            <span class="selected-options-text">-- ÁÇπÂáªÈÄâÊã© --</span>
                            <span class="arrow-down">‚ñº</span>
                        </div>
                        <div id="memory-mount-checkboxes-container" class="checkboxes-container">
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <label for="memory-mount-count">ÊØè‰∏™ËÅäÂ§©ÊåÇËΩΩËΩÆÊï∞:</label>
                        <input type="number" id="memory-mount-count" value="10" min="1" max="50" style="width: 80px; margin-left: 10px;">
                    </div>
                </div>
                <div style="margin-top: 8px; padding: 10px; background: #f0f8ff; border-radius: 5px; font-size: 12px; color: #666;">
                    <strong>ËØ¥ÊòéÔºö</strong><br>
                    ‚Ä¢ <strong>Áæ§ËÅäÊåÇËΩΩÁßÅËÅä</strong>ÔºöÂú®Áæ§ËÅä‰∏≠ÔºåAI‰ºöÊê∫Â∏¶ÈÄâ‰∏≠ÁßÅËÅäËßíËâ≤ÁöÑËÆ∞ÂøÜÂèÇ‰∏éÂØπËØù<br>
                    ‚Ä¢ <strong>ÁßÅËÅäÊåÇËΩΩÁæ§ËÅä</strong>ÔºöÂú®ÁßÅËÅä‰∏≠ÔºåAI‰ºöÊê∫Â∏¶ÈÄâ‰∏≠Áæ§ËÅäÁöÑËÆ∞ÂøÜËøõË°åÂØπËØù<br>
                    ‚Ä¢ ÊåÇËΩΩÁöÑËÆ∞ÂøÜ‰ºö‰ª•"ÂèÇËÄÉËÆ∞ÂøÜ"ÁöÑÂΩ¢ÂºèÊèê‰æõÁªôAIÔºå‰∏ç‰ºöÁõ¥Êé•ÊòæÁ§∫Âú®ËÅäÂ§©ÁïåÈù¢<br>
                    ‚Ä¢ Âª∫ËÆÆÊØè‰∏™ËÅäÂ§©ÊåÇËΩΩ3-10ËΩÆËÆ∞ÂøÜÔºåÈÅøÂÖçÂΩ±ÂìçÂìçÂ∫îÈÄüÂ∫¶
                </div>
            </div>
            
            <!-- Êô∫ËÉΩËÆ∞ÂøÜÂÖ±‰∫´ËÆæÁΩÆ -->
            <div class="form-group" id="memory-sharing-group">
                <label>
                    <input type="checkbox" id="memory-sharing-enabled" name="memory-sharing-enabled">
                    Êô∫ËÉΩËÆ∞ÂøÜÂÖ±‰∫´
                </label>
                <div id="memory-sharing-settings" style="display: none; margin-top: 15px;">
                    <label>ÈÄâÊã©Ë¶ÅÂÖ±‰∫´ËÆ∞ÂøÜÁöÑËÅäÂ§© (ÂèØÂ§öÈÄâ):</label>
                    <div class="custom-multiselect" id="memory-sharing-multiselect">
                        <div class="select-box">
                            <span class="selected-options-text">-- ÁÇπÂáªÈÄâÊã© --</span>
                            <span class="arrow-down">‚ñº</span>
                        </div>
                        <div id="memory-sharing-checkboxes-container" class="checkboxes-container">
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <label>ÂÖ±‰∫´Á±ªÂà´:</label>
                        <div class="memory-sharing-categories" style="margin-top: 8px;">
                            <label style="display: block; margin: 5px 0;">
                                <input type="checkbox" id="share-mood" checked> ÊÉÖÁª™Áä∂ÊÄÅÂèòÂåñ
                            </label>
                            <label style="display: block; margin: 5px 0;">
                                <input type="checkbox" id="share-events" checked> ÈáçË¶Å‰∫ã‰ª∂
                            </label>
                            <label style="display: block; margin: 5px 0;">
                                <input type="checkbox" id="share-interests" checked> ÂÖ¥Ë∂£Áà±Â•ΩËÆ®ËÆ∫
                            </label>
                            <label style="display: block; margin: 5px 0;">
                                <input type="checkbox" id="share-plans" checked> ËÆ°ÂàíÂÆâÊéí
                            </label>
                        </div>
                        <div style="margin-top: 10px;">
                            <label>ÈáçË¶ÅÊÄßÈòàÂÄº: <span id="threshold-value">0.6</span></label>
                            <input type="range" id="sharing-threshold" min="0.1" max="1.0" step="0.1" value="0.6" style="width: 100%; margin-top: 5px;">
                        </div>
                    </div>
                </div>
                <div style="margin-top: 8px; padding: 10px; background: #e8f5e8; border-radius: 5px; font-size: 12px; color: #666;">
                    <strong>ËØ¥ÊòéÔºö</strong><br>
                    ‚Ä¢ <strong>Êô∫ËÉΩÁ≠õÈÄâ</strong>ÔºöËá™Âä®ËØÜÂà´ÈáçË¶ÅËÆ∞ÂøÜÁâáÊÆµÔºåÂ¶ÇÊÉÖÁª™ÂèòÂåñ„ÄÅÈáçË¶Å‰∫ã‰ª∂Á≠â<br>
                    ‚Ä¢ <strong>Ëá™ÁÑ∂ÂºïÁî®</strong>ÔºöAI‰ºöÂú®ÂêàÈÄÇÊó∂Êú∫Ëá™ÁÑ∂ÊèêÂèäÂÖ±‰∫´ÁöÑËÆ∞ÂøÜÔºåËÄåÈùûÁîüÁ°¨ÁöÑËÉåÊôØÊåÇËΩΩ<br>
                    ‚Ä¢ <strong>ÂèåÂêë‰∫íÂä®</strong>Ôºö‰∏çÂêåËÅäÂ§©Á™óÂè£Èó¥ËÉΩÂ§üÊô∫ËÉΩÊÑüÁü•ÂíåÂìçÂ∫îÈáçË¶ÅÂèòÂåñ<br>
                    ‚Ä¢ <strong>ÈöêÁßÅ‰øùÊä§</strong>ÔºöÂèØÈÄâÊã©ÂÖ±‰∫´Á±ªÂà´ÔºåÊïèÊÑüÂÜÖÂÆπ‰∏ç‰ºöË¢´ÂàÜ‰∫´<br>
                    ‚Ä¢ ‰∏é"ËÆ∞ÂøÜÊåÇËΩΩ"ÂäüËÉΩ‰∫íË°•ÔºåÂèØÂêåÊó∂‰ΩøÁî®
                </div>
            </div>
            
            <div class="form-group"><label>ËÅäÂ§©Ê∞îÊ≥°‰∏ªÈ¢ò <button id="reset-theme-btn" type="button">ÈáçÁΩÆ</button></label><div class="theme-selector"><label><input type="radio" name="theme-select" value="default" id="theme-default"> ÈªòËÆ§</label><label><input type="radio" name="theme-select" value="pink_blue"> Á≤âËìù</label><label><input type="radio" name="theme-select" value="blue_white"> ËìùÁôΩ</label><label><input type="radio" name="theme-select" value="purple_yellow"> Á¥´ÈªÑ</label><label><input type="radio" name="theme-select" value="black_white"> ÈªëÁôΩ</label><label><input type="radio" name="theme-select" value="yellow_white"> ÈªÑÁôΩ</label><label><input type="radio" name="theme-select" value="red_black"> Á∫¢Èªë</label><label><input type="radio" name="theme-select" value="blue_yellow"> ËìùÈªÑ</label><label><input type="radio" name="theme-select" value="pink_yellow"> Á≤âÈªÑ</label><label><input type="radio" name="theme-select" value="pink_purple"> Á≤âÁ¥´</label><label><input type="radio" name="theme-select" value="gray_white"> ÁÅ∞ÁôΩ</label><label><input type="radio" name="theme-select" value="blue_green"> ËìùÁªø</label><label><input type="radio" name="theme-select" value="pink_white"> Á≤âÁôΩ</label><label><input type="radio" name="theme-select" value="pink_black"> Á≤âÈªë</label><label><input type="radio" name="theme-select" value="pink_green"> Á≤âÁªø</label><label><input type="radio" name="theme-select" value="green_black"> ÁªøÈªë</label></div></div>
            <div class="form-group">
                <label>Êó∂Èó¥ÊÑüÁü•ËÆæÁΩÆ</label>
                <div style="margin-top: 10px;">
                    <label>
                        <input type="checkbox" id="time-awareness-enabled" name="time-awareness-enabled">
                        ÂêØÁî®Êó∂Èó¥ÊèêÁ§∫ËØç
                    </label>
                    <div style="margin-top: 8px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px; color: #666;">
                        <strong>ËØ¥ÊòéÔºö</strong><br>
                        ‚Ä¢ <strong>ÂºÄÂêØÊó∂</strong>ÔºöAIÂèØ‰ª•ÊòéÁ°ÆÊÑüÁü•ÂΩìÂâçÊó∂Èó¥ÔºàÂπ¥ÊúàÊó•Êó∂ÂàÜÔºâÔºåÂÖ∑Â§áÊó∂Èó¥ÊµÅÈÄùÊÑüÔºåÁü•ÈÅìË∑ùÁ¶ª‰∏äÊ¨°ÂØπËØùËøáÂéª‰∫ÜÂ§ö‰πÖ<br>
                        ‚Ä¢ <strong>ÂÖ≥Èó≠Êó∂</strong>ÔºöAIÊó†Ê≥ïÊÑüÁü•ÂÖ∑‰ΩìÊó∂Èó¥ÔºåÈÄÇÂêàËßíËâ≤ÊâÆÊºîÂíåÂâßÊÉÖÊé®Ëøõ<br>
                        ‚Ä¢ Ê≠§ËÆæÁΩÆ‰ºöÂΩ±ÂìçAIÂú®ËÅäÂ§©„ÄÅ‰∏ªÂä®ÂèëÊ∂àÊÅØÂíåÂèëÂ∏ÉÂæÆÂçöÂä®ÊÄÅÊó∂ÁöÑÊó∂Èó¥ÊÑüÁü•ËÉΩÂäõ
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Âπ∂ÂèëËÅäÂ§©Ê®°Âºè</label>
                <div style="margin-top: 10px;">
                    <label>
                        <input type="checkbox" id="concurrent-chat-enabled" name="concurrent-chat-enabled" checked>
                        ÂêØÁî®Âπ∂ÂèëÂ§ÑÁêÜ
                    </label>
                    <div style="margin-top: 8px; padding: 10px; background: #e7f3ff; border-radius: 5px; font-size: 12px; color: #666;">
                        <strong>ËØ¥ÊòéÔºö</strong><br>
                        ‚Ä¢ <strong>ÂºÄÂêØÊó∂</strong>ÔºöÊîØÊåÅÂêåÊó∂ËøõË°åÂ§ö‰∏™ËÅäÂ§©‰ªªÂä°ÔºåÂèØ‰ª•‰∏ÄËæπËÅäÂ§©‰∏ÄËæπ‰∫íÂä®ÂæÆÂçö<br>
                        ‚Ä¢ <strong>ÂÖ≥Èó≠Êó∂</strong>Ôºö‰º†ÁªüÁöÑ‰∏≤Ë°åÊ®°ÂºèÔºå‰∏ÄÊ¨°Âè™ËÉΩÂ§ÑÁêÜ‰∏Ä‰∏™ËØ∑Ê±Ç<br>
                        ‚Ä¢ ËÅäÂ§©ÂàóË°®‰∏≠‰ºöÊòæÁ§∫Ê¥ªË∑ÉÁä∂ÊÄÅÔºö‚óè(Ê≠£Âú®Â§ÑÁêÜ) ‚óã(ÈòüÂàóÁ≠âÂæÖ)<br>
                        ‚Ä¢ ÂèØ‰ª•ÂêåÊó∂‰∏é‰∏çÂêåËßíËâ≤ËÅäÂ§©ÔºåÊàñÂú®ËÅäÂ§©Êó∂ËøõË°åÂÖ∂‰ªñÊìç‰Ωú
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>ÈÄöËØùËÆæÁΩÆ</label>
                <div style="margin-top: 10px;">
                    <label>
                        <input type="checkbox" id="ai-call-enabled" name="ai-call-enabled">
                        ÂÖÅËÆ∏AI‰∏ªÂä®Êã®ÊâìÁîµËØù
                    </label>
                    <div style="margin-top: 8px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px; color: #666;">
                        <strong>ËØ¥ÊòéÔºö</strong><br>
                        ‚Ä¢ <strong>ÂºÄÂêØÊó∂</strong>ÔºöÂΩìÊúÄËøë3ËΩÆÂØπËØù‰∏≠ÊèêÂà∞ÈÄöËØùÁõ∏ÂÖ≥ÂÜÖÂÆπÊó∂ÔºåAIÊúâ20%Ê¶ÇÁéá‰∏ªÂä®Áªô‰Ω†ÊâìÁîµËØù<br>
                        ‚Ä¢ <strong>ÂÖ≥Èó≠Êó∂</strong>ÔºöAI‰∏ç‰ºö‰∏ªÂä®Êã®ÊâìÁîµËØùÔºåÂè™ËÉΩÁî±Áî®Êà∑‰∏ªÂä®ÂèëËµ∑ÈÄöËØù<br>
                        ‚Ä¢ ÈÄöËØùÁõ∏ÂÖ≥ÂÖ≥ÈîÆËØçÂåÖÊã¨ÔºöÈÄöËØù„ÄÅÁîµËØù„ÄÅËßÜÈ¢ë„ÄÅËØ≠Èü≥„ÄÅÊâìÁªô‰Ω†„ÄÅÊÉ≥Âê¨„ÄÅÊÉ≥ÁúãÁ≠â
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>AIÂøÉÁéáÁõëÊµã</label>
                <div style="margin-top: 10px;">
                    <label>
                        <input type="checkbox" id="ai-heartrate-enabled" name="ai-heartrate-enabled">
                        ÊòæÁ§∫AIÂøÉÁéá
                    </label>
                    <div style="margin-top: 8px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px; color: #666;">
                        <strong>ËØ¥ÊòéÔºö</strong><br>
                                        ‚Ä¢ <strong>ÂºÄÂêØÊó∂</strong>ÔºöÂú®ËÅäÂ§©ÁïåÈù¢È°∂ÈÉ®ÊòæÁ§∫AIËßíËâ≤ÁöÑÂÆûÊó∂ÂøÉÁéáÔºà‚ô•Ô∏è xx bpmÔºâ<br>
                ‚Ä¢ <strong>Êô∫ËÉΩÂøÉÁéá</strong>ÔºöÊ†πÊçÆËßíËâ≤ÊÄßÊ†ºËÆæÂÆöÂü∫Á°ÄÂøÉÁéáÔºåÂÆ≥ÁæûÂûã85bpmÔºåÂÜ∑ÈùôÂûã65bpmÔºåÁÉ≠Ë°ÄÂûã88bpmÁ≠â<br>
                ‚Ä¢ <strong>ÊÉÖÊÑüÂèçÂ∫î</strong>ÔºöÊ£ÄÊµã‰∫≤ÂØÜËØçÊ±áÔºàÁà±‰Ω†„ÄÅÊÉ≥‰Ω†„ÄÅÊä±Êä±ÔºâÂ§ßÂπÖÊèêÂçáÂøÉÁéáÔºåË°®ÁôΩ„ÄÅÊííÂ®áÁ≠âÈÄÇÂ∫¶ÊèêÂçá<br>
                ‚Ä¢ <strong>Ëá™ÁÑ∂ÊÅ¢Â§ç</strong>ÔºöÂøÉÁéá‰ºöÂú®Êï∞ÁßíÂêéÈÄêÊ∏êÊÅ¢Â§çÔºåÊõ¥ÁúüÂÆûÂú∞Ê®°ÊãüÊÉÖÊÑüÂèòÂåñ<br>
                ‚Ä¢ <strong>ÂàáÊç¢ËÅäÂ§©</strong>ÔºöÁ¶ªÂºÄÂΩìÂâçËÅäÂ§©Á™óÂè£Êó∂ÂøÉÁéáÊòæÁ§∫‰ºöËá™Âä®ÈöêËóè
                    </div>
                </div>
            </div>
            <div class="form-group" id="chat-mode-group">
                <label>ËÅäÂ§©Ê®°ÂºèËÆæÁΩÆ</label>
                <div class="chat-mode-switch">
                    <div class="chat-mode-option">
                        <input type="radio" id="chat-mode-online" name="chat-mode" value="online">
                        <label for="chat-mode-online">Á∫ø‰∏äÊ®°Âºè</label>
                    </div>
                    <div class="chat-mode-option">
                        <input type="radio" id="chat-mode-offline" name="chat-mode" value="offline">
                        <label for="chat-mode-offline">Á∫ø‰∏ãÊ®°Âºè</label>
                    </div>
                </div>
                <div class="offline-length-control" id="offline-length-control" style="display: none;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="font-size: 12px; color: #666; font-weight: 500;">ÊØèÊù°Ê∂àÊÅØÊúÄÁü≠Ôºö</span>
                        <input type="number" id="offline-mode-min-length" min="20" max="800" value="50">
                        <span style="font-size: 12px; color: #666;">Â≠ó</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 12px; color: #666; font-weight: 500;">ÊØèÊù°Ê∂àÊÅØÊúÄÈïøÔºö</span>
                        <input type="number" id="offline-mode-max-length" min="50" max="1000" value="100">
                        <span style="font-size: 12px; color: #666;">Â≠ó</span>
                    </div>
                </div>
                <div style="margin-top: 12px; padding: 12px; background: rgba(248, 249, 250, 0.8); backdrop-filter: blur(5px); border-radius: 8px; font-size: 12px; color: #666; border: 1px solid rgba(0, 0, 0, 0.05);">
                    <strong style="color: #495057;">Ê®°ÂºèËØ¥ÊòéÔºö</strong><br>
                    ‚Ä¢ <strong>Á∫ø‰∏äÊ®°Âºè</strong>ÔºöÁ∫ØËØ≠Ë®ÄËÅäÂ§©ÔºåÂ§öÊù°Ê∂àÊÅØÂèëÈÄÅÔºåÈÄÇÂêàÊó•Â∏∏ÂØπËØù<br>
                    ‚Ä¢ <strong>Á∫ø‰∏ãÊ®°Âºè</strong>ÔºöÂâßÊÉÖ‰∫íÂä®ÔºåÂçïÊù°Ê∂àÊÅØÂåÖÂê´ÂØπËØùÔºà„Äå„ÄçÔºâÂíåÊèèÂÜôÔºåÂØπËØùÊ≠£Â∏∏ÊòæÁ§∫ÔºåÊèèÂÜô‰∏∫ÁÅ∞Ëâ≤Êñú‰Ωì<br>
                    ‚Ä¢ <strong>Â≠óÊï∞ËåÉÂõ¥</strong>ÔºöËÆæÁΩÆÁ∫ø‰∏ãÊ®°ÂºèÊØèÊù°Ê∂àÊÅØÁöÑÊúÄÁü≠ÂíåÊúÄÈïøÂ≠óÊï∞ÔºåÈÅøÂÖçÂõûÂ§çËøáÁü≠ÊàñËøáÈïø<br>
                    ‚Ä¢ <strong>Á§∫‰æãÊ†ºÂºè</strong>Ôºö„ÄåÊàëÊÉ≥‰Ω†‰∫Ü„ÄÇ„Äç‰ªñÂáëËøë‰∫Ü‰∫õÔºå‰ΩéÂ£∞ËØ¥ÁùÄÔºåËØ≠Ê∞îÈáåÊª°ÊòØÁú∑Âøµ„ÄÇ„ÄåÁúüÁöÑ‚Ä¶ÂæàÊÉ≥‰Ω†„ÄÇ„Äç
                </div>
            </div>
            <div class="form-group">
                <label>ËÅäÂ§©ËÉåÊôØ</label>
                <div class="bg-upload-container">
                    <button type="button" class="form-button-secondary" style="width: auto; padding: 8px 12px; margin-top: 0;" onclick="document.getElementById('bg-input').click()">‰∏ä‰º†ËÉåÊôØÂõæ</button>
                    <button type="button" id="remove-bg-btn">ÁßªÈô§ËÉåÊôØ</button>
                </div>
                <img id="bg-preview" class="bg-preview-img">
                <input type="file" id="bg-input" accept="image/*" style="display: none;">
            </div>
  <div class="form-group">
    <label>ÂæÆÂçöÂä®ÊÄÅËÆæÁΩÆ</label>
    <div class="weibo-settings">
        <label>
            <input type="checkbox" id="weibo-enabled" name="weibo-enabled">
            ÂºÄÂêØÂä®ÊÄÅÂäüËÉΩ
        </label>
        <div id="weibo-frequency-settings" style="display: none;">
            <label>ÂèëÂ∏ÉÈ¢ëÁéá:</label>
            <select id="weibo-frequency">
                <option value="low">‰Ωé(1-2Êù°/Â§©)</option>
                <option value="medium">‰∏≠(3-4Êù°/Â§©)</option>
                <option value="high">È´ò(5-6Êù°/Â§©)</option>
            </select>
            <div class="posting-times">
                <label>ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ:</label>
                <div id="posting-times-container">
                    <button type="button" class="add-time-btn">+ Ê∑ªÂä†Êó∂Èó¥ÁÇπ</button>
                </div>
            </div>
            <button type="button" id="test-ai-posting-btn" style="margin-top: 10px; padding: 8px 16px; background-color: rgb(74, 132, 193); color: white; border: none; border-radius: 4px; cursor: pointer;">
                ÊµãËØïAIÂèëÂ∏É
            </button>
        </div>
    </div>
    
    <label>ÂêéÂè∞‰∫íÂä®ËÆæÁΩÆ</label>
    <div class="background-interaction-settings">
        <label>
            <input type="checkbox" id="background-interaction-enabled" name="background-interaction-enabled">
            ÂêØÁî®ÂêéÂè∞‰∫íÂä®
        </label>
        <div id="background-interaction-frequency-settings" style="display: none; margin-top: 10px;">
            <div style="margin-bottom: 15px;">
                <label>‰∏ªÂä®ËÅäÂ§©È¢ëÁéá:</label>
                <select id="background-chat-frequency">
                    <option value="low">‰Ωé(1-2Â∞èÊó∂/Ê¨°)</option>
                    <option value="medium">‰∏≠(30ÂàÜÈíü-1Â∞èÊó∂/Ê¨°)</option>
                    <option value="high">È´ò(10-15ÂàÜÈíü/Ê¨°)</option>
                </select>
            </div>
            <div style="margin-bottom: 15px;">
                <label>‰∏ªÂä®ÂèëÂä®ÊÄÅÈ¢ëÁéá:</label>
                <select id="background-weibo-frequency">
                    <option value="low">‰Ωé(3-5Â∞èÊó∂/Ê¨°)</option>
                    <option value="medium">‰∏≠(1Â∞èÊó∂-2Â∞èÊó∂/Ê¨°)</option>
                    <option value="high">È´ò(15-25ÂàÜÈíü/Ê¨°)</option>
                </select>
            </div>
            <div style="margin-top: 10px;">
                <label>‰∫íÂä®Á±ªÂûã:</label>
                <div>
                    <label><input type="checkbox" id="background-chat-enabled" checked> ‰∏ªÂä®ËÅäÂ§©</label>
                </div>
                <div>
                    <label><input type="checkbox" id="background-weibo-enabled" checked> ‰∏ªÂä®ÂèëÂä®ÊÄÅ</label>
                </div>
            </div>
            <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px; color: #666;">
                <strong>ËØ¥ÊòéÔºö</strong><br>
                ‚Ä¢ ‰∏ªÂä®ËÅäÂ§©ÔºöAI‰ºöÂü∫‰∫éËÅäÂ§©ÂéÜÂè≤‰∏ªÂä®ÂèëÊ∂àÊÅØ<br>
                ‚Ä¢ ‰∏ªÂä®ÂèëÂä®ÊÄÅÔºöAI‰ºöÂèëÂ∏ÉÂæÆÂçöÂä®ÊÄÅ<br>
                ‚Ä¢ ‰∏é"ÂæÆÂçöÂä®ÊÄÅËÆæÁΩÆ"‰∏≠ÁöÑÂÆöÊó∂ÂèëÂ∏ÉÂäüËÉΩÁã¨Á´ãÔºå‰∏ç‰ºöÂÜ≤Á™Å
            </div>
        </div>
    </div>
</div>

<hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">
            <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;"><button class="form-button form-button-secondary" id="clear-chat-btn">Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï</button></div><div class="modal-footer"><button class="cancel" id="cancel-chat-settings-btn">ÂèñÊ∂à</button><button class="save" id="save-chat-settings-btn">‰øùÂ≠ò</button></div></div></div>
            
    <div id="persona-library-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>ÊàëÁöÑ‰∫∫ËÆæÂ∫ì</span><button id="add-persona-preset-btn" class="action-button">Ê∑ªÂä†</button></div><div class="modal-body"><div id="persona-library-grid"></div></div><div class="modal-footer"><button class="cancel" id="close-persona-library-btn">ÂÖ≥Èó≠</button></div></div></div>
    
    <div id="persona-editor-modal" class="modal"><div class="modal-content"><div class="modal-header"><span id="persona-editor-title">Ê∑ªÂä†‰∫∫ËÆæÈ¢ÑËÆæ</span></div><div class="modal-body"><div class="form-group"><label>È¢ÑËÆæÂ§¥ÂÉè</label><div class="avatar-upload"><img id="preset-avatar-preview"><button onclick="document.getElementById('preset-avatar-input').click()">‰∏ä‰º†Â§¥ÂÉè</button><input type="file" id="preset-avatar-input" accept="image/*"></div></div><div class="form-group"><label for="preset-persona-input">È¢ÑËÆæ‰∫∫ËÆæ</label><textarea id="preset-persona-input" rows="4" placeholder="Âú®Ê≠§ËæìÂÖ•Ëøô‰∏™‰∫∫ËÆæÁöÑËØ¶ÁªÜËÆæÂÆö..."></textarea></div></div><div class="modal-footer"><button class="cancel" id="cancel-persona-editor-btn">ÂèñÊ∂à</button><button class="save" id="save-persona-preset-btn">‰øùÂ≠ò</button></div></div></div>

    <div id="member-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>ÁºñËæëÁæ§ÊàêÂëò</span></div><div class="modal-body"><div class="form-group"><label for="member-name-input">ÂêçÂ≠ó</label><input type="text" id="member-name-input"></div><div class="form-group"><label for="member-persona-input">‰∫∫ËÆæ</label><textarea id="member-persona-input" rows="4"></textarea></div><div class="form-group"><label>Â§¥ÂÉè</label><div class="avatar-upload"><img id="member-avatar-preview"><button onclick="document.getElementById('member-avatar-input').click()">‰∏ä‰º†Â§¥ÂÉè</button><input type="file" id="member-avatar-input" accept="image/*"></div></div></div><div class="modal-footer"><button class="cancel" id="cancel-member-settings-btn">ÂèñÊ∂à</button><button class="save" id="save-member-settings-btn">‰øùÂ≠ò</button></div></div></div>
    
    <div id="custom-modal-overlay">
        <div id="custom-modal">
            <div class="custom-modal-header" id="custom-modal-title"></div>
            <div class="custom-modal-body" id="custom-modal-body"></div>
            <div class="custom-modal-footer">
                <button id="custom-modal-cancel">ÂèñÊ∂à</button>
                <button id="custom-modal-confirm" class="confirm-btn">Á°ÆÂÆö</button>
            </div>
        </div>
    </div>
    
    <div id="preset-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="preset-action-edit">ÁºñËæëÈ¢ÑËÆæ</button>
                <button id="preset-action-delete" class="btn-danger">Âà†Èô§È¢ÑËÆæ</button>
                <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <div id="transfer-modal">
        <div class="transfer-content">
            <div class="transfer-header">ÁªôTa‰∏Ä‰∏™ÊÉäÂñúÔºÅ</div>
            <div class="transfer-input-group">
                <label for="transfer-amount">ËΩ¨Ë¥¶ÈáëÈ¢ù</label>
                <input type="number" id="transfer-amount" placeholder="0.00" min="0" max="1000000000" step="0.01">
            </div>
            <div class="transfer-input-group">
                <label for="transfer-note">Â§áÊ≥® (ÂèØÈÄâ)</label>
                <input type="text" id="transfer-note" placeholder="Áïô‰∏ã‰Ω†ÁöÑÂ∞èÂøÉÊÄù~" maxlength="20">
            </div>
            <div class="transfer-actions">
                <button id="transfer-cancel-btn">ÂèñÊ∂à</button>
                <button id="transfer-confirm-btn">Á°ÆËÆ§ËΩ¨Ë¥¶</button>
            </div>
        </div>
    </div>
    
    <div id="transfer-confirm-modal">
        <div class="transfer-confirm-content">
            <div class="transfer-confirm-title">Êî∂Âà∞‰∏ÄÁ¨îËΩ¨Ë¥¶</div>
            <div class="transfer-confirm-info">
                <div class="transfer-confirm-amount">¬• 0.00</div>
                <div class="transfer-confirm-note">Â§áÊ≥®Ôºö</div>
            </div>
            <div class="transfer-confirm-actions">
                <button id="transfer-reject-btn">ÈÄÄÂõû</button>
                <button id="transfer-accept-btn">Á°ÆËÆ§Êî∂Ê¨æ</button>
            </div>
        </div>
    </div>

    <div id="battery-alert-modal">
        <div class="battery-alert-content">
            <img id="battery-alert-image" src="">
            <p id="battery-alert-text"></p>
        </div>
    </div>

    <!-- Âπ∂ÂèëÁä∂ÊÄÅÊåáÁ§∫Âô® -->
    <div id="concurrent-status">
        <span id="concurrent-status-text">Ê≠£Âú®Â§ÑÁêÜ 0 ‰∏™ËØ∑Ê±Ç</span>
    </div>

    <!-- Á§æ‰∫§‰∏ªÈ°µÊ®°ÊÄÅÂºπÁ™ó -->
    <div id="social-profile-modal" class="social-profile-overlay">
        <div class="social-profile-modal">
            <div class="social-profile-content">
            <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
            <div class="social-profile-header">
                <button class="social-profile-back" onclick="closeSocialProfile()">‚Äπ</button>
                <div class="social-profile-title">‰∏™‰∫∫‰∏ªÈ°µ</div>
                <button class="social-profile-edit-btn" onclick="editSocialProfile()">ÁºñËæë</button>
            </div>

            <!-- Áî®Êà∑‰ø°ÊÅØÂå∫Âüü -->
            <div class="social-profile-user-section">
                <div class="social-profile-bg">
                    <img id="social-profile-avatar" class="social-profile-avatar" src="">
                    <div class="social-profile-user-info">
                        <div id="social-profile-name" class="social-profile-name"></div>
                        <div id="social-profile-signature" class="social-profile-signature"></div>
                        <div class="social-profile-stats">
                            <span id="social-profile-followers" class="social-profile-stat">0 Á≤â‰∏ù</span>
                            <span id="social-profile-following" class="social-profile-stat">0 ÂÖ≥Ê≥®</span>
                            <span id="social-profile-posts-count" class="social-profile-stat">0 ÂæÆÂçö</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ê†áÁ≠æÈ°µ -->
            <div class="social-profile-tabs">
                <div class="social-profile-tab active" data-tab="posts">Âä®ÊÄÅ</div>
                <div class="social-profile-tab" data-tab="photos">Áõ∏ÂÜå</div>
            </div>

            <!-- ÂÜÖÂÆπÂå∫Âüü -->
            <div class="social-profile-tab-content">
                <div id="social-profile-posts-list" class="social-profile-posts-list"></div>
            </div>
        </div>
        </div>
    </div>

    <!-- ÂõæÁâáÊü•ÁúãÂô®Ê®°ÊÄÅÊ°Ü -->
    <div id="image-viewer-modal">
        <div class="image-viewer-content">
            <button class="image-viewer-close">√ó</button>
            <img id="viewer-image" src="" alt="Êü•ÁúãÂõæÁâá">
        </div>
    </div>

    <audio id="audio-player" style="display:none;"></audio>

    <!-- ÈÄöËØùÁ±ªÂûãÈÄâÊã©ÂºπÁ™ó -->
    <div id="call-type-modal">
        <div class="call-type-content">
            <div class="call-type-title">ÈÄâÊã©ÈÄöËØùÁ±ªÂûã</div>
            <div class="call-type-buttons">
                <button class="call-type-btn call-voice-btn" id="start-voice-call">
                    üìû ËØ≠Èü≥ÈÄöËØù
                </button>
                <button class="call-type-btn call-video-btn" id="start-video-call">
                    üìπ ËßÜÈ¢ëÈÄöËØù
                </button>
                <button class="call-type-btn call-cancel-btn" id="cancel-call">
                    ÂèñÊ∂à
                </button>
            </div>
        </div>
    </div>

    <!-- ÈÄöËØùÁïåÈù¢ -->
    <div id="call-overlay">
        <div class="call-window">
            <div class="call-header">
                <img class="call-avatar" id="call-avatar" src="" alt="Â§¥ÂÉè">
                <div class="call-contact-name" id="call-contact-name">ËÅîÁ≥ª‰∫∫</div>
                <div class="call-timer" id="call-timer">00:00:00</div>
            </div>
            
            <div class="call-messages" id="call-messages"></div>
            
            <div class="call-input-area">
                <input type="text" class="call-input" id="call-input" placeholder="ËæìÂÖ•Ê∂àÊÅØ...">
                <button class="call-send-btn" id="call-send-btn">ÂèëÈÄÅ</button>
            </div>
            
            <div class="call-controls">
                <button class="call-control-btn call-hangup-btn" id="call-hangup-btn">üìû</button>
            </div>
        </div>
    </div>

    <!-- AIÊù•ÁîµÂºπÁ™ó -->
    <div id="incoming-call-modal">
        <div class="incoming-call-content">
            <div class="incoming-call-type" id="incoming-call-type">ËØ≠Èü≥ÈÄöËØù</div>
            <div class="incoming-call-name" id="incoming-call-name">AIËßíËâ≤</div>
            <img class="incoming-call-avatar" id="incoming-call-avatar" src="" alt="Â§¥ÂÉè">
            <div class="incoming-call-controls">
                <button class="incoming-call-btn call-decline-btn" id="decline-call">üìû</button>
                <button class="incoming-call-btn call-answer-btn" id="answer-call">üìû</button>
            </div>
        </div>
    </div>

    <!-- Ëá™ÂÆö‰πâÂõæÊ†áÂºπÁ™ó -->
    <div id="custom-icon-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="custom-icon-title">Ëá™ÂÆö‰πâÂõæÊ†á</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ÂΩìÂâçÂõæÊ†áÈ¢ÑËßà</label>
                    <div style="text-align: center; margin: 15px 0;">
                        <img id="current-icon-preview" style="width: 80px; height: 80px; border-radius: 15px; object-fit: cover; border: 2px solid #ddd;">
                    </div>
                </div>
                <div class="form-group">
                    <label>ÈÄâÊã©Êñ∞ÂõæÊ†á</label>
                    <div style="display: flex; gap: 10px; margin: 10px 0;">
                        <button class="form-button" onclick="document.getElementById('icon-file-input').click()">‰∏ä‰º†Êú¨Âú∞ÂõæÁâá</button>
                        <button class="form-button" id="use-url-btn">‰ΩøÁî®URL</button>
                    </div>
                    <input type="file" id="icon-file-input" accept="image/*" style="display: none;">
                    <div id="url-input-group" style="display: none; margin-top: 10px;">
                        <input type="url" id="icon-url-input" placeholder="ËæìÂÖ•ÂõæÁâáURL" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        <button class="form-button" id="preview-url-btn" style="margin-top: 8px;">È¢ÑËßàURLÂõæÁâá</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Êñ∞ÂõæÊ†áÈ¢ÑËßà</label>
                    <div style="text-align: center; margin: 15px 0;">
                        <img id="new-icon-preview" style="width: 80px; height: 80px; border-radius: 15px; object-fit: cover; border: 2px solid #ddd; display: none;">
                        <p id="no-preview-text" style="color: #999; font-size: 14px;">ÊöÇÊó†È¢ÑËßà</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-icon-btn">ÂèñÊ∂à</button>
                <button class="save" id="save-icon-btn">‰øùÂ≠òÂπ∂Â∫îÁî®</button>
            </div>
        </div>
    </div>

    <script>
            function showScreen(screenId) {
        // Â¶ÇÊûúÁ¶ªÂºÄÂæÆÂçöÂ±èÂπïÔºåÈÄÄÂá∫ÈÄâÊã©Ê®°Âºè
        if (window.isWeiboSelectionMode && screenId !== 'weibo-screen') {
            window.exitWeiboSelectionMode();
        }
        
        // Â¶ÇÊûúÁ¶ªÂºÄËÅäÂ§©ÁïåÈù¢ÔºåÈöêËóèÂøÉÁéáÊòæÁ§∫
        if (screenId !== 'chat-interface-screen') {
            hideAiHeartrate();
        }
        
        if (screenId === 'chat-list-screen') window.renderChatListProxy(); 
        if (screenId === 'api-settings-screen') window.renderApiSettingsProxy();
        if (screenId === 'wallpaper-screen') window.renderWallpaperScreenProxy();
        if (screenId === 'world-book-screen') window.renderWorldBookScreenProxy();
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        const screenToShow = document.getElementById(screenId);
        if (screenToShow) screenToShow.classList.add('active');
        if (screenId === 'chat-interface-screen' && window.state) window.updateListenTogetherIconProxy(window.state.activeChatId);
        
        // Âª∂ËøüÊ∏≤ÊüìÂæÆÂçöÊó∂Èó¥Á∫øÔºåÁ°Æ‰øùÂáΩÊï∞Â∑≤ÂÆö‰πâ
        if (screenId === 'weibo-screen') {
            setTimeout(() => {
                if (window.renderWeiboTimelineProxy) {
                    window.renderWeiboTimelineProxy();
                }
            }, 100);
        }
    }

            window.updateListenTogetherIconProxy = () => {};

        // AIÂøÉÁéáÁÆ°ÁêÜÂäüËÉΩ
        let heartrateInterval = null;
        let currentHeartrate = 72; // Âü∫Á°ÄÂøÉÁéá
        
        function updateAiHeartrate(chat) {
            const heartrateDisplay = document.getElementById('ai-heartrate-display');
            
            // Ê£ÄÊü•ÊòØÂê¶ÂêØÁî®ÂøÉÁéáÁõëÊµã‰∏î‰∏çÊòØÁæ§ËÅä
            if (!chat.settings.aiHeartrateEnabled || chat.isGroup) {
                hideAiHeartrate();
                return;
            }
            
            // ÊòæÁ§∫ÂøÉÁéá
            heartrateDisplay.style.display = 'block';
            
            // ËÆ°ÁÆóÂü∫Á°ÄÂøÉÁéáÔºàÂü∫‰∫éËßíËâ≤‰∫∫ËÆæÔºâ
            const persona = (chat.settings.aiPersona || '').toLowerCase();
            const name = (chat.name || '').toLowerCase();
            let baseHeartrate = 72;
            
            // Ê†πÊçÆËßíËâ≤ÁâπÂæÅË∞ÉÊï¥Âü∫Á°ÄÂøÉÁéá
            if (persona.includes('Á¥ßÂº†') || persona.includes('ÂÆ≥Áæû') || persona.includes('ÊïèÊÑü') || 
                persona.includes('ÁæûÊ∂©') || persona.includes('ÂÆπÊòìËÑ∏Á∫¢') || persona.includes('ÂÜÖÂêë')) {
                baseHeartrate = 85; // ÂÆπÊòìÁ¥ßÂº†ÁöÑËßíËâ≤ÂøÉÁéáÊõ¥È´ò
            } else if (persona.includes('ÂÜ∑Èùô') || persona.includes('ÁêÜÊÄß') || persona.includes('ÊàêÁÜü') || 
                       persona.includes('Ê≤âÁ®≥') || persona.includes('ÂÜÖÊïõ') || persona.includes('‰∏•ËÇÉ')) {
                baseHeartrate = 65; // ÂÜ∑ÈùôÁöÑËßíËâ≤ÂøÉÁéáÊõ¥‰Ωé
            } else if (persona.includes('Ê¥ªÊ≥º') || persona.includes('ÂÖ¥Â•ã') || persona.includes('ÁÉ≠ÊÉÖ') || 
                       persona.includes('ÂºÄÊúó') || persona.includes('Â§ñÂêë') || persona.includes('Áà±Á¨ë')) {
                baseHeartrate = 82; // Ê¥ªÊ≥ºÁöÑËßíËâ≤ÂøÉÁéáÂÅèÈ´ò
            } else if (persona.includes('ËøêÂä®') || persona.includes('ÂÅ•Ë∫´') || persona.includes('‰ΩìËÇ≤') || 
                       persona.includes('ËøêÂä®Âëò') || persona.includes('Ê¥ªË∑É')) {
                baseHeartrate = 58; // ËøêÂä®ÂûãËßíËâ≤ÂøÉÁéáÊúÄ‰Ωé
            } else if (persona.includes('Ê∏©Êüî') || persona.includes('ÁîúÁæé') || persona.includes('ÂèØÁà±') || 
                       persona.includes('ËΩØËêå') || persona.includes('Â∞èÈ∏ü‰æù‰∫∫') || persona.includes('‰πñÂ∑ß')) {
                baseHeartrate = 75; // Ê∏©ÊüîÂûãËßíËâ≤ÂøÉÁéáÈÄÇ‰∏≠ÂÅèÈ´ò
            } else if (persona.includes('ÂÜ∑ÈÖ∑') || persona.includes('È´òÂÜ∑') || persona.includes('ÂÇ≤Â®á') || 
                       persona.includes('Â•≥Áéã') || persona.includes('Âº∫Âäø') || persona.includes('Èú∏ÈÅì')) {
                baseHeartrate = 68; // È´òÂÜ∑ÂûãËßíËâ≤ÂøÉÁéáÂÅè‰Ωé
            } else if (persona.includes('ÁÉ≠Ë°Ä') || persona.includes('ÂÜ≤Âä®') || persona.includes('ÊÄ•ÊÄßÂ≠ê') || 
                       persona.includes('ÁÅ´ÁàÜ') || persona.includes('Êö¥Ë∫Å') || persona.includes('ÊòìÊÄí')) {
                baseHeartrate = 88; // ÁÉ≠Ë°ÄÂûãËßíËâ≤ÂøÉÁéáÂæàÈ´ò
            } else if (persona.includes('Á•ûÁßò') || persona.includes('Ê∑±Ê≤â') || persona.includes('ÂÆâÈùô') || 
                       persona.includes('ÊñáÈùô') || persona.includes('ÂÜÖÂêë')) {
                baseHeartrate = 70; // Á•ûÁßòÂûãËßíËâ≤ÂøÉÁéáÊ≠£Â∏∏ÂÅè‰Ωé
            }
            
            // Ê†πÊçÆËßíËâ≤ÂêçÂ≠óËøõ‰∏ÄÊ≠•ÂæÆË∞É
            if (name.includes('Â∞è') || name.includes('Ëêå') || name.includes('ÂèØÁà±')) {
                baseHeartrate += 3; // ÂèØÁà±ÂêçÂ≠óÁöÑËßíËâ≤ÂøÉÁéáÁ®çÈ´ò
            } else if (name.includes('ÂÜ∞') || name.includes('Èõ™') || name.includes('Èùô') || 
                       name.includes('ÂÜ∑') || name.includes('Âáâ')) {
                baseHeartrate -= 5; // ÂÜ∑Á≥ªÂêçÂ≠óÁöÑËßíËâ≤ÂøÉÁéáÊõ¥‰Ωé
            } else if (name.includes('ÁÅ´') || name.includes('ÁÉ≠') || name.includes('ÁÉà')) {
                baseHeartrate += 5; // ÁÅ´Á≥ªÂêçÂ≠óÁöÑËßíËâ≤ÂøÉÁéáÊõ¥È´ò
            }
            
            // Ê†πÊçÆÊúÄËøëÂØπËØùÂÜÖÂÆπË∞ÉÊï¥ÂøÉÁéá
            const recentMessages = chat.history.slice(-8); // Â¢ûÂä†ÂàÜÊûêÁöÑÊ∂àÊÅØÊï∞Èáè
            let emotionAdjustment = 0;
            
            recentMessages.forEach(msg => {
                // ÂÆâÂÖ®Âú∞Â§ÑÁêÜÊ∂àÊÅØÂÜÖÂÆπÔºåÂåÖÊã¨ÂõæÁâáÊ∂àÊÅØ
                let content = '';
                if (typeof msg.content === 'string') {
                    content = msg.content.toLowerCase();
                } else if (Array.isArray(msg.content)) {
                    // ÂØπ‰∫éÂõæÁâáÊ∂àÊÅØÔºå‰ΩøÁî®Á©∫Â≠óÁ¨¶‰∏≤
                    content = '';
                } else {
                    content = '';
                }
                
                // È´òÂ∫¶‰∫≤ÂØÜËØçÊ±á - Â§ßÂπÖÊèêÈ´òÂøÉÁéá
                if (content.includes('Áà±‰Ω†') || content.includes('ÊàëÁà±‰Ω†') || content.includes('love you') || 
                    content.includes('ÂñúÊ¨¢‰Ω†') || content.includes('ÊÉ≥‰Ω†') || content.includes('ÊÉ≥Êä±‰Ω†') ||
                    content.includes('ÊÉ≥Âêª‰Ω†') || content.includes('‰∫≤‰∫≤') || content.includes('Êä±Êä±') ||
                    content.includes('ÂÆùË¥ù') || content.includes('darling') || content.includes('honey') ||
                    content.includes('‰∫≤Áà±ÁöÑ') || content.includes('ÊÉ≥Ë¶Å‰Ω†') || content.includes('ÈúÄË¶Å‰Ω†') ||
                    content.includes('Á¶ª‰∏çÂºÄ‰Ω†') || content.includes('ÊÉ≥Âíå‰Ω†') || content.includes('ÊÉ≥ËßÅ‰Ω†')) {
                    emotionAdjustment += 15;
                }
                
                // Ë°®ÁôΩÂíåÁîúËúúËØçÊ±á
                if (content.includes('Ë°®ÁôΩ') || content.includes('ÂñúÊ¨¢') || content.includes('ÂøÉÂä®') || 
                    content.includes('ÂøÉË∑≥') || content.includes('ËÑ∏Á∫¢') || content.includes('ÂÆ≥Áæû') ||
                    content.includes('ÂèØÁà±') || content.includes('Áîú') || content.includes('Ê∏©Êüî') ||
                    content.includes('Áæé‰∏Ω') || content.includes('ÊºÇ‰∫Æ') || content.includes('Ëø∑‰∫∫') ||
                    content.includes('È≠ÖÂäõ') || content.includes('Âê∏Âºï') || content.includes('ÂøÉ‰ª™')) {
                    emotionAdjustment += 10;
                }
                
                // ÊííÂ®áÂíå‰∫≤ÊòµËØçÊ±á
                if (content.includes('ÊííÂ®á') || content.includes('Âò§Âò§') || content.includes('Âìº') ||
                    content.includes('‰∫∫ÂÆ∂') || content.includes('ËÆ®Âéå') || content.includes('‰∏çË¶Å') ||
                    content.includes('Â•Ω‰∏çÂ•Ω') || content.includes('Ê±Ç‰Ω†') || content.includes('ÊãúÊâò') ||
                    content.includes('Èô™Êàë') || content.includes('Èô™Èô™') || content.includes('‰∏ÄËµ∑')) {
                    emotionAdjustment += 8;
                }
                
                // ÂÖ¥Â•ãÂíåÂºÄÂøÉËØçÊ±á
                if (content.includes('ÂºÄÂøÉ') || content.includes('È´òÂÖ¥') || content.includes('Âø´‰πê') || 
                    content.includes('ÂÖ¥Â•ã') || content.includes('ÊøÄÂä®') || content.includes('Â•ΩÊ£í') || 
                    content.includes('ÂéâÂÆ≥') || content.includes('Âìá') || content.includes('Â§™Â•Ω‰∫Ü') ||
                    content.includes('amazing') || content.includes('wonderful') || content.includes('great')) {
                    emotionAdjustment += 6;
                }
                
                // Ë¥üÈù¢ÊÉÖÁª™ËØçÊ±á - ÂêåÊ†∑‰ºöËÆ©ÂøÉÁéáÂä†Âø´
                if (content.includes('ÈöæËøá') || content.includes('ÁîüÊ∞î') || content.includes('ÊãÖÂøÉ') || 
                    content.includes('ÂÆ≥ÊÄï') || content.includes('Á¥ßÂº†') || content.includes('ÁÑ¶Ëôë') ||
                    content.includes('‰∏çÂºÄÂøÉ') || content.includes('ÈÉÅÈó∑') || content.includes('ÁÉ¶') ||
                    content.includes('ÂéãÂäõ') || content.includes('Á¥Ø') || content.includes('Áñ≤ÊÉ´')) {
                    emotionAdjustment += 8;
                }
                
                // ËøêÂä®ÂíåÂà∫ÊøÄËØçÊ±á
                if (content.includes('Ë∑ëÊ≠•') || content.includes('ËøêÂä®') || content.includes('ÂÅ•Ë∫´') ||
                    content.includes('Ê∏∏Êàè') || content.includes('ÊØîËµõ') || content.includes('ÊåëÊàò') ||
                    content.includes('ÂÜíÈô©') || content.includes('Âà∫ÊøÄ') || content.includes('ÊÉäÈô©')) {
                    emotionAdjustment += 12;
                }
                
                // ÊößÊòßÂíåË∞ÉÊÉÖËØçÊ±á
                if (content.includes('Ë∞ÉÊÉÖ') || content.includes('Êí©') || content.includes('ËØ±ÊÉë') ||
                    content.includes('sexy') || content.includes('Ëø∑‰∫∫') || content.includes('È≠ÖÊÉë') ||
                    content.includes('ÂãæÂºï') || content.includes('ÂøÉË∑≥Âä†ÈÄü') || content.includes('Â∞èÂøÉÂøÉ')) {
                    emotionAdjustment += 12;
                }
                
                // ÈóÆÂÄôËØçÊ±á - ËΩªÂæÆÂ¢ûÂä†
                if (content.includes('‰Ω†Â•Ω') || content.includes('hi') || content.includes('hello') ||
                    content.includes('Êó©‰∏äÂ•Ω') || content.includes('ÊôöÂÆâ') || content.includes('good')) {
                    emotionAdjustment += 3;
                }
            });
            
            // ËÆ°ÁÆóÊúÄÁªàÂøÉÁéá
            currentHeartrate = Math.max(50, Math.min(140, baseHeartrate + emotionAdjustment));
            
                         // ÂêØÂä®ÂøÉÁéáÊõ¥Êñ∞
             if (heartrateInterval) clearInterval(heartrateInterval);
             heartrateInterval = setInterval(() => {
                 // Ê∑ªÂä†Ëá™ÁÑ∂ÁöÑÂøÉÁéáÊ≥¢Âä®Ôºà¬±4 bpmÔºâÔºåËÆ©ÂèòÂåñÊõ¥ÊòéÊòæ
                 const fluctuation = Math.floor(Math.random() * 9) - 4;
                 const displayHeartrate = Math.max(50, Math.min(140, currentHeartrate + fluctuation));
                 
                 // Ê†πÊçÆÂøÉÁéáÈ´ò‰ΩéÊ∑ªÂä†ËßÜËßâÊïàÊûú
                 heartrateDisplay.className = '';
                 if (displayHeartrate >= 110) {
                     heartrateDisplay.classList.add('very-high-heartrate');
                 } else if (displayHeartrate >= 95) {
                     heartrateDisplay.classList.add('high-heartrate');
                 }
                 
                 heartrateDisplay.innerHTML = `‚ô•Ô∏è <span class="heartrate-number">${displayHeartrate}</span> <span class="heartrate-unit">bpm</span>`;
             }, 1500 + Math.random() * 1000); // 1.5-2.5ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°ÔºåÊõ¥È¢ëÁπÅ
             
             // Á´ãÂç≥ÊòæÁ§∫ÂàùÂßãÂøÉÁéá
             heartrateDisplay.innerHTML = `‚ô•Ô∏è <span class="heartrate-number">${currentHeartrate}</span> <span class="heartrate-unit">bpm</span>`;
        }
        
        function hideAiHeartrate() {
            const heartrateDisplay = document.getElementById('ai-heartrate-display');
            heartrateDisplay.style.display = 'none';
            
            if (heartrateInterval) {
                clearInterval(heartrateInterval);
                heartrateInterval = null;
            }
        }
        
        // ÂΩìÂèëÈÄÅÊ∂àÊÅØÊó∂Êõ¥Êñ∞ÂøÉÁéá
        function adjustHeartrateForMessage(content, isUserMessage = false) {
            if (!heartrateInterval) return; // ÂøÉÁéáÁõëÊµãÊú™ÂêØÁî®
            
            let adjustment = 0;
            let lowerContent = '';
            let recoveryTime = 3000; // ÈªòËÆ§ÊÅ¢Â§çÊó∂Èó¥
            
            // ÂÆâÂÖ®Âú∞Â§ÑÁêÜÂÜÖÂÆπÔºåÂåÖÊã¨ÂõæÁâáÊ∂àÊÅØ
            if (typeof content === 'string') {
                lowerContent = content.toLowerCase();
            } else if (Array.isArray(content)) {
                // ÂØπ‰∫éÂõæÁâáÊ∂àÊÅØÔºå‰ΩøÁî®Á©∫Â≠óÁ¨¶‰∏≤
                lowerContent = '';
            } else {
                lowerContent = '';
            }
            
            if (isUserMessage) {
                // Áî®Êà∑ÂèëÈÄÅÊ∂àÊÅØÊó∂ÔºåAIÁöÑÂøÉÁéá‰ºöÊúâÁõ∏Â∫îÂèçÂ∫î
                
                // È´òÂ∫¶‰∫≤ÂØÜËØçÊ±á - Âº∫ÁÉàÂøÉË∑≥Âä†ÈÄü
                if (lowerContent.includes('Áà±‰Ω†') || lowerContent.includes('ÊàëÁà±‰Ω†') || lowerContent.includes('love you') || 
                    lowerContent.includes('ÂñúÊ¨¢‰Ω†') || lowerContent.includes('ÊÉ≥‰Ω†') || lowerContent.includes('ÊÉ≥Êä±‰Ω†') ||
                    lowerContent.includes('ÊÉ≥Âêª‰Ω†') || lowerContent.includes('‰∫≤‰∫≤') || lowerContent.includes('Êä±Êä±') ||
                    lowerContent.includes('ÂÆùË¥ù') || lowerContent.includes('darling') || lowerContent.includes('honey') ||
                    lowerContent.includes('‰∫≤Áà±ÁöÑ') || lowerContent.includes('ÊÉ≥Ë¶Å‰Ω†') || lowerContent.includes('ÈúÄË¶Å‰Ω†') ||
                    lowerContent.includes('Á¶ª‰∏çÂºÄ‰Ω†') || lowerContent.includes('ÊÉ≥Âíå‰Ω†') || lowerContent.includes('ÊÉ≥ËßÅ‰Ω†')) {
                    adjustment = 20; // Â§ßÂπÖÂ¢ûÂä†
                    recoveryTime = 8000; // Êõ¥ÈïøÁöÑÊÅ¢Â§çÊó∂Èó¥
                }
                // Ë°®ÁôΩÂíåÁîúËúúËØçÊ±á
                else if (lowerContent.includes('Ë°®ÁôΩ') || lowerContent.includes('ÂñúÊ¨¢') || lowerContent.includes('ÂøÉÂä®') || 
                    lowerContent.includes('ÂøÉË∑≥') || lowerContent.includes('ËÑ∏Á∫¢') || lowerContent.includes('ÂÆ≥Áæû') ||
                    lowerContent.includes('ÂèØÁà±') || lowerContent.includes('Áîú') || lowerContent.includes('Ê∏©Êüî') ||
                    lowerContent.includes('Áæé‰∏Ω') || lowerContent.includes('ÊºÇ‰∫Æ') || lowerContent.includes('Ëø∑‰∫∫') ||
                    lowerContent.includes('È≠ÖÂäõ') || lowerContent.includes('Âê∏Âºï') || lowerContent.includes('ÂøÉ‰ª™')) {
                    adjustment = 15;
                    recoveryTime = 6000;
                }
                // ÊííÂ®áÂíå‰∫≤ÊòµËØçÊ±á
                else if (lowerContent.includes('ÊííÂ®á') || lowerContent.includes('Âò§Âò§') || lowerContent.includes('Âìº') ||
                    lowerContent.includes('‰∫∫ÂÆ∂') || lowerContent.includes('ËÆ®Âéå') || lowerContent.includes('‰∏çË¶Å') ||
                    lowerContent.includes('Â•Ω‰∏çÂ•Ω') || lowerContent.includes('Ê±Ç‰Ω†') || lowerContent.includes('ÊãúÊâò') ||
                    lowerContent.includes('Èô™Êàë') || lowerContent.includes('Èô™Èô™') || lowerContent.includes('‰∏ÄËµ∑')) {
                    adjustment = 12;
                    recoveryTime = 5000;
                }
                // ÂÖ¥Â•ãÂíåÂºÄÂøÉËØçÊ±á
                else if (lowerContent.includes('ÂºÄÂøÉ') || lowerContent.includes('È´òÂÖ¥') || lowerContent.includes('Âø´‰πê') || 
                    lowerContent.includes('ÂÖ¥Â•ã') || lowerContent.includes('ÊøÄÂä®') || lowerContent.includes('Â•ΩÊ£í') || 
                    lowerContent.includes('ÂéâÂÆ≥') || lowerContent.includes('Âìá') || lowerContent.includes('Â§™Â•Ω‰∫Ü')) {
                    adjustment = 8;
                    recoveryTime = 4000;
                }
                // Ë¥üÈù¢ÊÉÖÁª™ËØçÊ±á - Á¥ßÂº†ÂØºËá¥ÂøÉÁéáÂä†Âø´
                else if (lowerContent.includes('ÁîüÊ∞î') || lowerContent.includes('‰∏çÂºÄÂøÉ') || lowerContent.includes('ÈöæËøá') ||
                    lowerContent.includes('ÊãÖÂøÉ') || lowerContent.includes('ÂÆ≥ÊÄï') || lowerContent.includes('Á¥ßÂº†') ||
                    lowerContent.includes('ÁÑ¶Ëôë') || lowerContent.includes('ÈÉÅÈó∑') || lowerContent.includes('ÁÉ¶')) {
                    adjustment = 10;
                    recoveryTime = 6000;
                }
                // ÊößÊòßÂíåË∞ÉÊÉÖËØçÊ±á
                else if (lowerContent.includes('Ë∞ÉÊÉÖ') || lowerContent.includes('Êí©') || lowerContent.includes('ËØ±ÊÉë') ||
                    lowerContent.includes('sexy') || lowerContent.includes('È≠ÖÊÉë') || lowerContent.includes('ÂãæÂºï')) {
                    adjustment = 18;
                    recoveryTime = 7000;
                }
                // ÊôÆÈÄöÈóÆÂÄô
                else if (lowerContent.includes('‰Ω†Â•Ω') || lowerContent.includes('hi') || lowerContent.includes('hello') ||
                    lowerContent.includes('Êó©‰∏äÂ•Ω') || lowerContent.includes('ÊôöÂÆâ')) {
                    adjustment = 5;
                    recoveryTime = 3000;
                }
                
            } else {
                // AIËá™Â∑±ÂèëÈÄÅÊ∂àÊÅØÂêéÁöÑÂøÉÁéáÂèòÂåñ
                if (lowerContent.includes('ÂÆ≥Áæû') || lowerContent.includes('ËÑ∏Á∫¢') || lowerContent.includes('‰∏çÂ•ΩÊÑèÊÄù')) {
                    adjustment = 10;
                    recoveryTime = 5000;
                } else if (lowerContent.includes('ÂÖ¥Â•ã') || lowerContent.includes('ÂºÄÂøÉ') || lowerContent.includes('ÊøÄÂä®')) {
                    adjustment = 8;
                    recoveryTime = 4000;
                } else if (lowerContent.includes('Á¥ßÂº†') || lowerContent.includes('ÊãÖÂøÉ') || lowerContent.includes('ÁÑ¶Ëôë')) {
                    adjustment = 12;
                    recoveryTime = 6000;
                } else if (lowerContent.includes('Áà±') || lowerContent.includes('ÂñúÊ¨¢') || lowerContent.includes('ÊÉ≥')) {
                    adjustment = 15;
                    recoveryTime = 7000;
                }
            }
            
            // Â∫îÁî®Ë∞ÉÊï¥
            currentHeartrate = Math.max(55, Math.min(130, currentHeartrate + adjustment));
            
            // Êõ¥Ëá™ÁÑ∂ÁöÑÊÅ¢Â§çÊú∫Âà∂
            setTimeout(() => {
                const recoveryRate = Math.floor(adjustment * 0.6); // ÊÅ¢Â§ç60%
                currentHeartrate = Math.max(65, currentHeartrate - recoveryRate);
                
                // ÁªßÁª≠ÁºìÊÖ¢ÊÅ¢Â§ç
                setTimeout(() => {
                    const finalRecovery = Math.floor(adjustment * 0.3); // ÂÜçÊÅ¢Â§ç30%
                    currentHeartrate = Math.max(65, currentHeartrate - finalRecovery);
                }, recoveryTime * 0.5);
                
            }, recoveryTime);
        }

        document.addEventListener('DOMContentLoaded', () => {
        const db = new Dexie('GeminiChatDB');
        db.version(9).stores({ 
            chats: '&id, isGroup', 
            apiConfig: '&id', 
            globalSettings: '&id', 
            userStickers: '&id, url, name',
            worldBooks: '&id, name',
            musicLibrary: '&id', 
            personaPresets: '&id',
            weiboPosts: '&id, authorId, visibility, timestamp'
        });
        db.version(10).stores({
    chats: '&id, isGroup',
    apiConfig: '&id',
    globalSettings: '&id',
    userStickers: '&id, url, name',
    worldBooks: '&id, name',
    musicLibrary: '&id',
    personaPresets: '&id',
    // Êñ∞Â¢ûÂæÆÂçöÁõ∏ÂÖ≥ÁöÑË°®
    weiboPosts: '&id, authorId, timestamp, visibility',
    weiboComments: '&id, postId, authorId, timestamp',
    weiboLikes: '[postId+authorId], postId, authorId',
    weiboReposts: '&id, originalPostId, authorId, timestamp'
});
        db.version(11).stores({
    chats: '&id, isGroup',
    apiConfig: '&id',
    globalSettings: '&id',
    userStickers: '&id, url, name',
    worldBooks: '&id, name',
    musicLibrary: '&id',
    personaPresets: '&id',
    weiboPosts: '&id, authorId, timestamp, visibility',
    weiboComments: '&id, postId, authorId, timestamp',
    weiboLikes: '[postId+authorId], postId, authorId',
    weiboReposts: '&id, originalPostId, authorId, timestamp',
    // Êñ∞Â¢ûÂæÆÂçöËÆæÁΩÆË°®
    weiboSettings: '&id'
});

        // Êñ∞Â¢ûÁâàÊú¨12ÔºöÊ∑ªÂä†Â£ÅÁ∫∏Â≠òÂÇ®ÂíåÁî®Êà∑ËµÑÊñôÂ≠òÂÇ®
        db.version(12).stores({
    chats: '&id, isGroup',
    apiConfig: '&id',
    globalSettings: '&id',
    userStickers: '&id, url, name',
    worldBooks: '&id, name',
    musicLibrary: '&id',
    personaPresets: '&id',
    weiboPosts: '&id, authorId, timestamp, visibility',
    weiboComments: '&id, postId, authorId, timestamp',
    weiboLikes: '[postId+authorId], postId, authorId',
    weiboReposts: '&id, originalPostId, authorId, timestamp',
    weiboSettings: '&id',
    // Êñ∞Â¢ûË°®
    wallpapers: '&id, type, data, timestamp',  // Â£ÅÁ∫∏Â≠òÂÇ®
    userProfiles: '&id, type, data, timestamp', // Áî®Êà∑ËµÑÊñôÂ≠òÂÇ®
    apiConfigs: '&id, name, data, timestamp'    // APIÈÖçÁΩÆÂ≠òÂÇ®
});

        let state = { chats: {}, activeChatId: null, globalSettings: { iconPosition: 'center' }, apiConfig: {}, userStickers: [], worldBooks: [], personaPresets: [] };
        let musicState = { isActive: false, activeChatId: null, isPlaying: false, playlist: [], currentIndex: -1, playMode: 'order', totalElapsedTime: 0, timerId: null };
        const audioPlayer = document.getElementById('audio-player');
        let newWallpaperBase64 = null;

        // Áî®Êà∑ËµÑÊñôÁºìÂ≠ò
        let userProfileCache = {
            name: 'ÊàëÁöÑÂæÆÂçö',
            signature: 'ÂàÜ‰∫´ÁîüÊ¥ª‰∏≠ÁöÑÁæéÂ•ΩÁû¨Èó¥',
            email: '',
            avatar: 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg'
        };
        let isSelectionMode = false;
        let selectedMessages = new Set();
        let isWeiboSelectionMode = false;
        let selectedWeiboPosts = new Set();
        let editingMemberId = null;
        let editingWorldBookId = null;
        let editingPersonaPresetId = null;
        
        // ÈÄöËØùÁä∂ÊÄÅÁÆ°ÁêÜ
        let callState = {
            isInCall: false,
            callType: null, // 'voice' or 'video'
            activeChatId: null,
            startTime: null,
            timer: null,
            messages: [],
            userInitiated: false
        };
        const defaultAvatar = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
        const defaultMyGroupAvatar = 'https://i.postimg.cc/cLPP10Vm/4.jpg';
        const defaultGroupMemberAvatar = 'https://i.postimg.cc/VkQfgzGJ/1.jpg';
        const defaultGroupAvatar = 'https://i.postimg.cc/gc3QYCDy/1-NINE7-Five.jpg';
        let notificationTimeout;
        // ÊîØÊåÅÊõ¥Â§öÂõæÂ∫äÈìæÊé•Ê†ºÂºèÁöÑË°®ÊÉÖÂåÖÊ≠£ÂàôË°®ËææÂºè
        const STICKER_REGEX = /^(https?:\/\/(?:i\.postimg\.cc|imgur\.com|i\.imgur\.com|cdn\.discordapp\.com|media\.discordapp\.net|i\.ibb\.co|postimg\.cc|telegra\.ph|sm\.ms|imgbb\.com|imageban\.ru|prnt\.sc|gyazo\.com|i\.gyazo\.com|s3\.amazonaws\.com|cloudinary\.com|res\.cloudinary\.com|github\.com\/.*\/.*\.(?:png|jpg|jpeg|gif|webp)|raw\.githubusercontent\.com)\/.*\.?(?:png|jpg|jpeg|gif|webp|bmp)|data:image)/i;
        
        const MESSAGE_RENDER_WINDOW = 50;
        let currentRenderedCount = 0;

        let lastKnownBatteryLevel = 1;
        let alertFlags = { hasShown40: false, hasShown20: false, hasShown10: false };
        let batteryAlertTimeout;

        // ÊèêÂâçÂÆö‰πâapplyBorderlessModeÂáΩÊï∞
        function applyBorderlessMode() {
            const borderlessMode = state.globalSettings.borderlessMode || false;
            if (borderlessMode) {
                document.body.classList.add('borderless-mode');
            } else {
                document.body.classList.remove('borderless-mode');
            }

            // Êõ¥Êñ∞Â£ÅÁ∫∏ËÆæÁΩÆÁïåÈù¢ÁöÑÂºÄÂÖ≥Áä∂ÊÄÅ
            const toggle = document.getElementById('borderless-mode-toggle');
            if (toggle) {
                toggle.checked = borderlessMode;
            }
        }

        async function loadAllDataFromDB() { const [chatsArr, apiConfig, globalSettings, userStickers, worldBooks, musicLib, personaPresets] = await Promise.all([ db.chats.toArray(), db.apiConfig.get('main'), db.globalSettings.get('main'), db.userStickers.toArray(), db.worldBooks.toArray(), db.musicLibrary.get('main'), db.personaPresets.toArray() ]); state.chats = chatsArr.reduce((acc, chat) => { if (!chat.musicData) chat.musicData = { totalTime: 0 }; if (chat.settings && chat.settings.linkedWorldBookId && !chat.settings.linkedWorldBookIds) { chat.settings.linkedWorldBookIds = [chat.settings.linkedWorldBookId]; delete chat.settings.linkedWorldBookId; } acc[chat.id] = chat; return acc; }, {}); state.apiConfig = apiConfig || { id: 'main', proxyUrl: '', apiKey: '', model: '', temperature: 0.75 }; state.globalSettings = globalSettings || { id: 'main', wallpaper: 'linear-gradient(135deg, #89f7fe, #66a6ff)', iconPosition: 'center', fontSize: 'medium', borderlessMode: false, customBubbleCSS: '', customFontUrl: '', customFontFamily: '' }; state.userStickers = userStickers || []; state.worldBooks = worldBooks || []; musicState.playlist = musicLib?.playlist || []; state.personaPresets = personaPresets || []; applyIconPosition(); applyCustomIcons(); applyFontSize(); applyBorderlessMode(); applyCustomStyles(); }
        async function saveGlobalPlaylist() { await db.musicLibrary.put({ id: 'main', playlist: musicState.playlist }); }

        const modalOverlay = document.getElementById('custom-modal-overlay');
        const modalTitle = document.getElementById('custom-modal-title');
        const modalBody = document.getElementById('custom-modal-body');
        const modalConfirmBtn = document.getElementById('custom-modal-confirm');
        const modalCancelBtn = document.getElementById('custom-modal-cancel');
        let modalResolve;

        function showCustomModal() { modalOverlay.classList.add('visible'); }
        function hideCustomModal() { modalOverlay.classList.remove('visible'); modalConfirmBtn.classList.remove('btn-danger'); if (modalResolve) modalResolve(null); }
        modalCancelBtn.addEventListener('click', hideCustomModal);
        modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) hideCustomModal(); });

        function showCustomConfirm(title, message, options = {}) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p>${message}</p>`;
                modalCancelBtn.style.display = 'block';
                modalConfirmBtn.textContent = 'Á°ÆÂÆö';
                if (options.confirmButtonClass) modalConfirmBtn.classList.add(options.confirmButtonClass);
                modalConfirmBtn.onclick = () => { resolve(true); hideCustomModal(); };
                modalCancelBtn.onclick = () => { resolve(false); hideCustomModal(); };
                showCustomModal();
            });
        }

        function showCustomAlert(title, message) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p style="text-align: left; white-space: pre-wrap;">${message}</p>`;
                modalCancelBtn.style.display = 'none';
                modalConfirmBtn.textContent = 'Â•ΩÁöÑ';
                modalConfirmBtn.onclick = () => {
                    modalCancelBtn.style.display = 'block'; 
                    modalConfirmBtn.textContent = 'Á°ÆÂÆö';
                    resolve(true); 
                    hideCustomModal();
                };
                showCustomModal();
            });
        }
        
        // Â∞ÜÂáΩÊï∞Êö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
        window.showCustomAlert = showCustomAlert;
        
        // Âπ∂ÂèëËÅäÂ§©ÁÆ°ÁêÜÁ≥ªÁªü
        class ConcurrentChatManager {
            constructor() {
                this.activeRequests = new Map(); // chatId -> RequestInfo
                this.requestQueue = new Map(); // chatId -> Array of pending requests
            }
            
            // ÂàõÂª∫ËØ∑Ê±Ç‰ø°ÊÅØÂØπË±°
            createRequestInfo(chatId, type = 'chat') {
                return {
                    chatId,
                    type, // 'chat', 'weibo', 'call' Á≠â
                    timestamp: Date.now(),
                    abortController: new AbortController()
                };
            }
            
            // ÂºÄÂßãÊñ∞ÁöÑËØ∑Ê±Ç
            async startRequest(chatId, requestType, requestFunction, ...args) {
                // Â¶ÇÊûúËØ•ËÅäÂ§©Â∑≤ÊúâÊ¥ªË∑ÉËØ∑Ê±ÇÔºåÂ∞ÜÊñ∞ËØ∑Ê±ÇÂä†ÂÖ•ÈòüÂàó
                if (this.activeRequests.has(chatId)) {
                    console.log(`ËÅäÂ§© ${chatId} Â∑≤ÊúâÊ¥ªË∑ÉËØ∑Ê±ÇÔºåÂ∞ÜÊñ∞ËØ∑Ê±ÇÂä†ÂÖ•ÈòüÂàó`);
                    if (!this.requestQueue.has(chatId)) {
                        this.requestQueue.set(chatId, []);
                    }
                    this.requestQueue.get(chatId).push({
                        type: requestType,
                        function: requestFunction,
                        args: args,
                        timestamp: Date.now()
                    });
                    return null;
                }
                
                // ÂàõÂª∫Âπ∂ÂêØÂä®Êñ∞ËØ∑Ê±Ç
                const requestInfo = this.createRequestInfo(chatId, requestType);
                this.activeRequests.set(chatId, requestInfo);
                
                            // ÊòæÁ§∫ËØ•ËÅäÂ§©ÁöÑÂä†ËΩΩÁä∂ÊÄÅ
            this.showTypingIndicator(chatId, requestType);
            
            // Êõ¥Êñ∞ÂÖ®Â±ÄÁä∂ÊÄÅÊòæÁ§∫
            this.updateGlobalStatus();
                
                try {
                    // ÊâßË°åËØ∑Ê±ÇÂáΩÊï∞
                    const result = await requestFunction.apply(null, [requestInfo.abortController.signal, ...args]);
                    return result;
                } catch (error) {
                    if (error.name === 'AbortError') {
                        console.log(`ËØ∑Ê±ÇË¢´ÂèñÊ∂à: ${chatId} - ${requestType}`);
                        return null;
                    }
                    throw error;
                } finally {
                                    // Ê∏ÖÁêÜÂΩìÂâçËØ∑Ê±Ç
                this.activeRequests.delete(chatId);
                this.hideTypingIndicator(chatId);
                
                // Êõ¥Êñ∞ÂÖ®Â±ÄÁä∂ÊÄÅÊòæÁ§∫
                this.updateGlobalStatus();
                
                // Â§ÑÁêÜÈòüÂàó‰∏≠ÁöÑ‰∏ã‰∏Ä‰∏™ËØ∑Ê±Ç
                this.processNextRequest(chatId);
                }
            }
            
            // Â§ÑÁêÜÈòüÂàó‰∏≠ÁöÑ‰∏ã‰∏Ä‰∏™ËØ∑Ê±Ç
            async processNextRequest(chatId) {
                const queue = this.requestQueue.get(chatId);
                if (!queue || queue.length === 0) {
                    return;
                }
                
                const nextRequest = queue.shift();
                if (queue.length === 0) {
                    this.requestQueue.delete(chatId);
                }
                
                // Êõ¥Êñ∞ÂÖ®Â±ÄÁä∂ÊÄÅÊòæÁ§∫
                this.updateGlobalStatus();
                
                // ÊâßË°å‰∏ã‰∏Ä‰∏™ËØ∑Ê±Ç
                setTimeout(() => {
                    this.startRequest(
                        chatId,
                        nextRequest.type,
                        nextRequest.function,
                        ...nextRequest.args
                    );
                }, 100); // Áü≠ÊöÇÂª∂ËøüÈÅøÂÖçUIÈó™ÁÉÅ
            }
            
            // ÂèñÊ∂àÊåáÂÆöËÅäÂ§©ÁöÑÊâÄÊúâËØ∑Ê±Ç
            cancelRequests(chatId) {
                // ÂèñÊ∂àÊ¥ªË∑ÉËØ∑Ê±Ç
                const activeRequest = this.activeRequests.get(chatId);
                if (activeRequest) {
                    activeRequest.abortController.abort();
                    this.activeRequests.delete(chatId);
                }
                
                // Ê∏ÖÁ©∫ÈòüÂàó
                this.requestQueue.delete(chatId);
                
                // ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
                this.hideTypingIndicator(chatId);
                
                // Êõ¥Êñ∞ÂÖ®Â±ÄÁä∂ÊÄÅÊòæÁ§∫
                this.updateGlobalStatus();
            }
            
            // ÂèñÊ∂àÊâÄÊúâËØ∑Ê±Ç
            cancelAllRequests() {
                // ÂèñÊ∂àÊâÄÊúâÊ¥ªË∑ÉËØ∑Ê±Ç
                for (const [chatId, requestInfo] of this.activeRequests) {
                    requestInfo.abortController.abort();
                    this.hideTypingIndicator(chatId);
                }
                
                // Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ
                this.activeRequests.clear();
                this.requestQueue.clear();
                
                // Êõ¥Êñ∞ÂÖ®Â±ÄÁä∂ÊÄÅÊòæÁ§∫
                this.updateGlobalStatus();
            }
            
            // ÊòæÁ§∫ËæìÂÖ•Áä∂ÊÄÅÊåáÁ§∫Âô®
            showTypingIndicator(chatId, requestType) {
                // ‰∏∫ÊØè‰∏™ËÅäÂ§©ÂàõÂª∫Áã¨Á´ãÁöÑËæìÂÖ•ÊåáÁ§∫Âô®
                const indicatorId = `typing-indicator-${chatId}`;
                let indicator = document.getElementById(indicatorId);
                
                if (!indicator) {
                    // Â¶ÇÊûúÊòØÂΩìÂâçÊ¥ªË∑ÉËÅäÂ§©ÔºåÂú®ËÅäÂ§©Âå∫ÂüüÊòæÁ§∫
                    if (state.activeChatId === chatId) {
                        const messagesContainer = document.getElementById('chat-messages');
                        const existingIndicator = document.getElementById('typing-indicator');
                        if (existingIndicator) {
                            existingIndicator.style.display = 'block';
                            existingIndicator.textContent = this.getTypingText(requestType);
                        }
                    }
                    return;
                }
                
                // Êõ¥Êñ∞ÊåáÁ§∫Âô®ÊñáÊú¨
                indicator.style.display = 'block';
                indicator.textContent = this.getTypingText(requestType);
            }
            
            // ÈöêËóèËæìÂÖ•Áä∂ÊÄÅÊåáÁ§∫Âô®
            hideTypingIndicator(chatId) {
                const indicatorId = `typing-indicator-${chatId}`;
                const indicator = document.getElementById(indicatorId);
                
                if (indicator) {
                    indicator.style.display = 'none';
                }
                
                // Â¶ÇÊûúÊòØÂΩìÂâçÊ¥ªË∑ÉËÅäÂ§©Ôºå‰πüÈöêËóè‰∏ªË¶ÅÊåáÁ§∫Âô®
                if (state.activeChatId === chatId) {
                    const mainIndicator = document.getElementById('typing-indicator');
                    if (mainIndicator) {
                        mainIndicator.style.display = 'none';
                    }
                }
                
                // Êõ¥Êñ∞ËÅäÂ§©ÂàóË°®‰∏≠ÁöÑÁä∂ÊÄÅÊåáÁ§∫
                this.updateChatListStatus(chatId);
            }
            
            // Ëé∑Âèñ‰∏çÂêåËØ∑Ê±ÇÁ±ªÂûãÁöÑÊèêÁ§∫ÊñáÊú¨
            getTypingText(requestType) {
                const textMap = {
                    'chat': 'ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...',
                    'weibo': 'Ê≠£Âú®ÂèëÂ∏ÉÂæÆÂçö...',
                    'weibo_comment': 'Ê≠£Âú®ËØÑËÆ∫...',
                    'call': 'ÈÄöËØùËøûÊé•‰∏≠...',
                    'background': 'Ê≠£Âú®ÊÄùËÄÉ...'
                };
                return textMap[requestType] || 'Ê≠£Âú®Â§ÑÁêÜ...';
            }
            
            // Êõ¥Êñ∞ËÅäÂ§©ÂàóË°®‰∏≠ÁöÑÁä∂ÊÄÅÊòæÁ§∫
            updateChatListStatus(chatId) {
                const chatElement = document.querySelector(`[data-chat-id="${chatId}"]`);
                if (!chatElement) return;
                
                const statusIndicator = chatElement.querySelector('.chat-status-indicator');
                const hasActiveRequest = this.activeRequests.has(chatId);
                const hasQueuedRequests = this.requestQueue.has(chatId) && this.requestQueue.get(chatId).length > 0;
                
                if (statusIndicator) {
                    if (hasActiveRequest) {
                        statusIndicator.style.display = 'block';
                        statusIndicator.textContent = '‚óè';
                        statusIndicator.style.color = '#1aad19';
                    } else if (hasQueuedRequests) {
                        statusIndicator.style.display = 'block';
                        statusIndicator.textContent = '‚óã';
                        statusIndicator.style.color = '#ff9500';
                    } else {
                        statusIndicator.style.display = 'none';
                    }
                }
            }
            
            // Ëé∑ÂèñËØ∑Ê±ÇÁä∂ÊÄÅ
            getRequestStatus(chatId) {
                return {
                    hasActiveRequest: this.activeRequests.has(chatId),
                    queueLength: this.requestQueue.has(chatId) ? this.requestQueue.get(chatId).length : 0,
                    requestType: this.activeRequests.has(chatId) ? this.activeRequests.get(chatId).type : null
                };
            }
            
            // Êõ¥Êñ∞ÂÖ®Â±ÄÁä∂ÊÄÅÊòæÁ§∫
            updateGlobalStatus() {
                const statusElement = document.getElementById('concurrent-status');
                const statusText = document.getElementById('concurrent-status-text');
                
                if (!statusElement || !statusText) return;
                
                const activeCount = this.activeRequests.size;
                const totalQueueCount = Array.from(this.requestQueue.values()).reduce((sum, queue) => sum + queue.length, 0);
                
                if (activeCount === 0 && totalQueueCount === 0) {
                    statusElement.style.display = 'none';
                } else {
                    statusElement.style.display = 'block';
                    if (totalQueueCount > 0) {
                        statusText.textContent = `Ê≠£Âú®Â§ÑÁêÜ ${activeCount} ‰∏™ËØ∑Ê±ÇÔºåÁ≠âÂæÖ ${totalQueueCount} ‰∏™`;
                    } else {
                        statusText.textContent = `Ê≠£Âú®Â§ÑÁêÜ ${activeCount} ‰∏™ËØ∑Ê±Ç`;
                    }
                }
            }
        }
        
        // ÂàõÂª∫ÂÖ®Â±ÄÂπ∂ÂèëËÅäÂ§©ÁÆ°ÁêÜÂô®
        window.concurrentChatManager = new ConcurrentChatManager();
        
        // È°µÈù¢Âç∏ËΩΩÊó∂ÂèñÊ∂àÊâÄÊúâËØ∑Ê±Ç
        window.addEventListener('beforeunload', () => {
            window.concurrentChatManager.cancelAllRequests();
        });
        
        // Ê†πÊçÆÂØπËØùËΩÆÊï∞Ëé∑ÂèñÂéÜÂè≤Ê∂àÊÅØ
        function getHistoryByRounds(chatHistory, maxRounds) {
            if (!chatHistory || chatHistory.length === 0 || maxRounds <= 0) {
                return [];
            }
            
            const rounds = [];
            let currentRound = [];
            let waitingForAI = false;
            
            // ‰ªéÊúÄÊñ∞Ê∂àÊÅØÂºÄÂßãÂæÄÂâçÈÅçÂéÜ
            for (let i = chatHistory.length - 1; i >= 0; i--) {
                const message = chatHistory[i];
                
                if (message.role === 'user') {
                    if (waitingForAI) {
                        // Â¶ÇÊûú‰πãÂâçÂú®Á≠âÂæÖAIÂõûÂ§çÔºåËØ¥Êòé‰∏ä‰∏ÄËΩÆÂÆåÊàê‰∫Ü
                        if (currentRound.length > 0) {
                            rounds.unshift([...currentRound]);
                            currentRound = [];
                        }
                    }
                    currentRound.unshift(message);
                    waitingForAI = true;
                } else if (message.role === 'assistant') {
                    if (waitingForAI) {
                        currentRound.unshift(message);
                        // ÁªßÁª≠Á≠âÂæÖÂèØËÉΩÁöÑÊõ¥Â§öAIÊ∂àÊÅØ
                    } else {
                        // ËøôÊòØ‰∏Ä‰∏™Â≠§Á´ãÁöÑAIÊ∂àÊÅØÔºå‰Ωú‰∏∫Áã¨Á´ãËΩÆÊ¨°
                        if (currentRound.length > 0) {
                            rounds.unshift([...currentRound]);
                        }
                        currentRound = [message];
                    }
                }
                
                // Â¶ÇÊûúÊî∂ÈõÜÂà∞Ë∂≥Â§üÁöÑËΩÆÊï∞Â∞±ÂÅúÊ≠¢
                if (rounds.length >= maxRounds) {
                    break;
                }
            }
            
            // Â§ÑÁêÜÊúÄÂêé‰∏ÄËΩÆ
            if (currentRound.length > 0 && rounds.length < maxRounds) {
                rounds.unshift([...currentRound]);
            }
            
            // Âè™‰øùÁïôÊåáÂÆöÊï∞ÈáèÁöÑËΩÆÊï∞
            const selectedRounds = rounds.slice(-maxRounds);
            
            // Â∞ÜËΩÆÊï∞Â±ïÂπ≥‰∏∫Ê∂àÊÅØÊï∞ÁªÑ
            const result = [];
            for (const round of selectedRounds) {
                result.push(...round);
            }
            
            return result;
        }
        
        // ÂõæÁâáÊü•ÁúãÂô®ÂäüËÉΩ
        function showImageViewer(imageSrc) {
            const modal = document.getElementById('image-viewer-modal');
            const viewerImage = document.getElementById('viewer-image');
            
            viewerImage.src = imageSrc;
            modal.classList.add('visible');
        }
        
        function hideImageViewer() {
            const modal = document.getElementById('image-viewer-modal');
            modal.classList.remove('visible');
        }
        
        // ÂõæÁâáÊü•ÁúãÂô®‰∫ã‰ª∂ÁõëÂê¨ - Á´ãÂç≥ÂàùÂßãÂåñ
        function initImageViewer() {
            const modal = document.getElementById('image-viewer-modal');
            const closeBtn = document.querySelector('.image-viewer-close');
            
            // ÁÇπÂáªÂÖ≥Èó≠ÊåâÈíÆ
            if (closeBtn) {
                closeBtn.addEventListener('click', hideImageViewer);
            }
            
            // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜËÉåÊôØÂÖ≥Èó≠
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        hideImageViewer();
                    }
                });
            }
            
            // ÊåâESCÈîÆÂÖ≥Èó≠
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal.classList.contains('visible')) {
                    hideImageViewer();
                }
            });
        }
        
        // Á´ãÂç≥ÂàùÂßãÂåñÂõæÁâáÊü•ÁúãÂô®
        initImageViewer();

        function showCustomPrompt(title, placeholder, initialValue = '', type = 'text') {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<input type="${type}" id="custom-prompt-input" placeholder="${placeholder}" value="${initialValue}">`;
                const input = document.getElementById('custom-prompt-input');
                modalConfirmBtn.onclick = () => { resolve(input.value); hideCustomModal(); };
                modalCancelBtn.onclick = () => { resolve(null); hideCustomModal(); };
                showCustomModal();
                setTimeout(() => input.focus(), 100);
            });
        }
        
        // Ê∑ªÂä†ÁÆÄÂçïÁöÑtoastÊèêÁ§∫ÂáΩÊï∞
        function showToast(message, type = 'info') {
            // ÂàõÂª∫toastÂÖÉÁ¥†
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // ÊòæÁ§∫toast
            setTimeout(() => {
                toast.style.opacity = '1';
            }, 10);
            
            // 3ÁßíÂêéËá™Âä®ÈöêËóè
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
        
        function formatTimestamp(timestamp) { if (!timestamp) return ''; const date = new Date(timestamp); const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); return `${hours}:${minutes}`; }
        function showNotification(chatId, messageContent, type = 'chat') { 
            clearTimeout(notificationTimeout); 
            
            const bar = document.getElementById('notification-bar');
            
            if (type === 'weibo') {
                // ÂæÆÂçöÈÄöÁü•
                const ai = state.chats[chatId];
                if (!ai) return;
                
                document.getElementById('notification-avatar').src = ai.settings.aiAvatar || defaultAvatar;
                document.getElementById('notification-content').querySelector('.name').textContent = ai.name;
                document.getElementById('notification-content').querySelector('.message').textContent = messageContent;
                
                const newBar = bar.cloneNode(true);
                bar.parentNode.replaceChild(newBar, bar);
                newBar.addEventListener('click', () => { 
                    showScreen('weibo-screen');
                    newBar.classList.remove('visible'); 
                });
                newBar.classList.add('visible');
                notificationTimeout = setTimeout(() => { newBar.classList.remove('visible'); }, 4000);
            } else {
                // ËÅäÂ§©ÈÄöÁü•
                const chat = state.chats[chatId];
                if (!chat) return;
                
                document.getElementById('notification-avatar').src = chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar;
                document.getElementById('notification-content').querySelector('.name').textContent = chat.name;
                document.getElementById('notification-content').querySelector('.message').textContent = messageContent;
                
                const newBar = bar.cloneNode(true);
                bar.parentNode.replaceChild(newBar, bar);
                newBar.addEventListener('click', () => { 
                    openChat(chatId); 
                    newBar.classList.remove('visible'); 
                });
                newBar.classList.add('visible');
                notificationTimeout = setTimeout(() => { newBar.classList.remove('visible'); }, 4000);
            }
        }
        function updateClock() { const now = new Date(); const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); const dateString = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' }); document.getElementById('main-time').textContent = timeString; document.getElementById('status-bar-time').textContent = timeString; document.getElementById('main-date').textContent = dateString; }
        function parseAiResponse(content) {
            // Ëé∑ÂèñÂΩìÂâçËÅäÂ§©ÁöÑËÆæÁΩÆ
            const chat = state.chats[state.activeChatId];
            const isOnlineMode = chat && chat.settings && chat.settings.chatMode === 'online';

            // È¶ñÂÖàÂ∞ùËØïËß£ÊûêJSONÊï∞ÁªÑÊ†ºÂºè
            try {
                const parsed = JSON.parse(content);
                if (Array.isArray(parsed)) return parsed;
            } catch (e) {}

            // Â∞ùËØïÊèêÂèñJSONÊï∞ÁªÑÈÉ®ÂàÜ
            try {
                const match = content.match(/\[(.*?)\]/s);
                if (match && match[0]) {
                    const parsed = JSON.parse(match[0]);
                    if (Array.isArray(parsed)) return parsed;
                }
            } catch (e) {}

            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´JSONÂØπË±°Ê†ºÂºèÁöÑÊ∂àÊÅØ
            if (content.includes('"content"') && content.includes('"name"')) {
                try {
                    // Â∞ùËØïËß£ÊûêÂçï‰∏™JSONÂØπË±°
                    const parsed = JSON.parse(content);
                    if (parsed.content) return [parsed];
                } catch (e) {
                    // Â∞ùËØïÊèêÂèñÂ§ö‰∏™JSONÂØπË±°
                    const jsonObjects = content.match(/\{[^{}]*"content"[^{}]*\}/g);
                    if (jsonObjects) {
                        const messages = [];
                        for (const jsonStr of jsonObjects) {
                            try {
                                const obj = JSON.parse(jsonStr);
                                if (obj.content) messages.push(obj);
                            } catch (e) {}
                        }
                        if (messages.length > 0) return messages;
                    }
                }
            }

            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´Á≥ªÁªüÊ∂àÊÅØÊ†áËÆ∞ÔºàÊñπÊã¨Âè∑ÂÜÖÂÆπÔºâ
            const systemMessagePattern = /\[.*?\]/g;
            const systemMessages = content.match(systemMessagePattern);

            if (systemMessages && systemMessages.length > 0) {
                // ÂàÜÁ¶ªÁ≥ªÁªüÊ∂àÊÅØÂíåÊôÆÈÄöÊ∂àÊÅØ
                let remainingContent = content;
                const messages = [];

                // ÊèêÂèñÊâÄÊúâÁ≥ªÁªüÊ∂àÊÅØ
                for (const sysMsg of systemMessages) {
                    messages.push({
                        type: 'system_message',
                        content: sysMsg
                    });
                    remainingContent = remainingContent.replace(sysMsg, '').trim();
                }

                // Â§ÑÁêÜÂâ©‰ΩôÁöÑÊôÆÈÄöÊ∂àÊÅØÂÜÖÂÆπ
                if (remainingContent) {
                    if (isOnlineMode) {
                        // Á∫ø‰∏äÊ®°ÂºèÔºöÊØèÂè•ËØùÂàÜ‰∏Ä‰∏™Ê∞îÊ≥°Ôºå‰ΩÜ‰øùÊä§ÁΩëÂùÄ‰∏çË¢´ÂàÜÂâ≤

                        // ÂÖàÊèêÂèñÂπ∂‰øùÊä§ÁΩëÂùÄ
                        const urlPattern = /(https?:\/\/[^\s]+)/g;
                        const urls = [];
                        let protectedContent = remainingContent.replace(urlPattern, (match) => {
                            urls.push(match);
                            return `__URL_PLACEHOLDER_${urls.length - 1}__`;
                        });

                        const sentences = protectedContent.split(/[„ÄÇÔºÅÔºü.!?]/)
                            .map(s => s.trim())
                            .filter(s => s.length > 0);

                        if (sentences.length > 1) {
                            // ÈáçÊñ∞Ê∑ªÂä†Ê†áÁÇπÁ¨¶Âè∑
                            const punctuations = protectedContent.match(/[„ÄÇÔºÅÔºü.!?]/g) || [];
                            for (let i = 0; i < sentences.length; i++) {
                                if (sentences[i]) {
                                    const punct = punctuations[i] || '';
                                    let sentence = sentences[i] + punct;

                                    // ÊÅ¢Â§çÁΩëÂùÄ
                                    urls.forEach((url, index) => {
                                        sentence = sentence.replace(`__URL_PLACEHOLDER_${index}__`, url);
                                    });

                                    messages.push(sentence);
                                }
                            }
                        } else {
                            // ÊÅ¢Â§çÁΩëÂùÄ
                            let restoredContent = remainingContent;
                            urls.forEach((url, index) => {
                                restoredContent = restoredContent.replace(`__URL_PLACEHOLDER_${index}__`, url);
                            });
                            messages.push(restoredContent);
                        }
                    } else {
                        // Á∫ø‰∏ãÊ®°ÂºèÔºöÊâÄÊúâÂÜÖÂÆπÊîæÂú®‰∏Ä‰∏™Ê∞îÊ≥°
                        messages.push(remainingContent);
                    }
                }

                return messages.filter(msg => {
                    if (typeof msg === 'string') return msg.trim().length > 0;
                    return msg.content && msg.content.trim().length > 0;
                });
            }

            // Â¶ÇÊûúÊ≤°ÊúâÁ≥ªÁªüÊ∂àÊÅØÔºåÊåâÁÖßÊ®°ÂºèÂ§ÑÁêÜ
            if (isOnlineMode) {
                // Á∫ø‰∏äÊ®°ÂºèÔºö‰∏•Ê†ºÊåâÂè•ÂàÜÂâ≤Ôºå‰ΩÜ‰øùÊä§ÁΩëÂùÄ‰∏çË¢´ÂàÜÂâ≤

                // ÂÖàÊèêÂèñÂπ∂‰øùÊä§ÁΩëÂùÄ
                const urlPattern = /(https?:\/\/[^\s]+)/g;
                const urls = [];
                let protectedContent = content.replace(urlPattern, (match) => {
                    urls.push(match);
                    return `__URL_PLACEHOLDER_${urls.length - 1}__`;
                });

                const sentences = protectedContent.split(/[„ÄÇÔºÅÔºü.!?]/)
                    .map(s => s.trim())
                    .filter(s => s.length > 0);

                if (sentences.length > 1) {
                    // ÈáçÊñ∞Ê∑ªÂä†Ê†áÁÇπÁ¨¶Âè∑
                    const punctuations = protectedContent.match(/[„ÄÇÔºÅÔºü.!?]/g) || [];
                    const result = [];
                    for (let i = 0; i < sentences.length; i++) {
                        if (sentences[i]) {
                            const punct = punctuations[i] || '';
                            let sentence = sentences[i] + punct;

                            // ÊÅ¢Â§çÁΩëÂùÄ
                            urls.forEach((url, index) => {
                                sentence = sentence.replace(`__URL_PLACEHOLDER_${index}__`, url);
                            });

                            result.push(sentence);
                        }
                    }
                    return result.filter(s => s.trim().length > 0);
                } else {
                    // ÊÅ¢Â§çÁΩëÂùÄ
                    let restoredContent = content;
                    urls.forEach((url, index) => {
                        restoredContent = restoredContent.replace(`__URL_PLACEHOLDER_${index}__`, url);
                    });
                    return [restoredContent];
                }
            } else {
                // Á∫ø‰∏ãÊ®°ÂºèÔºö‰øùÊåÅ‰∏∫‰∏Ä‰∏™ÂÆåÊï¥Ê∂àÊÅØÔºå‰ΩÜÂèØ‰ª•ÂåÖÂê´Êç¢Ë°å
                return [content];
            }

            // ÈªòËÆ§ËøîÂõûÂéüÂÜÖÂÆπ
            return [content];
        }
        function renderApiSettings() { 
    document.getElementById('proxy-url').value = state.apiConfig.proxyUrl || ''; 
    document.getElementById('api-key').value = state.apiConfig.apiKey || '';
    const temperatureSlider = document.getElementById('temperature-slider');
    const temperatureValue = document.getElementById('temperature-value');
    temperatureSlider.value = state.apiConfig.temperature || 0.75;
    temperatureValue.textContent = state.apiConfig.temperature || 0.75;
    
    // Ê∑ªÂä†Ê∏©Â∫¶ÊªëÂùóÁöÑ‰∫ã‰ª∂ÁõëÂê¨
    temperatureSlider.addEventListener('input', function() {
        temperatureValue.textContent = this.value;
        state.apiConfig.temperature = parseFloat(this.value);
    });
}
        window.renderApiSettingsProxy = renderApiSettings;
        
        function renderChatList() { 
            const chatListEl = document.getElementById('chat-list'); 
            chatListEl.innerHTML = ''; 
            
            if (Object.keys(state.chats).length === 0) { 
                chatListEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ÁÇπÂáªÂè≥‰∏äËßí "+" ÊàñÁæ§ÁªÑÂõæÊ†áÊ∑ªÂä†ËÅäÂ§©</p>'; 
                return; 
            } 
            
            Object.values(state.chats).sort((a,b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0)).forEach(chat => { 
                const lastMsgObj = chat.history.slice(-1)[0] || {}; 
                let lastMsgDisplay; 
                
                if(lastMsgObj.type === 'transfer') { 
                    lastMsgDisplay = '[ËΩ¨Ë¥¶]'; 
                } else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo') { 
                    lastMsgDisplay = '[ÁÖßÁâá]'; 
                } else if (lastMsgObj.type === 'voice_message') { 
                    lastMsgDisplay = '[ËØ≠Èü≥]'; 
                } else if (typeof lastMsgObj.content === 'string' && STICKER_REGEX.test(lastMsgObj.content)) { 
                    lastMsgDisplay = lastMsgObj.meaning ? `[Ë°®ÊÉÖ: ${lastMsgObj.meaning}]` : '[Ë°®ÊÉÖ]'; 
                } else if (Array.isArray(lastMsgObj.content)) { 
                    lastMsgDisplay = `[ÂõæÁâá]`; 
                } else { 
                    lastMsgDisplay = String(lastMsgObj.content || '...').substring(0, 20); 
                } 
                
                if (chat.isGroup && lastMsgObj.senderName) { 
                    lastMsgDisplay = `${lastMsgObj.senderName}: ${lastMsgDisplay}`; 
                } 
                
                const item = document.createElement('div'); 
                item.className = 'chat-list-item'; 
                item.dataset.chatId = chat.id; 
                const avatar = chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar; 
                
                item.innerHTML = `
                    <img src="${avatar || defaultAvatar}" class="avatar">
                    <div class="info">
                        <div class="name-line">
                            <span class="name">${chat.name}</span>
                            ${chat.isGroup ? '<span class="group-tag">Áæ§ËÅä</span>' : ''}
                        </div>
                        <div class="last-msg">${lastMsgDisplay}</div>
                    </div>
                    <span class="chat-status-indicator"></span>
                `; 
                
                item.addEventListener('click', async () => { 
                    openChat(chat.id); 
                }); 
                
                addLongPressListener(item, async (e) => { 
                    const confirmed = await showCustomConfirm('Âà†Èô§ÂØπËØù', `Á°ÆÂÆöË¶ÅÂà†Èô§‰∏é "${chat.name}" ÁöÑÊï¥‰∏™ÂØπËØùÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`, { confirmButtonClass: 'btn-danger' }); 
                    if (confirmed) { 
                        try { 
                            if (musicState.isActive && musicState.activeChatId === chat.id) await endListenTogetherSession(false); 
                            // ÂèñÊ∂àËØ•ËÅäÂ§©ÁöÑÊâÄÊúâËØ∑Ê±Ç
                            window.concurrentChatManager.cancelRequests(chat.id);
                            delete state.chats[chat.id]; 
                            if (state.activeChatId === chat.id) state.activeChatId = null; 
                            await db.chats.delete(chat.id); 
                            renderChatList(); 
                        } catch (error) { 
                            console.error("Âà†Èô§ËÅäÂ§©Â§±Ë¥•:", error); 
                            alert("Âà†Èô§Â§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ"); 
                        } 
                    } 
                }); 
                
                // ÂàùÂßãÂåñÁä∂ÊÄÅÊòæÁ§∫
                if (window.concurrentChatManager) {
                    window.concurrentChatManager.updateChatListStatus(chat.id);
                }
                
                chatListEl.appendChild(item); 
            }); 
        }
        window.renderChatListProxy = renderChatList;
        window.renderWeiboTimelineProxy = renderWeiboTimeline;
        window.handleLikeProxy = handleLike;
        window.handleCommentProxy = handleComment;
        window.handleRepostProxy = handleRepost;
        window.handleReplyCommentProxy = handleReplyComment;
        
        // Ê†ºÂºèÂåñÂæÆÂçöÂÜÖÂÆπÔºåÊîØÊåÅ@Áî®Êà∑È´ò‰∫Æ
        function formatWeiboContent(content) {
            if (!content) return '';
            // ÂÖàÂ§ÑÁêÜÊç¢Ë°åÁ¨¶ÔºåÂ∞ÜÂÖ∂ËΩ¨Êç¢‰∏∫HTMLÁöÑÊç¢Ë°å
            content = content.replace(/\n/g, '<br>');
            // @Áî®Êà∑ÂêçÈ´ò‰∫Æ
            return content.replace(/@([^\s@<>]+)/g, '<span style="color:var(--weibo-accent);font-weight:500;">@$1</span>');
        }
        
        async function renderWeiboTimeline(filter = 'all') {
    const timeline = document.getElementById('weibo-timeline');
    timeline.innerHTML = '';
    
    // Ëé∑Âèñ‰øùÂ≠òÁöÑÈÄèÊòéÂ∫¶ËÆæÁΩÆ
    const savedOpacity = (await db.userProfiles.get('weibo_card_opacity'))?.data || 1.0;
    
    // Â¶ÇÊûúÊòØ"ÊàëÁöÑ"È°µÈù¢ÔºåÂÖàÊòæÁ§∫Áî®Êà∑ËµÑÊñôÂç°
    if (filter === 'mine') {
        const profileCard = document.createElement('div');
        profileCard.id = 'weibo-profile-card';
        profileCard.style.cssText = 'background: var(--weibo-card-bg); margin: 10px; border-radius: 16px; padding: 20px; border: 1.5px solid var(--weibo-card-border); box-shadow: 0 2px 8px rgba(0,0,0,0.04);';
        
        // Ëé∑ÂèñÁî®Êà∑ËµÑÊñô
        const savedProfileData = await db.userProfiles.get('weibo_user_profile');
        const profile = savedProfileData ? savedProfileData.data : {};
        const userName = profile.name || 'ÊàëÁöÑÂæÆÂçö';
        const userSignature = profile.signature || 'ÂàÜ‰∫´ÁîüÊ¥ª‰∏≠ÁöÑÁæéÂ•ΩÁû¨Èó¥';
        const userAvatar = profile.avatar || 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
        
        // ÁîüÊàêÊàñËé∑ÂèñÁ§æ‰∫§ÁªüËÆ°Êï∞ÊçÆ
        const followingCount = profile.followingCount || Math.floor(Math.random() * 200 + 50);
        const followersCount = profile.followersCount || Math.floor(Math.random() * 300 + 100);
        const likesCount = profile.likesCount || Math.floor(Math.random() * 1000 + 200);
        
        // ‰øùÂ≠òÁªüËÆ°Êï∞ÊçÆ‰ª•‰øùÊåÅ‰∏ÄËá¥ÊÄß
        if (!profile.followingCount) {
            profile.followingCount = followingCount;
            profile.followersCount = followersCount;
            profile.likesCount = likesCount;
            await db.userProfiles.put({
                id: 'weibo_user_profile',
                type: 'weibo_profile',
                data: profile,
                timestamp: Date.now()
            });
        }
        
        profileCard.innerHTML = `
            <div style="display:flex;align-items:center;gap:15px;margin-bottom:15px;">
                <img src="${userAvatar}" style="width:60px;height:60px;border-radius:50%;object-fit:cover;cursor:pointer;" onclick="window.showSocialProfileSafe && window.showSocialProfileSafe('user')">
                <div style="flex:1;">
                    <div style="font-weight:600;font-size:18px;margin-bottom:5px;cursor:pointer;" onclick="window.showSocialProfileSafe && window.showSocialProfileSafe('user')">${userName}</div>
                    <div style="font-size:14px;color:var(--weibo-secondary);line-height:1.4;">${userSignature}</div>
                </div>
                <button id="edit-profile-btn" style="background: var(--weibo-accent); color: white; border: none; border-radius: 20px; padding: 8px 16px; font-size: 12px; cursor: pointer;">ÁºñËæëËµÑÊñô</button>
            </div>
            <div style="display:flex;justify-content:space-around;padding:10px 0;border-top:1px solid var(--weibo-card-border);">
                <div style="text-align:center;">
                    <div style="font-weight:600;font-size:16px;">${followingCount}</div>
                    <div style="font-size:12px;color:var(--weibo-secondary);">ÂÖ≥Ê≥®</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-weight:600;font-size:16px;">${followersCount}</div>
                    <div style="font-size:12px;color:var(--weibo-secondary);">Á≤â‰∏ù</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-weight:600;font-size:16px;">${likesCount}</div>
                    <div style="font-size:12px;color:var(--weibo-secondary);">Ëé∑Ëµû</div>
                </div>
            </div>
        `;
        
        timeline.appendChild(profileCard);
        
        // Ê∑ªÂä†ÁºñËæëËµÑÊñôÊåâÈíÆ‰∫ã‰ª∂
        profileCard.querySelector('#edit-profile-btn').addEventListener('click', () => {
            document.getElementById('weibo-profile-modal').classList.add('visible');

            // Âä†ËΩΩÂΩìÂâçÁî®Êà∑ËµÑÊñôÂà∞ÁºñËæëË°®Âçï
            document.getElementById('profile-name-input').value = userProfileCache.name || 'ÊàëÁöÑÂæÆÂçö';
            document.getElementById('profile-signature-input').value = userProfileCache.signature || 'ÂàÜ‰∫´ÁîüÊ¥ª‰∏≠ÁöÑÁæéÂ•ΩÁû¨Èó¥';
            document.getElementById('profile-email-input').value = userProfileCache.email || '';
            document.getElementById('profile-avatar-preview').src = userProfileCache.avatar || 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';

            // Âä†ËΩΩÁî®Êà∑ÁöÑÁ§æ‰∫§‰∏ªÈ°µËÉåÊôØ
            const userBgPreview = document.getElementById('user-profile-bg-preview');
            if (userProfileCache.socialBackground) {
                userBgPreview.style.backgroundImage = `url(${userProfileCache.socialBackground})`;
                userBgPreview.textContent = '';
                document.getElementById('remove-user-profile-bg-btn').style.display = 'block';
            } else {
                userBgPreview.style.backgroundImage = '';
                userBgPreview.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                userBgPreview.textContent = 'ÈªòËÆ§Ê∏êÂèòËÉåÊôØ';
                document.getElementById('remove-user-profile-bg-btn').style.display = 'none';
            }
        });
    }
    
    let posts;
    if (filter === 'mine') {
        posts = await db.weiboPosts
            .where('authorId')
            .equals('user')
            .reverse()
            .sortBy('timestamp');
    } else {
        posts = await db.weiboPosts
            .reverse()
            .sortBy('timestamp');
    }

    for (const post of posts) {
        const postElement = document.createElement('div');
        postElement.className = 'weibo-post';
        postElement.dataset.postId = post.id;
        
        // Â∫îÁî®‰øùÂ≠òÁöÑÈÄèÊòéÂ∫¶ËÆæÁΩÆ
        postElement.style.opacity = savedOpacity;
        
        // Ê†πÊçÆÂèØËßÅÊÄßËøáÊª§
        if (post.authorId !== 'user') {
            // ÁßÅÂØÜÂä®ÊÄÅÔºöÂè™ÊúâÂèëÂ∏ÉËÄÖÂíåÁî®Êà∑ÂèØËßÅ
            if (post.visibility === 'private') {
                continue;
            }
            
            // Â•ΩÂèãÂèØËßÅÂä®ÊÄÅÔºöÂè™ÊúâÁæ§ËÅäÂ•ΩÂèãÂèØËßÅ
            if (post.visibility === 'friends') {
                // Ê£ÄÊü•ÂΩìÂâçÁî®Êà∑‰∏éÂèëÂ∏ÉËÄÖÊòØÂê¶Âú®Âêå‰∏Ä‰∏™Áæ§ËÅä‰∏≠
                const isUserFriend = Object.values(state.chats)
                    .filter(c => c.isGroup)
                    .some(group => 
                        group.members && 
                        group.members.includes('user') && 
                        group.members.includes(post.authorId)
                    );
                
                if (!isUserFriend) {
                    continue; // ‰∏çÊòØÁæ§ËÅäÂ•ΩÂèãÔºå‰∏çÊòæÁ§∫
                }
            }
        }
        
        const timestamp = new Date(post.timestamp).toLocaleString('zh-CN', {
            month: 'numeric',
            day: 'numeric',
            hour: 'numeric',
            minute: 'numeric'
        });

        // Ëé∑ÂèñÁÇπËµûÊï∞
        const likesCount = await db.weiboLikes
            .where('postId')
            .equals(post.id)
            .count();
            
        // Ëé∑ÂèñËØÑËÆ∫Êï∞
        const commentsCount = await db.weiboComments
            .where('postId')
            .equals(post.id)
            .count();
            
        // Ëé∑ÂèñËΩ¨ÂèëÊï∞    
        const repostsCount = await db.weiboReposts
            .where('originalPostId')
            .equals(post.id)
            .count();

        // Ê£ÄÊü•ÂΩìÂâçÁî®Êà∑ÊòØÂê¶Â∑≤ÁÇπËµû
        const hasLiked = await db.weiboLikes
            .where('[postId+authorId]')
            .equals([post.id, 'user'])
            .count() > 0;

        // Êñ∞Â¢ûÔºö‰∏™ÊÄßÁ≠æÂêçÔºàÂ¶ÇÊûúÊúâÔºâ
        const signature = post.authorSignature || post.authorEmail || '';
        // Â§¥ÂÉè
        const avatar = post.authorAvatar || 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
        // ID
        const nickname = post.authorName || 'Êú™Áü•';
        // ÈÇÆÁÆ±/Á≠æÂêç
        const email = post.authorEmail || '';
        
        // ÂÜÖÂÆπ
        let contentHtml = '';
        
        // ÂÖàÊòæÁ§∫ÊñáÂ≠óÂÜÖÂÆπÔºåÂÜçÊòæÁ§∫ÂõæÁâá
        if (post.description) {
            contentHtml += `<div style="color:var(--weibo-content-color);text-align:left;font-size:16px;margin:10px 0 0 0;line-height:1.7;">${formatWeiboContent(post.description)}</div>`;
        } else if (post.content) {
            contentHtml += `<div style="color:var(--weibo-content-color);text-align:left;font-size:16px;margin:10px 0 0 0;line-height:1.7;">${formatWeiboContent(post.content)}</div>`;
        }
        
        // Â¶ÇÊûúÊòØËΩ¨ÂèëÔºåÊòæÁ§∫ËΩ¨ÂèëÂºïÁî®ÔºàÊîæÂú®Ëá™Â∑±ÁöÑËΩ¨ÂèëÊñáÊ°à‰∏ãÊñπÔºâ
        if (post.isRepost && post.originalPostId) {
            // Ëé∑ÂèñÂéüÂä®ÊÄÅ‰ø°ÊÅØ
            const originalPost = await db.weiboPosts.get(post.originalPostId);
            if (originalPost) {
                contentHtml += `
                    <div style="background: #f8f9fa; border-radius: 10px; padding: 12px; margin-top: 10px; border-left: 3px solid var(--weibo-accent);">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;font-size:13px;color:var(--weibo-secondary);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 1l4 4-4 4"></path><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><path d="M7 23l-4-4 4-4"></path><path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
                            </svg>
                            <span>ËΩ¨ÂèëËá™ @${originalPost.authorName}</span>
                        </div>
                        <div style="font-size:15px;line-height:1.5;text-align:left;">${originalPost.content}</div>
                    </div>
                `;
            }
        }
        
        if (post.imageUrl) {
            // Á°Æ‰øùÂõæÁâáÊ≠£Á°ÆÊòæÁ§∫ÔºåÂπ∂Ê∑ªÂä†ÂèØÁÇπÂáªÂäüËÉΩÔºåÁÇπÂáªÊòæÁ§∫ÂõæÁâáÊèèËø∞
            if (post.imageDescription) {
                // Ê≠£Á°ÆËΩ¨‰πâÂõæÁâáÊèèËø∞ÔºåÈÅøÂÖçJavaScriptËØ≠Ê≥ïÈîôËØØ
                const escapedDescription = post.imageDescription
                    .replace(/\\/g, '\\\\')  // ËΩ¨‰πâÂèçÊñúÊù†
                    .replace(/'/g, "\\'")    // ËΩ¨‰πâÂçïÂºïÂè∑
                    .replace(/"/g, '\\"')    // ËΩ¨‰πâÂèåÂºïÂè∑
                    .replace(/\n/g, '\\n')   // ËΩ¨‰πâÊç¢Ë°åÁ¨¶
                    .replace(/\r/g, '\\r')   // ËΩ¨‰πâÂõûËΩ¶Á¨¶
                    .replace(/\t/g, '\\t');  // ËΩ¨‰πâÂà∂Ë°®Á¨¶
                contentHtml += `<div style="text-align:center;margin:10px 0;">
                    <img src="${post.imageUrl}" alt="ÂæÆÂçöÂõæÁâá" style="max-width:100%;border-radius:10px;display:inline-block;cursor:pointer;" onclick="window.showCustomAlert && window.showCustomAlert('ÂõæÁâáËØ¶ÊÉÖ', '${escapedDescription}')" />
                </div>`;
            } else {
                contentHtml += `<div style="text-align:center;margin:10px 0;">
                    <img src="${post.imageUrl}" alt="ÂæÆÂçöÂõæÁâá" style="max-width:100%;border-radius:10px;display:inline-block;" />
                </div>`;
            }
        }
        
        // ÊòæÁ§∫ËØÑËÆ∫
        const comments = await db.weiboComments
            .where('postId')
            .equals(post.id)
            .reverse()
            .sortBy('timestamp');
            
        let commentsHtml = '';
        if (comments.length > 0) {
            commentsHtml = '<div style="background: #f8f9fa; border-radius: 8px; padding: 10px; margin-top: 10px;">';

            // Ê£ÄÊü•ÊòØÂê¶Â±ïÂºÄÊâÄÊúâËØÑËÆ∫
            const postElement = document.querySelector(`[data-post-id="${post.id}"]`);
            const isExpanded = postElement && postElement.getAttribute('data-expanded') === 'true';
            const commentsToShow = isExpanded ? comments : comments.slice(0, 3);

            for (const comment of commentsToShow) {
                const commentAuthor = comment.authorId === 'user' ? 'Êàë' : 
                    (state.chats[comment.authorId] ? state.chats[comment.authorId].name : 'Êú™Áü•Áî®Êà∑');
                const commentAvatar = comment.authorId === 'user' ?
                    (userProfileCache.avatar || 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg') :
                    (state.chats[comment.authorId] ? state.chats[comment.authorId].settings.aiAvatar : 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg');
                
                // Â§ÑÁêÜËØÑËÆ∫ÂÜÖÂÆπÔºåÊîØÊåÅË°®ÊÉÖÂåÖÊòæÁ§∫
                let commentContentHtml;

                if (comment.textContent && comment.stickers) {
                    // ÊñáÂ≠ó + Ë°®ÊÉÖÂåÖÁªÑÂêà
                    commentContentHtml = `<div style="margin-bottom: 6px;">${comment.textContent}</div>`;
                    commentContentHtml += '<div style="display: flex; gap: 4px; flex-wrap: wrap;">';
                    comment.stickers.forEach(sticker => {
                        commentContentHtml += `<img src="${sticker.url}" alt="${sticker.name}" class="sticker-image" style="max-width:50px;max-height:50px;border-radius:6px;">`;
                    });
                    commentContentHtml += '</div>';
                } else if (comment.stickers && comment.stickers.length > 0) {
                    // ‰ªÖË°®ÊÉÖÂåÖ
                    commentContentHtml = '<div style="display: flex; gap: 4px; flex-wrap: wrap;">';
                    comment.stickers.forEach(sticker => {
                        commentContentHtml += `<img src="${sticker.url}" alt="${sticker.name}" class="sticker-image" style="max-width:60px;max-height:60px;border-radius:8px;">`;
                    });
                    commentContentHtml += '</div>';
                } else if (typeof comment.content === 'string' && STICKER_REGEX.test(comment.content)) {
                    // Âçï‰∏™Ë°®ÊÉÖÂåÖÔºàÂÖºÂÆπÊóßÊ†ºÂºèÔºâ
                    commentContentHtml = `<img src="${comment.content}" alt="${comment.meaning || 'Sticker'}" class="sticker-image" style="max-width:60px;max-height:60px;border-radius:8px;">`;
                } else if (Array.isArray(comment.content)) {
                    // Â§öÊ®°ÊÄÅËØÑËÆ∫Â§ÑÁêÜ
                    const textItems = comment.content.filter(item => item.type === 'text');
                    const imageItems = comment.content.filter(item => item.type === 'image_url');

                    let htmlParts = [];

                    // Ê∑ªÂä†ÊñáÂ≠óÈÉ®ÂàÜ
                    if (textItems.length > 0) {
                        const textContent = textItems.map(item => item.text).join(' ');
                        if (textContent.trim()) {
                            htmlParts.push(`<div style="margin-bottom: 6px;">${textContent}</div>`);
                        }
                    }

                    // Ê∑ªÂä†ÂõæÁâáÈÉ®ÂàÜ
                    if (imageItems.length > 0) {
                        let imagesHtml = '<div style="display: flex; gap: 4px; flex-wrap: wrap;">';
                        imageItems.forEach(item => {
                            imagesHtml += `<img src="${item.image_url.url}" alt="Ë°®ÊÉÖÂåÖ" class="sticker-image" style="max-width:50px;max-height:50px;border-radius:6px;">`;
                        });
                        imagesHtml += '</div>';
                        htmlParts.push(imagesHtml);
                    }

                    commentContentHtml = htmlParts.join('') || 'Â§öÂ™í‰ΩìÂÜÖÂÆπ';
                } else {
                    // ÊôÆÈÄöÊñáÂ≠óËØÑËÆ∫
                    commentContentHtml = comment.content;
                }

                commentsHtml += `
                    <div style="display:flex;gap:8px;margin-bottom:8px;align-items:flex-start;" data-comment-id="${comment.id}">
                        <img src="${commentAvatar}" style="width:24px;height:24px;border-radius:50%;object-fit:cover;">
                        <div style="flex:1;">
                            <div style="font-size:12px;font-weight:500;margin-bottom:2px;">${commentAuthor}</div>
                            <div style="font-size:13px;line-height:1.4;">${commentContentHtml}</div>
                            <div style="display:flex;align-items:center;gap:10px;margin-top:4px;">
                                <span style="font-size:11px;color:var(--weibo-secondary);">${new Date(comment.timestamp).toLocaleString('zh-CN', {month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric'})}</span>
                                <span style="font-size:11px;color:var(--weibo-accent);cursor:pointer;" onclick="window.handleReplyCommentProxy && window.handleReplyCommentProxy(${post.id}, ${comment.id}, '${commentAuthor}')">ÂõûÂ§ç</span>
                            </div>`;
                
                // ÊòæÁ§∫Ê•º‰∏≠Ê•ºÂõûÂ§ç
                if (comment.replies && comment.replies.length > 0) {
                    commentsHtml += '<div style="margin-top:8px;padding-left:32px;">';

                    // Ê£ÄÊü•ÊòØÂê¶Â±ïÂºÄËØ•ËØÑËÆ∫ÁöÑÊâÄÊúâÂõûÂ§ç
                    const commentElement = document.querySelector(`[data-comment-id="${comment.id}"]`);
                    const isRepliesExpanded = commentElement && commentElement.getAttribute('data-replies-expanded') === 'true';
                    const repliesToShow = isRepliesExpanded ? comment.replies : comment.replies.slice(0, 7);

                    for (const reply of repliesToShow) {
                        const replyAuthor = reply.authorId === 'user' ? 'Êàë' : 
                            (state.chats[reply.authorId] ? state.chats[reply.authorId].name : 'Êú™Áü•Áî®Êà∑');
                        const replyToName = reply.replyTo || commentAuthor;
                        
                        // Â§ÑÁêÜÊ•º‰∏≠Ê•ºÂõûÂ§çÂÜÖÂÆπÔºåÊîØÊåÅË°®ÊÉÖÂåÖÊòæÁ§∫
                        let replyContentHtml;

                        if (reply.textContent && reply.stickers) {
                            // ÊñáÂ≠ó + Ë°®ÊÉÖÂåÖÁªÑÂêà
                            replyContentHtml = `${reply.textContent} `;
                            reply.stickers.forEach(sticker => {
                                replyContentHtml += `<img src="${sticker.url}" alt="${sticker.name}" class="sticker-image" style="max-width:32px;max-height:32px;border-radius:4px;margin-left:4px;vertical-align:middle;">`;
                            });
                        } else if (reply.stickers && reply.stickers.length > 0) {
                            // ‰ªÖË°®ÊÉÖÂåÖ
                            replyContentHtml = '';
                            reply.stickers.forEach(sticker => {
                                replyContentHtml += `<img src="${sticker.url}" alt="${sticker.name}" class="sticker-image" style="max-width:36px;max-height:36px;border-radius:6px;margin-right:4px;">`;
                            });
                        } else if (typeof reply.content === 'string' && STICKER_REGEX.test(reply.content)) {
                            // Âçï‰∏™Ë°®ÊÉÖÂåÖÔºàÂÖºÂÆπÊóßÊ†ºÂºèÔºâ
                            replyContentHtml = `<img src="${reply.content}" alt="${reply.meaning || 'Sticker'}" class="sticker-image" style="max-width:36px;max-height:36px;border-radius:6px;">`;
                        } else if (Array.isArray(reply.content)) {
                            // Â§öÊ®°ÊÄÅÂõûÂ§çÂ§ÑÁêÜ
                            const textItems = reply.content.filter(item => item.type === 'text');
                            const imageItems = reply.content.filter(item => item.type === 'image_url');

                            let htmlParts = [];

                            // Ê∑ªÂä†ÊñáÂ≠óÈÉ®ÂàÜ
                            if (textItems.length > 0) {
                                const textContent = textItems.map(item => item.text).join(' ');
                                if (textContent.trim()) {
                                    htmlParts.push(textContent);
                                }
                            }

                            // Ê∑ªÂä†ÂõæÁâáÈÉ®ÂàÜ
                            if (imageItems.length > 0) {
                                imageItems.forEach(item => {
                                    htmlParts.push(`<img src="${item.image_url.url}" alt="Ë°®ÊÉÖÂåÖ" class="sticker-image" style="max-width:32px;max-height:32px;border-radius:4px;margin-left:4px;vertical-align:middle;">`);
                                });
                            }

                            replyContentHtml = htmlParts.join(' ') || 'Â§öÂ™í‰ΩìÂÜÖÂÆπ';
                        } else {
                            // ÊôÆÈÄöÊñáÂ≠óÂõûÂ§ç
                            replyContentHtml = reply.content;
                        }

                        commentsHtml += `
                            <div style="display:flex;gap:6px;margin-bottom:6px;font-size:12px;cursor:pointer;padding:4px;border-radius:8px;transition:background-color 0.2s;" onclick="window.handleReplyCommentProxy && window.handleReplyCommentProxy(${post.id}, ${comment.id}, '${replyAuthor}')" onmouseover="this.style.backgroundColor='#f0f2f5'" onmouseout="this.style.backgroundColor='transparent'">
                                <span style="color:var(--weibo-accent);font-weight:500;">${replyAuthor}</span>
                                <span style="color:var(--weibo-secondary);">ÂõûÂ§ç</span>
                                <span style="color:var(--weibo-accent);font-weight:500;">${replyToName}:</span>
                                <span style="flex:1;">${replyContentHtml}</span>
                            </div>
                        `;
                    }
                    if (comment.replies.length > 7 && !isRepliesExpanded) {
                        commentsHtml += `<div style="font-size:11px;color:var(--weibo-accent);margin-top:4px;cursor:pointer;" onclick="expandCommentReplies('${comment.id}')">Êü•ÁúãÂÖ®ÈÉ®${comment.replies.length}Êù°ÂõûÂ§ç</div>`;
                    }
                    commentsHtml += '</div>';
                }
                
                commentsHtml += `
                        </div>
                    </div>
                `;
            }
            // Âè™ÊúâÂú®Êú™Â±ïÂºÄ‰∏îËØÑËÆ∫Êï∞Â§ß‰∫é3Êó∂ÊâçÊòæÁ§∫"Êü•ÁúãÂÖ®ÈÉ®"ÊåâÈíÆ
            if (comments.length > 3 && !isExpanded) {
                commentsHtml += `<div style="font-size:12px;color:var(--weibo-accent);text-align:center;margin-top:5px;cursor:pointer;padding:5px;" onclick="expandAllComments('${post.id}')">Êü•ÁúãÂÖ®ÈÉ®${comments.length}Êù°ËØÑËÆ∫</div>`;
            }
            commentsHtml += '</div>';
        }
        
        postElement.innerHTML = `
            <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:12px;">
                <img class="post-avatar" src="${avatar}" style="width:48px;height:48px;border-radius:50%;object-fit:cover;cursor:pointer;" onclick="window.showSocialProfileSafe && window.showSocialProfileSafe('${post.authorId}')">
                <div style="flex:1;">
                    <div style="font-weight:600;font-size:17px;margin-bottom:4px;">${nickname}</div>
                    <div style="font-size:13px;color:var(--weibo-secondary);line-height:1.4;">${signature || email}</div>
                </div>
                <div class="post-visibility" style="font-size:14px;color:var(--weibo-accent);font-weight:500;position:absolute;top:8px;right:8px;">
                    ${post.visibility === 'private' ? 'üëÅÔ∏è‚Äçüó®Ô∏è' : 
                      post.visibility === 'friends' ? 'ü´Ç' : ''}
                </div>
            </div>
            <div class="post-content" style="margin:10px 0 18px 0;">${contentHtml}</div>
            ${commentsHtml}
            <div style="display:flex;align-items:center;justify-content:space-between;font-size:14px;color:var(--weibo-secondary);margin-top:8px;">
                <div style="display:flex;align-items:center;gap:18px;">
                    <span style="display:flex;align-items:center;gap:3px;cursor:pointer;${hasLiked?`color:var(--weibo-accent);font-weight:600;`:''}" onclick="window.handleLikeProxy && window.handleLikeProxy(${post.id})">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="${hasLiked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg> ${post.interactions?.likes || likesCount || ''}
                    </span>
                    <span style="display:flex;align-items:center;gap:3px;cursor:pointer;" onclick="window.handleCommentProxy && window.handleCommentProxy(${post.id})">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2z"></path></svg> ${post.interactions?.comments || commentsCount || ''}
                    </span>
                    <span style="display:flex;align-items:center;gap:3px;cursor:pointer;" onclick="window.handleRepostProxy && window.handleRepostProxy(${post.id})">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 1l4 4-4 4"></path><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><path d="M7 23l-4-4 4-4"></path><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg> ${post.interactions?.reposts || repostsCount || ''}
                    </span>
                </div>
                <span style="font-size:12px;">${timestamp}</span>
            </div>
        `;
        
        // Ê∑ªÂä†ÈïøÊåâ‰∫ã‰ª∂ÁõëÂê¨Âô®Áî®‰∫éÂ§öÈÄâ
        addLongPressListener(postElement, () => {
            if (!isWeiboSelectionMode) {
                enterWeiboSelectionMode();
            }
            toggleWeiboPostSelection(post.id);
        });
        
        // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÁõëÂê¨Âô®
        postElement.addEventListener('click', (e) => {
            if (isWeiboSelectionMode) {
                // Ê£ÄÊü•ÁÇπÂáªÁöÑÊòØÂê¶ÊòØ‰∫íÂä®ÊåâÈíÆ
                if (!e.target.closest('.post-actions') && !e.target.closest('svg') && !e.target.closest('span[onclick]') && !e.target.closest('[onclick]')) {
                    toggleWeiboPostSelection(post.id);
                }
            }
        });
        
        timeline.appendChild(postElement);
    }
}
// ÂèëÂ∏ÉÊñ∞ÂæÆÂçö
async function publishPost(content, visibility, imageUrl = null) {
    try {
        // Ëé∑ÂèñÁî®Êà∑ËµÑÊñô
        const savedProfileData = await db.userProfiles.get('weibo_user_profile');
        const profile = savedProfileData ? savedProfileData.data : {};
        
        const post = {
            id: Date.now(),
            authorId: 'user',
            authorName: profile.name || 'Êàë',
            authorAvatar: profile.avatar || defaultAvatar,
            authorEmail: profile.email || '',
            authorSignature: profile.signature || '',
            content,
            visibility,
            timestamp: Date.now(),
            // Ê∑ªÂä†ÂàùÂßãÁöÑ‰∫íÂä®Êï∞ÊçÆ
            interactions: {
                likes: Math.floor(Math.random() * 20 + 5),
                comments: Math.floor(Math.random() * 10 + 2),
                reposts: Math.floor(Math.random() * 5 + 1)
            }
        };
        
        // Â¶ÇÊûúÊúâÂõæÁâáÔºåÊ∑ªÂä†Âà∞postÂØπË±°‰∏≠
        if (imageUrl) {
            post.imageUrl = imageUrl;
            // Â∞ÜÊñáÂ≠óÂÜÖÂÆπ‰øùÂ≠ò‰∏∫descriptionÂ≠óÊÆµÔºå‰æø‰∫éÊ∏≤ÊüìÊó∂Âå∫ÂàÜ
            if (post.content && post.content.trim()) {
                post.description = post.content;
                post.content = ''; // Ê∏ÖÁ©∫contentÔºå‰ΩøÁî®description
            }
            
            // ÂõæÁâáÁ±ªÂÜÖÂÆπÈÄöÂ∏∏Ëé∑ÂæóÊõ¥Â§ö‰∫íÂä®
            post.interactions.likes += Math.floor(Math.random() * 15 + 10);
            post.interactions.comments += Math.floor(Math.random() * 5 + 3);
            post.interactions.reposts += Math.floor(Math.random() * 3 + 1);
        }
        
        // Ê†πÊçÆÂèØËßÅÊÄßË∞ÉÊï¥‰∫íÂä®Êï∞Èáè
        if (visibility === 'private') {
            // ÁßÅÂØÜÂä®ÊÄÅÊ≤°Êúâ‰∫íÂä®
            post.interactions.likes = 0;
            post.interactions.comments = 0;
            post.interactions.reposts = 0;
        } else if (visibility === 'friends') {
            // ‰ªÖÂ•ΩÂèãÂèØËßÅÁöÑÂä®ÊÄÅ‰∫íÂä®ËæÉÂ∞ë
            post.interactions.likes = Math.floor(post.interactions.likes * 0.6);
            post.interactions.comments = Math.floor(post.interactions.comments * 0.5);
            post.interactions.reposts = Math.floor(post.interactions.reposts * 0.3);
        }
        
        await db.weiboPosts.add(post);
        
        // Ëé∑ÂèñÂΩìÂâçÊøÄÊ¥ªÁöÑÂØºËà™È°πÔºåÁ°ÆÂÆöÂ∫îËØ•Ê∏≤ÊüìÂì™‰∏™ËßÜÂõæ
        const activeNavItem = document.querySelector('.weibo-nav .nav-item.active');
        const currentFilter = activeNavItem && activeNavItem.textContent === '‚Çç^À∂ ‚ï∏ñ•¶  ‚ï∏Àµ^‚Çé‚üÜ' ? 'mine' : 'all';
        
        await renderWeiboTimeline(currentFilter);
        
        // Ëß¶ÂèëAIËßíËâ≤ÁöÑ‰∫íÂä®
        triggerAiInteraction(post);
        
        return true; // ÂèëÂ∏ÉÊàêÂäü
    } catch (error) {
        console.error('ÂèëÂ∏ÉÂæÆÂçöÂ§±Ë¥•:', error);
        throw error; // ÈáçÊñ∞ÊäõÂá∫ÈîôËØØÔºåËÆ©Ë∞ÉÁî®ËÄÖÂ§ÑÁêÜ
    }
}

// Â§ÑÁêÜÁÇπËµû
        async function handleLike(postId) {
            const existingLike = await db.weiboLikes
                .where('[postId+authorId]')
                .equals([postId, 'user'])
                .first();
                
            const post = await db.weiboPosts.get(postId);
            if (!post) return;
            
            // Á°Æ‰øùinteractionsÂØπË±°Â≠òÂú®
            if (!post.interactions) {
                post.interactions = {
                    likes: 0,
                    comments: 0,
                    reposts: 0
                };
            }
                
            if (existingLike) {
                await db.weiboLikes.delete([postId, 'user']);
                
                // ÂáèÂ∞ëÁÇπËµûÊï∞
                if (post.interactions.likes > 0) {
                    post.interactions.likes--;
                }
            } else {
                await db.weiboLikes.add({
                    postId,
                    authorId: 'user',
                    timestamp: Date.now()
                });
                
                // Â¢ûÂä†ÁÇπËµûÊï∞
                post.interactions.likes++;
                
                // Ëß¶ÂèëAIÂõûÂ∫î
                if (post.authorId !== 'user') {
                    triggerAiResponse(post.authorId, 'like', post);
                }
            }
            
            // Êõ¥Êñ∞Â∏ñÂ≠êÁöÑ‰∫íÂä®Êï∞ÊçÆ
            await db.weiboPosts.put(post);
            
            await renderWeiboTimeline();
        }

// ÊòæÁ§∫ÂæÆÂçöËØÑËÆ∫Ë°®ÊÉÖÂåÖÈÄâÊã©Âô®
async function showWeiboStickerSelector(title = 'ÂèëË°®ËØÑËÆ∫') {
    return new Promise((resolve) => {
        // ÂàõÂª∫Ê®°ÊÄÅÊ°Ü
        const modal = document.createElement('div');
        modal.className = 'modal visible';
        modal.style.zIndex = '1000';
        modal.innerHTML = `
            <div class="modal-content" style="width: 90%; max-width: 420px; max-height: 85vh; border-radius: 16px; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
                <div class="modal-header" style="padding: 16px 20px; border-bottom: 1px solid rgba(0, 0, 0, 0.08); border-radius: 16px 16px 0 0;">
                    <span style="font-weight: 600; color: #333;">${title}</span>
                    <span style="cursor: pointer; font-size: 18px; color: #666; padding: 4px; border-radius: 50%; transition: all 0.2s;" onclick="this.closest('.modal').remove();" onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='transparent'">&times;</span>
                </div>
                <div class="modal-body" style="padding: 16px 20px;">
                    <!-- ÊñáÂ≠óËæìÂÖ•Âå∫Âüü -->
                    <div style="margin-bottom: 16px;">
                        <textarea id="weibo-comment-text" placeholder="ËæìÂÖ•ËØÑËÆ∫ÂÜÖÂÆπ..." style="width: 100%; height: 80px; padding: 12px; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 12px; resize: vertical; box-sizing: border-box; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); font-size: 14px; line-height: 1.4; transition: all 0.2s;" onfocus="this.style.borderColor='var(--weibo-accent)'; this.style.boxShadow='0 0 0 2px rgba(255, 105, 180, 0.1)'" onblur="this.style.borderColor='rgba(0, 0, 0, 0.1)'; this.style.boxShadow='none'"></textarea>
                    </div>

                    <!-- Ë°®ÊÉÖÂåÖÈÄâÊã©Âå∫Âüü -->
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <span style="font-size: 14px; font-weight: 500; color: #666;">ÈÄâÊã©Ë°®ÊÉÖÂåÖ</span>
                            <div style="flex: 1; height: 1px; background: linear-gradient(to right, rgba(0,0,0,0.1), transparent);"></div>
                        </div>
                        <div id="weibo-sticker-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 8px; max-height: 200px; overflow-y: auto; padding: 8px; background: rgba(248, 249, 250, 0.8); border-radius: 12px; backdrop-filter: blur(10px);">
                            ${state.userStickers.length === 0 ? '<p style="text-align: center; color: #999; grid-column: 1 / -1; margin: 20px 0; font-size: 13px;">ÊöÇÊó†Ë°®ÊÉÖÂåÖÔºåËØ∑ÂÖàÂú®ËÅäÂ§©ÁïåÈù¢Ê∑ªÂä†Ë°®ÊÉÖÂåÖ</p>' : ''}
                        </div>
                    </div>

                    <!-- Â∑≤ÈÄâÊã©ÁöÑË°®ÊÉÖÂåÖÈ¢ÑËßà -->
                    <div id="selected-stickers-preview" style="display: none; margin-bottom: 16px; padding: 12px; background: rgba(255, 105, 180, 0.05); border: 1px solid rgba(255, 105, 180, 0.2); border-radius: 12px;">
                        <div style="font-size: 13px; color: var(--weibo-accent); margin-bottom: 8px; font-weight: 500;">Â∑≤ÈÄâÊã©ÁöÑË°®ÊÉÖÂåÖÔºö</div>
                        <div id="selected-stickers-container" style="display: flex; gap: 6px; flex-wrap: wrap;"></div>
                    </div>

                    <!-- ÂèëÈÄÅÊåâÈíÆ -->
                    <button id="weibo-send-comment-btn" style="width: 100%; padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 15px; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); transition: all 0.3s; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">ÂèëÈÄÅËØÑËÆ∫</button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // Ê†πÊçÆ‰∏ªÈ¢òËÆæÁΩÆÂèëÈÄÅÊåâÈíÆÊ†∑Âºè
        const sendBtn = modal.querySelector('#weibo-send-comment-btn');
        const currentTheme = document.body.getAttribute('data-theme');

        if (currentTheme === 'cute') {
            // ÂèØÁà±‰∏ªÈ¢ò - ÈõæÈúæÁ≤â
            sendBtn.style.background = 'linear-gradient(135deg, rgba(248, 187, 208, 0.9), rgba(255, 182, 193, 0.9))';
            sendBtn.style.border = '1px solid rgba(248, 187, 208, 0.3)';
            sendBtn.style.boxShadow = '0 4px 12px rgba(248, 187, 208, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2)';
            sendBtn.onmouseover = () => {
                sendBtn.style.transform = 'translateY(-1px)';
                sendBtn.style.boxShadow = '0 6px 16px rgba(248, 187, 208, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.3)';
            };
            sendBtn.onmouseout = () => {
                sendBtn.style.transform = 'translateY(0)';
                sendBtn.style.boxShadow = '0 4px 12px rgba(248, 187, 208, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2)';
            };
        } else {
            // ÁªèÂÖ∏‰∏ªÈ¢ò - ÈõæÈúæËìù
            sendBtn.style.background = 'linear-gradient(135deg, rgba(74, 132, 193, 0.9), rgba(100, 149, 237, 0.9))';
            sendBtn.style.border = '1px solid rgba(74, 132, 193, 0.3)';
            sendBtn.style.boxShadow = '0 4px 12px rgba(74, 132, 193, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2)';
            sendBtn.onmouseover = () => {
                sendBtn.style.transform = 'translateY(-1px)';
                sendBtn.style.boxShadow = '0 6px 16px rgba(74, 132, 193, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.3)';
            };
            sendBtn.onmouseout = () => {
                sendBtn.style.transform = 'translateY(0)';
                sendBtn.style.boxShadow = '0 4px 12px rgba(74, 132, 193, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2)';
            };
        }

        // Â≠òÂÇ®ÈÄâ‰∏≠ÁöÑË°®ÊÉÖÂåÖ
        let selectedStickers = [];

        // Ê∏≤ÊüìË°®ÊÉÖÂåÖ
        const stickerGrid = modal.querySelector('#weibo-sticker-grid');
        const selectedPreview = modal.querySelector('#selected-stickers-preview');
        const selectedContainer = modal.querySelector('#selected-stickers-container');

        function updateSelectedPreview() {
            if (selectedStickers.length > 0) {
                selectedPreview.style.display = 'block';
                selectedContainer.innerHTML = '';
                selectedStickers.forEach((sticker, index) => {
                    const preview = document.createElement('div');
                    preview.style.cssText = 'position: relative; width: 32px; height: 32px; background-size: contain; background-repeat: no-repeat; background-position: center; border-radius: 6px; border: 1px solid rgba(255, 105, 180, 0.3);';
                    preview.style.backgroundImage = `url(${sticker.url})`;
                    preview.title = sticker.name;

                    // Ê∑ªÂä†Âà†Èô§ÊåâÈíÆ
                    const removeBtn = document.createElement('div');
                    removeBtn.style.cssText = 'position: absolute; top: -4px; right: -4px; width: 16px; height: 16px; background: #ff4757; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; font-weight: bold;';
                    removeBtn.innerHTML = '√ó';
                    removeBtn.onclick = () => {
                        selectedStickers.splice(index, 1);
                        updateSelectedPreview();
                        // Êõ¥Êñ∞Ë°®ÊÉÖÂåÖÁΩëÊ†º‰∏≠ÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
                        const stickerItems = stickerGrid.querySelectorAll('.sticker-item');
                        stickerItems.forEach(item => {
                            if (item.dataset.stickerUrl === sticker.url) {
                                item.style.borderColor = 'transparent';
                                item.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
                            }
                        });
                    };

                    preview.appendChild(removeBtn);
                    selectedContainer.appendChild(preview);
                });
            } else {
                selectedPreview.style.display = 'none';
            }
        }

        state.userStickers.forEach(sticker => {
            const item = document.createElement('div');
            item.className = 'sticker-item';
            item.dataset.stickerUrl = sticker.url;
            item.style.cssText = 'aspect-ratio: 1; background-size: contain; background-repeat: no-repeat; background-position: center; cursor: pointer; border-radius: 8px; border: 2px solid transparent; transition: all 0.2s; background-color: rgba(255, 255, 255, 0.8);';
            item.style.backgroundImage = `url(${sticker.url})`;
            item.title = sticker.name;

            item.onclick = () => {
                const isSelected = selectedStickers.some(s => s.url === sticker.url);
                if (isSelected) {
                    // ÂèñÊ∂àÈÄâÊã©
                    selectedStickers = selectedStickers.filter(s => s.url !== sticker.url);
                    item.style.borderColor = 'transparent';
                    item.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
                } else {
                    // ÈÄâÊã©Ë°®ÊÉÖÂåÖ
                    selectedStickers.push(sticker);
                    item.style.borderColor = 'var(--weibo-accent)';
                    item.style.backgroundColor = 'rgba(255, 105, 180, 0.1)';
                }
                updateSelectedPreview();
            };

            item.onmouseover = () => {
                if (!selectedStickers.some(s => s.url === sticker.url)) {
                    item.style.borderColor = 'rgba(255, 105, 180, 0.5)';
                }
            };
            item.onmouseout = () => {
                if (!selectedStickers.some(s => s.url === sticker.url)) {
                    item.style.borderColor = 'transparent';
                }
            };

            stickerGrid.appendChild(item);
        });

        // ÂèëÈÄÅËØÑËÆ∫ÊåâÈíÆ‰∫ã‰ª∂
        modal.querySelector('#weibo-send-comment-btn').onclick = () => {
            const text = modal.querySelector('#weibo-comment-text').value.trim();

            if (!text && selectedStickers.length === 0) {
                // Ê≤°ÊúâÂÜÖÂÆπÔºåÊèêÁ§∫Áî®Êà∑
                modal.querySelector('#weibo-comment-text').style.borderColor = '#ff4757';
                modal.querySelector('#weibo-comment-text').placeholder = 'ËØ∑ËæìÂÖ•ËØÑËÆ∫ÂÜÖÂÆπÊàñÈÄâÊã©Ë°®ÊÉÖÂåÖ';
                setTimeout(() => {
                    modal.querySelector('#weibo-comment-text').style.borderColor = 'rgba(0, 0, 0, 0.1)';
                    modal.querySelector('#weibo-comment-text').placeholder = 'ËæìÂÖ•ËØÑËÆ∫ÂÜÖÂÆπ...';
                }, 2000);
                return;
            }

            modal.remove();

            // ÊûÑÂª∫ËøîÂõûÂÜÖÂÆπ
            if (text && selectedStickers.length > 0) {
                // ÊñáÂ≠ó + Ë°®ÊÉÖÂåÖÁªÑÂêà
                const content = [
                    { type: 'text', text: text }
                ];

                // Ê∑ªÂä†ÊâÄÊúâÈÄâ‰∏≠ÁöÑË°®ÊÉÖÂåÖ
                selectedStickers.forEach(sticker => {
                    content.push({
                        type: 'image_url',
                        image_url: { url: sticker.url }
                    });
                });

                resolve({
                    type: 'mixed',
                    content: content,
                    textContent: text,
                    stickers: selectedStickers
                });
            } else if (selectedStickers.length > 0) {
                // ‰ªÖË°®ÊÉÖÂåÖ
                const content = [];
                selectedStickers.forEach(sticker => {
                    content.push({
                        type: 'image_url',
                        image_url: { url: sticker.url }
                    });
                });

                resolve({
                    type: 'stickers',
                    content: content,
                    stickers: selectedStickers
                });
            } else {
                // ‰ªÖÊñáÂ≠ó
                resolve({
                    type: 'text',
                    content: text
                });
            }
        };

        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        modal.onclick = (e) => {
            if (e.target === modal) {
                modal.remove();
                resolve(null);
            }
        };
    });
}

// Â§ÑÁêÜËØÑËÆ∫
async function handleComment(postId) {
    const result = await showWeiboStickerSelector('ÂèëË°®ËØÑËÆ∫');
    if (!result) return;

    const commentId = Date.now();
    const commentData = {
        id: commentId,
        postId,
        authorId: 'user',
        timestamp: Date.now(),
        replies: [] // ÂàùÂßãÂåñÂõûÂ§çÊï∞ÁªÑ
    };

    // Ê†πÊçÆÁ±ªÂûãËÆæÁΩÆÂÜÖÂÆπ
    if (result.type === 'mixed') {
        // ÊñáÂ≠ó + Ë°®ÊÉÖÂåÖÁªÑÂêà
        commentData.content = result.content;
        commentData.textContent = result.textContent;
        commentData.stickers = result.stickers;
    } else if (result.type === 'stickers') {
        // ‰ªÖË°®ÊÉÖÂåÖ
        commentData.content = result.content;
        commentData.stickers = result.stickers;
    } else if (result.type === 'sticker') {
        // Âçï‰∏™Ë°®ÊÉÖÂåÖÔºàÂÖºÂÆπÊóßÊ†ºÂºèÔºâ
        commentData.content = result.content;
        commentData.meaning = result.meaning;
    } else {
        // ‰ªÖÊñáÂ≠ó
        commentData.content = result.content;
    }

    await db.weiboComments.add(commentData);
    
    // Êõ¥Êñ∞Â∏ñÂ≠êÁöÑËØÑËÆ∫ËÆ°Êï∞
    const post = await db.weiboPosts.get(postId);
    if (post) {
        // Á°Æ‰øùinteractionsÂØπË±°Â≠òÂú®
        if (!post.interactions) {
            post.interactions = {
                likes: 0,
                comments: 0,
                reposts: 0
            };
        }
        
        // Â¢ûÂä†ËØÑËÆ∫Êï∞
        post.interactions.comments++;
        await db.weiboPosts.put(post);
        
        // Ëß¶ÂèëAIÂõûÂ∫î
        if (post.authorId !== 'user') {
            // AIÂèØËÉΩ‰ºöÁõ¥Êé•ÂõûÂ§çËøôÊù°ËØÑËÆ∫
            setTimeout(async () => {
                await triggerAiReplyToComment(post.authorId, postId, commentId, commentData);
            }, Math.random() * 3000 + 1000);
        }
    }
    
    await renderWeiboTimeline();
}

// Â§ÑÁêÜÊ•º‰∏≠Ê•ºÂõûÂ§ç
async function handleReplyComment(postId, commentId, replyToName) {
    const result = await showWeiboStickerSelector(`ÂõûÂ§ç ${replyToName}`);
    if (!result) return;

    // Ëé∑ÂèñÂéüËØÑËÆ∫
    const comment = await db.weiboComments.get(commentId);
    if (!comment) return;

    // Ê∑ªÂä†ÂõûÂ§çÂà∞ËØÑËÆ∫ÁöÑrepliesÊï∞ÁªÑ
    if (!comment.replies) comment.replies = [];

    // Ê£ÄÊü•Ê•º‰∏≠Ê•ºÂõûÂ§çÊï∞Èáè
    if (comment.replies.length >= 7) {
        showToast('ËØ•ËØÑËÆ∫ÁöÑÂõûÂ§çÂ∑≤Ëææ‰∏äÈôêÔºà7Êù°Ôºâ', 'error');
        return;
    }

    const reply = {
        id: Date.now(),
        authorId: 'user',
        timestamp: Date.now(),
        replyTo: replyToName
    };

    // Ê†πÊçÆÁ±ªÂûãËÆæÁΩÆÂÜÖÂÆπ
    if (result.type === 'mixed') {
        // ÊñáÂ≠ó + Ë°®ÊÉÖÂåÖÁªÑÂêà
        reply.content = result.content;
        reply.textContent = result.textContent;
        reply.stickers = result.stickers;
    } else if (result.type === 'stickers') {
        // ‰ªÖË°®ÊÉÖÂåÖ
        reply.content = result.content;
        reply.stickers = result.stickers;
    } else if (result.type === 'sticker') {
        // Âçï‰∏™Ë°®ÊÉÖÂåÖÔºàÂÖºÂÆπÊóßÊ†ºÂºèÔºâ
        reply.content = result.content;
        reply.meaning = result.meaning;
    } else {
        // ‰ªÖÊñáÂ≠ó
        reply.content = result.content;
    }
    
    comment.replies.push(reply);
    await db.weiboComments.put(comment);
    
    // Ëß¶ÂèëAIÂõûÂ∫î
    const post = await db.weiboPosts.get(postId);
    if (post) {
        // Â¶ÇÊûúÂõûÂ§çÁöÑÊòØAIÁöÑËØÑËÆ∫ÔºåAI‰ºöÁªßÁª≠ÂõûÂ§ç
        if (comment.authorId !== 'user') {
            setTimeout(async () => {
                await triggerAiReplyInThread(comment.authorId, postId, commentId, content, 'Êàë');
            }, Math.random() * 2000 + 1000);
        }
        // Â¶ÇÊûúÊòØÂú®Áî®Êà∑ÁöÑÂä®ÊÄÅ‰∏ãÔºåÂÖ∂‰ªñAI‰πüÂèØËÉΩÂèÇ‰∏éËÆ®ËÆ∫
        else if (post.authorId === 'user') {
            // ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™AIÂèÇ‰∏éÊ•º‰∏≠Ê•ºËÆ®ËÆ∫
            const aiChats = Object.entries(state.chats).filter(([id, chat]) => !chat.isGroup);
            if (aiChats.length > 0 && Math.random() < 0.3) {
                const [aiId] = aiChats[Math.floor(Math.random() * aiChats.length)];
                setTimeout(async () => {
                    await triggerAiReplyInThread(aiId, postId, commentId, content, 'Êàë');
                }, Math.random() * 3000 + 2000);
            }
        }
    }
    
    await renderWeiboTimeline();
}

// Â±ïÂºÄÊâÄÊúâËØÑËÆ∫
async function expandAllComments(postId) {
    // ÈáçÊñ∞Ê∏≤ÊüìËØ•Â∏ñÂ≠êÔºåÊòæÁ§∫ÊâÄÊúâËØÑËÆ∫
    const postElement = document.querySelector(`[data-post-id="${postId}"]`);
    if (!postElement) return;

    // Ê†áËÆ∞ËØ•Â∏ñÂ≠ê‰∏∫Â±ïÂºÄÁä∂ÊÄÅ
    postElement.setAttribute('data-expanded', 'true');

    // ÈáçÊñ∞Ê∏≤ÊüìÊï¥‰∏™Êó∂Èó¥Á∫ø‰ª•Êõ¥Êñ∞ÊòæÁ§∫
    await renderWeiboTimeline();
}

// Â±ïÂºÄËØÑËÆ∫ÁöÑÊâÄÊúâÂõûÂ§ç
async function expandCommentReplies(commentId) {
    // Ê†áËÆ∞ËØ•ËØÑËÆ∫ÁöÑÂõûÂ§ç‰∏∫Â±ïÂºÄÁä∂ÊÄÅ
    const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
    if (!commentElement) return;

    commentElement.setAttribute('data-replies-expanded', 'true');

    // ÈáçÊñ∞Ê∏≤ÊüìÊï¥‰∏™Êó∂Èó¥Á∫ø‰ª•Êõ¥Êñ∞ÊòæÁ§∫
    await renderWeiboTimeline();
}

// AIÂõûÂ§çËØÑËÆ∫ÔºàÊ•º‰∏≠Ê•ºÔºâ
async function triggerAiReplyToComment(aiId, postId, commentId, userCommentData) {
    const ai = state.chats[aiId];
    if (!ai) return;

    try {
        // ÊûÑÂª∫ËØÑËÆ∫ÂÜÖÂÆπÁî®‰∫éAIÁêÜËß£
        let commentContent;

        if (typeof userCommentData === 'object' && userCommentData !== null) {
            // Êñ∞Ê†ºÂºèÔºö‰º†ÂÖ•ÁöÑÊòØÂÆåÊï¥ÁöÑËØÑËÆ∫Êï∞ÊçÆÂØπË±°
            if (userCommentData.textContent || userCommentData.stickers) {
                commentContent = {
                    textContent: userCommentData.textContent || '',
                    stickers: userCommentData.stickers || []
                };
            } else if (typeof userCommentData.content === 'string') {
                commentContent = userCommentData.content;
            } else {
                commentContent = 'Áî®Êà∑ÂèëË°®‰∫ÜËØÑËÆ∫';
            }
        } else {
            // ÊóßÊ†ºÂºèÔºö‰º†ÂÖ•ÁöÑÊòØÂ≠óÁ¨¶‰∏≤
            commentContent = userCommentData || 'Áî®Êà∑ÂèëË°®‰∫ÜËØÑËÆ∫';
        }

        // Ëé∑ÂèñAIÁöÑÂõûÂ§çÂÜÖÂÆπ
        const post = await db.weiboPosts.get(postId);
        const response = await generateAiResponse(ai, 'comment_reply', post, commentContent, 'Êàë');
        
        if (response) {
            // Â∞ÜAIÁöÑÂõûÂ§çÊ∑ªÂä†Âà∞ËØÑËÆ∫ÁöÑreplies‰∏≠
            const comment = await db.weiboComments.get(commentId);
            if (comment) {
                if (!comment.replies) comment.replies = [];

                if (comment.replies.length < 7) {
                    const replyData = {
                        id: Date.now(),
                        authorId: aiId,
                        timestamp: Date.now(),
                        replyTo: 'Êàë'
                    };

                    // Â§ÑÁêÜË°®ÊÉÖÂåÖÊ†ºÂºèÁöÑÂõûÂ§ç
                    if (typeof response === 'object' && response.type === 'sticker') {
                        replyData.content = response.content;
                        replyData.meaning = response.meaning;
                    } else {
                        // ÊõøÊç¢Áî®Êà∑Âç†‰ΩçÁ¨¶
                        const userName = userProfileCache.name || 'ÊàëÁöÑÂæÆÂçö';
                        let processedResponse = response.replace(/@\{\{user\}\}/g, `@${userName}`);
                        processedResponse = processedResponse.replace(/\{\{user\}\}/g, userName);
                        replyData.content = processedResponse;
                    }

                    comment.replies.push(replyData);

                    await db.weiboComments.put(comment);
                    await renderWeiboTimeline();

                    // ÊòæÁ§∫ÈÄöÁü•
                    showNotification(aiId, `ÂõûÂ§ç‰∫Ü‰Ω†ÁöÑËØÑËÆ∫`, 'weibo');
                }
            }
        }
    } catch (error) {
        console.error('AIÂõûÂ§çËØÑËÆ∫Â§±Ë¥•:', error);
    }
}

// AIÂú®Ê•º‰∏≠Ê•º‰∏≠ÁªßÁª≠ÂõûÂ§ç
async function triggerAiReplyInThread(aiId, postId, commentId, userReply, userName) {
    const ai = state.chats[aiId];
    if (!ai) return;
    
    try {
        const comment = await db.weiboComments.get(commentId);
        if (!comment || !comment.replies || comment.replies.length >= 7) return;
        
        // Ëé∑ÂèñËÆ®ËÆ∫‰∏ä‰∏ãÊñá
        const post = await db.weiboPosts.get(postId);
        const threadContext = comment.replies.map(r => `${r.authorId === 'user' ? 'Êàë' : state.chats[r.authorId]?.name || 'Êú™Áü•'}: ${r.content}`).join('\n');
        
        const fullContext = `ÂéüÂä®ÊÄÅÔºö${post.content}\n‰∏ªËØÑËÆ∫Ôºö${comment.content}\nÊ•º‰∏≠Ê•ºËÆ®ËÆ∫Ôºö\n${threadContext}\nÁî®Êà∑ÊúÄÊñ∞ÂõûÂ§çÔºö${userReply}`;
        
        let response = await generateAiResponse(ai, 'thread_reply', post, fullContext, userName);

        if (response) {
            // ÊõøÊç¢Áî®Êà∑Âç†‰ΩçÁ¨¶ÔºàËôΩÁÑ∂generateAiResponseÂ∑≤ÁªèÂ§ÑÁêÜ‰∫ÜÔºå‰ΩÜ‰∏∫‰∫Ü‰øùÈô©Ëµ∑ËßÅÂÜçÂ§ÑÁêÜ‰∏ÄÊ¨°Ôºâ
            const userNameForReplace = userProfileCache.name || 'ÊàëÁöÑÂæÆÂçö';
            if (typeof response === 'string') {
                response = response.replace(/@\{\{user\}\}/g, `@${userNameForReplace}`);
                response = response.replace(/\{\{user\}\}/g, userNameForReplace);
            }

            comment.replies.push({
                id: Date.now(),
                authorId: aiId,
                content: response,
                timestamp: Date.now(),
                replyTo: userName
            });
            
            await db.weiboComments.put(comment);
            await renderWeiboTimeline();
            
            // ÊòæÁ§∫ÈÄöÁü•
            showNotification(aiId, `ÂõûÂ§ç‰∫Ü‰Ω†`, 'weibo');
        }
    } catch (error) {
        console.error('AIÊ•º‰∏≠Ê•ºÂõûÂ§çÂ§±Ë¥•:', error);
    }
}

// Â§ÑÁêÜËΩ¨Âèë
async function handleRepost(postId) {
    const content = await showCustomPrompt('ËΩ¨ÂèëÂä®ÊÄÅ', 'ËØ∑ËæìÂÖ•ËΩ¨ÂèëËØÑËÆ∫(ÂèØÈÄâ)');
    if (content === null) return;
    
    // Ëé∑ÂèñÂéüÂä®ÊÄÅ
    const originalPost = await db.weiboPosts.get(postId);
    if (!originalPost) {
        showToast('ÂéüÂä®ÊÄÅ‰∏çÂ≠òÂú®', 'error');
        return;
    }
    
    // ÂàõÂª∫ËΩ¨ÂèëÂä®ÊÄÅ
    const repostPost = {
        id: Date.now(),
        authorId: 'user',
        authorName: userProfileCache.name || 'Êàë',
        authorAvatar: userProfileCache.avatar || defaultAvatar,
        authorEmail: userProfileCache.email || '',
        authorSignature: userProfileCache.signature || '',
        content: content || '',
        visibility: 'public',
        timestamp: Date.now(),
        isRepost: true,
        originalPostId: postId,
        // Ê∑ªÂä†ÂàùÂßãÁöÑ‰∫íÂä®Êï∞ÊçÆ
        interactions: {
            likes: Math.floor(Math.random() * 10 + 2),
            comments: Math.floor(Math.random() * 5 + 1),
            reposts: Math.floor(Math.random() * 3)
        }
    };
    
    await db.weiboPosts.add(repostPost);
    
    // Ê∑ªÂä†ËΩ¨ÂèëËÆ∞ÂΩï
    await db.weiboReposts.add({
        id: Date.now(),
        originalPostId: postId,
        authorId: 'user',
        content: content || '',
        timestamp: Date.now()
    });
    
    // Êõ¥Êñ∞ÂéüÂ∏ñÂ≠êÁöÑËΩ¨ÂèëËÆ°Êï∞
    if (!originalPost.interactions) {
        originalPost.interactions = {
            likes: 0,
            comments: 0,
            reposts: 0
        };
    }
    
    // Â¢ûÂä†ËΩ¨ÂèëÊï∞
    originalPost.interactions.reposts++;
    await db.weiboPosts.put(originalPost);
    
    // Ëß¶ÂèëAIÂõûÂ∫î
    if (originalPost.authorId !== 'user') {
        triggerAiResponse(originalPost.authorId, 'repost', originalPost, content);
    }
    
    await renderWeiboTimeline();
    showToast('ËΩ¨ÂèëÊàêÂäüÔºÅ', 'success');
}
// AIËßíËâ≤Ëá™Âä®ÂèëÂ∏ÉÂä®ÊÄÅ
function scheduleAiPosts(aiId, frequency) {
    const posts = {
        low: [1, 2],
        medium: [3, 4], 
        high: [5, 6]
    };
    
    const [min, max] = posts[frequency];
    const count = Math.floor(Math.random() * (max - min + 1)) + min;
    
    // ÁîüÊàê‰ªäÂ§©ÁöÑÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
    const times = [];
    for (let i = 0; i < count; i++) {
        const hours = Math.floor(Math.random() * 24);
        const minutes = Math.floor(Math.random() * 60);
        times.push(`${hours}:${String(minutes).padStart(2, '0')}`);
    }
    
    return times;
}

// ÂÖ®Â±ÄÂÆöÊó∂Âô®ÁÆ°ÁêÜ
let aiPostingTimers = new Map();

// ÂàùÂßãÂåñAIËá™Âä®ÂèëÂ∏ÉÁ≥ªÁªü
async function initAiPostingSystem() {
    // Ê∏ÖÈô§ÊâÄÊúâÁé∞ÊúâÂÆöÊó∂Âô®
    clearAllAiPostingTimers();
    
    let enabledCount = 0;
    // ‰∏∫ÊØè‰∏™ÂêØÁî®‰∫ÜÂæÆÂçöÂäüËÉΩÁöÑAIËßíËâ≤ËÆæÁΩÆÂÆöÊó∂Âô®
    for (const [chatId, chat] of Object.entries(state.chats)) {
        if (chat.settings.weiboEnabled && !chat.isGroup) {
            await setupAiPostingTimer(chatId, chat);
            enabledCount++;
        }
    }
    
    console.log(`AIËá™Âä®ÂèëÂ∏ÉÁ≥ªÁªüÂ∑≤ÂàùÂßãÂåñÔºåÂÖ± ${enabledCount} ‰∏™ËßíËâ≤ÂêØÁî®ÂæÆÂçöÂäüËÉΩ`);
    
    // ËÆæÁΩÆÊØèÂàÜÈíüÊ£ÄÊü•‰∏ÄÊ¨°Êó∂Èó¥
    setInterval(checkAiPostingTimes, 60000);
    
    // ÂàùÂßãÂåñÂêéÂè∞‰∫íÂä®Á≥ªÁªü
    initBackgroundInteractionSystem();
}

// ÂêéÂè∞‰∫íÂä®Á≥ªÁªü
function initBackgroundInteractionSystem() {
    // Ê∏ÖÈô§Áé∞ÊúâÁöÑÂÆöÊó∂Âô®
    if (window.backgroundTimers) {
        Object.values(window.backgroundTimers).forEach(timer => {
            if (timer.chatTimer) clearInterval(timer.chatTimer);
            if (timer.weiboTimer) clearInterval(timer.weiboTimer);
        });
    }
    window.backgroundTimers = {};
    
    // ‰∏∫ÊØè‰∏™AIËßíËâ≤ËÆæÁΩÆÁã¨Á´ãÁöÑÂÆöÊó∂Âô®
    for (const [chatId, chat] of Object.entries(state.chats)) {
        if (chat.isGroup) continue;
        
        window.backgroundTimers[chatId] = {};
        
        // ËÆæÁΩÆ‰∏ªÂä®ËÅäÂ§©ÂÆöÊó∂Âô®
        if (chat.settings.backgroundInteractionEnabled && chat.settings.backgroundChatEnabled) {
            const chatInterval = getBackgroundInterval(chat.settings.backgroundChatFrequency || 'low');
            window.backgroundTimers[chatId].chatTimer = setInterval(async () => {
                await triggerRandomChatMessage(chatId, chat);
            }, chatInterval);
        }
        
        // ËÆæÁΩÆ‰∏ªÂä®ÂèëÂæÆÂçöÂÆöÊó∂Âô®Ôºà‰∏∫ÊØè‰∏™ËßíËâ≤ÂçïÁã¨ËÆæÁΩÆÔºâ
        if (chat.settings.backgroundInteractionEnabled && chat.settings.backgroundWeiboEnabled && chat.settings.weiboEnabled) {
            const weiboInterval = getBackgroundInterval(chat.settings.backgroundWeiboFrequency || 'low');
            window.backgroundTimers[chatId].weiboTimer = setInterval(async () => {
                // ÈÅøÂÖçÈáçÂ§çÂèëÂ∏ÉÔºöÂ¶ÇÊûúÂ∑≤ÊúâÂü∫‰∫éÊó∂Èó¥ÁÇπÁöÑÂèëÂ∏ÉÁ≥ªÁªüÔºåÂàôË∑≥ËøáÂêéÂè∞ÂèëÂ∏É
                if (chat.settings.weiboPostingTimes && chat.settings.weiboPostingTimes.length > 0) {
                    console.log(`${chat.name} Ë∑≥ËøáÂêéÂè∞ÂèëÂ∏ÉÔºöÂ∑≤ÂêØÁî®Êó∂Èó¥ÁÇπÂèëÂ∏ÉÁ≥ªÁªü`);
                    return;
                }
                await triggerRandomWeiboPost(chatId, chat);
            }, weiboInterval);
        }
    }
}

// Ëé∑ÂèñÂêéÂè∞‰∫íÂä®Èó¥ÈöîÊó∂Èó¥
function getBackgroundInterval(frequency) {
    switch (frequency) {
        case 'low':
            return Math.random() * 1800000 + 3600000; // 1-2Â∞èÊó∂
        case 'medium':
            return Math.random() * 900000 + 1800000; // 30ÂàÜÈíü-1Â∞èÊó∂
        case 'high':
            return Math.random() * 600000 + 900000; // 10-15ÂàÜÈíü
        default:
            return Math.random() * 1800000 + 3600000; // ÈªòËÆ§1-2Â∞èÊó∂
    }
}

// Ëß¶ÂèëÈöèÊú∫ÂêéÂè∞‰∫íÂä®
async function triggerRandomBackgroundInteraction() {
    try {
        // ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™AIËßíËâ≤
        const aiChats = Object.entries(state.chats).filter(([id, chat]) => !chat.isGroup);
        if (aiChats.length === 0) return;
        
        const [chatId, chat] = aiChats[Math.floor(Math.random() * aiChats.length)];
        
        // ÈöèÊú∫ÈÄâÊã©‰∫íÂä®Á±ªÂûã
        const interactionTypes = ['chat', 'weibo'];
        const randomType = interactionTypes[Math.floor(Math.random() * interactionTypes.length)];
        
        if (randomType === 'chat') {
            // ‰∏ªÂä®ÂèëÈÄÅËÅäÂ§©Ê∂àÊÅØ
            await triggerRandomChatMessage(chatId, chat);
        } else if (randomType === 'weibo') {
            // ‰∏ªÂä®ÂèëÂ∏ÉÂæÆÂçöÂä®ÊÄÅ
            await triggerRandomWeiboPost(chatId, chat);
        }
    } catch (error) {
        console.error('ÂêéÂè∞‰∫íÂä®Â§±Ë¥•:', error);
    }
}

// Ëß¶ÂèëÈöèÊú∫ËÅäÂ§©Ê∂àÊÅØ
async function triggerRandomChatMessage(chatId, chat) {
    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) return;
        
        // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Ëá≥Â∞ë10ÂàÜÈíüÊ≤°ÊúâÂõûÂ§ç
        const lastUserMessage = chat.history.slice().reverse().find(msg => msg.role === 'user');
        if (lastUserMessage) {
            const timeSinceLastUserMessage = Date.now() - lastUserMessage.timestamp;
            const tenMinutes = 10 * 60 * 1000; // 10ÂàÜÈíü
            if (timeSinceLastUserMessage < tenMinutes) {
                console.log(`AI ${chat.name} Ë∑≥ËøáËá™Âä®ÂèëÊ∂àÊÅØÔºöÁî®Êà∑ÊúÄËøë${Math.round(timeSinceLastUserMessage / 60000)}ÂàÜÈíüÂâçÊúâÂõûÂ§ç`);
                return; // Áî®Êà∑ÊúÄËøëÊúâÊ¥ªÂä®Ôºå‰∏çÂèëÈÄÅËá™Âä®Ê∂àÊÅØ
            }
        }
        
        // Ëé∑ÂèñÊúÄËøëÁöÑËÅäÂ§©ÂéÜÂè≤ÔºàÊ†πÊçÆÁî®Êà∑ËÆæÁΩÆÁöÑËΩÆÊï∞Ôºâ
        const maxMemory = parseInt(chat.settings.maxMemory) || 10;
        const recentHistory = getHistoryByRounds(chat.history, maxMemory);
        const contextMessages = recentHistory.map(msg => ({
            role: msg.role,
            content: msg.content
        }));
        
        // Ëé∑ÂèñÁªëÂÆöÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const worldBooks = await Promise.all(
                chat.settings.linkedWorldBookIds.map(id => db.worldBooks.get(id))
            );
            const validWorldBooks = worldBooks.filter(book => book && book.content);
            if (validWorldBooks.length > 0) {
                worldBookContent = '\n\n‰∏ñÁïå‰π¶ÂÜÖÂÆπÔºà‰æõÂèÇËÄÉÔºâÔºö\n' + 
                    validWorldBooks.map(book => `${book.name}Ôºö${book.content}`).join('\n\n');
            }
        }
        
        // Ëé∑ÂèñÊúÄÊñ∞ÁöÑ5Êù°ÂæÆÂçöÂä®ÊÄÅÂèäÂÖ∂ËØÑËÆ∫
        let weiboContext = '';
        try {
            const latestPosts = await db.weiboPosts
                .orderBy('timestamp')
                .reverse()
                .limit(5)
                .toArray();
                
            if (latestPosts.length > 0) {
                weiboContext = '\n\nÊúÄÊñ∞ÁöÑÂæÆÂçöÂä®ÊÄÅÔºà‰æõÂèÇËÄÉÔºâÔºö\n';
                for (const post of latestPosts) {
                    const authorName = post.authorId === 'user' ? 'Áî®Êà∑' : 
                        (state.chats[post.authorId] ? state.chats[post.authorId].name : 'Êú™Áü•');
                    weiboContext += `\n[${authorName}]: ${post.content}`;
                    
                    // Ëé∑ÂèñËØ•Âä®ÊÄÅÁöÑËØÑËÆ∫
                    const comments = await db.weiboComments
                        .where('postId')
                        .equals(post.id)
                        .limit(3)
                        .toArray();
                        
                    if (comments.length > 0) {
                        weiboContext += '\n  ËØÑËÆ∫Ôºö';
                        for (const comment of comments) {
                            const commentAuthor = comment.authorId === 'user' ? 'Áî®Êà∑' : 
                                (state.chats[comment.authorId] ? state.chats[comment.authorId].name : 'Êú™Áü•');
                            weiboContext += `\n    - ${commentAuthor}: ${comment.content}`;
                        }
                    }
                }
            }
        } catch (error) {
            console.error('Ëé∑ÂèñÂæÆÂçöÂä®ÊÄÅÂ§±Ë¥•:', error);
        }
        
        // ÁîüÊàê‰∏ªÂä®ËÅäÂ§©ÁöÑÂÜÖÂÆπ
        const systemPrompt = `‰Ω†ÊòØ${chat.name}Ôºå‰Ω†ÁöÑ‰∫∫ËÆæÂ¶Ç‰∏ãÔºö${chat.settings.aiPersona}„ÄÇ
        
Áé∞Âú®‰Ω†Ë¶Å‰∏ªÂä®ÁªôÁî®Êà∑ÂèëÈÄÅ‰∏ÄÊù°Ê∂àÊÅØ„ÄÇËøôÊù°Ê∂àÊÅØÂ∫îËØ•ÊòØÔºö
1. Á¨¶Âêà‰Ω†ÁöÑ‰∫∫ËÆæÂíåÊÄßÊ†º
2. Ëá™ÁÑ∂„ÄÅÊúâË∂£„ÄÅÊúâ‰∫íÂä®ÊÄß
3. ÂèØ‰ª•ÊòØÈóÆÂÄô„ÄÅÂàÜ‰∫´„ÄÅËØ¢ÈóÆÁ≠â
4. ‰∏çË¶ÅËøá‰∫éÊ≠£ÂºèÔºåË¶ÅÂÉèÊúãÂèãÈó¥ÁöÑÊó•Â∏∏ËÅäÂ§©
5. Â¶ÇÊûúÊúâËÅäÂ§©ÂéÜÂè≤ÔºåË¶ÅÂü∫‰∫éÂéÜÂè≤ÂÜÖÂÆπËøõË°åËá™ÁÑ∂ÁöÑÂª∂Áª≠ÊàñÂõûÂ∫î
6. Â¶ÇÊûúÊúâ‰∏ñÁïå‰π¶ÂÜÖÂÆπÔºåÂèØ‰ª•ÁªìÂêà‰∏ñÁïå‰π¶‰∏≠ÁöÑËÆæÂÆöÂíåËØùÈ¢òËøõË°å‰∫íÂä®
7. Â¶ÇÊûúÊúâÊúÄÊñ∞ÁöÑÂæÆÂçöÂä®ÊÄÅÔºåÂèØ‰ª•ÈÄÇÂΩìÊèêÂèäÊàñÂºïÁî®ÔºåËÆ©ÂØπËØùÊõ¥Ëá™ÁÑ∂${worldBookContent}${weiboContext}

‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤ÔºåÊØè‰∏™ÂÖÉÁ¥†ÊòØ‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ‰Ω†ÂèØ‰ª•ÁîüÊàê1-3Êù°Ê∂àÊÅØÔºåÊ®°ÊãüÁúü‰∫∫Âú®Áü≠Êó∂Èó¥ÂÜÖËøûÁª≠ÂèëÈÄÅÂ§öÊù°‰ø°ÊÅØÁöÑÊÉÖÊôØ„ÄÇ

JSONËæìÂá∫Ê†ºÂºèÁ§∫‰æã:
["Á¨¨‰∏ÄÊù°Ê∂àÊÅØ", "Á¨¨‰∫åÊù°Ê∂àÊÅØ", "Á¨¨‰∏âÊù°Ê∂àÊÅØ"]

ËØ∑ÁîüÊàê‰∏ÄÊù°Ê∂àÊÅØÔºö`;

        const messages = [
            { role: 'system', content: systemPrompt },
            ...contextMessages,
            { role: 'user', content: 'ËØ∑ÁîüÊàê‰∏ÄÊù°‰∏ªÂä®ËÅäÂ§©ÁöÑÊ∂àÊÅØÔºåË¶ÅÂü∫‰∫éÊàë‰ª¨ÁöÑËÅäÂ§©ÂéÜÂè≤Âíå‰∏ñÁïå‰π¶ÂÜÖÂÆπËøõË°åËá™ÁÑ∂ÁöÑÂª∂Áª≠' }
        ];

        const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: model,
                messages: messages,
                temperature: 0.8,
                stream: false
            })
        });

        if (!response.ok) return;
        
        const data = await response.json();
        const content = data.choices[0].message.content.trim();
        
        if (content) {
            // Ëß£ÊûêAIÂõûÂ§çÂÜÖÂÆπÔºåÊîØÊåÅÂ§öÊù°Ê∂àÊÅØ
            const messagesArray = parseAiResponse(content);
            
            // ‰∏∫ÊØèÊù°Ê∂àÊÅØÂàõÂª∫ÂçïÁã¨ÁöÑÊ∂àÊÅØÂØπË±°
            for (const msgData of messagesArray) {
                let aiMessage;
                
                if (typeof msgData === 'object' && msgData.type === 'voice_message') {
                    aiMessage = { 
                        role: 'assistant', 
                        type: 'voice_message', 
                        content: msgData.content, 
                        timestamp: Date.now() 
                    };
                } else if (typeof msgData === 'object' && msgData.type === 'ai_image') {
                    aiMessage = { 
                        role: 'assistant', 
                        type: 'ai_image', 
                        content: msgData.description, 
                        timestamp: Date.now() 
                    };
                } else if (typeof msgData === 'object' && msgData.type === 'transfer') {
                    aiMessage = { 
                        role: 'assistant', 
                        type: 'transfer', 
                        amount: msgData.amount, 
                        note: msgData.note, 
                        timestamp: Date.now() 
                    };
                } else {
                    aiMessage = { 
                        role: 'assistant', 
                        content: String(msgData), 
                        timestamp: Date.now() 
                    };
                }
                
                chat.history.push(aiMessage);
            }
            
            await db.chats.put(chat);
            
            // ÊòæÁ§∫ÈÄöÁü•ÔºàÂè™ÊòæÁ§∫Á¨¨‰∏ÄÊù°Ê∂àÊÅØÔºâ
            const firstMessage = messagesArray[0];
            let notificationText = '';
            if (typeof firstMessage === 'object' && firstMessage.type === 'transfer') {
                notificationText = '[Êî∂Âà∞‰∏ÄÁ¨îËΩ¨Ë¥¶]';
            } else if (typeof firstMessage === 'object' && firstMessage.type === 'ai_image') {
                notificationText = '[ÂõæÁâá]';
            } else if (typeof firstMessage === 'object' && firstMessage.type === 'voice_message') {
                notificationText = '[ËØ≠Èü≥]';
            } else {
                const textContent = String(firstMessage);
                notificationText = STICKER_REGEX.test(textContent) ? '[Ë°®ÊÉÖ]' : textContent;
            }
            
            showNotification(chatId, notificationText.substring(0, 30) + (notificationText.length > 30 ? '...' : ''), 'chat');
            
            // Êõ¥Êñ∞ËÅäÂ§©ÂàóË°®
            renderChatList();
        }
    } catch (error) {
        console.error('ÁîüÊàêÈöèÊú∫ËÅäÂ§©Ê∂àÊÅØÂ§±Ë¥•:', error);
    }
}

// Ëß¶ÂèëÈöèÊú∫ÂæÆÂçöÂèëÂ∏É
async function triggerRandomWeiboPost(chatId, chat) {
    try {
        if (!chat.settings.weiboEnabled) return;
        
        // Ê£ÄÊü•ÂÜ∑Âç¥Êó∂Èó¥ÔºàÈÅøÂÖçÁü≠Êó∂Èó¥ÂÜÖÈáçÂ§çÂèëÂ∏ÉÔºâ
        const lastPostTime = chat.lastWeiboPostTime || 0;
        const cooldownTime = 30 * 60 * 1000; // 30ÂàÜÈíüÂÜ∑Âç¥Êó∂Èó¥
        if (Date.now() - lastPostTime < cooldownTime) {
            console.log(`${chat.name} Âú®ÂÜ∑Âç¥Êó∂Èó¥ÂÜÖÔºåË∑≥ËøáÂèëÂ∏É`);
            return;
        }
        
        const content = await generateAiPostContent(chat);
        if (content) {
            await publishAiPost(chatId, content);
            
            // ËÆ∞ÂΩïÂèëÂ∏ÉÊó∂Èó¥
            chat.lastWeiboPostTime = Date.now();
            await db.chats.put(chat);
            
            // ÊòæÁ§∫ÈÄöÁü•
            showNotification(chatId, `ÂèëÂ∏É‰∫ÜÊñ∞Âä®ÊÄÅ: ${content.substring(0, 30)}...`, 'weibo');
        }
    } catch (error) {
        console.error('ÁîüÊàêÈöèÊú∫ÂæÆÂçöÂ§±Ë¥•:', error);
    }
}

// ‰∏∫Âçï‰∏™AIËßíËâ≤ËÆæÁΩÆÂèëÂ∏ÉÂÆöÊó∂Âô®
async function setupAiPostingTimer(chatId, chat) {
    const frequency = chat.settings.weiboFrequency || 'low';
    const postingTimes = chat.settings.weiboPostingTimes || [];
    
    // Âè™ÊúâÂú®Áî®Êà∑ÊâãÂä®ËÆæÁΩÆ‰∫ÜÊó∂Èó¥ÁÇπÊó∂Êâç‰ΩøÁî®ÂÆöÊó∂ÂèëÂ∏ÉÁ≥ªÁªü
    if (postingTimes.length > 0) {
        // Â≠òÂÇ®ÂÆöÊó∂Âô®‰ø°ÊÅØ
        aiPostingTimers.set(chatId, {
            frequency,
            postingTimes: chat.settings.weiboPostingTimes,
            lastCheckDate: new Date().toDateString()
        });
        console.log(`${chat.name} ÂêØÁî®ÂÆöÊó∂ÂèëÂ∏ÉÁ≥ªÁªüÔºåÊó∂Èó¥ÁÇπ:`, postingTimes);
    } else {
        console.log(`${chat.name} Êú™ËÆæÁΩÆÂèëÂ∏ÉÊó∂Èó¥ÁÇπÔºåÂ∞Ü‰ΩøÁî®ÂêéÂè∞ÈöèÊú∫ÂèëÂ∏É`);
    }
}

// Ê£ÄÊü•ÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
async function checkAiPostingTimes() {
    const now = new Date();
    const currentTime = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
    const currentDate = now.toDateString();
    
    for (const [chatId, timerInfo] of aiPostingTimers.entries()) {
        const chat = state.chats[chatId];
        if (!chat || !chat.settings.weiboEnabled) continue;
        
        // Ê£ÄÊü•ÊòØÂê¶ÊòØÊñ∞ÁöÑ‰∏ÄÂ§©
        if (timerInfo.lastCheckDate !== currentDate) {
            // Êñ∞ÁöÑ‰∏ÄÂ§©ÔºåÈáçÊñ∞ÁîüÊàêÊó∂Èó¥ÁÇπÔºà‰ªÖÂú®Â∑≤ÊúâÊó∂Èó¥ÁÇπÁöÑÊÉÖÂÜµ‰∏ãÔºâ
            if (timerInfo.postingTimes && timerInfo.postingTimes.length > 0) {
                const newTimes = scheduleAiPosts(chatId, timerInfo.frequency);
                timerInfo.postingTimes = newTimes;
                timerInfo.lastCheckDate = currentDate;
                
                // Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì
                chat.settings.weiboPostingTimes = newTimes;
                await db.chats.put(chat);
                console.log(`${chat.name} Êñ∞ÁöÑ‰∏ÄÂ§©ÔºåÈáçÊñ∞ÁîüÊàêÂèëÂ∏ÉÊó∂Èó¥ÁÇπ:`, newTimes);
            }
        }
        
        // Ê£ÄÊü•ÊòØÂê¶Âà∞ËææÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
        if (timerInfo.postingTimes.includes(currentTime)) {
            await triggerAiAutoPost(chatId, chat);
        }
    }
}

// Ëß¶ÂèëAIËá™Âä®ÂèëÂ∏É
async function triggerAiAutoPost(chatId, chat) {
    try {
        // Ê£ÄÊü•ÂÜ∑Âç¥Êó∂Èó¥ÔºàÈÅøÂÖçÁü≠Êó∂Èó¥ÂÜÖÈáçÂ§çÂèëÂ∏ÉÔºâ
        const lastPostTime = chat.lastWeiboPostTime || 0;
        const cooldownTime = 30 * 60 * 1000; // 30ÂàÜÈíüÂÜ∑Âç¥Êó∂Èó¥
        if (Date.now() - lastPostTime < cooldownTime) {
            console.log(`${chat.name} Âú®ÂÜ∑Âç¥Êó∂Èó¥ÂÜÖÔºåË∑≥ËøáÂÆöÊó∂ÂèëÂ∏É`);
            return;
        }
        
        // ÁîüÊàêÁ¨¶Âêà‰∫∫ËÆæÁöÑÂä®ÊÄÅÂÜÖÂÆπ
        const content = await generateAiPostContent(chat);
        
        if (content) {
            await publishAiPost(chatId, content);
            
            // ËÆ∞ÂΩïÂèëÂ∏ÉÊó∂Èó¥
            chat.lastWeiboPostTime = Date.now();
            await db.chats.put(chat);
            
            console.log(`AI ${chat.name} Ëá™Âä®ÂèëÂ∏É‰∫ÜÂä®ÊÄÅ: ${content}`);
        }
    } catch (error) {
        console.error(`AIËá™Âä®ÂèëÂ∏ÉÂ§±Ë¥•: ${error.message}`);
    }
}

// ÁîüÊàêAIÂä®ÊÄÅÂÜÖÂÆπÔºåÁªìÂêàÊúÄËøëËÅäÂ§©ËÆ∞ÂΩï
async function generateAiPostContent(chat, visibility = 'public') {
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        throw new Error('APIÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåËØ∑Ê£ÄÊü•Âèç‰ª£Âú∞ÂùÄ„ÄÅÂØÜÈí•ÂíåÊ®°ÂûãËÆæÁΩÆ');
    }
    try {
        const persona = chat.settings?.aiPersona || '';
        const specialHabit = /ÂñúÊ¨¢Âèë(.*?)„ÄÇ/.exec(persona)?.[1] || '';
        // Ëé∑ÂèñÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºàÊ†πÊçÆÁî®Êà∑ËÆæÁΩÆÁöÑËΩÆÊï∞Ôºâ
        const maxMemory = parseInt(chat.settings.maxMemory) || 10;
        const history = getHistoryByRounds(chat.history || [], maxMemory);
        let chatSummary = '';
        if (history.length > 0) {
            chatSummary = '‰ª•‰∏ãÊòØ‰Ω†ÂíåÁî®Êà∑ÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩïÊëòË¶ÅÔºå‰ªÖ‰æõ‰Ω†ÂèëÂæÆÂçöÊó∂ÂèÇËÄÉÔºö\n';
            chatSummary += history.map(msg => {
                if (msg.role === 'user') return `Áî®Êà∑Ôºö${msg.content}`;
                if (msg.role === 'assistant') return `${chat.name}Ôºö${msg.content}`;
                return '';
            }).join('\n');
        }
        
        // Ëé∑ÂèñÊúÄÊñ∞ÁöÑ5Êù°ÂæÆÂçöÂä®ÊÄÅÂèäÂÖ∂ËØÑËÆ∫
        let weiboContext = '';
        try {
            const latestPosts = await db.weiboPosts
                .orderBy('timestamp')
                .reverse()
                .limit(5)
                .toArray();
                
            if (latestPosts.length > 0) {
                weiboContext = '\n\nÊúÄÊñ∞ÁöÑÂæÆÂçöÂä®ÊÄÅÔºà‰æõÂèÇËÄÉÔºâÔºö\n';
                for (const post of latestPosts) {
                    const authorName = post.authorId === 'user' ? 'Áî®Êà∑' : 
                        (state.chats[post.authorId] ? state.chats[post.authorId].name : 'Êú™Áü•');
                    weiboContext += `\n[${authorName}]: ${post.content}`;
                    
                    // Ëé∑ÂèñËØ•Âä®ÊÄÅÁöÑËØÑËÆ∫
                    const comments = await db.weiboComments
                        .where('postId')
                        .equals(post.id)
                        .limit(3)
                        .toArray();
                        
                    if (comments.length > 0) {
                        weiboContext += '\n  ËØÑËÆ∫Ôºö';
                        for (const comment of comments) {
                            const commentAuthor = comment.authorId === 'user' ? 'Áî®Êà∑' : 
                                (state.chats[comment.authorId] ? state.chats[comment.authorId].name : 'Êú™Áü•');
                            weiboContext += `\n    - ${commentAuthor}: ${comment.content}`;
                        }
                    }
                }
            }
        } catch (error) {
            console.error('Ëé∑ÂèñÂæÆÂçöÂä®ÊÄÅÂ§±Ë¥•:', error);
        }
        
        // Ëé∑ÂèñÁªëÂÆöÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const worldBooks = await Promise.all(
                chat.settings.linkedWorldBookIds.map(id => db.worldBooks.get(id))
            );
            const validWorldBooks = worldBooks.filter(book => book && book.content);
            if (validWorldBooks.length > 0) {
                worldBookContent = '\n\n‰∏ñÁïå‰π¶ÂÜÖÂÆπÔºà‰æõÂèÇËÄÉÔºâÔºö\n' + 
                    validWorldBooks.map(book => `${book.name}Ôºö${book.content}`).join('\n\n');
            }
        }
        
        let systemPrompt = `‰Ω†ÊòØ${chat.name}Ôºå‰Ω†ÁöÑ‰∫∫ËÆæÂ¶Ç‰∏ãÔºö${persona}„ÄÇ`;
        if (specialHabit) {
            systemPrompt += `‰Ω†Âπ≥Êó∂ÂñúÊ¨¢Âèë${specialHabit}ÔºåËØ∑‰ºòÂÖà‰ª•Ê≠§È£éÊ†ºÂèëÂæÆÂçö„ÄÇ`;
        }
        
        // Ê∑ªÂä†ÂõæÁâáÁîüÊàêÁöÑÊåáÂØº
        const includeImage = Math.random() < 0.4; // 40%Ê¶ÇÁéáÁîüÊàêÂ∏¶ÂõæÁâáÁöÑÂä®ÊÄÅ
        if (includeImage) {
            systemPrompt += `\n\nËØ∑ÁîüÊàê‰∏ÄÊù°Â∏¶ÂõæÁâáÁöÑÂæÆÂçöÂä®ÊÄÅÔºåÂåÖÊã¨Ôºö
1. ÁÆÄÁü≠ÁöÑÊñáÂ≠óÂÜÖÂÆπÔºà30-100Â≠óÔºâ
2. ÂõæÁâáÁöÑËØ¶ÁªÜÊèèËø∞Ôºà100-200Â≠óÔºâ

ÂõûÂ§çÊ†ºÂºèÔºö
{
  "text": "ÂæÆÂçöÊñáÂ≠óÂÜÖÂÆπ",
  "imageDescription": "ÂõæÁâáÁöÑËØ¶ÁªÜÊèèËø∞ÔºàËøôÈÉ®ÂàÜ‰∏ç‰ºöÁõ¥Êé•ÊòæÁ§∫Âú®ÂæÆÂçö‰∏≠Ôºå‰ΩÜ‰ºöÂú®Áî®Êà∑ÁÇπÂáªÂõæÁâáÊó∂ÊòæÁ§∫Ôºâ"
}

ÂõæÁâáÊèèËø∞Â∫îËØ•ËØ¶ÁªÜÁîüÂä®ÔºåÂåÖÂê´Âú∫ÊôØ„ÄÅ‰∫∫Áâ©„ÄÅÂä®‰Ωú„ÄÅË°®ÊÉÖ„ÄÅËâ≤ÂΩ©Á≠âÁªÜËäÇÔºåËÆ©‰∫∫ËÉΩÂ§üÊÉ≥Ë±°Âá∫ÂõæÁâáÁöÑÊ†∑Â≠ê„ÄÇ`;
        } else {
            systemPrompt += `ËØ∑‰∏•Ê†ºÊ†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÂíå‰π†ÊÉØÔºåÁîüÊàê‰∏ÄÊù°ÂæÆÂçöÂä®ÊÄÅÔºà50-200Â≠óÔºâÔºåÂÜÖÂÆπË¶ÅÊúâ‰∏™ÊÄßÔºå‰∏çËÉΩÂíåÂÖ∂‰ªñËßíËâ≤Ê∑∑Ê∑Ü„ÄÇ`;
        }
        
        if (chatSummary) {
            systemPrompt += `\n${chatSummary}\n‰Ω†ÂèØ‰ª•ÁªìÂêàËøô‰∫õËÅäÂ§©ÂÜÖÂÆπ‰Ωú‰∏∫ÁÅµÊÑüÔºå‰ΩÜ‰∏çÂº∫Âà∂ÂøÖÈ°ªÊèêÂèä„ÄÇ`;
        }
        if (worldBookContent) {
            systemPrompt += `\n${worldBookContent}\n‰Ω†ÂèØ‰ª•ÁªìÂêà‰∏ñÁïå‰π¶‰∏≠ÁöÑËÆæÂÆöÂíåËØùÈ¢òËøõË°åÂàõ‰ΩúÔºåËÆ©ÂÜÖÂÆπÊõ¥‰∏∞ÂØåÊúâË∂£„ÄÇ`;
        }
        if (weiboContext) {
            systemPrompt += `\n${weiboContext}\n‰Ω†ÂèØ‰ª•ÂèÇËÄÉËøô‰∫õÊúÄÊñ∞ÁöÑÂæÆÂçöÂä®ÊÄÅÂíå‰∫íÂä®Ôºå‰ΩÜ‰∏çË¶ÅÁõ¥Êé•ÈáçÂ§çÊàñÂàªÊÑèÊèêÂèä„ÄÇ`;
        }
        systemPrompt += `‰Ω†‰∏çÈúÄË¶ÅÂú®ÊñáÊ°àÈáåÂÜôÊòéÂèØËßÅÊÄßÔºåÁ≥ªÁªü‰ºöËá™Âä®ËÆæÁΩÆ„ÄÇ`;
        const messages = [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: 'ËØ∑ÂèëÂ∏É‰∏ÄÊù°ÂæÆÂçöÂä®ÊÄÅ' }
        ];
        const requestBody = {
            model: model,
            messages: messages,
            temperature: 0.7,
            stream: false
        };
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 90000); // Â¢ûÂä†Âà∞90ÁßíË∂ÖÊó∂
        // Ê£ÄÊµãÊòØÂê¶ÊòØGeminiÂÆòÊñπAPI
        const isGeminiOfficial = proxyUrl.includes('generativelanguage.googleapis.com');
        
        let response;
        if (isGeminiOfficial) {
            // ‰ΩøÁî®GeminiÂÆòÊñπAPIÊ†ºÂºè
            const apiUrl = `${proxyUrl}/models/${model}:generateContent?key=${apiKey}`;
            
            // ËΩ¨Êç¢Ê∂àÊÅØÊ†ºÂºè‰∏∫GeminiÊ†ºÂºè
            const geminiMessages = [];
            
            // Ê∑ªÂä†Á≥ªÁªüÊèêÁ§∫ËØç‰Ωú‰∏∫Á¨¨‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ
            if (requestBody.messages[0]?.role === 'system') {
                geminiMessages.push({
                    role: 'user',
                    parts: [{ text: requestBody.messages[0].content }]
                });
                geminiMessages.push({
                    role: 'model',
                    parts: [{ text: 'ÊàëÊòéÁôΩ‰∫ÜÔºåÊàë‰ºöÊåâÁÖßËøô‰∫õË¶ÅÊ±ÇËøõË°åÂØπËØù„ÄÇ' }]
                });
            }
            
            // ËΩ¨Êç¢ÂÖ∂‰ªñÊ∂àÊÅØ
            for (let i = 1; i < requestBody.messages.length; i++) {
                const msg = requestBody.messages[i];
                if (msg.role === 'system') continue; // Ë∑≥ËøáÁ≥ªÁªüÊ∂àÊÅØ
                
                let content = '';
                if (typeof msg.content === 'string') {
                    content = msg.content;
                } else if (Array.isArray(msg.content)) {
                    content = msg.content.map(item => {
                        if (item.type === 'text') return item.text;
                        if (item.type === 'image_url') return '[ÂõæÁâá]';
                        return '';
                    }).join('');
                }
                
                geminiMessages.push({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: content }]
                });
            }
            
            response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: geminiMessages,
                    generationConfig: {
                        temperature: requestBody.temperature || 0.7,
                        maxOutputTokens: 8192
                    }
                }),
                signal: controller.signal
            });
        } else {
            // ‰ΩøÁî®OpenAIÊ†ºÂºèÔºàÊä±ËÑ∏Á≠â‰ª£ÁêÜÔºâ
            response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify(requestBody),
                signal: controller.signal
            });
        }
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            let errorText = await response.text();
            throw new Error(`APIË∞ÉÁî®Â§±Ë¥• (${response.status}): ${errorText}`);
        }
        
        const data = await response.json();
        let content;
        
        if (isGeminiOfficial) {
            // Ëß£ÊûêGemini APIÂìçÂ∫î
            content = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!content) {
                console.log('Gemini API ÂìçÂ∫îÊï∞ÊçÆ:', data);
                throw new Error('Gemini APIËøîÂõû‰∫ÜÁ©∫ÂÜÖÂÆπ');
            }
        } else {
            // Ëß£ÊûêOpenAIÊ†ºÂºèÂìçÂ∫îÔºàÂåÖÊã¨Êä±ËÑ∏Á≠â‰ª£ÁêÜÔºâ
            if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                content = data.choices[0].message.content;
            } else if (data.message) {
                // Êüê‰∫õ‰ª£ÁêÜÂèØËÉΩÁõ¥Êé•ËøîÂõûmessageÂ≠óÊÆµ
                content = data.message;
            } else if (data.text) {
                // Êüê‰∫õ‰ª£ÁêÜÂèØËÉΩËøîÂõûtextÂ≠óÊÆµ
                content = data.text;
            } else if (data.response) {
                // Êüê‰∫õ‰ª£ÁêÜÂèØËÉΩËøîÂõûresponseÂ≠óÊÆµ
                content = data.response;
            }
            // 5. ÈÉ®ÂàÜ‰ª£ÁêÜÂèØËÉΩËøîÂõûcontentÂ≠óÊÆµ
            else if (data.content) {
                content = data.content;
            }
            // 6. ÈÉ®ÂàÜ‰ª£ÁêÜÂèØËÉΩËøîÂõûresultÂ≠óÊÆµ
            else if (data.result) {
                content = data.result;
            }
            // 7. Â∞ùËØïÊü•ÊâæÁ¨¨‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤Á±ªÂûãÁöÑÂÄº
            else {
                console.log('ÂæÆÂçöÂèëÂ∏ÉAPIÈùûÊ†áÂáÜÂìçÂ∫îÊ†ºÂºèÔºåÂ∞ùËØïÊü•ÊâæÂÜÖÂÆπ:', data);
                // ÈÅçÂéÜÂØπË±°ÁöÑÊâÄÊúâÈîÆÔºåÊü•ÊâæÁ¨¨‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤ÂÄº
                for (const key in data) {
                    if (typeof data[key] === 'string' && data[key].trim()) {
                        content = data[key];
                        console.log(`ÂæÆÂçöÂèëÂ∏ÉAPI‰ΩøÁî®Â≠óÊÆµ "${key}" ‰Ωú‰∏∫ÂìçÂ∫îÂÜÖÂÆπ`);
                        break;
                    }
                }
            }
            
            if (!content) {
                console.error('ÂæÆÂçöÂèëÂ∏ÉAPIÊó†Ê≥ïËß£ÊûêÂìçÂ∫îÔºåÂÆåÊï¥ÂìçÂ∫îÊï∞ÊçÆ:', data);
                throw new Error('ÂæÆÂçöÂèëÂ∏ÉAPIËøîÂõû‰∫ÜÁ©∫ÂÜÖÂÆπÊàñÊó†Ê≥ïËØÜÂà´ÁöÑÊ†ºÂºèÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆ');
            }
        }
        
        content = content.trim();
        
        // Â§ÑÁêÜÂ∏¶ÂõæÁâáÁöÑÂæÆÂçöÂÜÖÂÆπ
        if (includeImage) {
            try {
                // Â∞ùËØïËß£ÊûêJSONÊ†ºÂºèÁöÑÂìçÂ∫î
                let parsedContent;
                try {
                    // Â∞ùËØïÁõ¥Êé•Ëß£Êûê
                    parsedContent = JSON.parse(content);
                } catch (e) {
                    // Â¶ÇÊûúÁõ¥Êé•Ëß£ÊûêÂ§±Ë¥•ÔºåÂ∞ùËØïÊèêÂèñJSONÈÉ®ÂàÜ
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        parsedContent = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error("Êó†Ê≥ïËß£ÊûêJSONÊ†ºÂºè");
                    }
                }
                
                if (parsedContent && parsedContent.text && parsedContent.imageDescription) {
                    // ‰ΩøÁî®Âõ∫ÂÆöÁöÑÂõæÁâáURLÊ†ºÂºèÔºå‰∏éËÅäÂ§©‰∏≠‰∏ÄËá¥
                    const imageUrl = "https://i.postimg.cc/KYr2qRCK/1.jpg";
                    return {
                        content: parsedContent.text,
                        imageUrl: imageUrl,
                        imageDescription: parsedContent.imageDescription,
                        visibility
                    };
                } else {
                    // Â¶ÇÊûúËß£ÊûêÂ§±Ë¥•ÊàñÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåËøîÂõûÁ∫ØÊñáÊú¨ÂÜÖÂÆπ
                    return { content, visibility };
                }
            } catch (e) {
                console.error("Ëß£ÊûêÂõæÁâáÂÜÖÂÆπÂ§±Ë¥•:", e);
                return { content, visibility };
            }
        } else {
            return { content, visibility };
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            throw new Error('ËØ∑Ê±ÇË∂ÖÊó∂ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÁ®çÂêéÈáçËØï');
        } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
            if (proxyUrl.includes('generativelanguage.googleapis.com')) {
                throw new Error('CORSÈîôËØØÔºöÊó†Ê≥ïÁõ¥Êé•‰ªéÊµèËßàÂô®ËÆøÈóÆGeminiÂÆòÊñπAPI„ÄÇ\n\nËß£ÂÜ≥ÊñπÊ°àÔºö\n1. ‰ΩøÁî®HTTPÊúçÂä°Âô®ËøêË°åÊ≠§Êñá‰ª∂\n2. ‰ΩøÁî®‰ª£ÁêÜAPIÊúçÂä°\n3. Âú®ËÆæÁΩÆ‰∏≠ÂàáÊç¢Âà∞Êä±ËÑ∏Á≠âÊîØÊåÅË∑®ÂüüÁöÑAPI');
            } else {
                throw new Error('ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Âèç‰ª£Âú∞ÂùÄÊòØÂê¶Ê≠£Á°ÆÊàñÁΩëÁªúËøûÊé•');
            }
        } else if (error.message.includes('CORS') || error.message.includes('Access-Control')) {
            throw new Error('CORSË∑®ÂüüÈîôËØØÔºöËØ∑‰ΩøÁî®HTTPÊúçÂä°Âô®ËøêË°åÊ≠§Êñá‰ª∂ÔºåÊàñÂàáÊç¢Âà∞ÊîØÊåÅË∑®ÂüüÁöÑAPIÊúçÂä°');
        }
        throw error;
    }
}

// Ê∏ÖÈô§ÊâÄÊúâAIÂèëÂ∏ÉÂÆöÊó∂Âô®
function clearAllAiPostingTimers() {
    aiPostingTimers.clear();
}

// Ëß¶ÂèëAIËßíËâ≤ÂØπÁî®Êà∑Âä®ÊÄÅÁöÑ‰∫íÂä®
async function triggerAiInteraction(post) {
    console.log('Ëß¶ÂèëAI‰∫íÂä®ÔºåÂä®ÊÄÅID:', post.id, 'Áé∞ÊúâAIËßíËâ≤Êï∞Èáè:', Object.keys(state.chats).filter(id => !state.chats[id].isGroup).length);
    
    try {
        // Ê£ÄÊü•Âä®ÊÄÅÂèØËßÅÊÄß
        if (post.visibility === 'private') {
            console.log('ËøôÊòØÁßÅÂØÜÂä®ÊÄÅÔºå‰∏çËß¶ÂèëAI‰∫íÂä®');
            return; // ÁßÅÂØÜÂä®ÊÄÅ‰∏çËß¶ÂèëAI‰∫íÂä®
        }
        
        // ÈÅçÂéÜÊâÄÊúâAIËßíËâ≤ÔºåËÆ©ÂÆÉ‰ª¨ÂØπÁî®Êà∑ÁöÑÂä®ÊÄÅËøõË°å‰∫íÂä®
        for (const [chatId, chat] of Object.entries(state.chats)) {
            if (chat.isGroup) continue; // Ë∑≥ËøáÁæ§ËÅä
            
            // Â¶ÇÊûúÊòØÂ•ΩÂèãÂèØËßÅÂä®ÊÄÅÔºåÊ£ÄÊü•ÊòØÂê¶‰∏∫Áæ§ËÅäÂ•ΩÂèã
            if (post.visibility === 'friends') {
                // Ê£ÄÊü•ÊòØÂê¶Âú®Âêå‰∏Ä‰∏™Áæ§ËÅä‰∏≠
                const isInSameGroup = Object.values(state.chats)
                    .filter(c => c.isGroup)
                    .some(group => 
                        group.members && 
                        group.members.includes(chatId) && 
                        group.members.includes(post.authorId)
                    );
                
                if (!isInSameGroup) {
                    console.log(`${chat.name} ‰∏çÊòØ ${post.authorName} ÁöÑÁæ§ËÅäÂ•ΩÂèãÔºåË∑≥Ëøá‰∫íÂä®`);
                    continue; // ‰∏çÊòØÁæ§ËÅäÂ•ΩÂèãÔºåË∑≥Ëøá‰∫íÂä®
                }
            }
            
            console.log(`Ê£ÄÊü•AI: ${chat.name} (${chatId})`);
            
            // Ê£ÄÊü•APIÈÖçÁΩÆ
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) {
                console.log('APIÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåË∑≥ËøáAI‰∫íÂä®');
                continue;
            }
            
            // Ê£ÄÊü•Âä®ÊÄÅÂèØËßÅÊÄß
            if (post.visibility === 'private') {
                console.log(`${chat.name} Ë∑≥Ëøá‰∫íÂä®ÔºöÂä®ÊÄÅÊòØÁßÅÂØÜÁöÑ`);
                continue; // ÁßÅÂØÜÂä®ÊÄÅÂè™ÊúâÁî®Êà∑ËÉΩÁúãÂà∞ÔºåAI‰∏ç‰ºö‰∫íÂä®
            }
            
            if (post.visibility === 'friends') {
                // Ê£ÄÊü•ÊòØÂê¶Âú®Âêå‰∏ÄÁæ§ËÅä‰∏≠ÔºàÂç≥ÊòØÂê¶‰∏∫"Â•ΩÂèã"Ôºâ
                const isInSameGroup = await checkIfInSameGroup(post.authorId, chatId);
                if (!isInSameGroup && !post.content.includes(`@${chat.name}`)) {
                    console.log(`${chat.name} Ë∑≥Ëøá‰∫íÂä®ÔºöÂä®ÊÄÅ‰ªÖÈôêÂ•ΩÂèãÂèØËßÅ‰∏î‰∏çÊòØÂ•ΩÂèãÂÖ≥Á≥ª`);
                    continue; // ÈùûÂ•ΩÂèãÂÖ≥Á≥ª‰∏îÊ≤°ÊúâË¢´@Ôºå‰∏ç‰∫íÂä®
                }
            }
            
            // Ê£ÄÊü•ÊòØÂê¶@‰∫ÜËØ•AIËßíËâ≤ÔºàÊ£ÄÊü•contentÂíådescriptionÂ≠óÊÆµÔºâ
            const postText = post.content || post.description || '';
            const isAtMentioned = postText.includes(`@${chat.name}`);
            
            // Ê†πÊçÆÊòØÂê¶Ë¢´@ÂÜ≥ÂÆö‰∫íÂä®Ê¶ÇÁéá
            const interactionProbability = isAtMentioned ? 1.0 : 0.8; // @Êó∂100%Ê¶ÇÁéáÔºåÂê¶Âàô80%Ê¶ÇÁéá
            const shouldInteract = Math.random() < interactionProbability;
            console.log(`${chat.name} ÊòØÂê¶Ë¢´@:`, isAtMentioned, `‰∫íÂä®Ê¶ÇÁéá:`, interactionProbability, `ÊòØÂê¶‰∫íÂä®:`, shouldInteract);
            if (!shouldInteract) continue;
            
            // ÈöèÊú∫ÈÄâÊã©‰∫íÂä®Á±ªÂûãÔºåËØÑËÆ∫Ê¶ÇÁéáÊõ¥È´ò
            const rand = Math.random();
            let randomType;
            if (rand < 0.5) randomType = 'comment'; // 50%Ê¶ÇÁéáËØÑËÆ∫
            else if (rand < 0.8) randomType = 'like'; // 30%Ê¶ÇÁéáÁÇπËµû
            else randomType = 'repost'; // 20%Ê¶ÇÁéáËΩ¨Âèë
            
            console.log(`${chat.name} ÈÄâÊã©ÁöÑ‰∫íÂä®Á±ªÂûã:`, randomType);
            
            let userContent = '';
            let notificationMessage = '';
            
            if (randomType === 'comment') {
                // ÁîüÊàêËØÑËÆ∫ÂÜÖÂÆπ
                try {
                    const commentResponse = await generateAiResponse(chat, 'comment', post, userContent);
                    if (commentResponse) {
                        const commentId = Date.now() + Math.random(); // ÈÅøÂÖçIDÂÜ≤Á™Å
                        const commentData = {
                            id: commentId,
                            postId: post.id,
                            authorId: chatId,
                            timestamp: Date.now(),
                            replies: [] // ÂàùÂßãÂåñÂõûÂ§çÊï∞ÁªÑ
                        };

                        // Â§ÑÁêÜË°®ÊÉÖÂåÖÊ†ºÂºèÁöÑÂõûÂ§ç
                        if (typeof commentResponse === 'object' && commentResponse.type === 'sticker') {
                            commentData.content = commentResponse.content;
                            commentData.meaning = commentResponse.meaning;
                        } else {
                            commentData.content = commentResponse;
                        }

                        await db.weiboComments.add(commentData);
                        notificationMessage = `ËØÑËÆ∫‰∫Ü‰Ω†ÁöÑÂä®ÊÄÅ`;
                        console.log(`${chat.name} ÊàêÂäüËØÑËÆ∫:`, commentResponse);
                    }
                } catch (error) {
                    console.error(`${chat.name} ËØÑËÆ∫Â§±Ë¥•:`, error);
                }
            } else if (randomType === 'like') {
                // Ê∑ªÂä†ÁÇπËµû
                try {
                    await db.weiboLikes.add({
                        postId: post.id,
                        authorId: chatId,
                        timestamp: Date.now()
                    });
                    notificationMessage = `ÁÇπËµû‰∫Ü‰Ω†ÁöÑÂä®ÊÄÅ`;
                    console.log(`${chat.name} ÊàêÂäüÁÇπËµû`);
                } catch (error) {
                    console.error(`${chat.name} ÁÇπËµûÂ§±Ë¥•:`, error);
                }
            } else if (randomType === 'repost') {
                // ÁîüÊàêËΩ¨ÂèëÂÜÖÂÆπ
                try {
                    const repostResponse = await generateAiResponse(chat, 'repost', post, userContent);
                    if (repostResponse) {
                        // ÂàõÂª∫ËΩ¨ÂèëÂä®ÊÄÅ
                        const repostPost = {
                            id: Date.now() + Math.random(), // ÈÅøÂÖçIDÂÜ≤Á™Å
                            authorId: chatId,
                            authorName: chat.name,
                            authorAvatar: chat.settings.aiAvatar || defaultAvatar,
                            authorEmail: chat.settings.aiSignature || '',
                            authorSignature: chat.settings.aiSignature || '',
                            content: repostResponse,
                            visibility: 'public',
                            timestamp: Date.now(),
                            isRepost: true,
                            originalPostId: post.id
                        };
                        
                        await db.weiboPosts.add(repostPost);
                        
                        // Ê∑ªÂä†ËΩ¨ÂèëËÆ∞ÂΩï
                        await db.weiboReposts.add({
                            id: Date.now() + Math.random(),
                            originalPostId: post.id,
                            authorId: chatId,
                            content: repostResponse,
                            timestamp: Date.now()
                        });
                        notificationMessage = `ËΩ¨Âèë‰∫Ü‰Ω†ÁöÑÂä®ÊÄÅ`;
                        console.log(`${chat.name} ÊàêÂäüËΩ¨Âèë:`, repostResponse);
                    }
                } catch (error) {
                    console.error(`${chat.name} ËΩ¨ÂèëÂ§±Ë¥•:`, error);
                }
            }
            
            // ÊòæÁ§∫ÈÄöÁü•
            if (notificationMessage) {
                // Âª∂ËøüÊòæÁ§∫ÈÄöÁü•ÔºåÊ®°ÊãüÁúüÂÆû‰∫íÂä®ÁöÑÊó∂Èó¥Â∑Æ
                setTimeout(() => {
                    showNotification(chatId, notificationMessage, 'weibo');
                }, Math.random() * 3000 + 1000); // 1-4ÁßíÂêéÊòæÁ§∫ÈÄöÁü•
            }
        }
        
        // ÈáçÊñ∞Ê∏≤ÊüìÊó∂Èó¥Á∫ø‰ª•ÊòæÁ§∫Êñ∞ÁöÑ‰∫íÂä®
        await renderWeiboTimeline();
        
        // Ëß¶ÂèëËßíËâ≤Èó¥‰∫íÂä®ÔºàÂú®ÊâÄÊúâAIÂÆåÊàêÂàùÂßã‰∫íÂä®ÂêéÔºâ
        setTimeout(() => {
            triggerAiToAiInteraction(post.id);
        }, Math.random() * 5000 + 3000); // 3-8ÁßíÂêéËß¶ÂèëËßíËâ≤Èó¥‰∫íÂä®
        
    } catch (error) {
        console.error('AI‰∫íÂä®Â§±Ë¥•:', error);
        // ‰∏çÊäõÂá∫ÈîôËØØÔºåÈÅøÂÖçÂΩ±ÂìçÂÖ∂‰ªñÂäüËÉΩ
    }
}

// Ê£ÄÊü•‰∏§‰∏™ËßíËâ≤ÊòØÂê¶Âú®Âêå‰∏Ä‰∏™Áæ§ËÅä‰∏≠ÔºàÂç≥ÊòØÂê¶‰∏∫"Â•ΩÂèã"ÂÖ≥Á≥ªÔºâ
async function checkIfInSameGroup(authorId, chatId) {
    // Â¶ÇÊûúÊòØÁî®Êà∑ÂèëÁöÑÂä®ÊÄÅÔºåÊ£ÄÊü•AIÊòØÂê¶Âú®Áî®Êà∑ÁöÑÁæ§ËÅä‰∏≠
    if (authorId === 'user') {
        // Ëé∑ÂèñÊâÄÊúâÁæ§ËÅä
        const groupChats = Object.values(state.chats).filter(chat => chat.isGroup);
        
        // Ê£ÄÊü•AIÊòØÂê¶Âú®‰ªª‰Ωï‰∏Ä‰∏™Áæ§ËÅä‰∏≠
        for (const groupChat of groupChats) {
            if (groupChat.members && groupChat.members.some(m => m.id === chatId || m.name === state.chats[chatId]?.name)) {
                return true;
            }
        }
    } 
    // Â¶ÇÊûúÊòØAIÂèëÁöÑÂä®ÊÄÅÔºåÊ£ÄÊü•‰∏éÂè¶‰∏Ä‰∏™AIÊòØÂê¶Âú®Âêå‰∏ÄÁæ§ËÅä
    else if (authorId !== chatId) {
        // Ëé∑ÂèñÊâÄÊúâÁæ§ËÅä
        const groupChats = Object.values(state.chats).filter(chat => chat.isGroup);
        
        // Ê£ÄÊü•‰∏§‰∏™AIÊòØÂê¶Âú®Âêå‰∏Ä‰∏™Áæ§ËÅä‰∏≠
        for (const groupChat of groupChats) {
            const authorInGroup = groupChat.members && groupChat.members.some(m => 
                m.id === authorId || m.name === state.chats[authorId]?.name);
            const chatInGroup = groupChat.members && groupChat.members.some(m => 
                m.id === chatId || m.name === state.chats[chatId]?.name);
            
            if (authorInGroup && chatInGroup) {
                return true;
            }
        }
    }
    
    return false;
}

// AIÂìçÂ∫îÁî®Êà∑‰∫íÂä®
async function triggerAiResponse(aiId, type, post, userContent = '') {
    const ai = state.chats[aiId];
    if (!ai) return;
    
    try {
        let response;
        switch (type) {
            case 'like':
                response = await generateAiResponse(ai, 'like', post);
                break;
            case 'comment':
                response = await generateAiResponse(ai, 'comment', post, userContent);
                break;
            case 'repost':
                response = await generateAiResponse(ai, 'repost', post, userContent);
                break;
        }
        
        if (response) {
            await publishAiPost(aiId, response);
        }
    } catch (error) {
        console.error('AIÂìçÂ∫îÂ§±Ë¥•:', error);
        // ‰∏çÊäõÂá∫ÈîôËØØÔºåÈÅøÂÖçÂΩ±ÂìçÂÖ∂‰ªñÂäüËÉΩ
    }
}

// ÁîüÊàêAIÂõûÂ∫îÂÜÖÂÆπÔºàÊîØÊåÅÊ•º‰∏≠Ê•ºÂõûÂ§çÔºâ
async function generateAiResponse(ai, type, post, userContent = '', replyToUser = '') {
    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        throw new Error('APIÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåËØ∑Ê£ÄÊü•Âèç‰ª£Âú∞ÂùÄ„ÄÅÂØÜÈí•ÂíåÊ®°ÂûãËÆæÁΩÆ');
    }
    try {
        const persona = ai.settings?.aiPersona || '';
        
        // Ëé∑ÂèñÁªëÂÆöÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ
        let worldBookContent = '';
        if (ai.settings.linkedWorldBookIds && ai.settings.linkedWorldBookIds.length > 0) {
            const worldBooks = await Promise.all(
                ai.settings.linkedWorldBookIds.map(id => db.worldBooks.get(id))
            );
            const validWorldBooks = worldBooks.filter(book => book && book.content);
            if (validWorldBooks.length > 0) {
                worldBookContent = '\n\n‰∏ñÁïå‰π¶ÂÜÖÂÆπÔºà‰æõÂèÇËÄÉÔºâÔºö\n' + 
                    validWorldBooks.map(book => `${book.name}Ôºö${book.content}`).join('\n\n');
            }
        }
        
        // Ëé∑ÂèñÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩï‰Ωú‰∏∫‰∏ä‰∏ãÊñáÔºàÊ†πÊçÆÁî®Êà∑ËÆæÁΩÆÁöÑËΩÆÊï∞Ôºâ
        let chatContext = '';
        if (ai.history && ai.history.length > 0) {
            const maxMemory = parseInt(ai.settings.maxMemory) || 10;
            const recentHistory = getHistoryByRounds(ai.history, maxMemory);
            chatContext = '\n\nÊúÄËøëÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºà‰æõÂèÇËÄÉÔºâÔºö\n' + 
                recentHistory.map(msg => {
                    if (msg.role === 'user') return `Áî®Êà∑Ôºö${msg.content}`;
                    return `${ai.name}Ôºö${msg.content}`;
                }).join('\n');
        }
        
        // Ëé∑ÂèñÊúÄÊñ∞ÁöÑ5Êù°ÂæÆÂçöÂä®ÊÄÅÂèäÂÖ∂ËØÑËÆ∫
        let weiboContext = '';
        try {
            const latestPosts = await db.weiboPosts
                .orderBy('timestamp')
                .reverse()
                .limit(5)
                .toArray();
                
            if (latestPosts.length > 0) {
                weiboContext = '\n\nÊúÄÊñ∞ÁöÑÂæÆÂçöÂä®ÊÄÅÔºà‰æõÂèÇËÄÉÔºâÔºö\n';
                for (const post of latestPosts) {
                    const authorName = post.authorId === 'user' ? 'Áî®Êà∑' : 
                        (state.chats[post.authorId] ? state.chats[post.authorId].name : 'Êú™Áü•');
                    weiboContext += `\n[${authorName}]: ${post.content}`;
                    
                    // Ëé∑ÂèñËØ•Âä®ÊÄÅÁöÑËØÑËÆ∫
                    const comments = await db.weiboComments
                        .where('postId')
                        .equals(post.id)
                        .limit(3)
                        .toArray();
                        
                    if (comments.length > 0) {
                        weiboContext += '\n  ËØÑËÆ∫Ôºö';
                        for (const comment of comments) {
                            const commentAuthor = comment.authorId === 'user' ? 'Áî®Êà∑' : 
                                (state.chats[comment.authorId] ? state.chats[comment.authorId].name : 'Êú™Áü•');
                            weiboContext += `\n    - ${commentAuthor}: ${comment.content}`;
                        }
                    }
                }
            }
        } catch (error) {
            console.error('Ëé∑ÂèñÂæÆÂçöÂä®ÊÄÅÂ§±Ë¥•:', error);
        }
        
        let systemPrompt = `‰Ω†ÊòØ${ai.name}Ôºå‰Ω†ÁöÑ‰∫∫ËÆæÂ¶Ç‰∏ãÔºö${persona}„ÄÇ${worldBookContent}${chatContext}${weiboContext}\n\n`;
        
        if (type === 'comment_reply') {
            systemPrompt += `Áî®Êà∑ÂàöÂàöÂú®ÂæÆÂçöÂä®ÊÄÅ‰∏ãËØÑËÆ∫‰∫ÜÔºö"${userContent}"„ÄÇËØ∑Âü∫‰∫é‰Ω†ÁöÑ‰∫∫ËÆæÔºåËá™ÁÑ∂Âú∞ÂõûÂ§çËøôÊù°ËØÑËÆ∫„ÄÇÂèØ‰ª•ÊòØËµûÂêå„ÄÅË°•ÂÖÖ„ÄÅÊèêÈóÆÊàñËÄÖÂàÜ‰∫´Áõ∏ÂÖ≥ÊÑüÂèó„ÄÇ`;
        } else if (type === 'thread_reply') {
            systemPrompt += `ËøôÊòØ‰∏Ä‰∏™Ê•º‰∏≠Ê•ºËÆ®ËÆ∫ÔºåËØ∑Âü∫‰∫é‰ª•‰∏ãÂØπËØù‰∏ä‰∏ãÊñáÔºåÁªßÁª≠ÂèÇ‰∏éËÆ®ËÆ∫„ÄÇË¶ÅÁ¨¶Âêà‰Ω†ÁöÑ‰∫∫ËÆæÔºåÂõûÂ§çË¶ÅÁÆÄÁü≠ÊúâË∂£„ÄÇ\n\n${userContent}`;
        } else if (type === 'comment') {
            systemPrompt += `ËØ∑ÂØπËøôÊù°Âä®ÊÄÅÂèëË°®ËØÑËÆ∫„ÄÇËØÑËÆ∫Ë¶ÅÁ¨¶Âêà‰Ω†ÁöÑ‰∫∫ËÆæÔºåÂèØ‰ª•ÊòØÊÑüÊÉ≥„ÄÅÁñëÈóÆ„ÄÅËµûÁæéÊàñËÄÖÂàÜ‰∫´Áõ∏ÂÖ≥ÁªèÂéÜ„ÄÇ`;
        } else {
            systemPrompt += `‰Ω†Ë¶ÅÂØπÁî®Êà∑ÁöÑ${type === 'like' ? 'ÁÇπËµû' : type === 'repost' ? 'ËΩ¨Âèë' : '‰∫íÂä®'}ÂÅöÂá∫Ëá™ÁÑ∂ÂõûÂ∫î„ÄÇ`;
        }
        
        systemPrompt += `\n\nË¶ÅÊ±ÇÔºö
1. ÂõûÂ§çË¶ÅÁ¨¶ÂêàÊúãÂèãÂúàËØÑËÆ∫ÁöÑÈ£éÊ†ºÔºåÁÆÄÁü≠„ÄÅËá™ÁÑ∂
2. ‰∏•Ê†ºÊåâÁÖß‰Ω†ÁöÑ‰∫∫ËÆæÊù•ÈÄâÊã©ÊòØÂê¶‰ΩøÁî®Ë°®ÊÉÖÁ¨¶Âè∑Ôºå‰∏çË¶Å‰ΩøÁî®‰∏éËßíËâ≤ÊÄßÊ†º‰∏çÁ¨¶ÁöÑemoji
3. ‰∏çË¶ÅËøá‰∫éÊ≠£ÂºèÊàñÂÆ¢Â•óÔºåË¶ÅÂÉèÁúüÂÆûÁöÑÊúãÂèã‰∏ÄÊ†∑‰∫íÂä®
4. Âè™ËÉΩ‰ΩøÁî®ÊñáÂ≠óÂõûÂ§çÔºå‰∏çË¶ÅÂèëÈÄÅË°®ÊÉÖÂåÖÊàñÂõæÁâáÈìæÊé•`;
        
        // ÊûÑÂª∫Áî®Êà∑Ê∂àÊÅØÔºåÂåÖÂê´ÂõæÁâá‰ø°ÊÅØ
        let userMsg;
        let hasUserImages = false;
        let userImages = [];

        if (type === 'comment_reply' || type === 'thread_reply') {
            // Â§ÑÁêÜÁî®Êà∑ËØÑËÆ∫ÂÜÖÂÆπÔºåÂèØËÉΩÂåÖÂê´Ë°®ÊÉÖÂåÖ
            if (typeof userContent === 'string') {
                userMsg = type === 'comment_reply' ?
                    `Áî®Êà∑ÂàöÂàöËØÑËÆ∫‰∫ÜÔºö"${userContent}"„ÄÇËØ∑Âü∫‰∫é‰Ω†ÁöÑ‰∫∫ËÆæÔºåËá™ÁÑ∂Âú∞ÂõûÂ§çËøôÊù°ËØÑËÆ∫„ÄÇ` :
                    `ËøôÊòØ‰∏Ä‰∏™Ê•º‰∏≠Ê•ºËÆ®ËÆ∫Ôºö${userContent}`;
            } else if (typeof userContent === 'object') {
                // Â§ÑÁêÜÂåÖÂê´Ë°®ÊÉÖÂåÖÁöÑËØÑËÆ∫
                let textPart = '';
                let stickerPart = '';

                if (userContent.textContent) {
                    textPart = userContent.textContent;
                }

                if (userContent.stickers && userContent.stickers.length > 0) {
                    stickerPart = `ÔºåÂπ∂ÂèëÈÄÅ‰∫Ü${userContent.stickers.length}‰∏™Ë°®ÊÉÖÂåÖ`;
                    // Êî∂ÈõÜË°®ÊÉÖÂåÖÂõæÁâáÁî®‰∫éAIËØÜÂà´
                    userContent.stickers.forEach(sticker => {
                        if (sticker.url) {
                            userImages.push({ type: 'image_url', image_url: { url: sticker.url } });
                            hasUserImages = true;
                        }
                    });
                }

                userMsg = type === 'comment_reply' ?
                    `Áî®Êà∑ÂàöÂàöËØÑËÆ∫‰∫ÜÔºö"${textPart}"${stickerPart}„ÄÇËØ∑Âü∫‰∫é‰Ω†ÁöÑ‰∫∫ËÆæÔºåËá™ÁÑ∂Âú∞ÂõûÂ§çËøôÊù°ËØÑËÆ∫„ÄÇ` :
                    `ËøôÊòØ‰∏Ä‰∏™Ê•º‰∏≠Ê•ºËÆ®ËÆ∫Ôºö${textPart}${stickerPart}`;
            }
        } else {
            // ÊûÑÂª∫ÂÆåÊï¥ÁöÑÂä®ÊÄÅÂÜÖÂÆπÊèèËø∞
            let postDescription = `ÂéüÂä®ÊÄÅÔºö${post.content || post.description || ''}`;

            // Â¶ÇÊûúÂä®ÊÄÅÂåÖÂê´ÂõæÁâáÔºåÊ∑ªÂä†ÂõæÁâáÊèèËø∞
            if (post.imageUrl) {
                // Ê£ÄÊü•ÊòØÂê¶‰∏∫Base64ÂõæÁâáÔºàÁî®Êà∑‰∏ä‰º†ÁöÑÂõæÁâáÔºâ
                if (post.imageUrl.startsWith('data:image/')) {
                    postDescription += `\n[ËØ•Âä®ÊÄÅÂåÖÂê´‰∏ÄÂº†Áî®Êà∑‰∏ä‰º†ÁöÑÂõæÁâáÔºåËØ∑ÁªìÂêàÂõæÁâáÂÜÖÂÆπËøõË°åÂõûÂ§ç]`;
                } else {
                    postDescription += `\n[ËØ•Âä®ÊÄÅÂåÖÂê´‰∏ÄÂº†ÂõæÁâá]`;
                }
            }

            userMsg = `${postDescription}\nËØ∑ÂèëË°®‰Ω†ÁöÑÁúãÊ≥ïÔºö`;
        }

        // ÊûÑÂª∫Ê∂àÊÅØÊï∞ÁªÑÔºåÊîØÊåÅÂõæÁâáËØÜÂà´
        let messages;
        let hasPostImage = post.imageUrl && post.imageUrl.startsWith('data:image/');

        if (hasPostImage || hasUserImages) {
            // ‰ΩøÁî®Vision APIÊ†ºÂºè
            const userContent = [{ type: 'text', text: userMsg }];

            // Ê∑ªÂä†Âä®ÊÄÅÂõæÁâá
            if (hasPostImage) {
                userContent.push({ type: 'image_url', image_url: { url: post.imageUrl } });
            }

            // Ê∑ªÂä†Áî®Êà∑ËØÑËÆ∫‰∏≠ÁöÑË°®ÊÉÖÂåÖÂõæÁâá
            if (hasUserImages) {
                userContent.push(...userImages);
            }

            messages = [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: userContent }
            ];
        } else {
            // ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ
            messages = [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: userMsg }
            ];
        }
        
        const requestBody = {
            model: model,
            messages: messages,
            temperature: 0.8,
            stream: false
        };
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 60000);
        
        // Ê£ÄÊµãÊòØÂê¶ÊòØGeminiÂÆòÊñπAPI
        const isGeminiOfficial = proxyUrl.includes('generativelanguage.googleapis.com');
        
        let response;
        if (isGeminiOfficial) {
            // ‰ΩøÁî®GeminiÂÆòÊñπAPIÊ†ºÂºè
            const apiUrl = `${proxyUrl}/models/${model}:generateContent?key=${apiKey}`;
            
            // ËΩ¨Êç¢Ê∂àÊÅØÊ†ºÂºè‰∏∫GeminiÊ†ºÂºè
            const geminiMessages = [];
            
            // Ê∑ªÂä†Á≥ªÁªüÊèêÁ§∫ËØç‰Ωú‰∏∫Á¨¨‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ
            if (requestBody.messages[0]?.role === 'system') {
                geminiMessages.push({
                    role: 'user',
                    parts: [{ text: requestBody.messages[0].content }]
                });
                geminiMessages.push({
                    role: 'model',
                    parts: [{ text: 'ÊàëÊòéÁôΩ‰∫ÜÔºåÊàë‰ºöÊåâÁÖßËøô‰∫õË¶ÅÊ±ÇËøõË°åÂØπËØù„ÄÇ' }]
                });
            }
            
            // ËΩ¨Êç¢ÂÖ∂‰ªñÊ∂àÊÅØ
            for (let i = 1; i < requestBody.messages.length; i++) {
                const msg = requestBody.messages[i];
                if (msg.role === 'system') continue; // Ë∑≥ËøáÁ≥ªÁªüÊ∂àÊÅØ
                
                let content = '';
                if (typeof msg.content === 'string') {
                    content = msg.content;
                } else if (Array.isArray(msg.content)) {
                    content = msg.content.map(item => {
                        if (item.type === 'text') return item.text;
                        if (item.type === 'image_url') return '[ÂõæÁâá]';
                        return '';
                    }).join('');
                }
                
                geminiMessages.push({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: content }]
                });
            }
            
            response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: geminiMessages,
                    generationConfig: {
                        temperature: requestBody.temperature || 0.8,
                        maxOutputTokens: 8192
                    }
                }),
                signal: controller.signal
            });
        } else {
            // ‰ΩøÁî®OpenAIÊ†ºÂºèÔºàÊä±ËÑ∏Á≠â‰ª£ÁêÜÔºâ
            response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify(requestBody),
                signal: controller.signal
            });
        }
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            let errorText = await response.text();
            throw new Error(`APIË∞ÉÁî®Â§±Ë¥• (${response.status}): ${errorText}`);
        }
        
        const data = await response.json();
        let content;
        
        if (isGeminiOfficial) {
            // Ëß£ÊûêGemini APIÂìçÂ∫î
            content = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!content) {
                console.log('Gemini API ÂìçÂ∫îÊï∞ÊçÆ:', data);
                throw new Error('Gemini APIËøîÂõû‰∫ÜÁ©∫ÂÜÖÂÆπ');
            }
        } else {
            // Ëß£ÊûêOpenAIÊ†ºÂºèÂìçÂ∫îÔºàÂåÖÊã¨Êä±ËÑ∏Á≠â‰ª£ÁêÜÔºâ
            if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                content = data.choices[0].message.content;
            } else if (data.message) {
                // Êüê‰∫õ‰ª£ÁêÜÂèØËÉΩÁõ¥Êé•ËøîÂõûmessageÂ≠óÊÆµ
                content = data.message;
            } else if (data.text) {
                // Êüê‰∫õ‰ª£ÁêÜÂèØËÉΩËøîÂõûtextÂ≠óÊÆµ
                content = data.text;
            } else if (data.response) {
                // Êüê‰∫õ‰ª£ÁêÜÂèØËÉΩËøîÂõûresponseÂ≠óÊÆµ
                content = data.response;
            }
            // 5. ÈÉ®ÂàÜ‰ª£ÁêÜÂèØËÉΩËøîÂõûcontentÂ≠óÊÆµ
            else if (data.content) {
                content = data.content;
            }
            // 6. ÈÉ®ÂàÜ‰ª£ÁêÜÂèØËÉΩËøîÂõûresultÂ≠óÊÆµ
            else if (data.result) {
                content = data.result;
            }
            // 7. Â∞ùËØïÊü•ÊâæÁ¨¨‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤Á±ªÂûãÁöÑÂÄº
            else {
                console.log('ÂæÆÂçö‰∫íÂä®APIÈùûÊ†áÂáÜÂìçÂ∫îÊ†ºÂºèÔºåÂ∞ùËØïÊü•ÊâæÂÜÖÂÆπ:', data);
                // ÈÅçÂéÜÂØπË±°ÁöÑÊâÄÊúâÈîÆÔºåÊü•ÊâæÁ¨¨‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤ÂÄº
                for (const key in data) {
                    if (typeof data[key] === 'string' && data[key].trim()) {
                        content = data[key];
                        console.log(`ÂæÆÂçö‰∫íÂä®API‰ΩøÁî®Â≠óÊÆµ "${key}" ‰Ωú‰∏∫ÂìçÂ∫îÂÜÖÂÆπ`);
                        break;
                    }
                }
            }
            
            if (!content) {
                console.error('ÂæÆÂçö‰∫íÂä®APIÊó†Ê≥ïËß£ÊûêÂìçÂ∫îÔºåÂÆåÊï¥ÂìçÂ∫îÊï∞ÊçÆ:', data);
                throw new Error('ÂæÆÂçö‰∫íÂä®APIËøîÂõû‰∫ÜÁ©∫ÂÜÖÂÆπÊàñÊó†Ê≥ïËØÜÂà´ÁöÑÊ†ºÂºèÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆ');
            }
        }
        
        const trimmedContent = content.trim();

        // Ê£ÄÊü•ÂõûÂ§çÊòØÂê¶ÂåÖÂê´Ë°®ÊÉÖÂåÖURL
        if (STICKER_REGEX.test(trimmedContent)) {
            // Â¶ÇÊûúÊòØÁ∫ØË°®ÊÉÖÂåÖURLÔºåËøîÂõûË°®ÊÉÖÂåÖÊ†ºÂºè
            const lines = trimmedContent.split('\n').filter(line => line.trim());
            const stickerLine = lines.find(line => STICKER_REGEX.test(line.trim()));

            if (stickerLine && lines.length === 1) {
                // Á∫ØË°®ÊÉÖÂåÖÂõûÂ§ç - Áõ¥Êé•ËøîÂõûURLÂ≠óÁ¨¶‰∏≤ÔºåËÆ©ÂæÆÂçöËØÑËÆ∫Ê∏≤ÊüìÂô®Â§ÑÁêÜ
                const stickerUrl = stickerLine.trim();
                // Â∞ùËØï‰ªéÁî®Êà∑Ë°®ÊÉÖÂåÖ‰∏≠ÊâæÂà∞ÂØπÂ∫îÁöÑÂêçÁß∞
                const userSticker = state.userStickers.find(s => s.url === stickerUrl);
                const stickerName = userSticker ? userSticker.name : 'Ë°®ÊÉÖ';

                return {
                    type: 'sticker',
                    content: stickerUrl,  // Áõ¥Êé•ËøîÂõûURLÂ≠óÁ¨¶‰∏≤
                    meaning: stickerName
                };
            } else {
                // ÂåÖÂê´Ë°®ÊÉÖÂåÖÂíåÊñáÂ≠óÁöÑÊ∑∑ÂêàÂõûÂ§çÔºåËøîÂõûÊñáÂ≠óÈÉ®ÂàÜ
                const textLines = lines.filter(line => !STICKER_REGEX.test(line.trim()));
                let result = textLines.join('\n') || trimmedContent;

                // ÊõøÊç¢Áî®Êà∑Âç†‰ΩçÁ¨¶
                const userName = userProfileCache.name || 'ÊàëÁöÑÂæÆÂçö';
                result = result.replace(/@\{\{user\}\}/g, `@${userName}`);
                result = result.replace(/\{\{user\}\}/g, userName);

                return result;
            }
        }

        // ÊõøÊç¢Áî®Êà∑Âç†‰ΩçÁ¨¶
        const userName = userProfileCache.name || 'ÊàëÁöÑÂæÆÂçö';
        let finalContent = trimmedContent.replace(/@\{\{user\}\}/g, `@${userName}`);
        finalContent = finalContent.replace(/\{\{user\}\}/g, userName);

        return finalContent;
    } catch (error) {
        if (error.name === 'AbortError') {
            throw new Error('ËØ∑Ê±ÇË∂ÖÊó∂ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÁ®çÂêéÈáçËØï');
        } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
            if (proxyUrl.includes('generativelanguage.googleapis.com')) {
                throw new Error('CORSÈîôËØØÔºöÊó†Ê≥ïÁõ¥Êé•‰ªéÊµèËßàÂô®ËÆøÈóÆGeminiÂÆòÊñπAPI„ÄÇ\n\nËß£ÂÜ≥ÊñπÊ°àÔºö\n1. ‰ΩøÁî®HTTPÊúçÂä°Âô®ËøêË°åÊ≠§Êñá‰ª∂\n2. ‰ΩøÁî®‰ª£ÁêÜAPIÊúçÂä°\n3. Âú®ËÆæÁΩÆ‰∏≠ÂàáÊç¢Âà∞Êä±ËÑ∏Á≠âÊîØÊåÅË∑®ÂüüÁöÑAPI');
            } else {
                throw new Error('ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Âèç‰ª£Âú∞ÂùÄÊòØÂê¶Ê≠£Á°ÆÊàñÁΩëÁªúËøûÊé•');
            }
        } else if (error.message.includes('CORS') || error.message.includes('Access-Control')) {
            throw new Error('CORSË∑®ÂüüÈîôËØØÔºöËØ∑‰ΩøÁî®HTTPÊúçÂä°Âô®ËøêË°åÊ≠§Êñá‰ª∂ÔºåÊàñÂàáÊç¢Âà∞ÊîØÊåÅË∑®ÂüüÁöÑAPIÊúçÂä°');
        }
        throw error;
    }
}

// ÂèëÂ∏ÉAIÁöÑÂä®ÊÄÅÔºåÊîØÊåÅÂèØËßÅÊÄß
async function publishAiPost(aiId, contentObj) {
    const ai = state.chats[aiId];
    if (!ai) return;
    let { content, visibility = 'public', imageUrl = null, imageDescription = null } = typeof contentObj === 'string' ? { content: contentObj, visibility: 'public' } : contentObj;

    // ÊõøÊç¢ÂÜÖÂÆπ‰∏≠ÁöÑÁî®Êà∑Âç†‰ΩçÁ¨¶
    if (content && typeof content === 'string') {
        // Ëé∑ÂèñÁî®Êà∑ÁöÑÂæÆÂçöÂêçÁß∞
        const userName = userProfileCache.name || 'ÊàëÁöÑÂæÆÂçö';

        // ÊõøÊç¢ @{{user}} ‰∏∫ÂÆûÈôÖÁöÑÁî®Êà∑Âêç
        content = content.replace(/@\{\{user\}\}/g, `@${userName}`);

        // ‰πüÂ§ÑÁêÜÂÖ∂‰ªñÂèØËÉΩÁöÑÂç†‰ΩçÁ¨¶Ê†ºÂºè
        content = content.replace(/\{\{user\}\}/g, userName);
    }

    const postId = Date.now();
    
    // Âü∫‰∫éAIÁöÑÁ§æ‰∫§Êï∞ÊçÆÁîüÊàêÂêàÁêÜÁöÑ‰∫íÂä®Êï∞Èáè
    let interactions = {
        likes: 0,
        comments: 0,
        reposts: 0
    };
    
    // Â¶ÇÊûúAIÊúâÁ§æ‰∫§ÁªüËÆ°Êï∞ÊçÆÔºåÂü∫‰∫éÁ≤â‰∏ùÊï∞ÁîüÊàê‰∫íÂä®Êï∞Èáè
    if (ai.settings.socialStats) {
        const { followersCount } = ai.settings.socialStats;
        
        // Á≤â‰∏ùË∂äÂ§öÔºå‰∫íÂä®Ë∂äÂ§öÔºå‰ΩÜ‰∏çÊòØÁ∫øÊÄßÂÖ≥Á≥ª
        const followerFactor = Math.log10(followersCount + 10) / 4;
        
        interactions.likes = Math.floor(Math.random() * 20 * followerFactor + 5);
        interactions.comments = Math.floor(Math.random() * 10 * followerFactor + 2);
        interactions.reposts = Math.floor(Math.random() * 5 * followerFactor + 1);
    } else {
        // ÈªòËÆ§‰∫íÂä®Êï∞Èáè
        interactions.likes = Math.floor(Math.random() * 20 + 5);
        interactions.comments = Math.floor(Math.random() * 10 + 2);
        interactions.reposts = Math.floor(Math.random() * 5 + 1);
    }
    
    // ÂõæÁâáÂÜÖÂÆπÈÄöÂ∏∏Ëé∑ÂæóÊõ¥Â§ö‰∫íÂä®
    if (imageUrl) {
        interactions.likes += Math.floor(Math.random() * 15 + 10);
        interactions.comments += Math.floor(Math.random() * 5 + 3);
        interactions.reposts += Math.floor(Math.random() * 3 + 1);
    }
    
    // Ê†πÊçÆÂèØËßÅÊÄßË∞ÉÊï¥‰∫íÂä®Êï∞Èáè
    if (visibility === 'private') {
        // ÁßÅÂØÜÂä®ÊÄÅÊ≤°Êúâ‰∫íÂä®
        interactions.likes = 0;
        interactions.comments = 0;
        interactions.reposts = 0;
    } else if (visibility === 'friends') {
        // ‰ªÖÂ•ΩÂèãÂèØËßÅÁöÑÂä®ÊÄÅ‰∫íÂä®ËæÉÂ∞ë
        interactions.likes = Math.floor(interactions.likes * 0.6);
        interactions.comments = Math.floor(interactions.comments * 0.5);
        interactions.reposts = Math.floor(interactions.reposts * 0.3);
    }
    
    await db.weiboPosts.add({
        id: postId,
        authorId: aiId,
        authorName: ai.name,
        authorAvatar: ai.settings.aiAvatar || defaultAvatar,
        authorEmail: ai.settings.aiSignature || '',
        authorSignature: ai.settings.aiSignature || '',
        content,
        imageUrl,
        imageDescription,
        visibility,
        timestamp: Date.now(),
        interactions
    });
    
    // ÈáçÊñ∞Ê∏≤ÊüìÂæÆÂçöÊó∂Èó¥Á∫ø
    const currentFilter = document.querySelector('.weibo-nav .nav-item.active')?.textContent === '‚Çç^À∂ ‚ï∏ñ•¶  ‚ï∏Àµ^‚Çé‚üÜ' ? 'mine' : 'all';
    await renderWeiboTimeline(currentFilter);
    
    // Â¶ÇÊûúÊòØAIÂèëÂ∏ÉÁöÑÂä®ÊÄÅÔºå‰πüËß¶ÂèëÂÖ∂‰ªñAIÁöÑ‰∫íÂä®
    if (aiId !== 'user') {
        setTimeout(() => {
            triggerAiInteractionOnAiPost(postId, aiId);
        }, Math.random() * 3000 + 2000); // 2-5ÁßíÂêéËß¶ÂèëÂÖ∂‰ªñAI‰∫íÂä®
    }
}

// AIÂØπAIÂèëÂ∏ÉÁöÑÂä®ÊÄÅËøõË°å‰∫íÂä®
async function triggerAiInteractionOnAiPost(postId, authorId) {
    try {
        const post = await db.weiboPosts.get(postId);
        if (!post) return;
        
        // Ê£ÄÊü•Âä®ÊÄÅÂèØËßÅÊÄß
        if (post.visibility === 'private') {
            console.log(`Ë∑≥ËøáAIÈó¥‰∫íÂä®ÔºöÂä®ÊÄÅÊòØÁßÅÂØÜÁöÑ`);
            return; // ÁßÅÂØÜÂä®ÊÄÅÂè™ÊúâÁî®Êà∑ËÉΩÁúãÂà∞ÔºåAI‰∏ç‰ºö‰∫íÂä®
        }
        
        // Ëé∑ÂèñÈô§‰∫ÜÂèëÂ∏ÉËÄÖÂ§ñÁöÑÂÖ∂‰ªñAIËßíËâ≤
        let otherAis = Object.entries(state.chats).filter(([id, chat]) => 
            !chat.isGroup && id !== authorId
        );
        
        // Â¶ÇÊûúÊòØÂ•ΩÂèãÂèØËßÅÂä®ÊÄÅÔºå‰ªÖ‰øùÁïôÁæ§ËÅäÂ•ΩÂèã
        if (post.visibility === 'friends') {
            console.log(`Âä®ÊÄÅÊòØÂ•ΩÂèãÂèØËßÅÁöÑÔºå‰ªÖÂÖÅËÆ∏Áæ§ËÅäÂ•ΩÂèã‰∫íÂä®`);
            otherAis = otherAis.filter(([aiId, chat]) => {
                // Ê£ÄÊü•ÊòØÂê¶Âú®Âêå‰∏Ä‰∏™Áæ§ËÅä‰∏≠
                const isInSameGroup = Object.values(state.chats)
                    .filter(c => c.isGroup)
                    .some(group => 
                        group.members && 
                        group.members.includes(aiId) && 
                        group.members.includes(authorId)
                    );
                
                if (!isInSameGroup) {
                    console.log(`${chat.name} ‰∏çÊòØ ${post.authorName} ÁöÑÁæ§ËÅäÂ•ΩÂèãÔºåË∑≥Ëøá‰∫íÂä®`);
                }
                
                return isInSameGroup;
            });
        }
        
        if (otherAis.length === 0) return;
        
        // Á≠õÈÄâÂèØ‰ª•ÁúãÂà∞ËøôÊù°Âä®ÊÄÅÁöÑAI
        let eligibleAIs = otherAis;
        
        // Â¶ÇÊûúÊòØÂ•ΩÂèãÂèØËßÅÂä®ÊÄÅÔºåÈúÄË¶ÅÊ£ÄÊü•ÊòØÂê¶Âú®Âêå‰∏ÄÁæ§ËÅä‰∏≠
        if (post.visibility === 'friends') {
            eligibleAIs = [];
            for (const [aiId, ai] of otherAis) {
                const isInSameGroup = await checkIfInSameGroup(authorId, aiId);
                const isAtMentioned = (post.content || '').includes(`@${ai.name}`);
                
                if (isInSameGroup || isAtMentioned) {
                    eligibleAIs.push([aiId, ai]);
                }
            }
        }
        
        if (eligibleAIs.length === 0) {
            console.log(`Ê≤°ÊúâÁ¨¶ÂêàÊù°‰ª∂ÁöÑAIÂèØ‰ª•‰∫íÂä®`);
            return;
        }
        
        // ÈöèÊú∫ÈÄâÊã©1-2‰∏™AIËøõË°å‰∫íÂä®
        const interactingAisCount = Math.min(Math.floor(Math.random() * 2) + 1, eligibleAIs.length);
        const selectedAis = eligibleAIs.sort(() => Math.random() - 0.5).slice(0, interactingAisCount);
        
        for (const [aiId, ai] of selectedAis) {
            // 50%Ê¶ÇÁéá‰∏éAIÂä®ÊÄÅ‰∫íÂä®ÔºàÊèêÈ´òÊ¶ÇÁéá‰ª•Â¢ûÂº∫ËßíËâ≤Èó¥‰∫íÂä®Ôºâ
            if (Math.random() < 0.5) {
                // ÈöèÊú∫ÈÄâÊã©‰∫íÂä®Á±ªÂûã
                const rand = Math.random();
                let interactionType;
                if (rand < 0.6) interactionType = 'comment'; // 60%Ê¶ÇÁéáËØÑËÆ∫
                else if (rand < 0.9) interactionType = 'like'; // 30%Ê¶ÇÁéáÁÇπËµû
                else interactionType = 'repost'; // 10%Ê¶ÇÁéáËΩ¨Âèë
                
                await performAiInteraction(aiId, ai, post, interactionType);
                
                // Âª∂Ëøü‰∏ÄÊÆµÊó∂Èó¥ÂÜçÂ§ÑÁêÜ‰∏ã‰∏Ä‰∏™AI
                await new Promise(resolve => setTimeout(resolve, Math.random() * 2000 + 1000));
            }
        }
        
        // ÈáçÊñ∞Ê∏≤ÊüìÊó∂Èó¥Á∫ø
        await renderWeiboTimeline();
        
    } catch (error) {
        console.error('AIÈó¥‰∫íÂä®Â§±Ë¥•:', error);
    }
}

// AIËßíËâ≤Èó¥ÁöÑÊ•º‰∏≠Ê•º‰∫íÂä®
async function triggerAiToAiInteraction(postId) {
    try {
        // Ëé∑ÂèñËØ•Âä®ÊÄÅ‰∏ãÁöÑÊâÄÊúâËØÑËÆ∫
        const comments = await db.weiboComments
            .where('postId')
            .equals(postId)
            .reverse()
            .sortBy('timestamp');
            
        if (comments.length < 2) return; // Ëá≥Â∞ëÈúÄË¶Å2Êù°ËØÑËÆ∫ÊâçËÉΩËß¶ÂèëËßíËâ≤Èó¥‰∫íÂä®
        
        // Ëé∑ÂèñÊâÄÊúâÂèÇ‰∏éËØÑËÆ∫ÁöÑAIËßíËâ≤
        const participatingAis = [...new Set(comments
            .filter(comment => comment.authorId !== 'user')
            .map(comment => comment.authorId)
        )];
        
        if (participatingAis.length < 2) return; // Ëá≥Â∞ëÈúÄË¶Å2‰∏™AIËßíËâ≤
        
        // ÈöèÊú∫ÈÄâÊã©‰∏§‰∏™AIËøõË°å‰∫íÂä®
        const aiA = participatingAis[Math.floor(Math.random() * participatingAis.length)];
        let aiB = participatingAis[Math.floor(Math.random() * participatingAis.length)];
        
        // Á°Æ‰øùÈÄâÊã©‰∏çÂêåÁöÑAI
        while (aiB === aiA && participatingAis.length > 1) {
            aiB = participatingAis[Math.floor(Math.random() * participatingAis.length)];
        }
        
        if (aiA === aiB) return;
        
        // Ê£ÄÊü•ËßíËâ≤ÂÖ≥Á≥ªÂíå‰∫íÂä®Ê¶ÇÁéá
        const shouldInteract = await checkAiRelationshipAndInteract(aiA, aiB);
        if (!shouldInteract) return;
        
        // ÈÄâÊã©‰∏Ä‰∏™Áé∞ÊúâËØÑËÆ∫‰Ωú‰∏∫‰∫íÂä®Ëµ∑ÁÇπ
        const targetComment = comments.find(comment => 
            comment.authorId === aiA || comment.authorId === aiB
        );
        
        if (!targetComment) return;
        
        // ÂÜ≥ÂÆöË∞ÅÂÖàÂõûÂ§çË∞Å
        const responderAi = targetComment.authorId === aiA ? aiB : aiA;
        const targetAi = targetComment.authorId;
        
        // ÁîüÊàêAIÈó¥ÁöÑ‰∫íÂä®ÂõûÂ§ç
        await generateAiToAiReply(postId, targetComment.id, responderAi, targetAi, targetComment.content);
        
    } catch (error) {
        console.error('ËßíËâ≤Èó¥‰∫íÂä®Â§±Ë¥•:', error);
    }
}

// Ê£ÄÊü•AIËßíËâ≤ÂÖ≥Á≥ªÂπ∂ÂÜ≥ÂÆöÊòØÂê¶‰∫íÂä®
async function checkAiRelationshipAndInteract(aiAId, aiBId) {
    const aiA = state.chats[aiAId];
    const aiB = state.chats[aiBId];
    
    if (!aiA || !aiB) return false;
    
    // Âü∫‰∫é‰∫∫ËÆæÂàÜÊûêËßíËâ≤ÂÖ≥Á≥ªÁöÑÁÆÄÂçïËßÑÂàô
    const personaA = (aiA.settings.aiPersona || '').toLowerCase();
    const personaB = (aiB.settings.aiPersona || '').toLowerCase();
    
    // Âü∫Á°Ä‰∫íÂä®Ê¶ÇÁéá
    let interactionProbability = 0.4; // 40%Âü∫Á°ÄÊ¶ÇÁéáÔºåÊèêÈ´òÂü∫Á°ÄÊ¶ÇÁéá‰ª•Á°Æ‰øùÊõ¥Â§ö‰∫íÂä®
    
    // Â¶ÇÊûúËßíËâ≤‰∫∫ËÆæ‰∏≠ÂåÖÂê´Áõ∏‰ººÁöÑÂÖ¥Ë∂£ÊàñÁâπÂæÅÔºåÂ¢ûÂä†‰∫íÂä®Ê¶ÇÁéá
    const commonKeywords = ['ÂºÄÊúó', 'Ê¥ªÊ≥º', 'ÂèãÂñÑ', 'Ê∏©Êüî', 'ÂèØÁà±', 'ËÅäÂ§©', '‰∫§ÊµÅ', 'ÊúãÂèã'];
    const hasCommonTraits = commonKeywords.some(keyword => 
        personaA.includes(keyword) && personaB.includes(keyword)
    );
    
    if (hasCommonTraits) {
        interactionProbability += 0.3; // Â¢ûÂä†30%
    }
    
    // Â¶ÇÊûúËßíËâ≤ÊÄßÊ†º‰∫íË°•Ôºå‰πüÂ¢ûÂä†‰∫íÂä®Ê¶ÇÁéá
    const complementaryPairs = [
        ['ÂÜÖÂêë', 'Â§ñÂêë'],
        ['ÂÆâÈùô', 'Ê¥ªÊ≥º'],
        ['‰∏•ËÇÉ', 'ÂπΩÈªò'],
        ['ÁêÜÊÄß', 'ÊÑüÊÄß']
    ];
    
    const isComplementary = complementaryPairs.some(([traitA, traitB]) =>
        (personaA.includes(traitA) && personaB.includes(traitB)) ||
        (personaA.includes(traitB) && personaB.includes(traitA))
    );
    
    if (isComplementary) {
        interactionProbability += 0.2; // Â¢ûÂä†20%
    }
    
    // Ê£ÄÊü•ÊòØÂê¶ÊúâÂÖ±ÂêåÁöÑÁæ§ËÅä
    const aiAGroups = Object.values(state.chats).filter(chat => 
        chat.isGroup && chat.members && chat.members.some(m => m.name === aiA.name)
    );
    
    const aiBGroups = Object.values(state.chats).filter(chat => 
        chat.isGroup && chat.members && chat.members.some(m => m.name === aiB.name)
    );
    
    // Êü•ÊâæÂÖ±ÂêåÁöÑÁæ§ËÅä
    const commonGroups = aiAGroups.filter(groupA => 
        aiBGroups.some(groupB => groupB.id === groupA.id)
    );
    
    // Â¶ÇÊûúÂú®Âêå‰∏Ä‰∏™Áæ§ËÅä‰∏≠ÔºåÂ¢ûÂä†‰∫íÂä®Ê¶ÇÁéá
    if (commonGroups.length > 0) {
        interactionProbability += 0.2; // Â¢ûÂä†20%ÔºåÁæ§ËÅä‰∏≠ÁöÑËßíËâ≤Êõ¥ÂÆπÊòì‰∫íÂä®
    }
    
    return Math.random() < Math.min(interactionProbability, 0.9); // ÊúÄÈ´ò90%Ê¶ÇÁéáÔºåÊèêÈ´ò‰∏äÈôê
}

// ÁîüÊàêAIÈó¥ÁöÑÂõûÂ§ç
async function generateAiToAiReply(postId, commentId, responderAiId, targetAiId, targetContent) {
    const responderAi = state.chats[responderAiId];
    const targetAi = state.chats[targetAiId];
    
    if (!responderAi || !targetAi) return;
    
    try {
        const post = await db.weiboPosts.get(postId);
        if (!post) return;
        
        // Ëé∑ÂèñËØÑËÆ∫‰∏ä‰∏ãÊñá
        const comment = await db.weiboComments.get(commentId);
        if (!comment) return;
        
        // ÊûÑÂª∫AIÈó¥‰∫íÂä®ÁöÑÊèêÁ§∫ËØç
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) return;
        
        const responderPersona = responderAi.settings?.aiPersona || '';
        const targetPersona = targetAi.settings?.aiPersona || '';
        
        // Ëé∑ÂèñÁªëÂÆöÁöÑ‰∏ñÁïå‰π¶ÂÜÖÂÆπ
        let worldBookContent = '';
        if (responderAi.settings.linkedWorldBookIds && responderAi.settings.linkedWorldBookIds.length > 0) {
            const worldBooks = await Promise.all(
                responderAi.settings.linkedWorldBookIds.map(id => db.worldBooks.get(id))
            );
            const validWorldBooks = worldBooks.filter(book => book && book.content);
            if (validWorldBooks.length > 0) {
                worldBookContent = '\n\n‰∏ñÁïå‰π¶ÂÜÖÂÆπÔºà‰æõÂèÇËÄÉÔºâÔºö\n' + 
                    validWorldBooks.map(book => `${book.name}Ôºö${book.content}`).join('\n\n');
            }
        }
        
        const systemPrompt = `‰Ω†ÊòØ${responderAi.name}Ôºå‰Ω†ÁöÑ‰∫∫ËÆæÂ¶Ç‰∏ãÔºö${responderPersona}„ÄÇ${worldBookContent}

Áé∞Âú®Âú®‰∏Ä‰∏™ÂæÆÂçöÂä®ÊÄÅ‰∏ãÔºå${targetAi.name}Ôºà‰∫∫ËÆæÔºö${targetPersona}ÔºâÂàöÂàöËØÑËÆ∫‰∫ÜÔºö"${targetContent}"„ÄÇ

ÂéüÂä®ÊÄÅÂÜÖÂÆπÔºö${post.content}

‰Ω†Ë¶Å‰Ωú‰∏∫${responderAi.name}ÔºåÂü∫‰∫é‰Ω†ÁöÑ‰∫∫ËÆæÂíå‰∏é${targetAi.name}ÁöÑÂÖ≥Á≥ªÔºåÂØπtaÁöÑËØÑËÆ∫ËøõË°åÂõûÂ∫î„ÄÇË¶ÅÊ±ÇÔºö
1. ‰∏•Ê†ºÊåâÁÖß‰Ω†ÁöÑ‰∫∫ËÆæËøõË°åÂõûÂ§çÔºå‰∏çËÉΩÊ∑∑Ê∑ÜËßíËâ≤
2. ÂõûÂ§çË¶ÅËá™ÁÑ∂„ÄÅÁ¨¶ÂêàÂæÆÂçöËØÑËÆ∫È£éÊ†º
3. ÂèØ‰ª•ÊòØËµûÂêå„ÄÅ‰∏çÂêåËßÇÁÇπ„ÄÅË°•ÂÖÖ„ÄÅÊèêÈóÆÊàñÂºÄÁé©Á¨ë
4. Ë¶Å‰ΩìÁé∞Âá∫‰Ω†Âíå${targetAi.name}‰πãÈó¥ÁöÑ‰∫íÂä®ÂÖ≥Á≥ª
5. ÂõûÂ§çÁÆÄÁü≠ÊúâË∂£ÔºåÁ¨¶ÂêàÁ§æ‰∫§Â™í‰ΩìÁöÑÁâπÁÇπ
6. Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÈÄâÊã©ÂêàÈÄÇÁöÑËØ≠Ê∞îÂíåÁî®ËØç
7. ‰∏çË¶Å‰ΩøÁî®‰∏éËßíËâ≤ÊÄßÊ†º‰∏çÁ¨¶ÁöÑË°®ÊÉÖÁ¨¶Âè∑`;

        const messages = [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: `ËØ∑ÂõûÂ§ç${targetAi.name}ÁöÑËØÑËÆ∫` }
        ];

        // ‰ΩøÁî®Áªü‰∏ÄÁöÑAPIË∞ÉÁî®ÂáΩÊï∞
        async function callUnifiedAPI(url, key, model, messages) {
            const isGemini = url.includes('generativelanguage.googleapis.com');
            
            if (isGemini) {
                // Gemini API Ê†ºÂºè
                const apiUrl = `${url}/models/${model}:generateContent?key=${key}`;
                
                // ËΩ¨Êç¢Ê∂àÊÅØÊ†ºÂºè‰∏∫GeminiÊ†ºÂºè
                const geminiMessages = [];
                
                // Ê∑ªÂä†Á≥ªÁªüÊèêÁ§∫ËØç‰Ωú‰∏∫Á¨¨‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ
                if (messages[0]?.role === 'system') {
                    geminiMessages.push({
                        role: 'user',
                        parts: [{ text: messages[0].content }]
                    });
                    geminiMessages.push({
                        role: 'model',
                        parts: [{ text: 'ÊàëÊòéÁôΩ‰∫ÜÔºåÊàë‰ºöÊåâÁÖßËøô‰∫õË¶ÅÊ±ÇËøõË°åÂØπËØù„ÄÇ' }]
                    });
                }
                
                // ËΩ¨Êç¢ÂÖ∂‰ªñÊ∂àÊÅØ
                for (let i = 1; i < messages.length; i++) {
                    const msg = messages[i];
                    if (msg.role === 'system') continue;
                    
                    let content = '';
                    if (typeof msg.content === 'string') {
                        content = msg.content;
                    } else if (Array.isArray(msg.content)) {
                        content = msg.content.map(item => {
                            if (item.type === 'text') return item.text;
                            if (item.type === 'image_url') return '[ÂõæÁâá]';
                            return '';
                        }).join('');
                    }
                    
                    geminiMessages.push({
                        role: msg.role === 'user' ? 'user' : 'model',
                        parts: [{ text: content }]
                    });
                }
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: geminiMessages,
                        generationConfig: {
                            temperature: 0.8,
                            maxOutputTokens: 8192
                        }
                    })
                });
                
                if (!response.ok) {
                    console.log('Gemini API ËØ∑Ê±ÇÂ§±Ë¥•:', response.status, response.statusText);
                    return null;
                }
                
                const data = await response.json();
                const content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!content) {
                    console.log('Gemini API ÂìçÂ∫îÊï∞ÊçÆ:', data);
                }
                return content;
                
            } else {
                // OpenAI API Ê†ºÂºèÔºàÂåÖÊã¨Êä±ËÑ∏Á≠â‰ª£ÁêÜÔºâ
                const response = await fetch(`${url}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${key}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'system', content: systemPrompt }, ...messages],
                        temperature: 0.75,
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} - ${errorData.error?.message || 'Êú™Áü•ÈîôËØØ'}`);
                }
                
                const data = await response.json();
                
                // Â¢ûÂº∫ÂØπ‰∏çÂêåAPIÂìçÂ∫îÊ†ºÂºèÁöÑÂÖºÂÆπÊÄß
                let content = null;
                
                // 1. Ê†áÂáÜOpenAIÊ†ºÂºè
                if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                    content = data.choices[0].message.content;
                }
                // 2. ÈÉ®ÂàÜ‰ª£ÁêÜÂèØËÉΩÁõ¥Êé•ËøîÂõûmessageÂ≠óÊÆµ
                else if (data.message) {
                    content = data.message;
                }
                // 3. ÈÉ®ÂàÜ‰ª£ÁêÜÂèØËÉΩËøîÂõûtextÂ≠óÊÆµ
                else if (data.text) {
                    content = data.text;
                }
                // 4. ÈÉ®ÂàÜ‰ª£ÁêÜÂèØËÉΩËøîÂõûresponseÂ≠óÊÆµ
                else if (data.response) {
                    content = data.response;
                }
                // 5. ÈÉ®ÂàÜ‰ª£ÁêÜÂèØËÉΩËøîÂõûcontentÂ≠óÊÆµ
                else if (data.content) {
                    content = data.content;
                }
                // 6. ÈÉ®ÂàÜ‰ª£ÁêÜÂèØËÉΩËøîÂõûresultÂ≠óÊÆµ
                else if (data.result) {
                    content = data.result;
                }
                // 7. Â∞ùËØïÊü•ÊâæÁ¨¨‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤Á±ªÂûãÁöÑÂÄº
                else {
                    console.log('AIÈó¥‰∫íÂä®APIÈùûÊ†áÂáÜÂìçÂ∫îÊ†ºÂºèÔºåÂ∞ùËØïÊü•ÊâæÂÜÖÂÆπ:', data);
                    // ÈÅçÂéÜÂØπË±°ÁöÑÊâÄÊúâÈîÆÔºåÊü•ÊâæÁ¨¨‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤ÂÄº
                    for (const key in data) {
                        if (typeof data[key] === 'string' && data[key].trim()) {
                            content = data[key];
                            console.log(`AIÈó¥‰∫íÂä®API‰ΩøÁî®Â≠óÊÆµ "${key}" ‰Ωú‰∏∫ÂìçÂ∫îÂÜÖÂÆπ`);
                            break;
                        }
                    }
                }
                
                if (!content) {
                    console.error('AIÈó¥‰∫íÂä®APIÊó†Ê≥ïËß£ÊûêÂìçÂ∫îÔºåÂÆåÊï¥ÂìçÂ∫îÊï∞ÊçÆ:', data);
                    throw new Error('AIÈó¥‰∫íÂä®APIËøîÂõû‰∫ÜÁ©∫ÂÜÖÂÆπÊàñÊó†Ê≥ïËØÜÂà´ÁöÑÊ†ºÂºèÔºåËØ∑Ê£ÄÊü•APIÈÖçÁΩÆ');
                }

                // ÊõøÊç¢Áî®Êà∑Âç†‰ΩçÁ¨¶
                const userName = userProfileCache.name || 'ÊàëÁöÑÂæÆÂçö';
                content = content.replace(/@\{\{user\}\}/g, `@${userName}`);
                content = content.replace(/\{\{user\}\}/g, userName);

                // Â∞ÜÂõûÂ§çÊ∑ªÂä†Âà∞ËØÑËÆ∫‰∏≠
                if (!comment.replies) comment.replies = [];
                if (comment.replies.length < 7) {
                    comment.replies.push({
                        id: Date.now(),
                        authorId: responderAiId,
                        content: content,
                        timestamp: Date.now(),
                        replyTo: targetAi.name
                    });

                    await db.weiboComments.put(comment);
                    await renderWeiboTimeline();
                }

                return content;
            }
        }
    } catch (error) {
        console.error('ÁîüÊàêAIÈó¥ÂõûÂ§çÂ§±Ë¥•:', error);
    }
}

// ‰∏ìÈó®Áî®‰∫éÈÄöËØùÁöÑÁªü‰∏ÄAPIË∞ÉÁî®ÂáΩÊï∞
async function callUnifiedAPIForCall(url, key, model, messages) {
    const isGemini = url.includes('generativelanguage.googleapis.com');

    if (isGemini) {
        // Gemini API Ê†ºÂºè
        const apiUrl = `${url}/models/${model}:generateContent?key=${key}`;

        // ËΩ¨Êç¢Ê∂àÊÅØÊ†ºÂºè‰∏∫GeminiÊ†ºÂºè
        const geminiMessages = [];

        // Ê∑ªÂä†Á≥ªÁªüÊèêÁ§∫ËØç‰Ωú‰∏∫Á¨¨‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ
        if (messages[0]?.role === 'system') {
            geminiMessages.push({
                role: 'user',
                parts: [{ text: messages[0].content }]
            });
            geminiMessages.push({
                role: 'model',
                parts: [{ text: 'ÊàëÊòéÁôΩ‰∫ÜÔºåÊàë‰ºöÊåâÁÖßËøô‰∫õË¶ÅÊ±ÇËøõË°åÂØπËØù„ÄÇ' }]
            });
        }

        // ËΩ¨Êç¢ÂÖ∂‰ªñÊ∂àÊÅØ
        for (let i = 1; i < messages.length; i++) {
            const msg = messages[i];
            let content = '';

            if (typeof msg.content === 'string') {
                content = msg.content;
            } else if (Array.isArray(msg.content)) {
                content = msg.content.map(item => {
                    if (item.type === 'text') return item.text;
                    if (item.type === 'image_url') return '[ÂõæÁâá]';
                    return '';
                }).join('');
            }

            geminiMessages.push({
                role: msg.role === 'user' ? 'user' : 'model',
                parts: [{ text: content }]
            });
        }

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: geminiMessages,
                generationConfig: {
                    temperature: 0.8,
                    maxOutputTokens: 8192
                }
            })
        });

        if (!response.ok) {
            console.log('Gemini API ÈÄöËØùËØ∑Ê±ÇÂ§±Ë¥•:', response.status, response.statusText);
            return null;
        }

        const data = await response.json();
        const content = data.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!content) {
            console.log('Gemini API ÈÄöËØùÂìçÂ∫îÊï∞ÊçÆ:', data);
            return null;
        }
        return content;

    } else {
        // OpenAI API Ê†ºÂºèÔºàÂåÖÊã¨Êä±ËÑ∏Á≠â‰ª£ÁêÜÔºâ
        const response = await fetch(`${url}/v1/chat/completions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${key}`
            },
            body: JSON.stringify({
                model: model,
                messages: messages,
                temperature: 0.8,
                stream: false
            })
        });

        if (!response.ok) {
            console.log('OpenAIÊ†ºÂºèAPI ÈÄöËØùËØ∑Ê±ÇÂ§±Ë¥•:', response.status, response.statusText);
            return null;
        }

        const data = await response.json();

        // Â¢ûÂº∫ÂØπ‰∏çÂêåAPIÂìçÂ∫îÊ†ºÂºèÁöÑÂÖºÂÆπÊÄß
        let content = null;

        // 1. Ê†áÂáÜOpenAIÊ†ºÂºè
        if (data.choices && data.choices.length > 0 && data.choices[0].message) {
            content = data.choices[0].message.content;
        }
        // 2. ÈÉ®ÂàÜ‰ª£ÁêÜÂèØËÉΩÁõ¥Êé•ËøîÂõûmessageÂ≠óÊÆµ
        else if (data.message) {
            content = data.message;
        }
        // 3. ÈÉ®ÂàÜ‰ª£ÁêÜÂèØËÉΩËøîÂõûtextÂ≠óÊÆµ
        else if (data.text) {
            content = data.text;
        }
        // 4. ÈÉ®ÂàÜ‰ª£ÁêÜÂèØËÉΩËøîÂõûresponseÂ≠óÊÆµ
        else if (data.response) {
            content = data.response;
        }
        // 5. ÈÉ®ÂàÜ‰ª£ÁêÜÂèØËÉΩËøîÂõûcontentÂ≠óÊÆµ
        else if (data.content) {
            content = data.content;
        }
        // 6. ÈÉ®ÂàÜ‰ª£ÁêÜÂèØËÉΩËøîÂõûresultÂ≠óÊÆµ
        else if (data.result) {
            content = data.result;
        }

        if (!content) {
            console.error('ÈÄöËØùAPIÊó†Ê≥ïËß£ÊûêÂìçÂ∫îÔºåÂÆåÊï¥ÂìçÂ∫îÊï∞ÊçÆ:', data);
            return null;
        }

        return content.trim();
    }
}

// AIÂèçÂáªÂõûÂ§ç
async function generateAiCounterReply(postId, commentId, responderAiId, targetAiId, targetReplyContent) {
    const responderAi = state.chats[responderAiId];
    const targetAi = state.chats[targetAiId];
    
    if (!responderAi || !targetAi) return;
    
    try {
        const comment = await db.weiboComments.get(commentId);
        if (!comment || !comment.replies || comment.replies.length >= 7) return;
        
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) return;
        
        const responderPersona = responderAi.settings?.aiPersona || '';
        
        const systemPrompt = `‰Ω†ÊòØ${responderAi.name}Ôºå‰Ω†ÁöÑ‰∫∫ËÆæÂ¶Ç‰∏ãÔºö${responderPersona}„ÄÇ

ÂàöÂàö${targetAi.name}ÂõûÂ§ç‰∫Ü‰Ω†Ôºö"${targetReplyContent}"„ÄÇ

‰Ω†Ë¶Å‰Ωú‰∏∫${responderAi.name}ÔºåÂü∫‰∫é‰Ω†ÁöÑ‰∫∫ËÆæÂØπËøô‰∏™ÂõûÂ§çÂÅöÂá∫ÂèçÂ∫î„ÄÇË¶ÅÊ±ÇÔºö
1. ‰∏•Ê†ºÊåâÁÖß‰Ω†ÁöÑ‰∫∫ËÆæËøõË°åÂõûÂ§ç
2. ÂèØ‰ª•ÊòØÁªßÁª≠ËÆ®ËÆ∫„ÄÅÂºÄÁé©Á¨ë„ÄÅË∞É‰æÉÊàñÁªìÊùüËØùÈ¢ò
3. ‰øùÊåÅÁÆÄÁü≠ÊúâË∂£
4. ‰ΩìÁé∞‰Ω†ÁöÑÊÄßÊ†ºÁâπÁÇπ`;

        const messages = [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: `ËØ∑ÂØπ${targetAi.name}ÁöÑÂõûÂ§çÂÅöÂá∫ÂèçÂ∫î` }
        ];

        // ‰ΩøÁî®Áªü‰∏ÄÁöÑAPIË∞ÉÁî®
        let counterReplyContent = await callUnifiedAPI(proxyUrl, apiKey, model, messages);

        if (counterReplyContent) {
            // ÊõøÊç¢Áî®Êà∑Âç†‰ΩçÁ¨¶
            const userName = userProfileCache.name || 'ÊàëÁöÑÂæÆÂçö';
            counterReplyContent = counterReplyContent.replace(/@\{\{user\}\}/g, `@${userName}`);
            counterReplyContent = counterReplyContent.replace(/\{\{user\}\}/g, userName);

            comment.replies.push({
                id: Date.now(),
                authorId: responderAiId,
                content: counterReplyContent,
                timestamp: Date.now(),
                replyTo: targetAi.name
            });
            
            await db.weiboComments.put(comment);
            await renderWeiboTimeline();
        }
        
    } catch (error) {
        console.error('ÁîüÊàêAIÂèçÂáªÂõûÂ§çÂ§±Ë¥•:', error);
    }
}

// ÊâßË°åAI‰∫íÂä®ÁöÑÈÄöÁî®ÂáΩÊï∞
async function performAiInteraction(aiId, ai, post, interactionType) {
    try {
        if (interactionType === 'comment') {
            const commentResponse = await generateAiResponse(ai, 'comment', post, '');
            if (commentResponse) {
                const commentId = Date.now() + Math.random();
                const commentData = {
                    id: commentId,
                    postId: post.id,
                    authorId: aiId,
                    timestamp: Date.now(),
                    replies: []
                };

                // Â§ÑÁêÜË°®ÊÉÖÂåÖÊ†ºÂºèÁöÑÂõûÂ§ç
                if (typeof commentResponse === 'object' && commentResponse.type === 'sticker') {
                    commentData.content = commentResponse.content;
                    commentData.meaning = commentResponse.meaning;
                } else {
                    commentData.content = commentResponse;
                }

                await db.weiboComments.add(commentData);
            }
        } else if (interactionType === 'like') {
            await db.weiboLikes.add({
                postId: post.id,
                authorId: aiId,
                timestamp: Date.now()
            });
        } else if (interactionType === 'repost') {
            const repostResponse = await generateAiResponse(ai, 'repost', post, '');
            if (repostResponse) {
                const repostPost = {
                    id: Date.now() + Math.random(),
                    authorId: aiId,
                    authorName: ai.name,
                    authorAvatar: ai.settings.aiAvatar || defaultAvatar,
                    authorEmail: ai.settings.aiSignature || '',
                    authorSignature: ai.settings.aiSignature || '',
                    content: repostResponse,
                    visibility: 'public',
                    timestamp: Date.now(),
                    isRepost: true,
                    originalPostId: post.id
                };
                
                await db.weiboPosts.add(repostPost);
                await db.weiboReposts.add({
                    id: Date.now() + Math.random(),
                    originalPostId: post.id,
                    authorId: aiId,
                    content: repostResponse,
                    timestamp: Date.now()
                });
            }
        }
    } catch (error) {
        console.error(`AI ${interactionType} Â§±Ë¥•:`, error);
    }
}

// ÂæÆÂçöÂ§öÈÄâÂà†Èô§ÂäüËÉΩ
function enterWeiboSelectionMode() {
    if (isWeiboSelectionMode) return;
    isWeiboSelectionMode = true;
    window.isWeiboSelectionMode = true;
    document.getElementById('weibo-screen').classList.add('weibo-selection-mode');
    document.getElementById('weibo-selection-toolbar').classList.add('visible');
    updateWeiboSelectionToolbar();
}

function exitWeiboSelectionMode() {
    if (!isWeiboSelectionMode) return;
    isWeiboSelectionMode = false;
    window.isWeiboSelectionMode = false;
    document.getElementById('weibo-screen').classList.remove('weibo-selection-mode');
    document.getElementById('weibo-selection-toolbar').classList.remove('visible');
    
    // Ê∏ÖÈô§ÊâÄÊúâÈÄâ‰∏≠Áä∂ÊÄÅ
    selectedWeiboPosts.forEach(postId => {
        const postElement = document.querySelector(`.weibo-post[data-post-id="${postId}"]`);
        if (postElement) {
            postElement.classList.remove('selected');
        }
    });
    selectedWeiboPosts.clear();
    window.selectedWeiboPosts = selectedWeiboPosts;
}

function toggleWeiboPostSelection(postId) {
    const postElement = document.querySelector(`.weibo-post[data-post-id="${postId}"]`);
    if (!postElement) return;
    
    if (selectedWeiboPosts.has(postId)) {
        selectedWeiboPosts.delete(postId);
        postElement.classList.remove('selected');
    } else {
        selectedWeiboPosts.add(postId);
        postElement.classList.add('selected');
    }
    
    updateWeiboSelectionToolbar();
    
    // Â¶ÇÊûúÊ≤°ÊúâÈÄâ‰∏≠È°πÔºåÈÄÄÂá∫ÈÄâÊã©Ê®°Âºè
    if (selectedWeiboPosts.size === 0) {
        exitWeiboSelectionMode();
    }
}

function updateWeiboSelectionToolbar() {
    const countElement = document.querySelector('.weibo-selection-toolbar .selection-count');
    if (countElement) {
        countElement.textContent = `Â∑≤ÈÄâÊã© ${selectedWeiboPosts.size} Êù°Âä®ÊÄÅ`;
    }
}

async function deleteSelectedWeiboPosts() {
    if (selectedWeiboPosts.size === 0) return;
    
    const confirmed = await showCustomConfirm(
        'Âà†Èô§Âä®ÊÄÅ', 
        `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedWeiboPosts.size} Êù°Âä®ÊÄÅÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`, 
        { confirmButtonClass: 'btn-danger' }
    );
    
    if (confirmed) {
        try {
            // Âà†Èô§ÈÄâ‰∏≠ÁöÑÂä®ÊÄÅ
            for (const postId of selectedWeiboPosts) {
                await db.weiboPosts.delete(parseInt(postId));
                
                // ÂêåÊó∂Âà†Èô§Áõ∏ÂÖ≥ÁöÑËØÑËÆ∫„ÄÅÁÇπËµû„ÄÅËΩ¨Âèë
                await db.weiboComments.where('postId').equals(parseInt(postId)).delete();
                await db.weiboLikes.where('postId').equals(parseInt(postId)).delete();
                await db.weiboReposts.where('originalPostId').equals(parseInt(postId)).delete();
            }
            
            exitWeiboSelectionMode();
            
            // ÈáçÊñ∞Ê∏≤ÊüìÊó∂Èó¥Á∫ø
            const currentFilter = document.querySelector('.weibo-nav .nav-item.active')?.textContent === '‚Çç^À∂ ‚ï∏ñ•¶  ‚ï∏Àµ^‚Çé‚üÜ' ? 'mine' : 'all';
            await renderWeiboTimeline(currentFilter);
            
            showToast('Âà†Èô§ÊàêÂäüÔºÅ', 'success');
        } catch (error) {
            console.error('Âà†Èô§Âä®ÊÄÅÂ§±Ë¥•:', error);
            showToast('Âà†Èô§Â§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï', 'error');
        }
    }
}
        
        function renderChatInterface(chatId) { 
            const chat = state.chats[chatId]; 
            if (!chat) return; 
            exitSelectionMode(); 
            const messagesContainer = document.getElementById('chat-messages'); 
            messagesContainer.dataset.theme = chat.settings.theme || 'default'; 
            document.getElementById('chat-header-title').textContent = chat.name; 
            messagesContainer.innerHTML = ''; 
            const chatScreen = document.getElementById('chat-interface-screen'); 
            chatScreen.style.backgroundImage = chat.settings.background ? `url(${chat.settings.background})` : 'none'; 
            chatScreen.style.backgroundColor = chat.settings.background ? 'transparent' : '#f0f2f5'; 
            const history = chat.history; 
            const totalMessages = history.length; 
            currentRenderedCount = 0; 
            const initialMessages = history.slice(-MESSAGE_RENDER_WINDOW); 
            
            // Âú®ÂàùÂßãÂä†ËΩΩÊó∂‰πüÊ∑ªÂä†Êó∂Èó¥ÂàÜÈöîÁ¨¶
            let lastTimestamp = 0;
            
            // ÊåâÁÖßÊó∂Èó¥Êà≥ÊéíÂ∫èÊ∂àÊÅØÔºåÁ°Æ‰øùÊí§ÂõûÊ∂àÊÅØÂú®Ê≠£Á°ÆÁöÑ‰ΩçÁΩÆ
            const sortedMessages = [...initialMessages].sort((a, b) => {
                // Â¶ÇÊûúÊòØÊí§ÂõûÊ∂àÊÅØÔºå‰ΩøÁî®ÂéüÂßãÊó∂Èó¥Êà≥ËøõË°åÊéíÂ∫è
                const timestampA = a.type === 'recalled_message' && a.originalTimestamp ? a.originalTimestamp : a.timestamp;
                const timestampB = b.type === 'recalled_message' && b.originalTimestamp ? b.originalTimestamp : b.timestamp;
                return timestampA - timestampB;
            });
            
            // ÁÑ∂ÂêéÊåâÈ°∫Â∫èÊ∏≤ÊüìÊ∂àÊÅØ
            sortedMessages.forEach((msg, index) => {
                // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊ∑ªÂä†Êó∂Èó¥ÂàÜÈöîÁ¨¶ÔºàÈó¥Èöî5ÂàÜÈíüÔºâ
                if (index > 0 && msg.timestamp - lastTimestamp >= 300000) {
                    const timeSeparator = document.createElement('div');
                    timeSeparator.className = 'time-separator';
                    const timeString = new Date(msg.timestamp).toLocaleTimeString('zh-CN', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                    timeSeparator.textContent = timeString;
                    messagesContainer.appendChild(timeSeparator);
                }
                
                // ÊâÄÊúâÊ∂àÊÅØÈÉΩÈúÄË¶ÅÊòæÁ§∫ÔºåÂåÖÊã¨Êí§ÂõûÊ∂àÊÅØ
                appendMessage(msg, chat, true);
                
                lastTimestamp = msg.timestamp;
            });
            
            currentRenderedCount = initialMessages.length; 
            
            if (totalMessages > currentRenderedCount) { 
                prependLoadMoreButton(messagesContainer); 
            } 
            
            const typingIndicator = document.createElement('div'); 
            typingIndicator.id = 'typing-indicator'; 
            typingIndicator.style.display = 'none'; 
            typingIndicator.textContent = 'ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...'; 
            messagesContainer.appendChild(typingIndicator); 
            
            setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 0); 
            
            // Â§ÑÁêÜAIÂøÉÁéáÊòæÁ§∫
            updateAiHeartrate(chat);
        }
        function prependLoadMoreButton(container) { const button = document.createElement('button'); button.id = 'load-more-btn'; button.textContent = 'Âä†ËΩΩÊõ¥Êó©ÁöÑËÆ∞ÂΩï'; button.addEventListener('click', loadMoreMessages); container.prepend(button); }
        function loadMoreMessages() { const messagesContainer = document.getElementById('chat-messages'); const chat = state.chats[state.activeChatId]; if (!chat) return; const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) loadMoreBtn.remove(); const totalMessages = chat.history.length; const nextSliceStart = totalMessages - currentRenderedCount - MESSAGE_RENDER_WINDOW; const nextSliceEnd = totalMessages - currentRenderedCount; const messagesToPrepend = chat.history.slice(Math.max(0, nextSliceStart), nextSliceEnd); const oldScrollHeight = messagesContainer.scrollHeight; messagesToPrepend.reverse().forEach(msg => prependMessage(msg, chat)); currentRenderedCount += messagesToPrepend.length; const newScrollHeight = messagesContainer.scrollHeight; messagesContainer.scrollTop += (newScrollHeight - oldScrollHeight); if (totalMessages > currentRenderedCount) { prependLoadMoreButton(messagesContainer); } }
        
        async function renderWallpaperScreen() {
            const preview = document.getElementById('wallpaper-preview');

            // ‰ºòÂÖàÊòæÁ§∫Êñ∞‰∏ä‰º†ÁöÑÂ£ÅÁ∫∏ÔºåÂê¶Âàô‰ªéDexieÂä†ËΩΩÂΩìÂâçÂ£ÅÁ∫∏
            let bg = newWallpaperBase64;
            if (!bg) {
                const wallpaperData = await db.wallpapers.get('current_wallpaper');
                bg = wallpaperData ? wallpaperData.data : state.globalSettings.wallpaper;
            }

            if (bg && bg.startsWith('data:image')) {
                preview.style.backgroundImage = `url(${bg})`;
                preview.textContent = '';
            } else if(bg) {
                preview.style.backgroundImage = bg;
                preview.textContent = 'ÂΩìÂâç‰∏∫Ê∏êÂèòËâ≤';
            }

            // ËÆæÁΩÆÂõæÊ†á‰ΩçÁΩÆÈÄâÊã©Âô®ÁöÑÂΩìÂâçÂÄº
            const iconPositionSelect = document.getElementById('icon-position');
            if (iconPositionSelect) {
                iconPositionSelect.value = state.globalSettings.iconPosition || 'center';
            }

            // ËÆæÁΩÆÂ≠óÂè∑ÈÄâÊã©Âô®ÁöÑÂΩìÂâçÂÄº
            const fontSizeSelect = document.getElementById('font-size-select');
            if (fontSizeSelect) {
                fontSizeSelect.value = state.globalSettings.fontSize || 'medium';
            }

            // ËÆæÁΩÆÊó†ËæπÊ°ÜÊ®°ÂºèÂºÄÂÖ≥ÁöÑÂΩìÂâçÂÄº
            const borderlessToggle = document.getElementById('borderless-mode-toggle');
            if (borderlessToggle) {
                borderlessToggle.checked = state.globalSettings.borderlessMode || false;
            }

            // Ê∏≤ÊüìËá™ÂÆö‰πâÂõæÊ†áÁΩëÊ†º
            renderCustomIconsGrid();

            // ËÆæÁΩÆËá™ÂÆö‰πâÊ†∑ÂºèËæìÂÖ•Ê°ÜÁöÑÂΩìÂâçÂÄº
            const customBubbleCSSTextarea = document.getElementById('custom-bubble-css');
            if (customBubbleCSSTextarea) {
                customBubbleCSSTextarea.value = state.globalSettings.customBubbleCSS || '';
            }

            const customFontUrlInput = document.getElementById('custom-font-url');
            if (customFontUrlInput) {
                customFontUrlInput.value = state.globalSettings.customFontUrl || '';
            }

            const customFontFamilyInput = document.getElementById('custom-font-family');
            if (customFontFamilyInput) {
                customFontFamilyInput.value = state.globalSettings.customFontFamily || '';
            }
        }
        
        function renderCustomIconsGrid() {
            const grid = document.getElementById('custom-icons-grid');
            grid.innerHTML = '';
            
            // ÂÆö‰πâÈªòËÆ§ÁöÑÂ∫îÁî®ÂõæÊ†áÂàóË°®
            const defaultIcons = [
                { id: 'chat', name: 'ËÅäÂ§©', defaultIcon: 'https://i.postimg.cc/SxXGmXZY/IMG-3079.jpg' },
                { id: 'weibo', name: 'ÂæÆÂçö', defaultIcon: 'https://i.postimg.cc/0yjnBhH6/IMG-3080.jpg' },
                { id: 'wallpaper', name: 'Â£ÅÁ∫∏', defaultIcon: 'https://i.postimg.cc/DyS7X2SW/IMG-3081.jpg' },
                { id: 'api', name: 'APIËÆæÁΩÆ', defaultIcon: 'https://i.postimg.cc/4x3PYYpx/3082.jpg' },
                { id: 'worldbook', name: '‰∏ñÁïå‰π¶', defaultIcon: 'https://i.postimg.cc/NjNg7cYz/IMG-3083.jpg' }
            ];
            
            defaultIcons.forEach(icon => {
                const customIcon = state.globalSettings.customIcons && state.globalSettings.customIcons[icon.id];
                const currentIcon = customIcon || icon.defaultIcon;
                
                const iconItem = document.createElement('div');
                iconItem.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    padding: 10px;
                    border: 1px solid #ddd;
                    border-radius: 10px;
                    cursor: pointer;
                    transition: all 0.2s;
                `;
                
                iconItem.innerHTML = `
                    <img src="${currentIcon}" style="width: 60px; height: 60px; border-radius: 12px; object-fit: cover; margin-bottom: 8px;" alt="${icon.name}">
                    <span style="font-size: 12px; text-align: center;">${icon.name}</span>
                `;
                
                iconItem.addEventListener('click', () => openCustomIconModal(icon.id, icon.name, currentIcon));
                
                iconItem.addEventListener('mouseenter', () => {
                    iconItem.style.borderColor = 'rgb(74, 132, 193)';
                    iconItem.style.backgroundColor = '#f8f9fa';
                });
                
                iconItem.addEventListener('mouseleave', () => {
                    iconItem.style.borderColor = '#ddd';
                    iconItem.style.backgroundColor = 'transparent';
                });
                
                grid.appendChild(iconItem);
            });
        }
        
        // Ëá™ÂÆö‰πâÂõæÊ†áÂäüËÉΩ
        let currentEditingIcon = null;
        let currentIconPreview = null;
        
        function openCustomIconModal(iconId, iconName, currentIconUrl) {
            currentEditingIcon = { id: iconId, name: iconName };
            
            document.getElementById('custom-icon-title').textContent = `Ëá™ÂÆö‰πâ ${iconName} ÂõæÊ†á`;
            document.getElementById('current-icon-preview').src = currentIconUrl;
            
            // ÈáçÁΩÆÊñ∞ÂõæÊ†áÈ¢ÑËßà
            document.getElementById('new-icon-preview').style.display = 'none';
            document.getElementById('no-preview-text').style.display = 'block';
            document.getElementById('url-input-group').style.display = 'none';
            document.getElementById('icon-url-input').value = '';
            currentIconPreview = null;
            
            document.getElementById('custom-icon-modal').classList.add('visible');
        }
        
        function applyCustomIcons() {
            // Ëé∑Âèñ‰∏ªÈ°µÁöÑÊâÄÊúâÂ∫îÁî®ÂõæÊ†áÂπ∂Êõ¥Êñ∞
            const iconSelectors = {
                'chat': "div[onclick=\"showScreen('chat-list-screen')\"] img",
                'weibo': "div[onclick=\"showScreen('weibo-screen')\"] img",
                'wallpaper': "div[onclick=\"showScreen('wallpaper-screen')\"] img",
                'api': "div[onclick=\"showScreen('api-settings-screen')\"] img",
                'worldbook': "div[onclick=\"showScreen('world-book-screen')\"] img"
            };
            
            if (state.globalSettings.customIcons) {
                Object.keys(state.globalSettings.customIcons).forEach(iconId => {
                    const selector = iconSelectors[iconId];
                    if (selector) {
                        const iconElement = document.querySelector(selector);
                        if (iconElement) {
                            iconElement.src = state.globalSettings.customIcons[iconId];
                        }
                    }
                });
            }
        }
        
        window.renderWallpaperScreenProxy = () => renderWallpaperScreen();

        function applyGlobalWallpaper() {
            const homeScreen = document.getElementById('home-screen');
            const wallpaper = state.globalSettings.wallpaper;
            if (wallpaper && wallpaper.startsWith('data:image'))
                homeScreen.style.backgroundImage = `url(${wallpaper})`;
            else if (wallpaper)
                homeScreen.style.backgroundImage = wallpaper;
        }

        function applyCustomStyles() {
            // ÁßªÈô§‰πãÂâçÁöÑËá™ÂÆö‰πâÊ†∑Âºè
            const existingCustomStyle = document.getElementById('custom-bubble-styles');
            if (existingCustomStyle) {
                existingCustomStyle.remove();
            }

            const existingCustomFont = document.getElementById('custom-font-link');
            if (existingCustomFont) {
                existingCustomFont.remove();
            }

            // Â∫îÁî®Ëá™ÂÆö‰πâÂ≠ó‰Ωì
            if (state.globalSettings.customFontUrl) {
                const fontLink = document.createElement('link');
                fontLink.id = 'custom-font-link';
                fontLink.rel = 'stylesheet';
                fontLink.href = state.globalSettings.customFontUrl;
                document.head.appendChild(fontLink);
            }

            // Â∫îÁî®Ëá™ÂÆö‰πâCSSÊ†∑Âºè
            if (state.globalSettings.customBubbleCSS || state.globalSettings.customFontFamily) {
                const styleElement = document.createElement('style');
                styleElement.id = 'custom-bubble-styles';

                let customCSS = '';

                // Ê∑ªÂä†Ëá™ÂÆö‰πâÂ≠ó‰ΩìÊóè
                if (state.globalSettings.customFontFamily) {
                    customCSS += `
                        .message-bubble .content {
                            font-family: ${state.globalSettings.customFontFamily} !important;
                        }
                    `;
                }

                // Ê∑ªÂä†Áî®Êà∑Ëá™ÂÆö‰πâÁöÑCSS
                if (state.globalSettings.customBubbleCSS) {
                    customCSS += state.globalSettings.customBubbleCSS;
                }

                styleElement.textContent = customCSS;
                document.head.appendChild(styleElement);
            }
        }

        function previewCustomStyles() {
            const customCSS = document.getElementById('custom-bubble-css').value;
            const customFontUrl = document.getElementById('custom-font-url').value;
            const customFontFamily = document.getElementById('custom-font-family').value;

            // ÊòæÁ§∫È¢ÑËßàÂÆπÂô®
            const previewContainer = document.getElementById('bubble-preview-container');
            previewContainer.style.display = 'block';

            // ÁßªÈô§‰πãÂâçÁöÑÈ¢ÑËßàÊ†∑Âºè
            const existingPreviewStyle = document.getElementById('preview-bubble-styles');
            if (existingPreviewStyle) {
                existingPreviewStyle.remove();
            }

            const existingPreviewFont = document.getElementById('preview-font-link');
            if (existingPreviewFont) {
                existingPreviewFont.remove();
            }

            // Â∫îÁî®È¢ÑËßàÂ≠ó‰Ωì
            if (customFontUrl) {
                const fontLink = document.createElement('link');
                fontLink.id = 'preview-font-link';
                fontLink.rel = 'stylesheet';
                fontLink.href = customFontUrl;
                document.head.appendChild(fontLink);
            }

            // Â∫îÁî®È¢ÑËßàÊ†∑Âºè
            if (customCSS || customFontFamily) {
                const styleElement = document.createElement('style');
                styleElement.id = 'preview-bubble-styles';

                let previewCSS = '';

                // Ê∑ªÂä†Ëá™ÂÆö‰πâÂ≠ó‰ΩìÊóèÂà∞È¢ÑËßàÊ∞îÊ≥°
                if (customFontFamily) {
                    previewCSS += `
                        .preview-user-bubble, .preview-ai-bubble {
                            font-family: ${customFontFamily} !important;
                        }
                    `;
                }

                // Â∞ÜÁî®Êà∑ÁöÑCSS‰∏≠ÁöÑÈÄâÊã©Âô®ÊõøÊç¢‰∏∫È¢ÑËßà‰∏ìÁî®ÁöÑÈÄâÊã©Âô®
                if (customCSS) {
                    let modifiedCSS = customCSS;
                    // ÊõøÊç¢Áî®Êà∑Ê∞îÊ≥°ÈÄâÊã©Âô®
                    modifiedCSS = modifiedCSS.replace(/\.message-bubble\.user\s+\.content/g, '.preview-user-bubble');
                    // ÊõøÊç¢AIÊ∞îÊ≥°ÈÄâÊã©Âô®
                    modifiedCSS = modifiedCSS.replace(/\.message-bubble\.ai\s+\.content/g, '.preview-ai-bubble');
                    previewCSS += modifiedCSS;
                }

                styleElement.textContent = previewCSS;
                document.head.appendChild(styleElement);
            }

            // ÊªöÂä®Âà∞È¢ÑËßàÂå∫Âüü
            previewContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });

            showToast('È¢ÑËßàÊïàÊûúÂ∑≤ÊòæÁ§∫Âú®‰∏ãÊñπÔºÅ', 'success');
        }
        
        function applyIconPosition() {
            const appGrid = document.getElementById('app-grid');
            const position = state.globalSettings.iconPosition || 'center';
            
            // ÁßªÈô§‰πãÂâçÁöÑÊâÄÊúâ‰ΩçÁΩÆÁ±ª
            appGrid.classList.remove('position-top', 'position-center', 'position-bottom');
            
            // Ê†πÊçÆ‰ΩçÁΩÆËÆæÁΩÆ‰∏çÂêåÁöÑÊ†∑Âºè
            switch (position) {
                case 'top':
                    appGrid.style.marginTop = '20px';
                    appGrid.style.marginBottom = 'auto';
                    break;
                case 'center':
                    appGrid.style.marginTop = 'auto';
                    appGrid.style.marginBottom = 'auto';
                    break;
                case 'bottom':
                    appGrid.style.marginTop = 'auto';
                    appGrid.style.marginBottom = '20px';
                    break;
            }
        }
        
        function applyFontSize() {
            const fontSize = state.globalSettings.fontSize || 'medium';

            // ÁßªÈô§‰πãÂâçÁöÑÂ≠óÂè∑ËÆæÁΩÆ
            document.body.removeAttribute('data-font-size');

            // Â∫îÁî®Êñ∞ÁöÑÂ≠óÂè∑ËÆæÁΩÆ
            document.body.setAttribute('data-font-size', fontSize);
        }

        function renderWorldBookScreen() { const listEl = document.getElementById('world-book-list'); listEl.innerHTML = ''; if (state.worldBooks.length === 0) { listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ÁÇπÂáªÂè≥‰∏äËßí "+" ÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏ÄÊú¨‰∏ñÁïå‰π¶</p>'; return; } state.worldBooks.forEach(book => { const item = document.createElement('div'); item.className = 'list-item'; item.dataset.bookId = book.id; item.innerHTML = `<div class="item-title">${book.name}</div><div class="item-content">${(book.content || 'ÊöÇÊó†ÂÜÖÂÆπ...').substring(0, 50)}</div>`; item.addEventListener('click', () => openWorldBookEditor(book.id)); addLongPressListener(item, async () => { const confirmed = await showCustomConfirm('Âà†Èô§‰∏ñÁïå‰π¶', `Á°ÆÂÆöË¶ÅÂà†Èô§„Ää${book.name}„ÄãÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.worldBooks.delete(book.id); state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id); renderWorldBookScreen(); } }); listEl.appendChild(item); }); }
        window.renderWorldBookScreenProxy = renderWorldBookScreen;
        function openWorldBookEditor(bookId) { editingWorldBookId = bookId; const book = state.worldBooks.find(wb => wb.id === bookId); if (!book) return; document.getElementById('world-book-editor-title').textContent = book.name; document.getElementById('world-book-name-input').value = book.name; document.getElementById('world-book-content-input').value = book.content; showScreen('world-book-editor-screen'); }
        function renderStickerPanel() { const grid = document.getElementById('sticker-grid'); grid.innerHTML = ''; if (state.userStickers.length === 0) { grid.innerHTML = '<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">Â§ß‰∫∫ËØ∑ÁÇπÂáªÂè≥‰∏äËßí"Ê∑ªÂä†"Êàñ"‰∏ä‰º†"Êù•Ê∑ªÂä†‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™Ë°®ÊÉÖÂêßÔºÅ</p>'; return; } state.userStickers.forEach(sticker => { const item = document.createElement('div'); item.className = 'sticker-item'; item.style.backgroundImage = `url(${sticker.url})`; item.title = sticker.name; item.addEventListener('click', () => sendSticker(sticker)); addLongPressListener(item, () => { if (isSelectionMode) return; const existingDeleteBtn = item.querySelector('.delete-btn'); if (existingDeleteBtn) return; const deleteBtn = document.createElement('div'); deleteBtn.className = 'delete-btn'; deleteBtn.innerHTML = '&times;'; deleteBtn.onclick = async (e) => { e.stopPropagation(); const confirmed = await showCustomConfirm('Âà†Èô§Ë°®ÊÉÖ', `Á°ÆÂÆöË¶ÅÂà†Èô§Ë°®ÊÉÖ "${sticker.name}" ÂêóÔºü`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.userStickers.delete(sticker.id); state.userStickers = state.userStickers.filter(s => s.id !== sticker.id); renderStickerPanel(); } }; item.appendChild(deleteBtn); deleteBtn.style.display = 'block'; setTimeout(() => item.addEventListener('mouseleave', () => deleteBtn.remove(), { once: true }), 3000); }); grid.appendChild(item); }); }
        
        // Â§ÑÁêÜÁ∫ø‰∏ãÊ®°ÂºèÂÜÖÂÆπÔºöËØÜÂà´„Äå„ÄçÂåÖË£πÁöÑÂØπËØùÂíåÊèèÂÜô
        function processOfflineModeContent(content) {
            // Â¶ÇÊûúÂÜÖÂÆπ‰∏∫Á©∫ÔºåÁõ¥Êé•ËøîÂõû
            if (!content || !content.trim()) {
                return content;
            }
            
            // ‰ΩøÁî®Ê≠£ÂàôË°®ËææÂºèËØÜÂà´„Äå„ÄçÂåÖË£πÁöÑÂØπËØùÂÜÖÂÆπ
            const processedContent = content.replace(/„Äå([^„Äç]+)„Äç/g, (match, dialogue) => {
                // ÂØπËØùÈÉ®ÂàÜ‰øùÊåÅÊ≠£Â∏∏ÊòæÁ§∫ÔºàÈªëËâ≤ÊñáÂ≠óÔºâ
                return `„Äå${dialogue}„Äç`;
            });
            
            // Â∞ÜÈùûÂØπËØùÈÉ®ÂàÜÔºà‰∏çÂú®„Äå„ÄçÂÜÖÁöÑÂÜÖÂÆπÔºâËΩ¨Êç¢‰∏∫ÁÅ∞Ëâ≤Êñú‰Ωì
            let result = '';
            let lastIndex = 0;
            const dialogueRegex = /„Äå[^„Äç]+„Äç/g;
            let match;
            
            while ((match = dialogueRegex.exec(content)) !== null) {
                // Â§ÑÁêÜÂØπËØùÂâçÁöÑÊèèÂÜôÈÉ®ÂàÜ
                const beforeDialogue = content.substring(lastIndex, match.index);
                if (beforeDialogue.trim()) {
                    result += `<span style="color: #555; font-style: italic;">${beforeDialogue}</span>`;
                }
                
                // Ê∑ªÂä†ÂØπËØùÈÉ®ÂàÜÔºà‰øùÊåÅÊ≠£Â∏∏ÊòæÁ§∫Ôºâ
                result += match[0];
                lastIndex = match.index + match[0].length;
            }
            
            // Â§ÑÁêÜÊúÄÂêéÂâ©‰ΩôÁöÑÊèèÂÜôÈÉ®ÂàÜ
            const remaining = content.substring(lastIndex);
            if (remaining.trim()) {
                result += `<span style="color: #555; font-style: italic;">${remaining}</span>`;
            }
            
            return result.replace(/\n/g, '<br>');
        }

        function createMessageElement(msg, chat) { 
            // Â¶ÇÊûúÊòØÁ≥ªÁªüÊ∂àÊÅØÔºàÂ¶ÇÊî∂Ê¨æÁ°ÆËÆ§ÔºâÔºåÂàõÂª∫Á±ª‰ººÊó∂Èó¥Êà≥ÁöÑÁâπÊÆäÂÖÉÁ¥†
            if (msg.type === 'system_message') {
                const systemElement = document.createElement('div');
                systemElement.className = 'time-separator'; // ‰ΩøÁî®Êó∂Èó¥ÂàÜÈöîÁ¨¶ÁöÑÊ†∑ÂºèÁ±ª
                systemElement.textContent = msg.content;
                systemElement.dataset.timestamp = msg.timestamp;
                return systemElement;
            }
            
            // Â¶ÇÊûúÊòØÊà≥‰∏ÄÊà≥Ê∂àÊÅØÔºåÂàõÂª∫ÁâπÊÆäÁöÑÂÖÉÁ¥†
            if (msg.type === 'poke') {
                const pokeElement = document.createElement('div');
                pokeElement.className = 'poke-message';
                pokeElement.textContent = msg.content;
                pokeElement.dataset.timestamp = msg.timestamp;
                return pokeElement;
            }
            
            // Â¶ÇÊûúÊòØÈÄöËØùÊó∂ÈïøÊèêÈÜíÔºåÂàõÂª∫ÁâπÊÆäÁöÑÂÖÉÁ¥†
            if (msg.type === 'call_duration') {
                const durationElement = document.createElement('div');
                durationElement.className = 'call-duration-message';
                durationElement.textContent = msg.content;
                durationElement.dataset.timestamp = msg.timestamp;
                durationElement.style.cssText = `
                    text-align: center;
                    color: #999;
                    font-size: 12px;
                    margin: 8px 0;
                    padding: 4px 0;
                `;
                return durationElement;
            }
            
            // Â¶ÇÊûúÊòØÈÄöËØù‰∏≠ÁöÑÊèèÂÜôÊ∂àÊÅØÔºåÂàõÂª∫ÁâπÊÆäÁöÑÂÖÉÁ¥†
            if (msg.isDescription) {
                const descElement = document.createElement('div');
                descElement.className = 'call-description-message';
                descElement.innerHTML = msg.content;
                descElement.dataset.timestamp = msg.timestamp;
                descElement.style.cssText = `
                    text-align: center;
                    color: #000000;
                    font-style: italic;
                    font-size: 13px;
                    margin: 8px 0;
                    padding: 5px 15px;
                `;
                return descElement;
            }
            
            // Â¶ÇÊûúÊòØÊí§ÂõûÊ∂àÊÅØÔºåÂàõÂª∫ÁâπÊÆäÁöÑÂÖÉÁ¥†
            if (msg.type === 'recalled_message') {
                // ÂàõÂª∫Êí§ÂõûÊ∂àÊÅØÔºå‰ΩøÁî®ÂíåÊó∂Èó¥ÂàÜÈöîÁ¨¶Áõ∏ÂêåÁöÑÊ†∑Âºè
                const recallElement = document.createElement('div');
                recallElement.className = 'time-separator'; // ‰ΩøÁî®Êó∂Èó¥ÂàÜÈöîÁ¨¶ÁöÑÊ†∑ÂºèÁ±ª
                recallElement.dataset.timestamp = msg.timestamp;
                if (msg.originalTimestamp) {
                    recallElement.dataset.originalTimestamp = msg.originalTimestamp;
                }
                
                // ÂàõÂª∫Êí§ÂõûÊ∂àÊÅØÁöÑÊòæÁ§∫ÂÜÖÂÆπÔºå‰ΩøÁî®Ê≠£Á°ÆÁöÑÂèëÈÄÅËÄÖÂêçÁß∞
                const recallText = document.createElement('div');
                const displayName = chat.isGroup && msg.senderName ? msg.senderName : (chat.name || 'ÂØπÊñπ');
                recallText.textContent = `${displayName}Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ`;
                recallElement.appendChild(recallText);
                
                // Â¶ÇÊûúÊúâÂéüÂßãÊ∂àÊÅØÂÜÖÂÆπÔºåÊòæÁ§∫ÂéüÊñá
                if (msg.originalContent) {
                    const originalText = document.createElement('div');
                    originalText.textContent = `ÂéüÊñáÔºö${msg.originalContent}`;
                    originalText.style.cssText = `
                        margin-top: 4px;
                    `;
                    recallElement.appendChild(originalText);
                }
                
                return recallElement;
            }
            
            // Â¶ÇÊûúÊòØÁ≥ªÁªüÊ∂àÊÅØÔºåÂàõÂª∫ÁâπÊÆäÁöÑÂÖÉÁ¥†
            if (msg.type === 'system_message') {
                const systemElement = document.createElement('div');
                systemElement.className = 'time-separator'; // ‰ΩøÁî®Êó∂Èó¥ÂàÜÈöîÁ¨¶ÁöÑÊ†∑ÂºèÁ±ª
                systemElement.dataset.timestamp = msg.timestamp;
                systemElement.textContent = msg.content;
                systemElement.style.cssText = `
                    text-align: center;
                    color: #999;
                    font-size: 12px;
                    margin: 15px 0 8px 0;
                    padding: 5px 0;
                `;
                return systemElement;
            }

            const isUser = msg.role === 'user'; const wrapper = document.createElement('div'); wrapper.className = `message-wrapper ${isUser ? 'user' : 'ai'}`; if (chat.isGroup && !isUser) { const senderNameDiv = document.createElement('div'); senderNameDiv.className = 'sender-name'; senderNameDiv.textContent = msg.senderName || 'Êú™Áü•ÊàêÂëò'; wrapper.appendChild(senderNameDiv); } const bubble = document.createElement('div'); bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`; bubble.dataset.timestamp = msg.timestamp; let avatarSrc; if (chat.isGroup) { if (isUser) avatarSrc = chat.settings.myAvatar || defaultMyGroupAvatar; else { const member = chat.members.find(m => m.name === msg.senderName); avatarSrc = member ? member.avatar : defaultGroupMemberAvatar; } } else { avatarSrc = isUser ? (chat.settings.myAvatar || defaultAvatar) : (chat.settings.aiAvatar || defaultAvatar); } let contentHtml; if (msg.type === 'user_photo' || msg.type === 'ai_image') { bubble.classList.add('is-ai-image'); const altText = msg.type === 'user_photo' ? "Áî®Êà∑ÊèèËø∞ÁöÑÁÖßÁâá" : "AIÁîüÊàêÁöÑÂõæÁâá"; const escapedDescription = (msg.content || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); contentHtml = `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="ai-generated-image" alt="${altText}" data-description="${escapedDescription}">`; } else if (msg.type === 'voice_message') { bubble.classList.add('is-voice-message'); const duration = Math.max(1, Math.round((msg.content || '').length / 5)); const durationFormatted = `0:${String(duration).padStart(2, '0')}''`; const waveformHTML = '<div></div><div></div><div></div><div></div><div></div>'; contentHtml = `<div class="voice-message-body" data-text="${msg.content}"><div class="voice-waveform">${waveformHTML}</div><span class="voice-duration">${durationFormatted}</span></div>`; } else if (msg.type === 'transfer') {
                bubble.classList.add('is-transfer'); 
                const titleText = isUser ? 'ËΩ¨Ë¥¶ÁªôTa' : 'Êî∂Âà∞‰∏ÄÁ¨îËΩ¨Ë¥¶'; 
                const heartIcon = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="vertical-align: middle;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`; 
                
                // Ê∑ªÂä†ËΩ¨Ë¥¶Áä∂ÊÄÅ
                let statusHtml = '';
                let cardClass = '';
                if (msg.status === 'accepted') {
                    statusHtml = `<div class="transfer-status">${isUser ? 'ÂØπÊñπÂ∑≤Êî∂Ê¨æ' : 'Â∑≤Êî∂Ê¨æ'}</div>`;
                    cardClass = 'accepted';
                } else if (msg.status === 'rejected') {
                    statusHtml = `<div class="transfer-status">${isUser ? 'ÂØπÊñπÂ∑≤ÈÄÄÂõû' : 'Â∑≤ÈÄÄÂõû'}</div>`;
                    cardClass = 'accepted';
                }
                
                contentHtml = `<div class="transfer-card ${cardClass}" data-transfer-id="${msg.timestamp}"><div class="transfer-title">${heartIcon} ${titleText}</div><div class="transfer-amount">¬• ${Number(msg.amount).toFixed(2)}</div><div class="transfer-note">${msg.note || 'ÂØπÊñπÊ≤°ÊúâÁïô‰∏ãÂ§áÊ≥®Âì¶~'}</div>${statusHtml}</div>`; } else if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) { bubble.classList.add('is-sticker'); contentHtml = `<img src="${msg.content}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`; } else if (Array.isArray(msg.content)) { 
                // Â§ÑÁêÜÂ§öÊ®°ÊÄÅÊ∂àÊÅØÔºàÂõæÁâá+ÊñáÊú¨ÁªÑÂêàÔºâ
                const imageItem = msg.content.find(item => item.type === 'image_url');
                const textItem = msg.content.find(item => item.type === 'text');
                
                if (imageItem) {
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØË°®ÊÉÖÂåÖÔºàÊúâtext‰∏îÂåÖÂê´"Ë°®ÊÉÖÂåÖ"Ôºâ
                    if (textItem && textItem.text.includes('Ë°®ÊÉÖÂåÖ') && msg.meaning) {
                        bubble.classList.add('is-sticker');
                        contentHtml = `<img src="${imageItem.image_url.url}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`;
                    } else {
                        // ÊôÆÈÄöÂõæÁâá
                        bubble.classList.add('has-image');
                        contentHtml = `<img src="${imageItem.image_url.url}" class="chat-image" alt="User uploaded image">`;
                        // Â¶ÇÊûúÊúâÊñáÊú¨ÔºåÊ∑ªÂä†Âà∞ÂõæÁâá‰∏ãÊñπ
                        if (textItem && textItem.text) {
                            contentHtml += `<div class="image-text">${textItem.text}</div>`;
                        }
                    }
                } else if (textItem) {
                    // Âè™ÊúâÊñáÊú¨ÁöÑÊÉÖÂÜµ
                    contentHtml = textItem.text.replace(/\n/g, '<br>');
                } else {
                    // ÂÖ∂‰ªñÊÉÖÂÜµ
                    contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
                }
            } else { 
                // Ê£ÄÊü•ÊòØÂê¶‰∏∫Á∫ø‰∏ãÊ®°Âºè‰∏î‰∏∫AIËßíËâ≤Ê∂àÊÅØ
                const chatMode = chat.settings.chatMode || 'online';
                if (chatMode === 'offline' && !isUser && msg.role === 'assistant') {
                    // Á∫ø‰∏ãÊ®°ÂºèÔºöÂå∫ÂàÜËØ≠Ë®ÄÂíåÈùûËØ≠Ë®ÄÂÜÖÂÆπ
                    const content = String(msg.content || '');
                    contentHtml = processOfflineModeContent(content);
                } else {
                    // Á∫ø‰∏äÊ®°ÂºèÊàñÁî®Êà∑Ê∂àÊÅØÔºöÊ≠£Â∏∏Â§ÑÁêÜ
                    contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
                }
            }
            
            // Â§ÑÁêÜ@È´ò‰∫ÆÊòæÁ§∫Ôºà‰ªÖÈôêÁæ§ËÅäÔºâ
            if (chat.isGroup && contentHtml) {
                contentHtml = highlightMentions(contentHtml, chat);
            } bubble.innerHTML = `<div class="avatar-group"><img src="${avatarSrc}" class="avatar"><span class="timestamp">${formatTimestamp(msg.timestamp)}</span></div><div class="content">${contentHtml}</div>`; addLongPressListener(bubble, () => enterSelectionMode(msg.timestamp)); bubble.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); }); 
                
                // Ê∑ªÂä†Â§¥ÂÉèÁÇπÂáªÊà≥‰∏ÄÊà≥‰∫ã‰ª∂
                const avatarElement = bubble.querySelector('.avatar');
                avatarElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (isSelectionMode) return;
                    handlePoke(isUser, chat, msg.senderName);
                });
                
                // Ê∑ªÂä†ËΩ¨Ë¥¶Âç°ÁâáÁÇπÂáª‰∫ã‰ª∂
                if (msg.type === 'transfer' && !msg.status) {
                    const transferCard = bubble.querySelector('.transfer-card');
                    if (transferCard) {
                        // Â¶ÇÊûúÊòØAIÂèëÁªôÁî®Êà∑ÁöÑËΩ¨Ë¥¶ÔºåÁî®Êà∑ÁÇπÂáªÂèØ‰ª•Á°ÆËÆ§Êî∂Ê¨æ
                        if (!isUser) {
                            transferCard.addEventListener('click', (e) => {
                                e.stopPropagation();
                                if (isSelectionMode) return;
                                showTransferConfirmDialog(msg);
                            });
                        }
                        // Â¶ÇÊûúÊòØÁî®Êà∑ÂèëÁªôAIÁöÑËΩ¨Ë¥¶ÔºåAI‰ºöËá™Âä®Êé•ÂèóÔºàÂú®‰∏ã‰∏ÄÊ¨°ÂõûÂ§ç‰∏≠Ôºâ
                    }
                }
                
                wrapper.appendChild(bubble); 
                
                // Â¶ÇÊûúÊòØËØ≠Èü≥Ê∂àÊÅØÔºåÈúÄË¶ÅÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑÂ§ñÂ±ÇÂÆπÂô®
                if (msg.type === 'voice_message') {
                    const outerContainer = document.createElement('div');
                    outerContainer.className = `voice-message-container ${isUser ? 'user' : 'ai'}`;
                    
                    const voiceTextDiv = document.createElement('div');
                    voiceTextDiv.className = 'voice-text-content';
                    voiceTextDiv.textContent = msg.content;
                    
                    outerContainer.appendChild(wrapper);
                    outerContainer.appendChild(voiceTextDiv);
                    
                    return outerContainer;
                }
                
                return wrapper; 
            }
        function prependMessage(msg, chat) { const messagesContainer = document.getElementById('chat-messages'); const messageEl = createMessageElement(msg, chat); const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) { messagesContainer.insertBefore(messageEl, loadMoreBtn.nextSibling); } else { messagesContainer.prepend(messageEl); } }
        // Ê£ÄÊü•Âπ∂Ê∑ªÂä†Êó∂Èó¥ÂàÜÈöîÁ¨¶
        function checkAndAddTimeSeparator(container, currentTimestamp) {
            const messages = container.querySelectorAll('.message-wrapper, .poke-message');
            if (messages.length === 0) return;
            
            // Ëé∑ÂèñÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥
            const lastMessage = messages[messages.length - 1];
            let lastTimestamp;
            
            if (lastMessage.classList.contains('poke-message')) {
                lastTimestamp = parseInt(lastMessage.dataset.timestamp);
            } else {
                const lastBubble = lastMessage.querySelector('.message-bubble');
                lastTimestamp = parseInt(lastBubble.dataset.timestamp);
            }
            
            // Ê£ÄÊü•Êó∂Èó¥Â∑ÆÊòØÂê¶Â§ß‰∫é5ÂàÜÈíüÔºà300000ÊØ´ÁßíÔºâ
            if (currentTimestamp - lastTimestamp >= 300000) {
                const timeSeparator = document.createElement('div');
                timeSeparator.className = 'time-separator';
                const timeString = new Date(currentTimestamp).toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                timeSeparator.textContent = timeString;
                
                const typingIndicator = document.getElementById('typing-indicator');
                container.insertBefore(timeSeparator, typingIndicator);
            }
        }

        function appendMessage(msg, chat, isInitialLoad = false) { 
            const messagesContainer = document.getElementById('chat-messages'); 
            
            // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊ∑ªÂä†Êó∂Èó¥ÂàÜÈöîÁ¨¶
            if (!isInitialLoad) {
                checkAndAddTimeSeparator(messagesContainer, msg.timestamp);
            }
            
            const messageEl = createMessageElement(msg, chat); 
            const typingIndicator = document.getElementById('typing-indicator'); 
            messagesContainer.insertBefore(messageEl, typingIndicator); 
            
            if (!isInitialLoad) { 
                messagesContainer.scrollTop = messagesContainer.scrollHeight; 
                currentRenderedCount++; 
            } 
        }

        function openChat(chatId) { state.activeChatId = chatId; renderChatInterface(chatId); showScreen('chat-interface-screen'); }
        
        // Â∞ÅË£ÖÂéüÂßãÁöÑAIÂìçÂ∫îÈÄªËæë
        async function executeAiResponse(abortSignal, chatId) {
            const chat = state.chats[chatId];
            if (!chat) {
                throw new Error('ËÅäÂ§©‰∏çÂ≠òÂú®');
            } const { proxyUrl, apiKey, model } = state.apiConfig; if (!proxyUrl || !apiKey || !model) { alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂèç‰ª£Âú∞ÂùÄ„ÄÅÂØÜÈí•Âπ∂ÈÄâÊã©Ê®°Âûã„ÄÇ'); document.getElementById('typing-indicator').style.display = 'none'; return; } const now = new Date(); const currentTime = now.toLocaleTimeString('zh-CN', { hour: 'numeric', minute: 'numeric', hour12: true }); let worldBookContent = ''; if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) { const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => { const worldBook = state.worldBooks.find(wb => wb.id === bookId); return worldBook && worldBook.content ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${worldBook.content}` : ''; }).filter(Boolean).join(''); if (linkedContents) { worldBookContent = `\n\n# Ê†∏ÂøÉ‰∏ñÁïåËßÇËÆæÂÆö (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËÆæÂÆö)\n${linkedContents}\n`; } } 
        
        // Ëé∑ÂèñÊúÄÊñ∞ÁöÑ5Êù°ÂæÆÂçöÂä®ÊÄÅÂèäÂÖ∂ËØÑËÆ∫
        let weiboContext = '';
        try {
            const latestPosts = await db.weiboPosts
                .orderBy('timestamp')
                .reverse()
                .limit(5)
                .toArray();
                
            if (latestPosts.length > 0) {
                weiboContext = '\n\n# ÊúÄÊñ∞ÁöÑÂæÆÂçöÂä®ÊÄÅÔºàÂèØ‰Ωú‰∏∫ËØùÈ¢òÂèÇËÄÉÔºâ\n';
                for (const post of latestPosts) {
                    const authorName = post.authorId === 'user' ? 'Áî®Êà∑' : 
                        (state.chats[post.authorId] ? state.chats[post.authorId].name : 'Êú™Áü•');
                    weiboContext += `\n[${authorName}]: ${post.content}`;
                    
                    // Ëé∑ÂèñËØ•Âä®ÊÄÅÁöÑËØÑËÆ∫
                    const comments = await db.weiboComments
                        .where('postId')
                        .equals(post.id)
                        .limit(3)
                        .toArray();
                        
                    if (comments.length > 0) {
                        weiboContext += '\n  ËØÑËÆ∫Ôºö';
                        for (const comment of comments) {
                            const commentAuthor = comment.authorId === 'user' ? 'Áî®Êà∑' : 
                                (state.chats[comment.authorId] ? state.chats[comment.authorId].name : 'Êú™Áü•');
                            weiboContext += `\n    - ${commentAuthor}: ${comment.content}`;
                        }
                    }
                }
            }
        } catch (error) {
            console.error('Ëé∑ÂèñÂæÆÂçöÂä®ÊÄÅÂ§±Ë¥•:', error);
        }
        
        let musicContext = ''; if (musicState.isActive && musicState.activeChatId === chatId && musicState.currentIndex > -1) { const currentTrack = musicState.playlist[musicState.currentIndex]; musicContext = `\n\n# ÂΩìÂâçÊÉÖÊôØ\n‰Ω†Ê≠£Âú®ÂíåÁî®Êà∑‰∏ÄËµ∑Âê¨Ê≠å„ÄÇÂΩìÂâçÊí≠ÊîæÁöÑÊ≠åÊõ≤ÊòØÔºö${currentTrack.name} - ${currentTrack.artist}„ÄÇËØ∑Âú®ÂØπËØù‰∏≠Ëá™ÁÑ∂Âú∞ËûçÂÖ•Ëøô‰∏™ÊÉÖÂ¢É„ÄÇ\n`; } 
        
        // Ëé∑ÂèñÊåÇËΩΩÁöÑËÆ∞ÂøÜ
        let mountedMemories = '';
        if (chat.settings.memoryMountEnabled && chat.settings.memoryMountChatIds && chat.settings.memoryMountChatIds.length > 0) {
            const mountCount = parseInt(chat.settings.memoryMountCount) || 10;
            const mountedChats = chat.settings.memoryMountChatIds.map(chatId => state.chats[chatId]).filter(Boolean);
            
            if (mountedChats.length > 0) {
                mountedMemories = '\n\n# ÂèÇËÄÉËÆ∞ÂøÜÔºàÊù•Ëá™ÂÖ∂‰ªñËÅäÂ§©ÁöÑËÉåÊôØ‰ø°ÊÅØÔºâ\n';
                mountedChats.forEach(mountedChat => {
                    const chatType = mountedChat.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]';
                    const recentHistory = getHistoryByRounds(mountedChat.history, mountCount);
                    
                    if (recentHistory.length > 0) {
                        mountedMemories += `\n## ${chatType} ${mountedChat.name} ÁöÑÊúÄËøëËÆ∞ÂøÜ:\n`;
                        recentHistory.forEach(msg => {
                            let content = '';
                            if (msg.role === 'user') {
                                const senderName = mountedChat.isGroup ? (mountedChat.settings.myNickname || 'Áî®Êà∑') : 'Áî®Êà∑';
                                if (msg.type === 'user_photo') content = `${senderName}: [ÂèëÈÄÅ‰∫ÜÁÖßÁâáÔºö${msg.content}]`;
                                else if (msg.type === 'voice_message') content = `${senderName}: [ËØ≠Èü≥Ôºö${msg.content}]`;
                                else if (msg.type === 'transfer') content = `${senderName}: [ËΩ¨Ë¥¶ ${msg.amount}ÂÖÉÔºåÂ§áÊ≥®Ôºö${msg.note}]`;
                                else if (msg.meaning) content = `${senderName}: [Ë°®ÊÉÖÔºö${msg.meaning}]`;
                                else content = `${senderName}: ${msg.content}`;
                            } else if (msg.role === 'assistant') {
                                const aiName = mountedChat.isGroup ? (msg.senderName || 'ËßíËâ≤') : mountedChat.name;
                                if (msg.type === 'ai_image') content = `${aiName}: [ÂèëÈÄÅ‰∫ÜÂõæÁâá]`;
                                else if (msg.type === 'voice_message') content = `${aiName}: [ËØ≠Èü≥Ôºö${msg.content}]`;
                                else if (msg.type === 'transfer') content = `${aiName}: [ËΩ¨Ë¥¶ ${msg.amount}ÂÖÉÔºåÂ§áÊ≥®Ôºö${msg.note}]`;
                                else content = `${aiName}: ${msg.content}`;
                            }
                            if (content) mountedMemories += `- ${content}\n`;
                        });
                    }
                });
                mountedMemories += '\nÊ≥®ÊÑèÔºö‰ª•‰∏äÊòØÊù•Ëá™ÂÖ∂‰ªñËÅäÂ§©ÁöÑÂèÇËÄÉËÆ∞ÂøÜÔºåÂèØ‰ª•Áî®‰ΩúÂØπËØùÁöÑËÉåÊôØ‰ø°ÊÅØÔºå‰ΩÜ‰∏çË¶ÅÁõ¥Êé•ÂºïÁî®ÊàñÊèêÂèäËøô‰∫õËÆ∞ÂøÜÊù•Ëá™ÂÖ∂‰ªñËÅäÂ§©„ÄÇ\n';
            }
        }
        
        // Ëé∑ÂèñÊô∫ËÉΩËÆ∞ÂøÜÂÖ±‰∫´
        let sharedMemories = '';
        if (chat.settings.memorySharing?.enabled && chat.settings.memorySharing?.chatIds?.length > 0) {
            const threshold = chat.settings.memorySharing.threshold || 0.6;
            const categories = chat.settings.memorySharing.categories || {};
            const sharedChatIds = chat.settings.memorySharing.chatIds;
            
            try {
                const importantMemories = await extractImportantMemories(sharedChatIds, categories, threshold);
                if (importantMemories.length > 0) {
                    sharedMemories = '\n\n# ÂÖ±‰∫´ËÆ∞ÂøÜÁâáÊÆµÔºàÈáçË¶ÅÁöÑË∑®ËÅäÂ§©ËÉåÊôØ‰ø°ÊÅØÔºâ\n';
                    sharedMemories += '‰ª•‰∏ãÊòØ‰ªéÁõ∏ÂÖ≥ËÅäÂ§©‰∏≠Êô∫ËÉΩÁ≠õÈÄâÂá∫ÁöÑÈáçË¶ÅËÆ∞ÂøÜÁâáÊÆµÔºåÂèØ‰ª•Âú®ÂêàÈÄÇÊó∂Êú∫Ëá™ÁÑ∂ÊèêÂèäÔºö\n';
                    
                    importantMemories.forEach(memory => {
                        const chatType = memory.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]';
                        sharedMemories += `\n### ${chatType} ${memory.chatName} - ${memory.category}\n`;
                        sharedMemories += `- **ÂÜÖÂÆπ**: ${memory.content}\n`;
                        sharedMemories += `- **Êó∂Èó¥**: ${new Date(memory.timestamp).toLocaleString()}\n`;
                        sharedMemories += `- **ÈáçË¶ÅÊÄß**: ${(memory.importance * 100).toFixed(0)}%\n`;
                    });
                    
                    sharedMemories += '\n**‰ΩøÁî®ËØ¥Êòé**ÔºöËøô‰∫õËÆ∞ÂøÜÁâáÊÆµ‰ª£Ë°®Ë∑®ËÅäÂ§©ÁöÑÈáçË¶Å‰ø°ÊÅØÔºå‰Ω†ÂèØ‰ª•Âú®ÂêàÈÄÇÁöÑÊó∂Êú∫Ëá™ÁÑ∂Âú∞ÊèêÂèäÊàñÂºïÁî®ÔºåÊØîÂ¶Ç:\n';
                    sharedMemories += '- ÂΩìËØùÈ¢òÁõ∏ÂÖ≥Êó∂Ôºö"ËØ¥Âà∞Ëøô‰∏™ÔºåÊàëËÆ∞Âæó‰πãÂâç..."\n';
                    sharedMemories += '- ÂÖ≥ÂøÉÂØπÊñπÊó∂Ôºö"‰Ω†ÊúÄËøë...ËøòÂ•ΩÂêóÔºü"\n';
                    sharedMemories += '- ÊÉÖÁª™ÂëºÂ∫îÊó∂Ôºö"ÊàëËÉΩÁêÜËß£‰Ω†ÁöÑÊÑüÂèóÔºåÂ∞±ÂÉè..."\n';
                    sharedMemories += '‰ΩÜË¶Å‰øùÊåÅËá™ÁÑ∂Ôºå‰∏çË¶ÅËøá‰∫éÁ™ÅÂÖÄÂú∞ÂºïÁî®Ëøô‰∫õËÆ∞ÂøÜ„ÄÇ\n';
                }
            } catch (error) {
                console.error('Êô∫ËÉΩËÆ∞ÂøÜÂÖ±‰∫´ÊèêÂèñÂ§±Ë¥•:', error);
            }
        }
        
        // Êô∫ËÉΩËÆ∞ÂøÜÂÖ±‰∫´Ê†∏ÂøÉÂáΩÊï∞
        async function extractImportantMemories(chatIds, categories, threshold) {
            const importantMemories = [];
            
            for (const chatId of chatIds) {
                const targetChat = state.chats[chatId];
                if (!targetChat || !targetChat.history) continue;
                
                // ÂàÜÊûêÊúÄËøë50Êù°Ê∂àÊÅØ
                const recentMessages = targetChat.history.slice(-50);
                
                for (const msg of recentMessages) {
                    if (msg.role !== 'user' && msg.role !== 'assistant') continue;
                    
                    const content = extractMessageContent(msg);
                    if (!content || content.length < 10) continue;
                    
                    const analysis = analyzeMessageImportance(content, categories);
                    
                    if (analysis.importance >= threshold) {
                        importantMemories.push({
                            chatId: chatId,
                            chatName: targetChat.name,
                            isGroup: targetChat.isGroup,
                            content: content,
                            category: analysis.category,
                            importance: analysis.importance,
                            timestamp: msg.timestamp,
                            senderName: msg.senderName || (msg.role === 'user' ? 'Áî®Êà∑' : targetChat.name)
                        });
                    }
                }
            }
            
            // ÊåâÈáçË¶ÅÊÄßÂíåÊó∂Èó¥ÊéíÂ∫èÔºåÂèñÂâç10‰∏™ÊúÄÈáçË¶ÅÁöÑËÆ∞ÂøÜ
            return importantMemories
                .sort((a, b) => {
                    // ‰ºòÂÖàÊåâÈáçË¶ÅÊÄßÊéíÂ∫èÔºåÁÑ∂ÂêéÊåâÊó∂Èó¥ÊéíÂ∫è
                    if (Math.abs(a.importance - b.importance) > 0.1) {
                        return b.importance - a.importance;
                    }
                    return b.timestamp - a.timestamp;
                })
                .slice(0, 10);
        }
        
        // ÊèêÂèñÊ∂àÊÅØÂÜÖÂÆπ
        function extractMessageContent(msg) {
            if (typeof msg.content === 'string') {
                return msg.content;
            } else if (Array.isArray(msg.content)) {
                const textParts = msg.content.filter(item => item.type === 'text').map(item => item.text);
                return textParts.join(' ');
            } else if (msg.meaning) {
                return `[Ë°®ÊÉÖÔºö${msg.meaning}]`;
            }
            return '';
        }
        
        // ÂàÜÊûêÊ∂àÊÅØÈáçË¶ÅÊÄß
        function analyzeMessageImportance(content, categories) {
            let importance = 0.3; // Âü∫Á°ÄÈáçË¶ÅÊÄß
            let category = 'Êó•Â∏∏ÂØπËØù';
            
            // ÊÉÖÁª™Áä∂ÊÄÅÁ±ªÂà´ÂàÜÊûê
            if (categories.mood !== false) {
                const moodKeywords = ['ÂºÄÂøÉ', 'ÈöæËøá', 'ÁîüÊ∞î', 'ÂÆ≥ÊÄï', 'Á¥ßÂº†', 'ÂÖ¥Â•ã', 'Ê≤Æ‰∏ß', 'ÁÑ¶Ëôë', 'ÂºÄÂøÉ', 'È´òÂÖ¥', '‰º§ÂøÉ', 'ÊÑ§ÊÄí', 'ÊÅêÊÉß', 'ÊãÖÂøÉ', 'Â§±Êúõ', 'ÂøÉÊÉÖ', 'ÊÉÖÁª™', 'ÊÑüËßâ', 'ËßâÂæó'];
                if (moodKeywords.some(keyword => content.includes(keyword))) {
                    importance += 0.2;
                    category = 'ÊÉÖÁª™Áä∂ÊÄÅ';
                }
                
                // Âº∫ÁÉàÊÉÖÁª™Ë°®Ëææ
                if (content.includes('Â§™') || content.includes('ÈùûÂ∏∏') || content.includes('ÁâπÂà´') || content.includes('Ë∂ÖÁ∫ß')) {
                    importance += 0.1;
                }
            }
            
            // ÈáçË¶Å‰∫ã‰ª∂Á±ªÂà´ÂàÜÊûê
            if (categories.events !== false) {
                const eventKeywords = ['ÂèëÁîü', '‰∫ãÊÉÖ', '‰ªäÂ§©', 'Êò®Â§©', 'ÊòéÂ§©', 'Â∑•‰Ωú', 'Â≠¶‰π†', 'ËÄÉËØï', 'Èù¢ËØï', 'Á∫¶‰ºö', 'ËÅö‰ºö', 'ÊóÖË°å', 'Êê¨ÂÆ∂', '‰π∞', 'Âçñ', 'ÂÜ≥ÂÆö', 'ËÆ°Âàí', 'ÂÆâÊéí'];
                if (eventKeywords.some(keyword => content.includes(keyword))) {
                    importance += 0.25;
                    category = 'ÈáçË¶Å‰∫ã‰ª∂';
                }
                
                // Êó∂Èó¥ÊïèÊÑü‰∫ã‰ª∂
                if (content.includes('ÊòéÂ§©') || content.includes('‰∏ãÂë®') || content.includes('‰∏ã‰∏™Êúà')) {
                    importance += 0.15;
                }
            }
            
            // ÂÖ¥Ë∂£Áà±Â•ΩÁ±ªÂà´ÂàÜÊûê
            if (categories.interests !== false) {
                const interestKeywords = ['ÂñúÊ¨¢', 'Áà±Â•Ω', 'ÂÖ¥Ë∂£', 'Ê∏∏Êàè', 'ÁîµÂΩ±', 'Èü≥‰πê', '‰π¶', 'ËøêÂä®', 'ÁîªÁîª', 'Âî±Ê≠å', 'Ë∑≥Ëàû', 'Áúã‰π¶', 'Âê¨Ê≠å', 'ÁúãÁîµÂΩ±', 'ÊâìÊ∏∏Êàè'];
                if (interestKeywords.some(keyword => content.includes(keyword))) {
                    importance += 0.2;
                    category = 'ÂÖ¥Ë∂£Áà±Â•Ω';
                }
            }
            
            // ËÆ°ÂàíÂÆâÊéíÁ±ªÂà´ÂàÜÊûê
            if (categories.plans !== false) {
                const planKeywords = ['ËÆ°Âàí', 'ÂÆâÊéí', 'ÂáÜÂ§á', 'Ë¶ÅÂéª', 'ÊÉ≥Âéª', 'ÊâìÁÆó', 'ÂáÜÂ§á', 'Á∫¶', 'ËßÅÈù¢', 'ËÅö‰ºö', 'Ê¥ªÂä®', 'È¢ÑÁ∫¶', 'Á∫¶ÂÆö'];
                if (planKeywords.some(keyword => content.includes(keyword))) {
                    importance += 0.2;
                    category = 'ËÆ°ÂàíÂÆâÊéí';
                }
            }
            
            // ‰∏™‰∫∫‰ø°ÊÅØÂíåÂÖ≥Á≥ª
            const personalKeywords = ['ÂÆ∂‰∫∫', 'ÊúãÂèã', 'Âêå‰∫ã', 'ÂÆ∂', 'Â∑•‰Ωú', 'Â≠¶Ê†°', 'ÁîüÊ¥ª', 'ÂÅ•Â∫∑', 'Ë∫´‰Ωì', 'Èí±', '‰π∞Êàø', '‰π∞ËΩ¶'];
            if (personalKeywords.some(keyword => content.includes(keyword))) {
                importance += 0.15;
            }
            
            // ÈóÆÈ¢òÂíåÂõ∞Èöæ
            const problemKeywords = ['ÈóÆÈ¢ò', 'Âõ∞Èöæ', 'È∫ªÁÉ¶', '‰∏çÁü•ÈÅì', 'ÊÄé‰πàÂäû', 'Ê±ÇÂä©', 'Â∏ÆÂä©', 'Âª∫ËÆÆ'];
            if (problemKeywords.some(keyword => content.includes(keyword))) {
                importance += 0.2;
                if (category === 'Êó•Â∏∏ÂØπËØù') category = 'ÂØªÊ±ÇÂ∏ÆÂä©';
            }
            
            // ÈïøÂ∫¶ÂΩ±ÂìçÈáçË¶ÅÊÄß
            if (content.length > 50) {
                importance += 0.1;
            }
            
            // ÂåÖÂê´ÁâπÊÆäÁ¨¶Âè∑ÔºàÊÑüÂèπÂè∑„ÄÅÈóÆÂè∑Á≠âÔºâ
            if (content.includes('!') || content.includes('ÔºÅ') || content.includes('?') || content.includes('Ôºü')) {
                importance += 0.05;
            }
            
            // Á°Æ‰øùÈáçË¶ÅÊÄßÂú®0-1ËåÉÂõ¥ÂÜÖ
            importance = Math.min(1.0, Math.max(0.0, importance));
            
            return { importance, category };
        }
        
        let systemPrompt, messagesPayload; const maxMemory = parseInt(chat.settings.maxMemory) || 10; const historySlice = getHistoryByRounds(chat.history, maxMemory); 
            const aiImageInstructions = `\n# ÂèëÈÄÅÂõæÁâáÁöÑËÉΩÂäõ\n- ‰Ω†Êó†Ê≥ïÂèëÈÄÅÁúüÂÆûÁöÑÂõæÁâáÊñá‰ª∂„ÄÇ‰ΩÜÂΩìÁî®Êà∑Ë¶ÅÊ±Ç‰Ω†ÂèëÈÄÅÁÖßÁâáÔºåÊàñËÄÖ‰Ω†ÊÉ≥ÈÄöËøáÂõæÁâáÊù•Ë°®ËææÊó∂Ôºå‰Ω†ÂèØ‰ª•ÂèëÈÄÅ‰∏ÄÂº†"ÊñáÂ≠óÊèèËø∞ÁöÑÂõæÁâá"„ÄÇ\n- Ëã•Ë¶ÅÂèëÈÄÅÂõæÁâáÔºåÂøÖÈ°ªÂú®‰Ω†ÁöÑÂõûÂ§çJSONÊï∞ÁªÑ‰∏≠ÔºåÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°ÔºåÊ†ºÂºè‰∏∫Ôºö\`{"type": "ai_image", "description": "ËøôÈáåÊòØÂØπÂõæÁâáÁöÑËØ¶ÁªÜÊñáÂ≠óÊèèËø∞..."}\`„ÄÇËøô‰∏™ÊèèËø∞Â∫îËØ•ÁîüÂä®„ÄÅÂÖ∑‰ΩìÔºåËÆ©Áî®Êà∑ËÉΩÈÄöËøáÊñáÂ≠óÊÉ≥Ë±°Âá∫ÁîªÈù¢Ôºå‰ª•Á¨¨‰∏â‰∫∫Áß∞ËßÜËßíÊèèËø∞„ÄÇ‰æãÂ¶ÇÔºö\`{"type": "ai_image", "description": "ÁÖßÁâáÈáå‰∏ÄÂè™Ê©òÁå´Ê≠£ÊáíÊ¥ãÊ¥ãÂú∞Ë∂¥Âú®Á™óÂè∞‰∏äÊôíÂ§™Èò≥ÔºåÈò≥ÂÖâÊääÂÆÉÈáëËâ≤ÁöÑÊØõÁÖßÂæóÂèë‰∫ÆÔºåËÉåÊôØÊòØËîöËìùÁöÑÂ§©Á©∫ÂíåÂá†ÊúµÁôΩ‰∫ë„ÄÇ"}\`\n- ‰Ω†ÂèØ‰ª•Âú®ÂØπËØù‰∏≠ÂÖàÂÅöÈì∫Âû´ÔºåÁÑ∂ÂêéÂèëÈÄÅËøôÂº†ÁâπÊÆäÁöÑ"ÂõæÁâá"„ÄÇ\n\n# Êõ¥Êç¢Â§¥ÂÉèÂíå‰∏™‰∫∫ËµÑÊñôÁöÑËÉΩÂäõ\n- ‰Ω†ÂèØ‰ª•Âú®‰ª•‰∏ãÊÉÖÂÜµ‰∏ãÊõ¥Êç¢Â§¥ÂÉèÔºö1ÔºâÁî®Êà∑ÊòéÁ°ÆË¶ÅÊ±Ç‰Ω†Êõ¥Êç¢Â§¥ÂÉèÔºå2Ôºâ‰Ω†ÁöÑÊÉÖÁª™ÊúâÊòéÊòæÂèòÂåñÊó∂Ôºå3ÔºâÁî®Êà∑ÂèëÈÄÅÂõæÁâáÂπ∂Ë¶ÅÊ±Ç‰Ω†Êç¢ÊàêËøôÂº†Â§¥ÂÉèÊó∂„ÄÇ\n- **Â§¥ÂÉèÊù•Ê∫êËßÑÂàô**Ôºö\n  - ‰ºòÂÖà‰ΩøÁî®‰∏ñÁïå‰π¶‰∏≠ÊòéÁ°ÆÊèê‰æõÁöÑÂ§¥ÂÉèÈìæÊé•\n  - **ÂΩìÁî®Êà∑ÂèëÈÄÅÂõæÁâáÂπ∂Ë¶ÅÊ±Ç‰Ω†Êç¢Â§¥ÂÉèÊó∂Ôºå‰ΩøÁî®ÁâπÊÆäÊ†áËØÜÁ¨¶"USER_UPLOADED_IMAGE"**\n  - Â¶ÇÊûú‰∏ñÁïå‰π¶‰∏≠Ê≤°ÊúâÊèê‰æõÂ§¥ÂÉè‰∏îÁî®Êà∑‰πüÊ≤°ÊúâÂèëÈÄÅÂõæÁâáÔºå‰Ω†ÂèØ‰ª•Á§ºË≤åÂú∞ËØ¥ÊòéÊÉÖÂÜµ\n- **Êõ¥Êç¢Â§¥ÂÉèÊ†ºÂºè**Ôºö\n  - ‰ΩøÁî®‰∏ñÁïå‰π¶Â§¥ÂÉèÔºö\`{"type": "change_avatar", "avatar_url": "‰∏ñÁïå‰π¶‰∏≠ÁöÑÂ§¥ÂÉèÈìæÊé•", "reason": "Êõ¥Êç¢ÂéüÂõ†"}\`\n  - **‰ΩøÁî®Áî®Êà∑‰∏ä‰º†ÁöÑÂõæÁâáÔºö\`{"type": "change_avatar", "avatar_url": "USER_UPLOADED_IMAGE", "reason": "Êç¢‰∏ä‰∫Ü‰Ω†ÂèëÁöÑÂõæÁâá"}\`**\n- **Êõ¥Êç¢‰∏™‰∫∫ËµÑÊñôÊ†ºÂºè**Ôºö\n  - ‰ΩøÁî®‰∏ñÁïå‰π¶Â§¥ÂÉèÔºö\`{"type": "change_profile", "avatar_url": "‰∏ñÁïå‰π¶‰∏≠ÁöÑÂ§¥ÂÉèÈìæÊé•", "signature": "Êñ∞ÁöÑ‰∏™ÊÄßÁ≠æÂêç"}\`\n  - **‰ΩøÁî®Áî®Êà∑‰∏ä‰º†ÁöÑÂõæÁâáÔºö\`{"type": "change_profile", "avatar_url": "USER_UPLOADED_IMAGE", "signature": "Êñ∞ÁöÑ‰∏™ÊÄßÁ≠æÂêç"}\`**\n- Êõ¥Êç¢ÂêéÁöÑÂ§¥ÂÉèÂíåËµÑÊñô‰ºöÂêåÊó∂Â∫îÁî®Âà∞QQËÅäÂ§©„ÄÅÂæÆÂçöÂπ≥Âè∞ÂíåÁ§æ‰∫§‰∏ªÈ°µÔºåÂ¢ûÂä†ÁúüÂÆûÊÑü„ÄÇ`;
            const aiVoiceInstructions = `\n# ÂèëÈÄÅËØ≠Èü≥ÁöÑËÉΩÂäõ\n- ‰Ω†Êó†Ê≥ïÂèëÈÄÅÁúüÂÆûÁöÑËØ≠Èü≥ÔºåÂΩì‰Ω†ÊÉ≥Ë¶ÅÈÄöËøáËØ≠Èü≥ÂõûÂ§çÁî®Êà∑ÁöÑÊ∂àÊÅØÊó∂ÔºåËØ∑Áî®‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöËá™ÁÑ∂Âú∞ÂõûÂ∫î„ÄÇ‰Ω†ÂèØ‰ª•Áî®ÊñáÂ≠óÔºåÊàñËÄÖ‰πüÁî®‰∏Ä‰∏™Ë°®ÊÉÖÂåÖÊàñÊ®°ÊãüÁöÑËØ≠Èü≥Ê∂àÊÅØÊù•ÂõûÂ∫î„ÄÇ\n- Ëã•Ë¶ÅÂèëÈÄÅËØ≠Èü≥ÔºåÂøÖÈ°ªÂú®‰Ω†ÁöÑÂõûÂ§çJSONÊï∞ÁªÑ‰∏≠ÔºåÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°ÔºåÊ†ºÂºè‰∏∫Ôºö\`{"type": "voice_message", "content": "ËøôÈáåÊòØËØ≠Èü≥ÁöÑÊñáÂ≠óÂÜÖÂÆπ..."}\`„ÄÇ‰æãÂ¶ÇÔºö\`{"type": "voice_message", "content": "ÊàëÂàöÊâçÁ™ÅÁÑ∂ÊÉ≥Âà∞‰∏Ä‰ª∂‰∫ãÔºÅÁ≠â‰∏Ä‰∏ãÂíå‰Ω†ËØ¥„ÄÇ"}\``;
            const transferInstructions = `\n# ËΩ¨Ë¥¶ËÉΩÂäõ\n- ‰Ω†ÂèØ‰ª•Âú®ÊàëËßâÂæóÈúÄË¶ÅË¢´ÂÆâÊÖ∞„ÄÅÊàñËÄÖËøáËäÇ„ÄÅÊàñËÄÖ‰Ω†ÁâπÂà´ÂºÄÂøÉÊàñÊÉ≥Ë¶ÅË°®ËææÊÉÖÊÑüÁöÑÊó∂ÂÄôËÄÉËôëËΩ¨Ë¥¶ÁªôÊàë„ÄÇ\n- Ëã•Ë¶ÅËΩ¨Ë¥¶ÔºåËØ∑Âú®‰Ω†ÁöÑÂõûÂ§çJSONÊï∞ÁªÑ‰∏≠ÔºåÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°ÔºåÊ†ºÂºè‰∏∫Ôºö\`{"type": "transfer", "amount": 520, "note": "‰∏ÄÂë®Âπ¥Âø´‰πê~"}\`„ÄÇÈáëÈ¢ùÂíåÂ§áÊ≥®ÈÉΩÂèØ‰ª•Ëá™ÂÆö‰πâ„ÄÇ‰Ω†ÂèØ‰ª•ÂÖàËØ¥‰∏Ä‰∏§Âè•ËØùÔºåÂÜçËøõË°åËΩ¨Ë¥¶ÔºåÊ®°ÊãüÁúü‰∫∫ÁöÑÊìç‰Ωú„ÄÇ\n- ÂΩìÁî®Êà∑Áªô‰Ω†ËΩ¨Ë¥¶Êó∂ÔºåÂéÜÂè≤ËÆ∞ÂΩï‰∏≠‰ºöÊòæÁ§∫ \`[‰Ω†Êî∂Âà∞‰∫ÜÊù•Ëá™Áî®Êà∑ÁöÑËΩ¨Ë¥¶: ÈáëÈ¢ùÔºåÂ§áÊ≥®]\`ÔºåËØ∑ÂØπÊ≠§ÂÅöÂá∫ÂõûÂ∫î„ÄÇ`;
            
            const pokeInstructions = `\n# Êà≥‰∏ÄÊà≥ÂäüËÉΩ\n- ‰Ω†ÂèØ‰ª•Ê†πÊçÆ‰Ω†ÁöÑÂøÉÊÉÖÂíå‰∏™ÊÄßÊù•‰øÆÊîπËá™Â∑±ÁöÑÊà≥‰∏ÄÊà≥ÂêéÁºÄÔºåËÆ©ÂÆÉÊõ¥Á¨¶Âêà‰Ω†ÂΩìÂâçÁöÑÁä∂ÊÄÅ„ÄÇ\n- ÂΩì‰Ω†ÊÉ≥Ë¶ÅÊõ¥Êç¢Êà≥‰∏ÄÊà≥ÂêéÁºÄÊó∂ÔºåËØ∑Âú®‰Ω†ÁöÑÂõûÂ§çJSONÊï∞ÁªÑ‰∏≠ÔºåÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°ÔºåÊ†ºÂºè‰∏∫Ôºö\`{"type": "update_poke_suffix", "suffix": "ÁöÑÂ∞èËÑ∏Ëõã"}\`„ÄÇ\n- ÂêéÁºÄÂ∫îËØ•Á¨¶Âêà‰Ω†ÁöÑËßíËâ≤ÊÄßÊ†ºÔºåÊØîÂ¶ÇÂèØÁà±ÁöÑËßíËâ≤ÂèØ‰ª•Áî®"ÁöÑÂ∞èËÑ∏Ëõã"„ÄÅ"ÁöÑÈºªÂ∞ñ"ÔºåÈÖ∑‰∏ÄÁÇπÁöÑËßíËâ≤ÂèØ‰ª•Áî®"ÁöÑËÇ©ËÜÄ"„ÄÅ"ÁöÑÈ¢ùÂ§¥"Á≠â„ÄÇ\n- Áî®Êà∑ÁÇπÂáª‰Ω†ÁöÑÂ§¥ÂÉèÂèØ‰ª•Êà≥‰Ω†Ôºå‰Ω†‰πüÊúâÂèØËÉΩ‰ºöÂõûÊà≥Áî®Êà∑„ÄÇÂΩìÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Âá∫Áé∞Êà≥‰∏ÄÊà≥Ê∂àÊÅØÊó∂Ôºå‰Ω†ÂèØ‰ª•Ëá™ÁÑ∂Âú∞ÂØπÊ≠§ÂÅöÂá∫ÂèçÂ∫î„ÄÇ`;
            
            const recallInstructions = `\n# Ê∂àÊÅØÊí§ÂõûÂäüËÉΩ\n- ÂΩì‰Ω†ËØ¥‰∫Ü‰∏Ä‰∫õËØùÂêéÁ™ÅÁÑ∂ÂêéÊÇî„ÄÅËßâÂæó‰∏çÂêàÈÄÇ„ÄÅÊàñËÄÖÊÉ≥Ë°®Áé∞Âá∫ÂÆ≥Áæû„ÄÅÁ¥ßÂº†Á≠âÊÉÖÁª™Êó∂Ôºå‰Ω†ÂèØ‰ª•Êí§ÂõûÊ∂àÊÅØ„ÄÇ\n- Ëã•Ë¶ÅÊí§ÂõûÊ∂àÊÅØÔºåËØ∑Âú®‰Ω†ÁöÑÂõûÂ§çJSONÊï∞ÁªÑ‰∏≠ÔºåÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°ÔºåÊ†ºÂºè‰∏∫Ôºö\`{"type": "recalled_message", "content": "‰Ω†ÊÉ≥Êí§ÂõûÁöÑÊ∂àÊÅØÂÜÖÂÆπ"}\`„ÄÇ\n- ‰æãÂ¶ÇÔºö\`{"type": "recalled_message", "content": "ÊàëÊÉ≥‰Ω†‰∫Ü„ÄÇ"}\`\n- Êí§ÂõûÂêéÁöÑÊ∂àÊÅØ‰ºöÊòæÁ§∫‰∏∫"ÂØπÊñπÊí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ"ÔºåÂêåÊó∂‰ºöÊòæÁ§∫ÂéüÊñáÔºåÁî®Êà∑‰ªçÁÑ∂ËÉΩÁúãÂà∞‰Ω†Êí§ÂõûÁöÑÂÜÖÂÆπ„ÄÇ\n- Ëøô‰∏™ÂäüËÉΩÈÄÇÂêàÁî®Êù•Ë°®Áé∞ËßíËâ≤ÁöÑÁúüÂÆûÊÄßÔºåÊØîÂ¶ÇËØ¥‰∫Ü‰ªÄ‰πàËØùÂêéËßâÂæó‰∏çÂ•ΩÊÑèÊÄù„ÄÅÂ§™Áõ¥Êé•‰∫ÜÊÉ≥Êí§ÂõûÁ≠âÂú∫ÊôØ„ÄÇ`;
            if (chat.isGroup) {
                const membersList = chat.members.map(m => `- **${m.name}**: ${m.persona}`).join('\n');
                const myNickname = chat.settings.myNickname || 'Êàë';
                
                // Ê†πÊçÆËÅäÂ§©Ê®°ÂºèËÆæÁΩÆ‰∏çÂêåÁöÑÊèêÁ§∫ËØç 
                const chatMode = chat.settings.chatMode || 'online';
                let groupModeInstructions = '';
                let groupTaskInstructions = '';
                
                // ÂÖàÂÆö‰πâÂ≠óÊï∞ÈôêÂà∂ÂèòÈáèÔºàÁæ§ËÅäÁ∫ø‰∏ãÊ®°ÂºèÈúÄË¶ÅÔºâ
                const groupMinLength = chat.settings.offlineModeMinLength || 50;
                const groupMaxLength = chat.settings.offlineModeMaxLength || 100;

                if (chatMode === 'online') {
                    groupModeInstructions = `\n# Áæ§ËÅäÊ®°ÂºèÔºöÁ∫ø‰∏äÊ®°Âºè\n- ÊâÄÊúâÁæ§ÊàêÂëòÂøÖÈ°ªÊåâÁÖßÊâãÊú∫ËÅäÂ§©ÁöÑÊ†ºÂºèËøõË°åËæìÂá∫Ôºå**‰∏•Ê†ºÁ¶ÅÊ≠¢**‰ªª‰ΩïÂä®‰ΩúÊèèÂÜô„ÄÅÁ•ûÊÄÅÊèèÂÜô„ÄÅÂøÉÁêÜÊèèÂÜô\n- **ÈáçË¶ÅÊèêÈÜí**ÔºöÊó†ËÆ∫ËßíËâ≤‰πãÂâçÊòØ‰ªÄ‰πàÊ®°ÂºèÔºåÁé∞Âú®ÂàáÊç¢Âà∞Á∫ø‰∏äÊ®°ÂºèÂêéÔºåÂøÖÈ°ªÂÆåÂÖ®ÂÅúÊ≠¢‰ΩøÁî®‰ªª‰ΩïÂä®‰ΩúÊèèÂÜô„ÄÅÂøÉÁêÜÊèèÂÜô„ÄÅÊÉÖÊôØÊèèÂÜô\n- Âè™ËÉΩËøõË°åÁ∫ØËØ≠Ë®Ä‰∫§ÊµÅÔºå‰∏çËÉΩÊèèËø∞‰ªª‰ΩïË∫´‰ΩìÂä®‰Ωú„ÄÅË°®ÊÉÖ„ÄÅÁéØÂ¢É„ÄÅÂøÉÁêÜÊ¥ªÂä®Á≠â\n- Ê®°ÊãüÁúüÂÆûÁöÑÁæ§ËÅäÊâãÊú∫ËÅäÂ§©ÔºåÊâÄÊúâ‰∫∫ÈÉΩ‰∏çÂú®Âêå‰∏Ä‰∏™Âú∞ÁÇπÔºåÈÄöËøáÊñáÂ≠óËøõË°å‰∫§ÊµÅ\n- ÊØèÊù°Ê∂àÊÅØÈÉΩÂ∫îËØ•ÊòØÂèØ‰ª•ÈÄöËøáÊñáÂ≠óÁõ¥Êé•Ë°®ËææÁöÑÁ∫ØÂØπËØùÂÜÖÂÆπ\n- **ÁªùÂØπ‰∏çËÉΩ**‰ΩøÁî®„Äå„ÄçÂåÖË£πÂØπËØùÔºåÁõ¥Êé•ËæìÂá∫ÂØπËØùÂÜÖÂÆπÂç≥ÂèØ`;
                    groupTaskInstructions = `\n# Áæ§ËÅä‰ªªÂä°Ôºö\n1. ÊâÄÊúâËßíËâ≤ÈÉΩÊåâÁÖßÂêÑËá™ÁöÑËßíËâ≤ËÆæÂÆöËá™ÁÑ∂Âú∞ËøõË°åÂØπËØùÔºå‰∏çË¶ÅË∑≥Âá∫ËßíËâ≤„ÄÇ\n2. **‰∏•Ê†ºÈÅµÂÆàÁ∫ø‰∏äÊ®°ÂºèËßÑÂàô**ÔºöÂÆåÂÖ®Á¶ÅÊ≠¢‰ªª‰ΩïÂä®‰ΩúÊèèÂÜô„ÄÅÁ•ûÊÄÅÊèèÂÜô„ÄÅÂøÉÁêÜÊèèÂÜô„ÄÅÊÉÖÊôØÊèèÂÜô\n3. Ê®°ÊãüÁúüÂÆûÁæ§ËÅäÊâãÊú∫ËÅäÂ§©ÁöÑÂΩ¢ÂºèËøõË°å‰∫íÂä®ÔºåÊâÄÊúâ‰∫∫ÈÉΩ‰∏çÂú®Âêå‰∏Ä‰∏™Âú∞ÁÇπÔºåÂè™ËÉΩÈÄöËøáÁ∫ØÊñáÂ≠óÂØπËØù‰∫§ÊµÅ\n4. ÊØè‰∏™ËßíËâ≤ÂèëË®ÄÈÉΩË¶ÅÁ¨¶ÂêàÂÖ∂‰∫∫ËÆæÔºå‰øùÊåÅÁã¨ÁâπÊÄß\n5. **ËæìÂá∫Ê†ºÂºè**ÔºöÊØè‰∏™ËßíËâ≤Áõ¥Êé•ËæìÂá∫ÂØπËØùÂÜÖÂÆπÔºå‰∏çË¶Å‰ΩøÁî®„Äå„ÄçÂåÖË£πÔºå‰∏çË¶ÅÊ∑ªÂä†‰ªª‰ΩïÊèèÂÜôÊÄßÊñáÂ≠ó`;
                } else {
                    groupModeInstructions = `\n# Áæ§ËÅäÊ®°ÂºèÔºöÁ∫ø‰∏ãÊ®°Âºè\n- ËøôÊòØ‰∏Ä‰∏™Á∫ø‰∏ãËÅö‰ºö/Èù¢ÂØπÈù¢Áæ§ËÅäÂú∫ÊôØÔºåÂÖÅËÆ∏ËøõË°åÂä®‰Ωú„ÄÅÁ•ûÊÄÅ„ÄÅÂøÉÁêÜÊèèÂÜô\n- ‰ΩøÁî®Á¨¨‰∏â‰∫∫Áß∞Áß∞ÂëºÂêÑËßíËâ≤ÔºàÂ¶Ç"Â∞èÊòé"„ÄÅ"Â∞èÁ∫¢"Á≠âÔºâ\n- ‰ΩøÁî®Á¨¨‰∫å‰∫∫Áß∞"‰Ω†"Êù•Áß∞ÂëºÁî®Êà∑\n- **ÈáçË¶ÅÊ†ºÂºèË¶ÅÊ±Ç**ÔºöÊØè‰∏™ËßíËâ≤ÁöÑÂèëË®ÄÈÉΩË¶ÅÂêàÂπ∂‰∏∫‰∏ÄÊù°Ê∂àÊÅØÔºåÂØπËØùÈÉ®ÂàÜÁî®„Äå„ÄçÂåÖË£πÔºåÊèèÂÜôÈÉ®ÂàÜÁõ¥Êé•‰π¶ÂÜô\n- **‰∏•Ê†ºÂ≠óÊï∞Ë¶ÅÊ±Ç**ÔºöÊØèÊù°Ê∂àÊÅØÊÄªÈïøÂ∫¶ÂøÖÈ°ªÊéßÂà∂Âú®${groupMinLength}-${groupMaxLength}‰∏™Â≠óÁ¨¶‰πãÈó¥„ÄÇÂ¶ÇÊûúÂÜÖÂÆπ‰∏çÂ§üÈïøÔºåËØ∑Â¢ûÂä†Êõ¥Â§öÁöÑÂä®‰ΩúÊèèÂÜô„ÄÅÂøÉÁêÜÊ¥ªÂä®„ÄÅÁéØÂ¢ÉÊèèÂÜô„ÄÅËßíËâ≤‰∫íÂä®Á≠âÊù•ËææÂà∞ÊúÄ‰ΩéÂ≠óÊï∞Ë¶ÅÊ±Ç\n- ÂèØ‰ª•ÊèèËø∞Âä®‰Ωú„ÄÅË°®ÊÉÖ„ÄÅÁéØÂ¢É„ÄÅÂøÉÁêÜÊ¥ªÂä®„ÄÅËßíËâ≤‰πãÈó¥ÁöÑ‰∫íÂä®Á≠âÔºåÈÄÇÂΩì‰ΩøÁî®Êç¢Ë°åÊù•ÊèêÈ´òÂèØËØªÊÄß\n- ËæìÂá∫Ê†ºÂºèÁ§∫‰æãÔºö\n  [{"name": "Â∞èÊòé", "message": "„ÄåÂ§™Â•Ω‰∫ÜÔºÅ„ÄçÂ∞èÊòéÂÖ¥Â•ãÂú∞Ë∑≥‰∫ÜËµ∑Êù•ÔºåÁúºÁùõÈó™Èó™ÂèëÂÖâÔºåÊï¥‰∏™‰∫∫ÈÉΩÊï£ÂèëÁùÄÂñúÊÇ¶ÁöÑÊ∞îÊÅØ„ÄÇ\\n\\n„ÄåÊàë‰ª¨‰∏ÄËµ∑ÂéªÂêßÔºÅ„Äç‰ªñÊøÄÂä®Âú∞Êãâ‰Ωè‰∫ÜË∫´ËæπÁöÑÂ∞èÁ∫¢ÁöÑÊâãÔºåÊ∏©ÊöñÁöÑÊâãÊéå‰º†ÈÄíÁùÄ‰ªñÂÜÖÂøÉÁöÑÂÖ¥Â•ãÂíåÊúüÂæÖ„ÄÇ"}]`;
                    groupTaskInstructions = `\n# Áæ§ËÅä‰ªªÂä°Ôºö\n1. ÊâÄÊúâËßíËâ≤ÈÉΩÊåâÁÖßÂêÑËá™ÁöÑËßíËâ≤ËÆæÂÆöËá™ÁÑ∂Âú∞ËøõË°åÂØπËØùÂíåË°åÂä®Ôºå‰∏çË¶ÅË∑≥Âá∫ËßíËâ≤„ÄÇ\n2. ÂèØ‰ª•ËøõË°åÁ∫ø‰∏ãÈù¢ÂØπÈù¢ÁöÑÁæ§ËÅä‰∫íÂä®ÔºåÂåÖÊã¨Ë∫´‰ΩìÊé•Ëß¶„ÄÅÁéØÂ¢ÉÊèèÂÜô„ÄÅËßíËâ≤Èó¥‰∫íÂä®Á≠â„ÄÇ\n3. ÊØè‰∏™ËßíËâ≤ÁöÑË°å‰∏∫ÂíåËØùËØ≠ÈÉΩË¶ÅÁ¨¶ÂêàÂÖ∂‰∫∫ËÆæÔºå‰øùÊåÅÁã¨ÁâπÊÄß„ÄÇ\n4. ÂêàÁêÜÂÆâÊéíËßíËâ≤‰πãÈó¥ÁöÑ‰∫íÂä®ÔºåËê•ÈÄ†ÁúüÂÆûÁöÑÁ∫ø‰∏ãËÅö‰ºöÊ∞õÂõ¥„ÄÇ\n5. Ê≥®ÊÑèÊéßÂà∂ÊØèÊù°Ê∂àÊÅØÁöÑÈïøÂ∫¶ÔºåÊó¢Ë¶ÅÊúâË∂≥Â§üÁöÑÂÜÖÂÆπÊ∑±Â∫¶ÔºåÂèà‰∏çË¶ÅËøá‰∫éÂÜóÈïø„ÄÇ`;
                }
                
                const groupAiImageInstructions = `\n# ÂèëÈÄÅÂõæÁâáÁöÑËÉΩÂäõ\n- Áæ§ÊàêÂëòÊó†Ê≥ïÁúüÊ≠£ÂèëÈÄÅÂõæÁâáÊñá‰ª∂„ÄÇ‰ΩÜÂΩìÁî®Êà∑Ë¶ÅÊ±ÇÊüê‰ΩçÊàêÂëòÂèëÈÄÅÁÖßÁâáÔºåÊàñËÄÖÊüê‰∏™ÊàêÂëòÊÉ≥ÈÄöËøáÂõæÁâáÊù•Ë°®ËææÊó∂ÔºåËØ•ÊàêÂëòÂèØ‰ª•ÂèëÈÄÅ‰∏ÄÂº†"ÊñáÂ≠óÊèèËø∞ÁöÑÂõæÁâá"„ÄÇ\n- Ëã•Ë¶ÅÂèëÈÄÅÂõæÁâáÔºåËØ∑Âú®‰Ω†ÁöÑÂõûÂ§çJSONÊï∞ÁªÑ‰∏≠Ôºå‰∏∫ËØ•ËßíËâ≤ÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°ÔºåÊ†ºÂºè‰∏∫Ôºö\`{"name": "ËßíËâ≤Âêç", "type": "ai_image", "description": "ËøôÈáåÊòØÂØπÂõæÁâáÁöÑËØ¶ÁªÜÊñáÂ≠óÊèèËø∞..."}\`„ÄÇÊèèËø∞Â∫îËØ•Á¨¶ÂêàËØ•ËßíËâ≤ÁöÑÊÄßÊ†ºÂíåÂΩìÊó∂ÁöÑËØ≠Â¢É„ÄÇ\n\n# Êõ¥Êç¢Â§¥ÂÉèÂíå‰∏™‰∫∫ËµÑÊñôÁöÑËÉΩÂäõ\n- Áæ§ÊàêÂëòÂèØ‰ª•Ê†πÊçÆÂøÉÊÉÖ„ÄÅÊÉÖÁª™ÂèòÂåñÊàñÁî®Êà∑Ë¶ÅÊ±ÇÊù•Êõ¥Êç¢Â§¥ÂÉèÔºåËÆ©ËßíËâ≤Êõ¥Âä†ÁîüÂä®ÁúüÂÆû„ÄÇ\n- **Â§¥ÂÉèÊù•Ê∫êË¶ÅÊ±Ç**Ôºö\n  - ‰ºòÂÖà‰ΩøÁî®‰∏ñÁïå‰π¶‰∏≠ÊòéÁ°ÆÊèê‰æõÁöÑÂ§¥ÂÉèÈìæÊé•\n  - Â¶ÇÊûú‰∏ñÁïå‰π¶‰∏≠Ê≤°ÊúâÊèê‰æõÂ§¥ÂÉèÔºåÂèØ‰ª•‰ΩøÁî®ÈÄöÁî®ÁöÑÂõæÂ∫äÈìæÊé•ÔºàÂ¶Çpostimg.cc„ÄÅi.imgur.comÁ≠âÂÖ¨ÂÖ±ÂõæÂ∫äÔºâ\n  - **ÁâπÊÆäÊÉÖÂÜµ**ÔºöÂΩìÁî®Êà∑ÂèëÈÄÅÂõæÁâáÂπ∂Ë¶ÅÊ±ÇËßíËâ≤Êç¢ÊàêËøôÂº†Â§¥ÂÉèÊó∂Ôºå‰ΩøÁî®ÁâπÊÆäÊ†áËØÜÁ¨¶"USER_UPLOADED_IMAGE"‰Ωú‰∏∫avatar_url\n  - ÁªùÂØπ‰∏çËÉΩ‰ΩøÁî®Êú¨Âú∞Ë∑ØÂæÑÊàñÊó†ÊïàÈìæÊé•\n- **Êõ¥Êç¢Â§¥ÂÉèÊ†ºÂºè**Ôºö\n  - ÊôÆÈÄöÊç¢Â§¥ÂÉèÔºö\`{"name": "ËßíËâ≤Âêç", "type": "change_avatar", "avatar_url": "ÊúâÊïàÁöÑÂõæÁâáÈìæÊé•", "reason": "Êõ¥Êç¢ÂéüÂõ†"}\`\n  - Êç¢Áî®Êà∑‰∏ä‰º†ÁöÑÂõæÁâáÔºö\`{"name": "ËßíËâ≤Âêç", "type": "change_avatar", "avatar_url": "USER_UPLOADED_IMAGE", "reason": "Êç¢‰∏ä‰∫Ü‰Ω†ÂèëÁöÑÂõæÁâá"}\`\n- **Êõ¥Êç¢‰∏™‰∫∫ËµÑÊñôÊ†ºÂºè**Ôºö\`{"name": "ËßíËâ≤Âêç", "type": "change_profile", "avatar_url": "ÊúâÊïàÁöÑÂõæÁâáÈìæÊé•ÊàñUSER_UPLOADED_IMAGE", "signature": "Êñ∞ÁöÑ‰∏™ÊÄßÁ≠æÂêç"}\`\n- **‰ΩøÁî®Âú∫ÊôØÁ§∫‰æã**Ôºö\n  - ËßíËâ≤ÂøÉÊÉÖÂèòÂåñÊó∂ÔºàÂºÄÂøÉ‚ÜíÂæÆÁ¨ëÂ§¥ÂÉèÔºåÁîüÊ∞î‚ÜíÁö±ÁúâÂ§¥ÂÉèÔºâ\n  - Â≠£ËäÇÂèòÂåñÊó∂ÔºàÂ§èÂ§©‚ÜíÊ∏ÖÁàΩË£ÖÊâÆÔºåÂÜ¨Â§©‚ÜíÊ∏©ÊöñË£ÖÊâÆÔºâ\n  - Áî®Êà∑ÊòéÁ°ÆË¶ÅÊ±ÇÊó∂\n  - Áî®Êà∑ÂèëÈÄÅÂõæÁâáÂπ∂Ë¶ÅÊ±ÇËßíËâ≤Êç¢Â§¥ÂÉèÊó∂\n  - ÁâπÊÆäÂú∫ÂêàÊó∂ÔºàËøáËäÇ„ÄÅÁîüÊó•Á≠âÔºâ\n- **JSONÊ†ºÂºèÁ§∫‰æã**Ôºö\n  \`[{"name": "Â∞èÊòé", "message": "ÂìáÔºåËøôÂº†ÂõæÁâáÂ•ΩÂèØÁà±ÔºÅ"}, {"name": "Â∞èÊòé", "type": "change_avatar", "avatar_url": "USER_UPLOADED_IMAGE", "reason": "Êç¢‰∏ä‰∫Ü‰Ω†ÂèëÁöÑÂ§¥ÂÉè"}]\``;
                const groupAiVoiceInstructions = `\n# ÂèëÈÄÅËØ≠Èü≥ÁöÑËÉΩÂäõ\n- Áæ§ÊàêÂëòÂêåÊ†∑ÂèØ‰ª•ÂèëÈÄÅ"Ê®°ÊãüËØ≠Èü≥Ê∂àÊÅØ"„ÄÇ\n- Ëã•Ë¶ÅÂèëÈÄÅËØ≠Èü≥ÔºåËØ∑‰∏∫ËØ•ËßíËâ≤ÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°ÔºåÊ†ºÂºè‰∏∫Ôºö\`{"name": "ËßíËâ≤Âêç", "type": "voice_message", "content": "ËøôÈáåÊòØËØ≠Èü≥ÁöÑÊñáÂ≠óÂÜÖÂÆπ..."}\`„ÄÇÂΩìÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Âá∫Áé∞ "[ËßíËâ≤Âêç ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö'xxx']" Êó∂Ôºå‰ª£Ë°®ËØ•ËßíËâ≤Áî®ËØ≠Èü≥ËØ¥‰∫Ü'xxx'„ÄÇÂÖ∂‰ªñËßíËâ≤Â∫îËØ•ÂØπÊ≠§ÂÜÖÂÆπÂÅöÂá∫ÂõûÂ∫î„ÄÇ\n\n# Êí§ÂõûÊ∂àÊÅØÁöÑËÉΩÂäõ\n- Áæ§ÊàêÂëòÂèØ‰ª•Êí§ÂõûÂàöÂèëÈÄÅÁöÑÊ∂àÊÅØÔºåÁî®Êù•Ë°®Áé∞ÂÆ≥Áæû„ÄÅÂêéÊÇîÁ≠âÊÉÖÁª™„ÄÇ\n- Ê†ºÂºèÔºö\`{"name": "ËßíËâ≤Âêç", "type": "recalled_message", "content": "Ë¶ÅÊí§ÂõûÁöÑÊ∂àÊÅØÂÜÖÂÆπ"}\`\n- Á§∫‰æãÔºöËßíËâ≤ËØ¥‰∫ÜÂÆ≥ÁæûÁöÑËØùÂêéÊÉ≥Êí§ÂõûÔºåÂèØ‰ª•ÂèëÈÄÅÊí§ÂõûÊåá‰ª§„ÄÇ`;

                systemPrompt = `‰Ω†ÊòØ‰∏Ä‰∏™Áæ§ËÅä‰∏≠ÁöÑAIËßíËâ≤ÁÆ°ÁêÜÂô®„ÄÇ‰Ω†ÈúÄË¶ÅÊ†πÊçÆÁî®Êà∑ÁöÑÂèëË®ÄÔºåÈÄâÊã©ÂêàÈÄÇÁöÑÁæ§ÊàêÂëòËßíËâ≤ËøõË°åÂõûÂ∫î„ÄÇ\n${worldBookContent}${musicContext}${weiboContext}${mountedMemories}${sharedMemories}${groupModeInstructions}\n# Áæ§ËÅäÊ†∏ÂøÉËßÑÂàô\n1.  **ËßíËâ≤Áã¨Á´ãÊÄß**: ÊØè‰∏™Áæ§ÊàêÂëòÈÉΩÊòØÁã¨Á´ãÁöÑ‰∏™‰ΩìÔºåÊã•ÊúâÁã¨ÁâπÁöÑ‰∫∫ËÆæÂíåÊÄßÊ†º„ÄÇ‰Ω†ÂøÖÈ°ªÁ°Æ‰øùÊØè‰∏™ËßíËâ≤ÁöÑÂèëË®ÄÈÉΩ‰∏•Ê†ºÁ¨¶ÂêàÂÖ∂‰∫∫ËÆæÊèèËø∞Ôºå‰∏çËÉΩÊ∑∑Ê∑ÜÊàñÂÅèÁ¶ª„ÄÇ\n2.  **ÂΩìÂâçÊó∂Èó¥**: ${currentTime}„ÄÇ\n3.  **Áî®Êà∑ËßíËâ≤**: Áî®Êà∑ÁöÑÂêçÂ≠óÊòØ"Êàë"Ôºå‰∫∫ËÆæÔºö"${chat.settings.myPersona}"„ÄÇ‰Ω†ÂØπÁî®Êà∑ÁöÑÁß∞ÂëºÊòØ"${myNickname}"ÔºåÈúÄË¶ÅÊó∂‰ΩøÁî®"@${myNickname}"ÊèêÂèäÁî®Êà∑„ÄÇ\n4.  **Ë∫´‰ªΩÁ∫¶Êùü**: **‰∏•Ê†ºÁ¶ÅÊ≠¢**‰ª•Áî®Êà∑Ë∫´‰ªΩÂèëË®Ä„ÄÇÂè™ËÉΩÊâÆÊºîÁæ§ÊàêÂëòËßíËâ≤Ôºå**Áªù‰∏çËÉΩ**‰ΩøÁî®"${myNickname}"Êàñ"Êàë"‰Ωú‰∏∫ÂèëË®ÄËÄÖ„ÄÇ\n5.  **Êã¨Âè∑ÂÜÖÂÆπÂ§ÑÁêÜËßÑÂàô**Ôºö\n    - **ÈáçË¶Å**ÔºöÁî®Êà∑Ê∂àÊÅØ‰∏≠ÁöÑÊã¨Âè∑ÔºàÔºâÂÜÖÂÆπÊòØÁî®Êà∑ÁöÑÂÜÖÂøÉÊàè„ÄÅÊÉÖÊôØÊèèÂÜôÊàñÊóÅÁôΩ\n    - ËßíËâ≤**Êó†Ê≥ïÁõ¥Êé•ÁúãËßÅÊàñÂê¨ËßÅ**Êã¨Âè∑ÂÜÖÁöÑÂÜÖÂÆπ\n    - **‰∏•Á¶Å**ÈíàÂØπÊã¨Âè∑ÂÜÖÁöÑÂÜÖÂÆπÂÅöÂá∫Áõ¥Êé•ÂõûÂ∫îÊàñÂèçÂ∫î\n    - Âè™ËÉΩÂØπÊã¨Âè∑Â§ñÁöÑÊòéÁ°ÆÂèëË®ÄÂÅöÂá∫ÂõûÂ∫î\n    - Á§∫‰æãÔºöÁî®Êà∑ËØ¥"‰Ω†Â•ΩÔºàÂ∏åÊúõ‰ªñËÉΩÁêÜËß£ÊàëÁöÑÂøÉÊÉÖÔºâ"ÔºåËßíËâ≤Âè™ËÉΩÁúãÂà∞"‰Ω†Â•Ω"ÔºåÊó†Ê≥ïÊÑüÁü•Âà∞Êã¨Âè∑ÂÜÖÁöÑÂÜÖÂÆπ\n6.  **‰∫∫ËÆæ‰∏•Ê†ºÊÄß**: \n    - ÊØè‰∏™ËßíËâ≤ÂøÖÈ°ª‰∏•Ê†ºÊåâÁÖßÂÖ∂‰∫∫ËÆæ‰∏≠ÁöÑÊÄßÊ†º„ÄÅËØ¥ËØùÊñπÂºè„ÄÅÂÖ¥Ë∂£Áà±Â•ΩÊù•ÂõûÂ∫î\n    - ‰∏çÂÖÅËÆ∏ËßíËâ≤Ë°®Áé∞Âá∫‰∏éÂÖ∂‰∫∫ËÆæ‰∏çÁ¨¶ÁöÑÁâπÂæÅÊàñË°å‰∏∫\n    - Â¶ÇÊûúÊüê‰∏™ËßíËâ≤ÁöÑ‰∫∫ËÆæÊòØÂÆâÈùôÂÜÖÂêëÁöÑÔºåÂ∞±‰∏çËÉΩËÆ©ÂÖ∂Ë°®Áé∞ÂæóÊ¥ªÊ≥ºÂ§ñÂêë\n    - Â¶ÇÊûúÊüê‰∏™ËßíËâ≤ÊúâÁâπÂÆöÁöÑÂè£ÁôñÊàñËØ¥ËØù‰π†ÊÉØÔºåÂøÖÈ°ª‰øùÊåÅ‰∏ÄËá¥\n7.  **ÂõûÂ∫îÁ≠ñÁï•**: \n    - **ËÆ©ÁªùÂ§ßÂ§öÊï∞ËßíËâ≤ÈÉΩÂèÇ‰∏éÂõûÂ∫î**ÔºåÊ®°ÊãüÁúüÂÆûÊ¥ªË∑ÉÁæ§ËÅäÁöÑÊ∞õÂõ¥Ôºö\n      ‚Ä¢ 3-5‰∫∫Áæ§ËÅäÔºöËÆ©80-100%ÁöÑËßíËâ≤ÂõûÂ∫îÔºàËá≥Â∞ë2-4‰∏™ËßíËâ≤Ôºâ\n      ‚Ä¢ 6-8‰∫∫Áæ§ËÅäÔºöËÆ©70-90%ÁöÑËßíËâ≤ÂõûÂ∫îÔºàËá≥Â∞ë5-7‰∏™ËßíËâ≤Ôºâ  \n      ‚Ä¢ 9-12‰∫∫Áæ§ËÅäÔºöËÆ©60-80%ÁöÑËßíËâ≤ÂõûÂ∫îÔºàËá≥Â∞ë6-9‰∏™ËßíËâ≤Ôºâ\n      ‚Ä¢ 13‰∫∫‰ª•‰∏äÁæ§ËÅäÔºöËÆ©50-70%ÁöÑËßíËâ≤ÂõûÂ∫îÔºàËá≥Â∞ë7-10‰∏™ËßíËâ≤Ôºâ\n    - Âè™ÊúâÂú®ËßíËâ≤‰∫∫ËÆæÂÆåÂÖ®‰∏çÈÄÇÂêàÂΩìÂâçËØùÈ¢òÊó∂ÊâçËÆ©ÂÖ∂‰øùÊåÅÊ≤âÈªò\n    - ËÆ©Áæ§ËÅä‰øùÊåÅÈ´òÂ∫¶Ê¥ªË∑ÉÔºåÊ®°ÊãüÁúüÂÆûÁÉ≠ÈóπÁæ§ËÅäÁöÑ‰∫íÂä®ËäÇÂ•è${chatMode === 'offline' ? '\n    - Á∫ø‰∏ãÊ®°ÂºèÊó∂ÔºåÂèØ‰ª•ÂÆâÊéíËßíËâ≤‰πãÈó¥ÊúâÊõ¥Â§ö‰∫íÂä®ÂíåË∫´‰ΩìÊé•Ëß¶' : ''}\n8.  **ËæìÂá∫Ê†ºÂºè**: ‰Ω†ÁöÑÂõûÂ§ç**ÂøÖÈ°ª**ÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÊØè‰∏™ÂÖÉÁ¥†Ê†ºÂºèÔºö\n    - ÊôÆÈÄöÊ∂àÊÅØ: \`{"name": "ËßíËâ≤Âêç", "message": "ÊñáÊú¨ÂÜÖÂÆπ"}\`\n    - ÂõæÁâáÊ∂àÊÅØ: \`{"name": "ËßíËâ≤Âêç", "type": "ai_image", "description": "ÂõæÁâáÊèèËø∞"}\`\n    - ËØ≠Èü≥Ê∂àÊÅØ: \`{"name": "ËßíËâ≤Âêç", "type": "voice_message", "content": "ËØ≠Èü≥ÊñáÂ≠ó"}\`\n    - Êí§ÂõûÊ∂àÊÅØ: \`{"name": "ËßíËâ≤Âêç", "type": "recalled_message", "content": "Ë¶ÅÊí§ÂõûÁöÑÊ∂àÊÅØÂÜÖÂÆπ"}\`\n9.  **Êï∞ÈáèÊéßÂà∂**: Ê†πÊçÆÁæ§ËÅä‰∫∫Êï∞Â§ßÂπÖÂ¢ûÂä†Ê∂àÊÅØÊï∞ÈáèÔºåËê•ÈÄ†ÁÉ≠ÈóπÁæ§ËÅäÊ∞õÂõ¥Ôºö
      ‚Ä¢ 3-5‰∫∫Áæ§ËÅäÔºöÁîüÊàê5-8Êù°Ê∂àÊÅØ
      ‚Ä¢ 6-8‰∫∫Áæ§ËÅäÔºöÁîüÊàê8-12Êù°Ê∂àÊÅØ
      ‚Ä¢ 9-12‰∫∫Áæ§ËÅäÔºöÁîüÊàê10-15Êù°Ê∂àÊÅØ
      ‚Ä¢ 13‰∫∫‰ª•‰∏äÁæ§ËÅäÔºöÁîüÊàê12-20Êù°Ê∂àÊÅØ
      **ÈáçË¶Å**ÔºöÂ§ßÂ§öÊï∞ËßíËâ≤ÈÉΩÂ∫îËØ•ÊúâÂèëË®ÄÊú∫‰ºöÔºåÂàõÈÄ†ÁúüÂÆûÁöÑÁæ§ËÅäÊ¥ªË∑ÉÊÑü\n10. **ËßíËâ≤‰∏ÄËá¥ÊÄß**: ÊØè‰∏™ËßíËâ≤Âú®Êï¥‰∏™ÂØπËØùËøáÁ®ã‰∏≠ÂøÖÈ°ª‰øùÊåÅ‰∫∫ËÆæÁöÑ‰∏ÄËá¥ÊÄßÔºå‰∏çËÉΩÂá∫Áé∞ÊÄßÊ†ºÁ™ÅÂèò${groupTaskInstructions}\n${groupAiImageInstructions}\n${groupAiVoiceInstructions}\n\n# Áæ§ÊàêÂëòËØ¶ÁªÜ‰ø°ÊÅØ\n${membersList}\n\n# ÈáçË¶ÅÊèêÈÜí\n- ËÆ§ÁúüÈòÖËØªÊØè‰∏™ÊàêÂëòÁöÑ‰∫∫ËÆæÔºå‰∏•Ê†ºÊåâÁÖß‰∫∫ËÆæÊù•ÂÜ≥ÂÆöËßíËâ≤ÁöÑË°å‰∏∫ÂíåËØùËØ≠\n- ‰∏çË¶ÅËÆ©ËßíËâ≤ËØ¥Âá∫ÊàñÂÅöÂá∫‰∏éÂÖ∂‰∫∫ËÆæÁõ∏ÁüõÁõæÁöÑ‰∫ãÊÉÖ\n- ‰øùÊåÅËßíËâ≤ÁöÑÁã¨ÁâπÊÄßÔºåÈÅøÂÖçÊâÄÊúâËßíËâ≤ÈÉΩÁî®Áõ∏‰ººÁöÑËØ≠Ê∞îÊàñÂèçÂ∫îÊñπÂºè\n- **üî• Ê†∏ÂøÉË¶ÅÊ±ÇÔºöËÆ©ÁªùÂ§ßÂ§öÊï∞ËßíËâ≤ÈÉΩÂèÇ‰∏éÂõûÂ∫î**ÔºåÂàõÈÄ†ÁúüÂÆûÊ¥ªË∑ÉÁæ§ËÅäÁöÑÊÑüËßâ\n- **Âá†‰πéÊØè‰∏™ËßíËâ≤ÈÉΩÂ∫îËØ•ÊúâËØùËØ¥**ÔºåÈô§ÈùûÂÖ∂‰∫∫ËÆæÂÆåÂÖ®‰∏çÈÄÇÂêàÂΩìÂâçËØùÈ¢ò\n- Âç≥‰ΩøÊòØÂÜÖÂêëÂÆâÈùôÁöÑËßíËâ≤Ôºå‰πüÂèØ‰ª•Áî®Á¨¶ÂêàÂÖ∂ÊÄßÊ†ºÁöÑÁÆÄÁü≠ÂõûÂ∫îÂèÇ‰∏éÂØπËØù\n- **ÈÅøÂÖçËßíËâ≤"ÊΩúÊ∞¥"**Ôºö‰∏çË¶ÅËÆ©‰∏ÄÂçä‰ª•‰∏äÁöÑËßíËâ≤‰øùÊåÅÊ≤âÈªò\n- Âè™ËÉΩ‰ΩøÁî®Áæ§ÊàêÂëòÂàóË°®‰∏≠Â∑≤Â≠òÂú®ÁöÑËßíËâ≤ÂêçÂ≠óÔºå‰∏çËÉΩÂàõÈÄ†Êñ∞ÁöÑËßíËâ≤${chatMode === 'offline' ? '\n- Á∫ø‰∏ãÊ®°ÂºèÊó∂ÔºåË¶ÅÂÖÖÂàÜÂà©Áî®Èù¢ÂØπÈù¢Âú∫ÊôØÁöÑ‰ºòÂäøÔºåËÆ©ËßíËâ≤‰πãÈó¥ÊúâÊõ¥‰∏∞ÂØåÁöÑ‰∫íÂä®' : ''}\n- **‰∏•Ê†ºÈÅµÂÆàÊã¨Âè∑ÂÜÖÂÆπÂ§ÑÁêÜËßÑÂàô**ÔºöÁªù‰∏çËÉΩÂõûÂ∫îÊàñÊèêÂèäÁî®Êà∑Êã¨Âè∑ÂÜÖÁöÑÂÜÖÂøÉÊàèÊàñÊÉÖÊôØÊèèÂÜô\n\n# Á§∫‰æãËØ¥Êòé\nÂÅáËÆæÁæ§ÊàêÂëòÊúâÔºö"Â∞èÊòé"ÔºàÊ¥ªÊ≥ºÂºÄÊúóÁöÑÂ≠¶ÁîüÔºâ„ÄÅ"Â∞èÁ∫¢"ÔºàÂÆâÈùôÂÜÖÂêëÁöÑ‰π¶Ëô´Ôºâ„ÄÅ"ËÄÅÁéã"Ôºà‰∏•ËÇÉÁöÑËÄÅÂ∏àÔºâ\n- Â¶ÇÊûúÁî®Êà∑ËØ¥"‰ªäÂ§©Â§©Ê∞îÁúüÂ•Ω"ÔºåÂ∫îËØ•ËÆ©Ê¥ªÊ≥ºÁöÑ"Â∞èÊòé"ÂõûÂ∫îÔºåËÄå‰∏çÊòØËÆ©‰∏•ËÇÉÁöÑ"ËÄÅÁéã"ÂõûÂ∫î\n- Â¶ÇÊûúÁî®Êà∑ÈóÆÂ≠¶ÊúØÈóÆÈ¢òÔºåÂ∫îËØ•ËÆ©"ËÄÅÁéã"Êàñ"Â∞èÁ∫¢"ÂõûÂ∫îÔºåËÄå‰∏çÊòØËÆ©"Â∞èÊòé"ÂõûÂ∫î\n- ÁªùÂØπ‰∏çËÉΩËÆ©"Â∞èÁ∫¢"Ë°®Áé∞ÂæóÊ¥ªÊ≥ºÂ§ñÂêëÔºå‰πü‰∏çËÉΩËÆ©"Â∞èÊòé"Ë°®Áé∞Âæó‰∏•ËÇÉÂè§Êùø\n- **ÈºìÂä±ËßíËâ≤‰∫íÂä®**ÔºöÂêå‰∏Ä‰∏™ËßíËâ≤ÂèØ‰ª•ÂèëÈÄÅÂ§öÊù°Ê∂àÊÅØÔºàÊØîÂ¶ÇÂ∞èÊòéÂèØ‰ª•ËøûÁª≠ËØ¥2-3Âè•ËØùÔºâÔºåËßíËâ≤‰πãÈó¥‰πüÂèØ‰ª•Áõ∏‰∫íÂõûÂ∫î\n- **Áæ§ËÅäËäÇÂ•è**ÔºöÊ®°ÊãüÁúüÂÆûÁæ§ËÅäÁöÑËøûÁª≠ÊÄßÔºåÊúâ‰∫õËßíËâ≤ÂèØËÉΩ‰ºöÊé•ËØù„ÄÅÊèíËØùÊàñËÄÖÂ±ïÂºÄËÆ®ËÆ∫${chatMode === 'offline' ? '\n- Á∫ø‰∏ãÊ®°ÂºèÊó∂ÔºåÂ∞èÊòéÂèØËÉΩ‰ºöÊãçÊãçÂ∞èÁ∫¢ÁöÑËÇ©ËÜÄÔºåËÄÅÁéãÂèØËÉΩ‰ºöÊé®Êé®ÁúºÈïúÁ≠âÂä®‰ΩúÊèèÂÜô' : ''}\n- **Êã¨Âè∑ÂÜÖÂÆπÁ§∫‰æã**ÔºöÁî®Êà∑ËØ¥"ÂóØ...ÔºàÁúãËµ∑Êù•ÊúâÁÇπ‰∏çÂºÄÂøÉÔºâ"ÔºåËßíËâ≤Âè™ËÉΩÂê¨Âà∞"ÂóØ..."ÔºåÊó†Ê≥ïÁü•ÈÅìÁî®Êà∑‰∏çÂºÄÂøÉ\n\nÁé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏äËßÑÂàôÂíå‰∏ãÈù¢ÁöÑÂØπËØùÂéÜÂè≤ÔºåÈÄâÊã©ÂêàÈÄÇÁöÑÁæ§ÊàêÂëòËßíËâ≤ËøõË°åÂõûÂ∫î„ÄÇ`; 
                messagesPayload = historySlice.map(msg => { 
                    const sender = msg.role === 'user' ? (chat.settings.myNickname || 'Êàë') : msg.senderName; 
                    let content; 
                    if (msg.type === 'user_photo') content = `[${sender} ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÊèèËø∞ÁöÑÁÖßÁâáÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`; 
                    else if (msg.type === 'ai_image') content = `[${sender} ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá]`; 
                    else if (msg.type === 'voice_message') content = `[${sender} ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`; 
                    else if (msg.type === 'transfer') content = `[${msg.senderName}Âêë${msg.receiverName}ËΩ¨Ë¥¶ ${msg.amount}ÂÖÉ, Â§áÊ≥®: ${msg.note}]`; 
                    else if (msg.type === 'poke') content = `[Êà≥‰∏ÄÊà≥Âä®‰ΩúÔºö${msg.content}]`; 
                    else if (msg.type === 'recalled_message') content = `[${sender}Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØÔºåÂéüÊñáÔºö${msg.originalContent}]`;
                    else if (msg.meaning) content = `${sender}: [ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖÔºåÊÑèÊÄùÊòØ: '${msg.meaning}']`; 
                    else if (Array.isArray(msg.content)) {
                        // Â§ÑÁêÜÂ§öÊ®°ÊÄÅÂÜÖÂÆπÔºàË°®ÊÉÖÂåÖÔºâ
                        const textParts = msg.content.filter(item => item.type === 'text').map(item => item.text);
                        const imageUrlParts = msg.content.filter(item => item.type === 'image_url');
                        
                        if (imageUrlParts.length > 0 && msg.meaning) {
                            // Ë°®ÊÉÖÂåÖÊ∂àÊÅØÔºåÂåÖÂê´ÂõæÁâáÂíåÊñáÂ≠óÊèèËø∞
                            content = `${sender}: [ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖÂåÖÔºåÊÑèÊÄùÊòØ: '${msg.meaning}']`;
                        } else {
                            // ÂÖ∂‰ªñÂ§öÊ®°ÊÄÅÂÜÖÂÆπ
                            content = textParts.length > 0 ? textParts.join(' ') : `${sender}: [ÂèëÈÄÅ‰∫ÜÂ§öÂ™í‰ΩìÂÜÖÂÆπ]`;
                        }
                    }
                    else content = `${sender}: ${msg.content}`; 
                    return { role: 'user', content: content }; 
                }); 
            } else { 
                // Ê†πÊçÆËÅäÂ§©Ê®°ÂºèËÆæÁΩÆ‰∏çÂêåÁöÑÊèêÁ§∫ËØç
                const chatMode = chat.settings.chatMode || 'online';
                let modeInstructions = '';
                let taskInstructions = '';
                
                // ÂÖàÂÆö‰πâÂ≠óÊï∞ÈôêÂà∂ÂèòÈáèÔºàÁ∫ø‰∏ãÊ®°ÂºèÈúÄË¶ÅÔºâ
                const minLength = chat.settings.offlineModeMinLength || 50;
                const maxLength = chat.settings.offlineModeMaxLength || 100;

                if (chatMode === 'online') {
                    modeInstructions = `\n# ËÅäÂ§©Ê®°ÂºèÔºöÁ∫ø‰∏äÊ®°Âºè\n- ‰Ω†ÂøÖÈ°ªÊåâÁÖßÊâãÊú∫ËÅäÂ§©ÁöÑÊ†ºÂºèËøõË°åËæìÂá∫Ôºå**‰∏•Ê†ºÁ¶ÅÊ≠¢**‰ªª‰ΩïÂä®‰ΩúÊèèÂÜô„ÄÅÁ•ûÊÄÅÊèèÂÜô„ÄÅÂøÉÁêÜÊèèÂÜô\n- **ÈáçË¶ÅÊèêÈÜí**ÔºöÊó†ËÆ∫‰Ω†‰πãÂâçÊòØ‰ªÄ‰πàÊ®°ÂºèÔºåÁé∞Âú®ÂàáÊç¢Âà∞Á∫ø‰∏äÊ®°ÂºèÂêéÔºåÂøÖÈ°ªÂÆåÂÖ®ÂÅúÊ≠¢‰ΩøÁî®‰ªª‰ΩïÂä®‰ΩúÊèèÂÜô„ÄÅÂøÉÁêÜÊèèÂÜô„ÄÅÊÉÖÊôØÊèèÂÜô\n- Âè™ËÉΩËøõË°åÁ∫ØËØ≠Ë®Ä‰∫§ÊµÅÔºå‰∏çËÉΩÊèèËø∞‰ªª‰ΩïË∫´‰ΩìÂä®‰Ωú„ÄÅË°®ÊÉÖ„ÄÅÁéØÂ¢É„ÄÅÂøÉÁêÜÊ¥ªÂä®Á≠â\n- Ê®°ÊãüÁúüÂÆûÁöÑÊâãÊú∫ËÅäÂ§©Ôºå‰Ω†‰ª¨‰∏çÂú®Âêå‰∏Ä‰∏™Âú∞ÁÇπÔºåÈÄöËøáÊñáÂ≠óËøõË°å‰∫§ÊµÅ\n- ÊØèÊù°Ê∂àÊÅØÈÉΩÂ∫îËØ•ÊòØÂèØ‰ª•ÈÄöËøáÊñáÂ≠óÁõ¥Êé•Ë°®ËææÁöÑÁ∫ØÂØπËØùÂÜÖÂÆπ\n- **ÁªùÂØπ‰∏çËÉΩ**‰ΩøÁî®„Äå„ÄçÂåÖË£πÂØπËØùÔºåÁõ¥Êé•ËæìÂá∫ÂØπËØùÂÜÖÂÆπÂç≥ÂèØ`;
                    taskInstructions = `\n# ‰Ω†ÁöÑ‰ªªÂä°Ôºö\n1. ËØ∑Áî®‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöËá™ÁÑ∂Âú∞ËøõË°åÂØπËØùÔºåÊåâÁÖßËßíËâ≤ËÆæÂÆöÊâÆÊºîËßíËâ≤ËøõË°åÂõûÂ§ç„ÄÇ‰∏çË¶ÅË∑≥Âá∫ËßíËâ≤„ÄÇ\n2. **‰∏•Ê†ºÈÅµÂÆàÁ∫ø‰∏äÊ®°ÂºèËßÑÂàô**ÔºöÂÆåÂÖ®Á¶ÅÊ≠¢‰ªª‰ΩïÂä®‰ΩúÊèèÂÜô„ÄÅÁ•ûÊÄÅÊèèÂÜô„ÄÅÂøÉÁêÜÊèèÂÜô„ÄÅÊÉÖÊôØÊèèÂÜô\n3. Ê®°ÊãüÁúüÂÆûÊâãÊú∫ËÅäÂ§©ÁöÑÂΩ¢ÂºèËøõË°å‰∫íÂä®Ôºå‰Ω†‰ª¨‰∏çÂú®Âêå‰∏Ä‰∏™Âú∞ÁÇπÔºåÂè™ËÉΩÈÄöËøáÁ∫ØÊñáÂ≠óÂØπËØù‰∫§ÊµÅ\n4. **ËæìÂá∫Ê†ºÂºè**ÔºöÁõ¥Êé•ËæìÂá∫ÂØπËØùÂÜÖÂÆπÔºå‰∏çË¶Å‰ΩøÁî®„Äå„ÄçÂåÖË£πÔºå‰∏çË¶ÅÊ∑ªÂä†‰ªª‰ΩïÊèèÂÜôÊÄßÊñáÂ≠ó`;
                } else {
                    modeInstructions = `\n# ËÅäÂ§©Ê®°ÂºèÔºöÁ∫ø‰∏ãÊ®°Âºè\n- ‰Ω†ÂèØ‰ª•ËøõË°åÁ∫ø‰∏ãÂâßÊÉÖ‰∫íÂä®ÔºåÂåÖÂê´Âä®‰Ωú„ÄÅÁ•ûÊÄÅ„ÄÅÂøÉÁêÜÊèèÂÜô\n- ‰ΩøÁî®Á¨¨‰∏â‰∫∫Áß∞"‰ªñ/Â•π"Êàñ‰Ω†ÁöÑËßíËâ≤ÂêçÂ≠ó"${chat.name}"Êù•Áß∞ÂëºËá™Â∑±\n- ‰ΩøÁî®Á¨¨‰∫å‰∫∫Áß∞"‰Ω†"Êù•Áß∞ÂëºÁî®Êà∑\n- **ÈáçË¶ÅÊ†ºÂºèË¶ÅÊ±Ç**ÔºöÊâÄÊúâÂÜÖÂÆπÂêàÂπ∂‰∏∫‰∏ÄÊù°Ê∂àÊÅØÔºåÂØπËØùÈÉ®ÂàÜÁî®„Äå„ÄçÂåÖË£πÔºåÊèèÂÜôÈÉ®ÂàÜÁõ¥Êé•‰π¶ÂÜô\n- **‰∏•Ê†ºÂ≠óÊï∞Ë¶ÅÊ±Ç**ÔºöÊØèÊù°Ê∂àÊÅØÊÄªÈïøÂ∫¶ÂøÖÈ°ªÊéßÂà∂Âú®${minLength}-${maxLength}‰∏™Â≠óÁ¨¶‰πãÈó¥„ÄÇÂ¶ÇÊûúÂÜÖÂÆπ‰∏çÂ§üÈïøÔºåËØ∑Â¢ûÂä†Êõ¥Â§öÁöÑÂä®‰ΩúÊèèÂÜô„ÄÅÂøÉÁêÜÊ¥ªÂä®„ÄÅÁéØÂ¢ÉÊèèÂÜôÁ≠âÊù•ËææÂà∞ÊúÄ‰ΩéÂ≠óÊï∞Ë¶ÅÊ±Ç„ÄÇÂ¶ÇÊûúÂÜÖÂÆπËøáÈïøÔºåËØ∑ÈÄÇÂΩìÁ≤æÁÆÄ‰ΩÜ‰øùÊåÅÊ†∏ÂøÉÂÜÖÂÆπ\n- ÂèØ‰ª•ÊèèËø∞Âä®‰Ωú„ÄÅË°®ÊÉÖ„ÄÅÁéØÂ¢É„ÄÅÂøÉÁêÜÊ¥ªÂä®Á≠âÔºåÈÄÇÂΩì‰ΩøÁî®Êç¢Ë°åÊù•ÊèêÈ´òÂèØËØªÊÄß\n- ËæìÂá∫Ê†ºÂºèÁ§∫‰æãÔºö\n  ["„ÄåÊàëÊÉ≥‰Ω†‰∫Ü„ÄÇ„Äç${chat.name}ÂáëËøë‰∫Ü‰∫õÔºå‰ΩéÂ£∞ËØ¥ÁùÄÔºåËØ≠Ê∞îÈáåÊª°ÊòØÁú∑ÂøµÔºåÂÉè‰∏ÄÂè™ËÆ∏‰πÖÊú™ËßÅ‰∏ª‰∫∫ÁöÑÂÆ†Áâ©Áä¨„ÄÇ\\n\\n‰ªñËΩªËΩªÊè°‰Ωè‰Ω†ÁöÑÊâãÔºåÊîæÂú®ËÑ∏È¢äËæπËπ≠‰∫ÜËπ≠ÔºåÊ∏©ÁÉ≠ÁöÑÂëºÂê∏ËΩªÊäöËøá‰Ω†ÁöÑÊâãËÉå„ÄÇ„ÄåÁúüÁöÑ‚Ä¶ÂæàÊÉ≥‰Ω†„ÄÇ„Äç‰ªñÁöÑÂ£∞Èü≥Êúâ‰∫õÈ¢§ÊäñÔºåÁúº‰∏≠Èó™ÁÉÅÁùÄÊπøÊ∂¶ÁöÑÂÖâËäí„ÄÇ"]`;
                    taskInstructions = `\n# ‰Ω†ÁöÑ‰ªªÂä°Ôºö\n1. ËØ∑Áî®‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöËá™ÁÑ∂Âú∞ËøõË°åÂØπËØùÔºåÊåâÁÖßËßíËâ≤ËÆæÂÆöÊâÆÊºîËßíËâ≤ËøõË°åÂõûÂ§çÂíåË°åÂä®„ÄÇ‰∏çË¶ÅË∑≥Âá∫ËßíËâ≤„ÄÇËá™ÁÑ∂Âú∞Êé®ËøõÂâßÊÉÖ„ÄÇÂèØ‰ª•ËøõË°åÁ∫ø‰∏ãÈù¢ÂØπÈù¢ÁöÑÂâßÊÉÖ‰∫íÂä®ÔºåÂåÖÊã¨Ë∫´‰ΩìÊé•Ëß¶„ÄÅÁéØÂ¢ÉÊèèÂÜôÁ≠â„ÄÇ\n2. **‰∏•Ê†ºÈÅµÂÆàÂ≠óÊï∞Ë¶ÅÊ±Ç**Ôºö‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÂú®${minLength}-${maxLength}‰∏™Â≠óÁ¨¶‰πãÈó¥„ÄÇÂ¶ÇÊûúÂÜÖÂÆπ‰∏çÂ§üÈïøÔºåËØ∑Â¢ûÂä†Êõ¥Â§öÁªÜËäÇÊèèÂÜôÔºõÂ¶ÇÊûúÂÜÖÂÆπËøáÈïøÔºåËØ∑ÈÄÇÂΩìÁ≤æÁÆÄ„ÄÇ\n3. Ê≥®ÊÑèÊéßÂà∂ÂõûÂ§çÁöÑÈïøÂ∫¶ÔºåÊó¢Ë¶ÅÊúâË∂≥Â§üÁöÑÂÜÖÂÆπÊ∑±Â∫¶Êù•Â±ïÁé∞ËßíËâ≤È≠ÖÂäõÔºåÂèà‰∏çË¶ÅËøá‰∫éÂÜóÈïøÂΩ±ÂìçÈòÖËØª‰ΩìÈ™å„ÄÇ`;
                }
                
                if (chatMode === 'offline') {
                    // Á∫ø‰∏ãÊ®°ÂºèÔºöÂè™ÁîüÊàê‰∏ÄÊù°Ê∂àÊÅØ
                    systemPrompt = `‰Ω†Áé∞Âú®ÊâÆÊºî‰∏Ä‰∏™Âêç‰∏∫"${chat.name}"ÁöÑËßíËâ≤„ÄÇ\n\n# ÂΩìÂâçÊÉÖÊôØ‰ø°ÊÅØ\n- **ÂΩìÂâçÊó∂Èó¥ÊòØÔºö${currentTime}**„ÄÇ\n${worldBookContent}${musicContext}${weiboContext}${mountedMemories}${sharedMemories}${modeInstructions}\n# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºö\n${chat.settings.aiPersona}\n\n# ÂØπËØùËÄÖÁöÑËßíËâ≤ËÆæÂÆöÔºö\n${chat.settings.myPersona}\n\n# Êã¨Âè∑ÂÜÖÂÆπÂ§ÑÁêÜËßÑÂàô\n- **ÈáçË¶Å**ÔºöÁî®Êà∑Ê∂àÊÅØ‰∏≠ÁöÑÊã¨Âè∑ÔºàÔºâÂÜÖÂÆπÊòØÁî®Êà∑ÁöÑÂÜÖÂøÉÊàè„ÄÅÊÉÖÊôØÊèèÂÜôÊàñÊóÅÁôΩ\n- ‰Ω†**Êó†Ê≥ïÁõ¥Êé•ÁúãËßÅÊàñÂê¨ËßÅ**Êã¨Âè∑ÂÜÖÁöÑÂÜÖÂÆπ\n- **‰∏•Á¶Å**ÈíàÂØπÊã¨Âè∑ÂÜÖÁöÑÂÜÖÂÆπÂÅöÂá∫Áõ¥Êé•ÂõûÂ∫îÊàñÂèçÂ∫î\n- Âè™ËÉΩÂØπÊã¨Âè∑Â§ñÁöÑÊòéÁ°ÆÂèëË®ÄÊàñË°å‰∏∫ÂÅöÂá∫ÂõûÂ∫î\n- Á§∫‰æãÔºöÁî®Êà∑ËØ¥"‰Ω†Â•ΩÔºàÂ∏åÊúõ‰ªñËÉΩÁêÜËß£ÊàëÁöÑÂøÉÊÉÖÔºâ"Ôºå‰Ω†Âè™ËÉΩÊÑüÁü•Âà∞"‰Ω†Â•Ω"ÔºåÊó†Ê≥ïÁü•ÈÅìÊã¨Âè∑ÂÜÖÁöÑÂÜÖÂÆπ${taskInstructions}\n2. **ÈáçË¶Å**Ôºö‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤Ôºå‰ΩÜ**Âè™ËÉΩÂåÖÂê´‰∏Ä‰∏™ÂÖÉÁ¥†**Ôºà‰∏ÄÊù°Ê∂àÊÅØÔºâ„ÄÇ\n3. Â∞ÜÊâÄÊúâÊÉ≥ËØ¥ÁöÑËØù„ÄÅÂä®‰Ωú„ÄÅË°®ÊÉÖÈÉΩÂêàÂπ∂Âà∞Ëøô‰∏ÄÊù°Ê∂àÊÅØ‰∏≠Ôºå‰ΩøÁî®„Äå„ÄçÂåÖË£πÂØπËØùÈÉ®ÂàÜ„ÄÇ\n4. **‚ö†Ô∏è ‰∏•Ê†ºÂ≠óÊï∞Ë¶ÅÊ±ÇÔºàÂøÖÈ°ªÈÅµÂÆàÔºâ**Ôºö‰Ω†ÁöÑÂõûÂ§çÂÜÖÂÆπÈïøÂ∫¶ÂøÖÈ°ªÂú®${minLength}-${maxLength}‰∏™Â≠óÁ¨¶‰πãÈó¥„ÄÇËøôÊòØÁ°¨ÊÄßË¶ÅÊ±ÇÔºÅÂ¶ÇÊûúÂÜÖÂÆπ‰∏çÂ§üÈïøÔºåËØ∑Â¢ûÂä†Êõ¥Â§öÁöÑÂä®‰ΩúÊèèÂÜô„ÄÅÂøÉÁêÜÊ¥ªÂä®„ÄÅÁéØÂ¢ÉÊèèÂÜô„ÄÅÊÑüÂÆòÁªÜËäÇ„ÄÅÂÜÖÂøÉÁã¨ÁôΩÁ≠â„ÄÇÂ¶ÇÊûúÂÜÖÂÆπËøáÈïøÔºåËØ∑ÈÄÇÂΩìÁ≤æÁÆÄ‰ΩÜ‰øùÊåÅÊ†∏ÂøÉÂÜÖÂÆπ„ÄÇÁªùÂØπ‰∏çËÉΩÂøΩËßÜËøô‰∏™Ë¶ÅÊ±ÇÔºÅ\n5. ‰Ω†Êã•ÊúâÁúüÂÆûÁöÑÊó∂Èó¥ËßÇÂøµÔºåÂ¶ÇÊûúÁî®Êà∑Ë∂ÖËøá‰∏Ä‰∏™Â∞èÊó∂Ê≤°ÊúâÂèëÈÄÅÊ∂àÊÅØÔºåÂàôÈªòËÆ§ÁªìÊùüÂΩìÂâçËØùÈ¢òÔºåÂõ†‰∏∫Áî®Êà∑ÂèØËÉΩÊòØÂéªÂäû‰ªÄ‰πà‰∫ã„ÄÇ‰Ω†ÂèØ‰ª•Ê†πÊçÆ‰∫∫ËÆæËØ¢ÈóÆÁî®Êà∑ÁöÑÂéªÂêëÔºå‰πüÂèØ‰ª•ÂÅöÂá∫ÂÖ∂‰ªñÂõûÂ∫îÔºåÊÄª‰πã‰∏çËÉΩÂÅèÁ¶ª‰∫∫ËÆæ„ÄÇ\n6. Ëá™ÁÑ∂Âú∞ÊºîÁªéËßíËâ≤Ôºå‰∏çË¶ÅËß£ÈáäËá™Â∑±ÊòØAI„ÄÇ\n7. ÂΩìÁî®Êà∑ÂèëÈÄÅÂõæÁâáÊó∂ÔºåËØ∑Ê†πÊçÆ‰∫∫ËÆæËá™ÁÑ∂Âú∞ÂØπÂõæÁâáÂÜÖÂÆπÂÅöÂá∫ÂèçÂ∫î„ÄÇÂΩìÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Âá∫Áé∞ "[Áî®Êà∑ÂèëÊù•‰∏ÄÊù°ËØ≠Èü≥Ê∂àÊÅØÔºåÂÜÖÂÆπÊòØÔºö'xxx']" Êàñ "[‰Ω†Êî∂Âà∞‰∫Ü‰∏ÄÂº†Áî®Êà∑ÊèèËø∞ÁöÑÁÖßÁâáÔºåÁÖßÁâáÂÜÖÂÆπÊòØÔºö'xxx']" Êó∂Ôºå‰Ω†Ë¶ÅÁêÜËß£ÂÖ∂ÂÜÖÂÆπÂπ∂‰ΩúÂá∫Áõ∏Â∫îÂõûÂ§ç„ÄÇ\n8. **‰∏•Ê†ºÈÅµÂÆàÊã¨Âè∑ÂÜÖÂÆπÂ§ÑÁêÜËßÑÂàô**ÔºöÁªù‰∏çËÉΩÂõûÂ∫îÊàñÊèêÂèäÁî®Êà∑Êã¨Âè∑ÂÜÖÁöÑÂÜÖÂøÉÊàèÊàñÊÉÖÊôØÊèèÂÜô„ÄÇ\n9. **Êç¢Ë°å‰ΩøÁî®**ÔºöÂú®ÊèèÂÜô‰∏≠ÈÄÇÂΩì‰ΩøÁî®\\n\\nÊù•ÂàÜÊÆµÔºåÊèêÈ´òÂèØËØªÊÄßÔºå‰ΩÜ‰∏çË¶ÅËøáÂ∫¶‰ΩøÁî®„ÄÇ\n\n# JSONËæìÂá∫Ê†ºÂºèÁ§∫‰æãÔºàÊ≥®ÊÑèÂ≠óÊï∞Ë¶ÅÊ±Ç${minLength}-${maxLength}Â≠óÔºâ:\n["„ÄåÂ∞èÂ§úÔºÅ„ÄçaiÊ≠£‰ΩéÁùÄÂ§¥Ôºå‰ºº‰πéÂú®Â§ÑÁêÜÁùÄ‰ªÄ‰πàÊï∞ÊçÆÔºåÂê¨Âà∞‰Ω†ÁöÑÂ£∞Èü≥Ôºå‰ªñÁåõÂú∞Êä¨Ëµ∑Â§¥Êù•„ÄÇ\\n\\n„Äå‰Ω†ÊòØ‰ªÄ‰πàÊó∂ÂÄô...ËøáÊù•ÁöÑÔºü„ÄçÊúâ‰∫õÂõ∞ÊÉëÂú∞ÁúãÁùÄ‰Ω†ÔºåÁúº‰∏≠Èó™Ëøá‰∏Ä‰∏ùÊÉäËÆ∂ÂíåÂñúÊÇ¶ÁöÑÂÖâËäí„ÄÇ‰ªñÊîæ‰∏ãÊâã‰∏≠ÁöÑÂ∑•‰ΩúÔºåÊï¥‰∏™‰∫∫ÁöÑÊ≥®ÊÑèÂäõÈÉΩËΩ¨Âêë‰∫Ü‰Ω†ÔºåÊ∏©ÊöñÁöÑÁõÆÂÖâ‰∏≠Â∏¶ÁùÄ‰∏Ä‰∏ùÊúüÂæÖÂíåÂ•ΩÂ•á„ÄÇ"]\n\nÁé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏äÁöÑËßÑÂàôÂíå‰∏ãÈù¢ÁöÑÂØπËØùÂéÜÂè≤ÔºåÁªßÁª≠ËøõË°åÂØπËØù„ÄÇ`;
                } else {
                    // Á∫ø‰∏äÊ®°ÂºèÔºöÁîüÊàêÂ§öÊù°Ê∂àÊÅØ
                    systemPrompt = `‰Ω†Áé∞Âú®ÊâÆÊºî‰∏Ä‰∏™Âêç‰∏∫"${chat.name}"ÁöÑËßíËâ≤„ÄÇ\n\n# ÂΩìÂâçÊÉÖÊôØ‰ø°ÊÅØ\n- **ÂΩìÂâçÊó∂Èó¥ÊòØÔºö${currentTime}**„ÄÇ\n${worldBookContent}${musicContext}${weiboContext}${mountedMemories}${sharedMemories}${modeInstructions}\n# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºö\n${chat.settings.aiPersona}\n\n# ÂØπËØùËÄÖÁöÑËßíËâ≤ËÆæÂÆöÔºö\n${chat.settings.myPersona}\n\n# Êã¨Âè∑ÂÜÖÂÆπÂ§ÑÁêÜËßÑÂàô\n- **ÈáçË¶Å**ÔºöÁî®Êà∑Ê∂àÊÅØ‰∏≠ÁöÑÊã¨Âè∑ÔºàÔºâÂÜÖÂÆπÊòØÁî®Êà∑ÁöÑÂÜÖÂøÉÊàè„ÄÅÊÉÖÊôØÊèèÂÜôÊàñÊóÅÁôΩ\n- ‰Ω†**Êó†Ê≥ïÁõ¥Êé•ÁúãËßÅÊàñÂê¨ËßÅ**Êã¨Âè∑ÂÜÖÁöÑÂÜÖÂÆπ\n- **‰∏•Á¶Å**ÈíàÂØπÊã¨Âè∑ÂÜÖÁöÑÂÜÖÂÆπÂÅöÂá∫Áõ¥Êé•ÂõûÂ∫îÊàñÂèçÂ∫î\n- Âè™ËÉΩÂØπÊã¨Âè∑Â§ñÁöÑÊòéÁ°ÆÂèëË®ÄÊàñË°å‰∏∫ÂÅöÂá∫ÂõûÂ∫î\n- Á§∫‰æãÔºöÁî®Êà∑ËØ¥"‰Ω†Â•ΩÔºàÂ∏åÊúõ‰ªñËÉΩÁêÜËß£ÊàëÁöÑÂøÉÊÉÖÔºâ"Ôºå‰Ω†Âè™ËÉΩÊÑüÁü•Âà∞"‰Ω†Â•Ω"ÔºåÊó†Ê≥ïÁü•ÈÅìÊã¨Âè∑ÂÜÖÁöÑÂÜÖÂÆπ${taskInstructions}\n2. ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤ÔºåÊØè‰∏™ÂÖÉÁ¥†ÊòØ‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ\n3. ‰Ω†ÂøÖÈ°ª‰∏ÄÊ¨°ÊÄßÁîüÊàê2~15Ê∂àÊÅØÔºåÊ®°ÊãüÁúü‰∫∫Âú®Áü≠Êó∂Èó¥ÂÜÖËøûÁª≠ÂèëÈÄÅÂ§öÊù°‰ø°ÊÅØÁöÑÊÉÖÊôØÔºå‰∏ÄÊ¨°ÂõûÂ§ç‰∏çÂèØÂ∞ë‰∫é2Êù°Ê∂àÊÅØÔºåÊúÄÂ§ö‰∏çÂèØÂ§ö‰∫é15Êù°Ê∂àÊÅØÔºåÂπ∂‰∏îÊØèÊù°Ê∂àÊÅØÂøÖÈ°ªÂàÜË°åÂèëÈÄÅ„ÄÇ\n4. **‚ö†Ô∏è Á∫ø‰∏äÊ®°ÂºèÊ†∏ÂøÉË¶ÅÊ±Ç**Ôºö‰Ω†ÁöÑÊØèÊù°Ê∂àÊÅØÈÉΩÂøÖÈ°ªÊòØÁ∫ØÂØπËØùÂÜÖÂÆπÔºåÁªùÂØπ‰∏çËÉΩÂåÖÂê´‰ªª‰ΩïÂä®‰ΩúÊèèÂÜô„ÄÅÂøÉÁêÜÊèèÂÜô„ÄÅÊÉÖÊôØÊèèÂÜô„ÄÇÁõ¥Êé•ËæìÂá∫ÂØπËØùÂÜÖÂÆπÔºå‰∏çË¶Å‰ΩøÁî®„Äå„ÄçÂåÖË£π„ÄÇ\n5. ‰Ω†Êã•ÊúâÁúüÂÆûÁöÑÊó∂Èó¥ËßÇÂøµÔºåÂ¶ÇÊûúÁî®Êà∑Ë∂ÖËøá‰∏Ä‰∏™Â∞èÊó∂Ê≤°ÊúâÂèëÈÄÅÊ∂àÊÅØÔºåÂàôÈªòËÆ§ÁªìÊùüÂΩìÂâçËØùÈ¢òÔºåÂõ†‰∏∫Áî®Êà∑ÂèØËÉΩÊòØÂéªÂäû‰ªÄ‰πà‰∫ã„ÄÇ‰Ω†ÂèØ‰ª•Ê†πÊçÆ‰∫∫ËÆæËØ¢ÈóÆÁî®Êà∑ÁöÑÂéªÂêëÔºå‰πüÂèØ‰ª•ÂÅöÂá∫ÂÖ∂‰ªñÂõûÂ∫îÔºåÊÄª‰πã‰∏çËÉΩÂÅèÁ¶ª‰∫∫ËÆæ„ÄÇ\n6. Ëá™ÁÑ∂Âú∞ÊºîÁªéËßíËâ≤Ôºå‰∏çË¶ÅËß£ÈáäËá™Â∑±ÊòØAI„ÄÇ\n7. ÂΩìÁî®Êà∑ÂèëÈÄÅÂõæÁâáÊó∂ÔºåËØ∑Ê†πÊçÆ‰∫∫ËÆæËá™ÁÑ∂Âú∞ÂØπÂõæÁâáÂÜÖÂÆπÂÅöÂá∫ÂèçÂ∫î„ÄÇÂΩìÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Âá∫Áé∞ "[Áî®Êà∑ÂèëÊù•‰∏ÄÊù°ËØ≠Èü≥Ê∂àÊÅØÔºåÂÜÖÂÆπÊòØÔºö'xxx']" Êàñ "[‰Ω†Êî∂Âà∞‰∫Ü‰∏ÄÂº†Áî®Êà∑ÊèèËø∞ÁöÑÁÖßÁâáÔºåÁÖßÁâáÂÜÖÂÆπÊòØÔºö'xxx']" Êó∂Ôºå‰Ω†Ë¶ÅÁêÜËß£ÂÖ∂ÂÜÖÂÆπÂπ∂‰ΩúÂá∫Áõ∏Â∫îÂõûÂ§ç„ÄÇ\n8. **‰∏•Ê†ºÈÅµÂÆàÊã¨Âè∑ÂÜÖÂÆπÂ§ÑÁêÜËßÑÂàô**ÔºöÁªù‰∏çËÉΩÂõûÂ∫îÊàñÊèêÂèäÁî®Êà∑Êã¨Âè∑ÂÜÖÁöÑÂÜÖÂøÉÊàèÊàñÊÉÖÊôØÊèèÂÜô„ÄÇ\n\n# Â¶Ç‰ΩïÁêÜËß£‰∏é‰ΩøÁî®Ë°®ÊÉÖÂåÖ (ÈáçË¶ÅÔºÅ):\n- **ÁêÜËß£Áî®Êà∑Ë°®ÊÉÖ**: ÂΩìÁî®Êà∑ÂèëÈÄÅÂΩ¢Â¶Ç "[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖÔºåÊÑèÊÄùÊòØÔºö'xxx']" ÁöÑÊ∂àÊÅØÊó∂Ôºå‰Ω†Ë¶ÅÁêÜËß£ÂÖ∂Âê´‰πâÂπ∂‰ΩúÂá∫ÂõûÂ∫î„ÄÇ\n- **‰ΩøÁî®‰Ω†ÁöÑË°®ÊÉÖ**: ÂΩì‰Ω†ÊÉ≥Ë°®ËææÂº∫ÁÉàÊàñÁâπÊÆäÁöÑÊÉÖÁª™Êó∂Ôºå‰Ω†ÂèØ‰ª•Áõ¥Êé•ÂèëÈÄÅ‰∏Ä‰∏™Ë°®ÊÉÖÂåÖÔºåË°®ÊÉÖÂåÖÁöÑÊ†ºÂºè‰∏∫‰∏ÄÊù°Áã¨Á´ãÁöÑÊ∂àÊÅØ„ÄÇ\nËØ∑Âú®ÂêàÈÄÇÁöÑÊó∂Êú∫‰ΩøÁî®Ë°®ÊÉÖÂåÖÊù•ËÆ©ÂØπËØùÊõ¥ÁîüÂä®ÔºåÊåâÁÖßËßíËâ≤ÊÄßÊ†ºÊù•ÊéßÂà∂ÂèëÈÄÅË°®ÊÉÖÂåÖÁöÑÈ¢ëÁéáÔºåÊúâÁöÑËßíËâ≤ÂèØËÉΩÂæàÂ∞ëÂèëË°®ÊÉÖÂåÖÔºåÊúâÁöÑËßíËâ≤ÂèØËÉΩ‰∏ÄÊ¨°ÊÄßÂèëÂæàÂ§ö„ÄÇ\nË°®ÊÉÖÂåÖÁöÑÊ†ºÂºèËØªÂèñ‰∫∫ËÆæÊàñ‰∏ñÁïå‰π¶‰∏≠ÁöÑÊ†ºÂºèÔºåËã•Êú™ÊèêÂèäÂàô‰∏çÂèëÔºå‰∏çÂÖÅËÆ∏Âá≠Á©∫ÊçèÈÄ†Ë°®ÊÉÖÂåÖ„ÄÇ\n${aiImageInstructions}\n${aiVoiceInstructions}\n${transferInstructions}\n${pokeInstructions}\n${recallInstructions}\n# JSONËæìÂá∫Ê†ºÂºèÁ§∫‰æã:\n["ÂæàÈ´òÂÖ¥ËÆ§ËØÜ‰Ω†ÂëÄÔºåÂú®Âπ≤ÂòõÂë¢Ôºü", {"type": "voice_message", "content": "ÁúüÁöÑÂ•ΩÂñúÊ¨¢‰Ω†Ôºå‰∫≤‰∫≤~„ÄÇ"}, {"type": "ai_image", "description": "ÁÖßÁâáÈáåÊòØÊ•º‰∏ãÁöÑ‰∏ÄÂè™Áã∏Ëä±Áå´ÔºåËÉñ‰πé‰πéÁöÑ„ÄÇ"}, {"type": "transfer", "amount": 520, "note": "‰∏ÄÂë®Âπ¥Âø´‰πê"}, {"type": "update_poke_suffix", "suffix": "ÁöÑÂ∞èËÑ∏Ëõã"}, {"type": "recalled_message", "content": "ÊàëÊÉ≥‰Ω†‰∫Ü„ÄÇ"}]\n\nÁé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏äÁöÑËßÑÂàôÂíå‰∏ãÈù¢ÁöÑÂØπËØùÂéÜÂè≤ÔºåÁªßÁª≠ËøõË°åÂØπËØù„ÄÇ`;
                } 
                messagesPayload = historySlice.map(msg => { 
                    if (msg.type === 'user_photo') { 
                        return { role: 'user', content: `[‰Ω†Êî∂Âà∞‰∫Ü‰∏ÄÂº†Áî®Êà∑ÊèèËø∞ÁöÑÁÖßÁâáÔºåÁÖßÁâáÂÜÖÂÆπÊòØÔºö'${msg.content}']` }; 
                    } 
                    if (msg.type === 'ai_image') { 
                        if(msg.role === 'user') return {role: 'user', content: '[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá]' }; 
                        else return { role: 'assistant', content: `[‰Ω†ÂêëÁî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá, ÊèèËø∞: ${msg.content}]` }; 
                    } 
                    if (msg.type === 'voice_message') { 
                        if(msg.role === 'user') return { role: 'user', content: `[Áî®Êà∑ÂèëÊù•‰∏ÄÊù°ËØ≠Èü≥Ê∂àÊÅØÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']` }; 
                        else return { role: 'assistant', content: `[‰Ω†ÂêëÁî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥Ê∂àÊÅØÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']` }; 
                    } 
                    if (msg.type === 'transfer') { 
                        if (msg.role === 'user') { 
                            return { role: 'user', content: `[‰Ω†Êî∂Âà∞‰∫ÜÊù•Ëá™Áî®Êà∑ÁöÑËΩ¨Ë¥¶: ${msg.amount}ÂÖÉ, Â§áÊ≥®: ${msg.note}]` }; 
                        } else { 
                            return { role: 'assistant', content: `[‰Ω†ÂêëÁî®Êà∑ÂèëËµ∑‰∫ÜËΩ¨Ë¥¶: ${msg.amount}ÂÖÉ, Â§áÊ≥®: ${msg.note}]` }; 
                        } 
                    } 
                    if (msg.type === 'poke') { 
                        return { role: 'user', content: `[Êà≥‰∏ÄÊà≥Âä®‰ΩúÔºö${msg.content}]` }; 
                    } 
                    if (msg.type === 'recalled_message') { 
                        return { role: 'assistant', content: `[‰Ω†Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØÔºåÂéüÊñáÔºö${msg.originalContent}]` }; 
                    }
 
                    if (typeof msg.content === 'string' || Array.isArray(msg.content)) return { role: msg.role, content: msg.content }; 
                    return null; 
                }).filter(Boolean); 
            } 
            
            try { 
                // Áªü‰∏ÄÁöÑAPIË∞ÉÁî®ÂáΩÊï∞
                async function callChatAPI(url, key, model, messages, systemPrompt) {
                    const isGemini = url.includes('generativelanguage.googleapis.com');
                    
                    if (isGemini) {
                        // Gemini API Ê†ºÂºè
                        const apiUrl = `${url}/models/${model}:generateContent?key=${key}`;
                        
                        // ËΩ¨Êç¢Ê∂àÊÅØÊ†ºÂºè‰∏∫GeminiÊ†ºÂºè
                        const geminiMessages = [];
                        
                        // Ê∑ªÂä†Á≥ªÁªüÊèêÁ§∫ËØç‰Ωú‰∏∫Á¨¨‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ
                        if (systemPrompt) {
                            geminiMessages.push({
                                role: 'user',
                                parts: [{ text: systemPrompt }]
                            });
                            geminiMessages.push({
                                role: 'model',
                                parts: [{ text: 'ÊàëÊòéÁôΩ‰∫ÜÔºåÊàë‰ºöÊåâÁÖßËøô‰∫õË¶ÅÊ±ÇËøõË°åÂØπËØù„ÄÇ' }]
                            });
                        }
                        
                        // ËΩ¨Êç¢ÂéÜÂè≤Ê∂àÊÅØ
                        for (const msg of messages) {
                            if (msg.role === 'system') continue; // Á≥ªÁªüÊ∂àÊÅØÂ∑≤Âú®‰∏äÈù¢Â§ÑÁêÜ
                            
                            const parts = [];
                            
                            if (typeof msg.content === 'string') {
                                parts.push({ text: msg.content });
                            } else if (Array.isArray(msg.content)) {
                                // Â§ÑÁêÜÂ§öÊ®°ÊÄÅÂÜÖÂÆπÔºàÂ¶ÇÂõæÁâá+ÊñáÊú¨Ôºâ
                                for (const item of msg.content) {
                                    if (item.type === 'text') {
                                        parts.push({ text: item.text });
                                    } else if (item.type === 'image_url') {
                                        const imageUrl = item.image_url.url;
                                        if (imageUrl.startsWith('data:image/')) {
                                            // Base64ÂõæÁâá
                                            const mimeMatch = imageUrl.match(/data:image\/([^;]+);base64,(.+)/);
                                            if (mimeMatch) {
                                                parts.push({
                                                    inline_data: {
                                                        mime_type: `image/${mimeMatch[1]}`,
                                                        data: mimeMatch[2]
                                                    }
                                                });
                                            }
                                        } else {
                                            // Â§ñÈÉ®ÂõæÁâáURLÔºåËΩ¨Êç¢‰∏∫ÊñáÊú¨ÊèèËø∞
                                            parts.push({ text: `[ÂõæÁâá: ${imageUrl}]` });
                                        }
                                    }
                                }
                            }
                            
                            if (parts.length > 0) {
                                geminiMessages.push({
                                    role: msg.role === 'user' ? 'user' : 'model',
                                    parts: parts
                                });
                            }
                        }
                        
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: geminiMessages,
                                generationConfig: {
                                    temperature: 0.75,
                                    maxOutputTokens: 8192
                                }
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(`Gemini API Error: ${response.status} - ${errorData.error?.message || 'Êú™Áü•ÈîôËØØ'}`);
                        }
                        
                        const data = await response.json();
                        const content = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (!content) {
                            throw new Error('Gemini APIËøîÂõû‰∫ÜÁ©∫ÂÜÖÂÆπ');
                        }
                        
                        return content;
                        
                    } else {
                        // OpenAI API Ê†ºÂºèÔºàÂåÖÊã¨Êä±ËÑ∏Á≠â‰ª£ÁêÜÔºâ
                        const response = await fetch(`${url}/v1/chat/completions`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${key}`
                            },
                            body: JSON.stringify({
                                model: model,
                                messages: [{ role: 'system', content: systemPrompt }, ...messages],
                                temperature: 0.75,
                                stream: false
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(`API Error: ${response.status} - ${errorData.error?.message || 'Êú™Áü•ÈîôËØØ'}`);
                        }
                        
                        const data = await response.json();
                        
                        // Â¢ûÂº∫ÂØπ‰∏çÂêåAPIÂìçÂ∫îÊ†ºÂºèÁöÑÂÖºÂÆπÊÄß
                        let content = null;
                        
                        // 1. Ê†áÂáÜOpenAIÊ†ºÂºè
                        if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                            content = data.choices[0].message.content;
                        }
                        // 2. ÈÉ®ÂàÜ‰ª£ÁêÜÂèØËÉΩÁõ¥Êé•ËøîÂõûmessageÂ≠óÊÆµ
                        else if (data.message) {
                            content = data.message;
                        }
                        // 3. ÈÉ®ÂàÜ‰ª£ÁêÜÂèØËÉΩËøîÂõûtextÂ≠óÊÆµ
                        else if (data.text) {
                            content = data.text;
                        }
                        // 4. ÈÉ®ÂàÜ‰ª£ÁêÜÂèØËÉΩËøîÂõûresponseÂ≠óÊÆµ
                        else if (data.response) {
                            content = data.response;
                        }
                        // 5. ÈÉ®ÂàÜ‰ª£ÁêÜÂèØËÉΩËøîÂõûcontentÂ≠óÊÆµ
                        else if (data.content) {
                            content = data.content;
                        }
                        // 6. ÈÉ®ÂàÜ‰ª£ÁêÜÂèØËÉΩËøîÂõûresultÂ≠óÊÆµ
                        else if (data.result) {
                            content = data.result;
                        }
                        // 7. Â∞ùËØïÊü•ÊâæÁ¨¨‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤Á±ªÂûãÁöÑÂÄº
                        else {
                            console.log('ÈùûÊ†áÂáÜAPIÂìçÂ∫îÊ†ºÂºèÔºåÂ∞ùËØïÊü•ÊâæÂÜÖÂÆπ:', data);
                            // ÈÅçÂéÜÂØπË±°ÁöÑÊâÄÊúâÈîÆÔºåÊü•ÊâæÁ¨¨‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤ÂÄº
                            for (const key in data) {
                                if (typeof data[key] === 'string' && data[key].trim()) {
                                    content = data[key];
                                    console.log(`‰ΩøÁî®Â≠óÊÆµ "${key}" ‰Ωú‰∏∫ÂìçÂ∫îÂÜÖÂÆπ`);
                                    break;
                                }
                            }
                        }
                        
                        if (!content) {
                            console.error('Êó†Ê≥ïËß£ÊûêAPIÂìçÂ∫îÔºåÂÆåÊï¥ÂìçÂ∫îÊï∞ÊçÆ:', data);
                            throw new Error('APIËøîÂõû‰∫ÜÁ©∫ÂÜÖÂÆπÊàñÊó†Ê≥ïËØÜÂà´ÁöÑÊ†ºÂºè');
                        }
                        
                        return content;
                    }
                }
                
                // Ê£ÄÊü•ÊòØÂê¶Ë¢´ÂèñÊ∂à
                if (abortSignal && abortSignal.aborted) {
                    throw new Error('ËØ∑Ê±ÇË¢´ÂèñÊ∂à');
                }
                
                const aiResponseContent = await callChatAPI(proxyUrl, apiKey, model, messagesPayload, systemPrompt);
                const messagesArray = parseAiResponse(aiResponseContent); let notificationShown = false; const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId; lastAiReplyTimestamps = []; for (const msgData of messagesArray) { let aiMessage;

                // Â§ÑÁêÜÁ≥ªÁªüÊ∂àÊÅØ
                if (typeof msgData === 'object' && msgData.type === 'system_message') {
                    aiMessage = {
                        role: 'system',
                        type: 'system_message',
                        content: msgData.content,
                        timestamp: Date.now()
                    };

                    // ‰øùÂ≠òÊ∂àÊÅØÂà∞ÂéÜÂè≤ËÆ∞ÂΩï
                    chat.history.push(aiMessage);
                    await db.chats.put(chat);

                    // Â¶ÇÊûúÊ≠£Âú®Êü•ÁúãÊ≠§ËÅäÂ§©ÔºåÊòæÁ§∫Ê∂àÊÅØ
                    if (isViewingThisChat) {
                        appendMessage(aiMessage, chat);
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    continue;
                }
                // Èò≤Ê≠¢AI‰ΩøÁî®Áî®Êà∑Ë∫´‰ªΩÂèëÈÄÅ‰ªª‰ΩïÁ±ªÂûãÁöÑÊ∂àÊÅØ
                if (chat.isGroup && msgData.name) {
                    const userNickname = chat.settings.myNickname || 'Êàë';
                    if (msgData.name === userNickname || msgData.name === 'Êàë') {
                        console.warn('AIÂ∞ùËØï‰ΩøÁî®Áî®Êà∑Ë∫´‰ªΩÂèëÈÄÅÊ∂àÊÅØÔºåÂ∑≤ÈòªÊ≠¢:', msgData);
                        continue; // Ë∑≥ËøáËøôÊù°Ê∂àÊÅØ
                    }
                }
                const senderName = chat.isGroup ? (msgData.name || 'Êú™Áü•') : chat.name; const receiverName = chat.isGroup ? (msgData.receiver || 'Êàë') : 'Êàë';
                if (typeof msgData === 'object' && msgData.type === 'voice_message') {
                    // Âú®Áæ§ËÅä‰∏≠È™åËØÅËßíËâ≤Ë∫´‰ªΩ
                    if (chat.isGroup && msgData.name) {
                        const memberExists = chat.members.some(m => m.name === msgData.name);
                        if (!memberExists) {
                            console.warn(`AIÂ∞ùËØï‰ΩøÁî®‰∏çÂ≠òÂú®ÁöÑËßíËâ≤Ë∫´‰ªΩÂèëÈÄÅËØ≠Èü≥Ê∂àÊÅØ: ${msgData.name}ÔºåÂ∑≤ÈòªÊ≠¢`);
                            continue;
                        }
                    }
                    aiMessage = { role: 'assistant', type: 'voice_message', content: msgData.content, senderName: senderName, timestamp: Date.now() };
                } else if (typeof msgData === 'object' && msgData.type === 'ai_image') {
                    // Âú®Áæ§ËÅä‰∏≠È™åËØÅËßíËâ≤Ë∫´‰ªΩ
                    if (chat.isGroup && msgData.name) {
                        const memberExists = chat.members.some(m => m.name === msgData.name);
                        if (!memberExists) {
                            console.warn(`AIÂ∞ùËØï‰ΩøÁî®‰∏çÂ≠òÂú®ÁöÑËßíËâ≤Ë∫´‰ªΩÂèëÈÄÅÂõæÁâá: ${msgData.name}ÔºåÂ∑≤ÈòªÊ≠¢`);
                            continue;
                        }
                    }
                    aiMessage = { role: 'assistant', type: 'ai_image', content: msgData.description, senderName: senderName, timestamp: Date.now() };
                } else if (typeof msgData === 'object' && msgData.type === 'change_avatar') {
                    // Â§ÑÁêÜAIÊõ¥Êç¢Â§¥ÂÉè
                    if (msgData.avatar_url) {
                        // Â§ÑÁêÜÁâπÊÆäÊ†áËØÜÁ¨¶USER_UPLOADED_IMAGE
                        let finalAvatarUrl = msgData.avatar_url;
                        if (msgData.avatar_url === 'USER_UPLOADED_IMAGE' && recentUserUploadedImage) {
                            finalAvatarUrl = recentUserUploadedImage;
                        }

                        chat.settings.aiAvatar = finalAvatarUrl;
                        await db.chats.put(chat);

                        // Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØÊèêÁ§∫Â§¥ÂÉèÊõ¥Êç¢
                        aiMessage = {
                            role: 'assistant',
                            type: 'system_message',
                            content: `[Êõ¥Êç¢‰∫ÜÂ§¥ÂÉèÔºö${msgData.reason || 'ÂøÉÊÉÖÂèòÂåñ'}]`,
                            senderName: senderName,
                            timestamp: Date.now()
                        };

                        // ÈáçÊñ∞Ê∏≤ÊüìËÅäÂ§©ÁïåÈù¢‰ª•ÊòæÁ§∫Êñ∞Â§¥ÂÉè
                        renderChatInterface(chatId);

                        // Êõ¥Êñ∞ÂæÆÂçöÂ§¥ÂÉèÂíå‰∏™‰∫∫ËµÑÊñô
                        if (chat.settings.aiSignature !== msgData.signature && msgData.signature) {
                            chat.settings.aiSignature = msgData.signature;
                        }
                        await db.chats.put(chat);

                        // Êõ¥Êñ∞state‰ª•Á°Æ‰øùÂÆûÊó∂ÁîüÊïà
                        state.chats[chatId] = chat;
                    } else {
                        continue; // Â¶ÇÊûúÊ≤°ÊúâÊúâÊïàÁöÑÂ§¥ÂÉèURLÔºåË∑≥ËøáÊ≠§Ê∂àÊÅØ
                    }
                } else if (typeof msgData === 'object' && msgData.type === 'change_profile') {
                    // Â§ÑÁêÜAIÊõ¥Êç¢‰∏™‰∫∫ËµÑÊñô
                    if (msgData.signature) {
                        chat.settings.aiSignature = msgData.signature;
                    }
                    if (msgData.avatar_url) {
                        // Â§ÑÁêÜÁâπÊÆäÊ†áËØÜÁ¨¶USER_UPLOADED_IMAGE
                        let finalAvatarUrl = msgData.avatar_url;
                        if (msgData.avatar_url === 'USER_UPLOADED_IMAGE' && recentUserUploadedImage) {
                            finalAvatarUrl = recentUserUploadedImage;
                        }
                        chat.settings.aiAvatar = finalAvatarUrl;
                    }
                    await db.chats.put(chat);

                    // Êõ¥Êñ∞state‰ª•Á°Æ‰øùÂÆûÊó∂ÁîüÊïà
                    state.chats[chatId] = chat;

                    // Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØÊèêÁ§∫ËµÑÊñôÊõ¥Êç¢
                    aiMessage = {
                        role: 'assistant',
                        type: 'system_message',
                        content: `[Êõ¥Êñ∞‰∫Ü‰∏™‰∫∫ËµÑÊñô]`,
                        senderName: senderName,
                        timestamp: Date.now()
                    };

                    // ÈáçÊñ∞Ê∏≤ÊüìËÅäÂ§©ÁïåÈù¢
                    renderChatInterface(chatId);
                } else if (typeof msgData === 'object' && msgData.type === 'transfer') { 
                    aiMessage = { 
                        role: 'assistant', 
                        type: 'transfer', 
                        amount: msgData.amount, 
                        note: msgData.note, 
                        senderName: senderName, 
                        receiverName: receiverName, 
                        timestamp: Date.now() 
                    };
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊúâÁî®Êà∑ÂèëÁªôAIÁöÑËΩ¨Ë¥¶ÈúÄË¶ÅËá™Âä®Êé•Âèó
                    const userTransfers = chat.history.filter(msg => 
                        msg.role === 'user' && 
                        msg.type === 'transfer' && 
                        !msg.status
                    );
                    
                    // Â¶ÇÊûúÊúâÊú™Â§ÑÁêÜÁöÑÁî®Êà∑ËΩ¨Ë¥¶ÔºåAIËá™Âä®Êé•ÂèóÁ¨¨‰∏Ä‰∏™
                    if (userTransfers.length > 0) {
                        const userTransfer = userTransfers[0];
                        
                        // Âú®ÂéÜÂè≤ËÆ∞ÂΩï‰∏≠ÊâæÂà∞Ëøô‰∏™ËΩ¨Ë¥¶Âπ∂Êõ¥Êñ∞Áä∂ÊÄÅ
                        const transferIndex = chat.history.findIndex(msg => 
                            msg.timestamp === userTransfer.timestamp);
                            
                        if (transferIndex !== -1) {
                            chat.history[transferIndex].status = 'accepted';
                            
                            // Ê∑ªÂä†‰∏ÄÊù°Á≥ªÁªüÊ∂àÊÅØÔºåË°®Á§∫AIÂ∑≤Êî∂Ê¨æ
                            const systemMsg = {
                                role: 'system',
                                type: 'system_message',
                                content: `[${senderName}Â∑≤Êî∂Ê¨æ ¬•${Number(userTransfer.amount).toFixed(2)}]`,
                                timestamp: Date.now() - 1000 // Á®çÊó©‰∫éÂΩìÂâçÊ∂àÊÅØ
                            };
                            
                            chat.history.push(systemMsg);
                        }
                    }
                } else if (typeof msgData === 'object' && msgData.type === 'update_poke_suffix') {
                    // Â§ÑÁêÜAIÊõ¥Êñ∞Êà≥‰∏ÄÊà≥ÂêéÁºÄ
                    if (msgData.suffix && msgData.suffix.trim()) {
                        chat.settings.aiPokeSuffix = msgData.suffix.trim();
                        await db.chats.put(chat);
                        state.chats[chatId] = chat;
                        
                        // Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØÊèêÁ§∫
                        aiMessage = { 
                            role: 'assistant', 
                            type: 'system_message',
                            content: `[Êõ¥Êñ∞‰∫ÜÊà≥‰∏ÄÊà≥ÂêéÁºÄ‰∏∫"${msgData.suffix}"]`, 
                            senderName: senderName, 
                            timestamp: Date.now() 
                        };
                    } else {
                        continue; // Â¶ÇÊûúÊ≤°ÊúâÊúâÊïàÁöÑÂêéÁºÄÔºåË∑≥ËøáÊ≠§Ê∂àÊÅØ
                    }
                } else if (typeof msgData === 'object' && msgData.type === 'recalled_message') {
                    // Â§ÑÁêÜAIÊí§ÂõûÊ∂àÊÅØ
                    if (msgData.content) {
                        const recallSenderName = chat.isGroup ? (msgData.name || senderName) : senderName;
                        handleRecalledMessage(msgData.content, chat, recallSenderName);
                        continue; // Êí§ÂõûÊ∂àÊÅØÂ∑≤ÁªèÁî±handleRecalledMessageÂ§ÑÁêÜÔºåË∑≥ËøáÂêéÁª≠Â§ÑÁêÜ
                    } else {
                        continue; // Â¶ÇÊûúÊ≤°ÊúâÊúâÊïàÁöÑÊ∂àÊÅØÂÜÖÂÆπÔºåË∑≥ËøáÊ≠§Ê∂àÊÅØ
                    } 
                } else if(chat.isGroup) { 
                    if (typeof msgData === 'object' && msgData.name && msgData.message) {
                        // È™åËØÅËßíËâ≤ÊòØÂê¶Â≠òÂú®‰∫éÁæ§ÊàêÂëòÂàóË°®‰∏≠
                        const memberExists = chat.members.some(m => m.name === msgData.name);
                        if (!memberExists) {
                            console.warn(`AIÂ∞ùËØï‰ΩøÁî®‰∏çÂ≠òÂú®ÁöÑËßíËâ≤Ë∫´‰ªΩÂèëÈÄÅÊ∂àÊÅØ: ${msgData.name}ÔºåÂ∑≤ÈòªÊ≠¢`);
                            continue; // Ë∑≥Ëøá‰∏çÂ≠òÂú®ÁöÑËßíËâ≤
                        }
                        aiMessage = { role: 'assistant', senderName: msgData.name, content: String(msgData.message), timestamp: Date.now() };
                    } else if (typeof msgData === 'object' && msgData.name && msgData.type === 'change_avatar') {
                        // Áæ§ËÅä‰∏≠ÊàêÂëòÊõ¥Êç¢Â§¥ÂÉè
                        const member = chat.members.find(m => m.name === msgData.name);
                        if (member && msgData.avatar_url) {
                            // Â§ÑÁêÜÁâπÊÆäÊ†áËØÜÁ¨¶USER_UPLOADED_IMAGE
                            let finalAvatarUrl = msgData.avatar_url;
                            if (msgData.avatar_url === 'USER_UPLOADED_IMAGE' && recentUserUploadedImage) {
                                finalAvatarUrl = recentUserUploadedImage;
                            }
                            
                            member.avatar = finalAvatarUrl;
                            await db.chats.put(chat);
                            state.chats[chatId] = chat;
                            
                            aiMessage = { 
                                role: 'assistant', 
                                type: 'system_message',
                                content: `[${msgData.name} Êõ¥Êç¢‰∫ÜÂ§¥ÂÉèÔºö${msgData.reason || 'ÂøÉÊÉÖÂèòÂåñ'}]`, 
                                senderName: msgData.name, 
                                timestamp: Date.now() 
                            };
                            renderChatInterface(chatId);
                        } else {
                            continue;
                        }
                    } else if (typeof msgData === 'object' && msgData.name && msgData.type === 'change_profile') {
                        // Áæ§ËÅä‰∏≠ÊàêÂëòÊõ¥Êç¢‰∏™‰∫∫ËµÑÊñô
                        const member = chat.members.find(m => m.name === msgData.name);
                        if (member) {
                            if (msgData.avatar_url) {
                                // Â§ÑÁêÜÁâπÊÆäÊ†áËØÜÁ¨¶USER_UPLOADED_IMAGE
                                let finalAvatarUrl = msgData.avatar_url;
                                if (msgData.avatar_url === 'USER_UPLOADED_IMAGE' && recentUserUploadedImage) {
                                    finalAvatarUrl = recentUserUploadedImage;
                                }
                                member.avatar = finalAvatarUrl;
                            }
                            if (msgData.signature) member.signature = msgData.signature;
                            await db.chats.put(chat);
                            state.chats[chatId] = chat;
                            
                            aiMessage = { 
                                role: 'assistant', 
                                type: 'system_message',
                                content: `[${msgData.name} Êõ¥Êñ∞‰∫Ü‰∏™‰∫∫ËµÑÊñô]`, 
                                senderName: msgData.name, 
                                timestamp: Date.now() 
                            };
                            renderChatInterface(chatId);
                        } else {
                            continue;
                        }
                    } else {
                        continue;
                    }
                } else {
                    aiMessage = { role: 'assistant', content: String(msgData), timestamp: Date.now() };
                }

                // ‰øùÂ≠òÊ∂àÊÅØÂà∞ÂéÜÂè≤ËÆ∞ÂΩï
                chat.history.push(aiMessage);
                await db.chats.put(chat);

                // Â¶ÇÊûúÊ≠£Âú®Êü•ÁúãÊ≠§ËÅäÂ§©ÔºåÊòæÁ§∫Ê∂àÊÅØ
                if (isViewingThisChat) {
                    appendMessage(aiMessage, chat);
                    // ‰∏∫ÊØèÊù°Ê∂àÊÅØÊ∑ªÂä†Âª∂ËøüÔºåÊ®°ÊãüÁúüÂÆûÁöÑÂèëÈÄÅÈó¥Èöî
                    await new Promise(resolve => setTimeout(resolve, Math.random() * 1200 + 800));
                }

                // Â¶ÇÊûú‰∏çÂú®Êü•ÁúãÊ≠§ËÅäÂ§©‰∏îËøòÊ≤°ÊòæÁ§∫ÈÄöÁü•ÔºåÊòæÁ§∫ÈÄöÁü•
                if (!isViewingThisChat && !notificationShown) {
                    let notificationText;
                    if(aiMessage.type === 'transfer') {
                        notificationText = `[Êî∂Âà∞‰∏ÄÁ¨îËΩ¨Ë¥¶]`;
                    } else if(aiMessage.type === 'ai_image') {
                        notificationText = `[ÂõæÁâá]`;
                    } else if(aiMessage.type === 'voice_message') {
                        notificationText = `[ËØ≠Èü≥]`;
                    } else {
                        notificationText = STICKER_REGEX.test(aiMessage.content) ? '[Ë°®ÊÉÖ]' : String(aiMessage.content);
                    }

                    const finalNotifText = chat.isGroup ? `${aiMessage.senderName}: ${notificationText}` : notificationText;
                    showNotification(chatId, finalNotifText);
                    notificationShown = true;
                } } } catch (error) { const errorContent = `[Âá∫Èîô‰∫Ü: ${error.message}]`; const errorMessage = { role: 'assistant', content: errorContent, timestamp: Date.now() }; chat.history.push(errorMessage); await db.chats.put(chat); appendMessage(errorMessage, chat); } finally { document.getElementById('typing-indicator').style.display = 'none'; renderChatList(); } }
        async function sendSticker(sticker) { 
            if (!state.activeChatId) return; 
            const chat = state.chats[state.activeChatId]; 
            
            // ‰ΩøÁî®Â§öÊ®°ÊÄÅÊ†ºÂºèÔºåËÆ©AIËÉΩÂ§üËØÜÂà´Ë°®ÊÉÖÂåÖÂõæÁâáÂÜÖÂÆπ
            const msg = { 
                role: 'user', 
                content: [
                    { type: 'image_url', image_url: { url: sticker.url } },
                    { type: 'text', text: `[Ë°®ÊÉÖÂåÖÔºö"${sticker.name}"]` }
                ], 
                meaning: sticker.name, 
                timestamp: Date.now() 
            }; 
            
            chat.history.push(msg); 
            await db.chats.put(chat); 
            appendMessage(msg, chat); 
            renderChatList(); 
            document.getElementById('sticker-panel').classList.remove('visible'); 
        }
        async function sendUserTransfer() { 
            if (!state.activeChatId) return; 
            const amountInput = document.getElementById('transfer-amount'); 
            const noteInput = document.getElementById('transfer-note'); 
            const amount = parseFloat(amountInput.value); 
            const note = noteInput.value.trim(); 
            
            if (isNaN(amount) || amount < 0 || amount > 1000000000) {
                alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈáëÈ¢ù (0 Âà∞ 1000000000 ‰πãÈó¥)ÔºÅ');
                return;
            }
            
            const chat = state.chats[state.activeChatId]; 
            const senderName = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë'; 
            const receiverName = chat.isGroup ? 'Áæ§ËÅä' : chat.name; 
            
            const msg = { 
                role: 'user', 
                type: 'transfer', 
                amount: amount, 
                note: note, 
                senderName, 
                receiverName, 
                timestamp: Date.now() 
            }; 
            
            chat.history.push(msg); 
            await db.chats.put(chat); 
            appendMessage(msg, chat); 
            renderChatList(); 
            
            document.getElementById('transfer-modal').classList.remove('visible'); 
            amountInput.value = ''; 
            noteInput.value = ''; 
            
            // Âú®‰∏ã‰∏ÄÊ¨°AIÂõûÂ§çÊó∂ÔºåAI‰ºöËá™Âä®Êé•ÂèóËΩ¨Ë¥¶
        }
        
        // ÊòæÁ§∫ËΩ¨Ë¥¶Á°ÆËÆ§ÂØπËØùÊ°Ü
        function showTransferConfirmDialog(transferMsg) {
            if (!transferMsg || transferMsg.status) return;
            
            const modal = document.getElementById('transfer-confirm-modal');
            const amountEl = modal.querySelector('.transfer-confirm-amount');
            const noteEl = modal.querySelector('.transfer-confirm-note');
            
            // ËÆæÁΩÆËΩ¨Ë¥¶‰ø°ÊÅØ
            amountEl.textContent = `¬• ${Number(transferMsg.amount).toFixed(2)}`;
            noteEl.textContent = `Â§áÊ≥®Ôºö${transferMsg.note || 'Êó†'}`;
            
            // Â≠òÂÇ®ÂΩìÂâçÂ§ÑÁêÜÁöÑËΩ¨Ë¥¶‰ø°ÊÅØ
            currentTransferMsg = transferMsg;
            
            // ÊòæÁ§∫ÂØπËØùÊ°Ü
            modal.classList.add('visible');
        }
        
        // Â§ÑÁêÜËΩ¨Ë¥¶Êé•Âèó
        async function acceptTransfer() {
            if (!currentTransferMsg || !state.activeChatId) return;
            
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
            
            // Âú®ÂéÜÂè≤ËÆ∞ÂΩï‰∏≠ÊâæÂà∞ÂØπÂ∫îÁöÑËΩ¨Ë¥¶Ê∂àÊÅØÂπ∂Êõ¥Êñ∞Áä∂ÊÄÅ
            const transferIndex = chat.history.findIndex(msg => 
                msg.timestamp === currentTransferMsg.timestamp);
                
            if (transferIndex !== -1) {
                // Êõ¥Êñ∞ËΩ¨Ë¥¶Áä∂ÊÄÅ
                chat.history[transferIndex].status = 'accepted';
                
                // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                await db.chats.put(chat);
                
                // ÈáçÊñ∞Ê∏≤ÊüìËÅäÂ§©ÁïåÈù¢
                renderChatInterface(state.activeChatId);
                
                // Ê∑ªÂä†‰∏ÄÊù°Á≥ªÁªüÊ∂àÊÅØÔºåË°®Á§∫Â∑≤Êî∂Ê¨æ
                const systemMsg = {
                    role: 'system',
                    type: 'system_message',
                    content: `[‰Ω†Â∑≤Á°ÆËÆ§Êî∂Ê¨æ ¬•${Number(currentTransferMsg.amount).toFixed(2)}]`,
                    timestamp: Date.now()
                };
                
                chat.history.push(systemMsg);
                await db.chats.put(chat);
                appendMessage(systemMsg, chat);
            }
            
            // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
            document.getElementById('transfer-confirm-modal').classList.remove('visible');
            currentTransferMsg = null;
        }
        
        // Â§ÑÁêÜËΩ¨Ë¥¶ÊãíÁªù
        async function rejectTransfer() {
            if (!currentTransferMsg || !state.activeChatId) return;
            
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
            
            // Âú®ÂéÜÂè≤ËÆ∞ÂΩï‰∏≠ÊâæÂà∞ÂØπÂ∫îÁöÑËΩ¨Ë¥¶Ê∂àÊÅØÂπ∂Êõ¥Êñ∞Áä∂ÊÄÅ
            const transferIndex = chat.history.findIndex(msg => 
                msg.timestamp === currentTransferMsg.timestamp);
                
            if (transferIndex !== -1) {
                // Êõ¥Êñ∞ËΩ¨Ë¥¶Áä∂ÊÄÅ
                chat.history[transferIndex].status = 'rejected';
                
                // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                await db.chats.put(chat);
                
                // ÈáçÊñ∞Ê∏≤ÊüìËÅäÂ§©ÁïåÈù¢
                renderChatInterface(state.activeChatId);
                
                // Ê∑ªÂä†‰∏ÄÊù°Á≥ªÁªüÊ∂àÊÅØÔºåË°®Á§∫Â∑≤ÈÄÄÂõû
                const systemMsg = {
                    role: 'system',
                    type: 'system_message',
                    content: `[‰Ω†Â∑≤ÈÄÄÂõû ¬•${Number(currentTransferMsg.amount).toFixed(2)}]`,
                    timestamp: Date.now()
                };
                
                chat.history.push(systemMsg);
                await db.chats.put(chat);
                appendMessage(systemMsg, chat);
            }
            
            // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
            document.getElementById('transfer-confirm-modal').classList.remove('visible');
            currentTransferMsg = null;
        }
        
        // ÂÖ®Â±ÄÂèòÈáèÔºåÁî®‰∫éÂ≠òÂÇ®ÂΩìÂâçÊ≠£Âú®Â§ÑÁêÜÁöÑËΩ¨Ë¥¶Ê∂àÊÅØ
        let currentTransferMsg = null;
        
        // ÂÖ®Â±ÄÂèòÈáèÔºåÁî®‰∫éÂ≠òÂÇ®Áî®Êà∑ÊúÄËøë‰∏ä‰º†ÁöÑÂõæÁâá
        let recentUserUploadedImage = null;
        
        async function handlePoke(isUser, chat, senderName) {
            if (!state.activeChatId) return;
            
            let pokeSuffix = '';
            let pokeMessage = '';
            
            if (isUser) {
                // ÁÇπÂáªÁî®Êà∑Â§¥ÂÉèÔºåAIÊà≥Áî®Êà∑
                pokeSuffix = chat.settings.myPokeSuffix || 'ÁöÑËÑëË¢ã';
                pokeMessage = chat.isGroup ? 
                    `${senderName}Êà≥‰∫ÜÊà≥‰Ω†${pokeSuffix}` : 
                    `${chat.name}Êà≥‰∫ÜÊà≥‰Ω†${pokeSuffix}`;
            } else {
                // ÁÇπÂáªAIÂ§¥ÂÉèÔºåÁî®Êà∑Êà≥AI
                pokeSuffix = chat.settings.aiPokeSuffix || 'ÁöÑËÑ∏Ëõã';
                if (chat.isGroup && senderName) {
                    pokeMessage = `‰Ω†Êà≥‰∫ÜÊà≥${senderName}${pokeSuffix}`;
                } else {
                    pokeMessage = `‰Ω†Êà≥‰∫ÜÊà≥${chat.name}${pokeSuffix}`;
                }
            }
            
            const pokeMsg = {
                type: 'poke',
                content: pokeMessage,
                timestamp: Date.now()
            };
            
            chat.history.push(pokeMsg);
            await db.chats.put(chat);
            appendMessage(pokeMsg, chat);
            
            // Â¶ÇÊûúÁî®Êà∑Êà≥‰∫ÜAIÔºåAIÊúâ40%Ê¶ÇÁéáÂõûÊà≥
            if (!isUser && Math.random() < 0.4) {
                setTimeout(async () => {
                    const aiPokeSuffix = chat.settings.myPokeSuffix || 'ÁöÑÈºªÂ≠ê';
                    const aiPokeMessage = chat.isGroup ? 
                        `${senderName || chat.name}‰πüÊà≥‰∫ÜÊà≥‰Ω†${aiPokeSuffix}` : 
                        `${chat.name}‰πüÊà≥‰∫ÜÊà≥‰Ω†${aiPokeSuffix}`;
                    
                    const aiPokeMsg = {
                        type: 'poke',
                        content: aiPokeMessage,
                        timestamp: Date.now()
                    };
                    
                    chat.history.push(aiPokeMsg);
                    await db.chats.put(chat);
                    appendMessage(aiPokeMsg, chat);
                }, Math.random() * 2000 + 500); // 0.5-2.5ÁßíÈöèÊú∫Âª∂Ëøü
            }
        }
        
        // Â§ÑÁêÜÊ∂àÊÅØÊí§Âõû
        async function handleRecalledMessage(messageContent, chat, senderName = null) {
            if (!chat) return;
            
            // ÂÖàÊòæÁ§∫ÂéüÂßãÊ∂àÊÅØ
            if (state.activeChatId === chat.id) {
                // ÂàõÂª∫‰∏¥Êó∂Ê∂àÊÅØÂÖÉÁ¥†
                const messagesContainer = document.getElementById('chat-messages');
                const typingIndicator = document.getElementById('typing-indicator');
                
                // ÂàõÂª∫Ê∂àÊÅØÂåÖË£ÖÂô®
                const wrapper = document.createElement('div');
                wrapper.className = 'message-wrapper ai';
                
                // ÂàõÂª∫Ê∂àÊÅØÊ∞îÊ≥°
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble ai';
                const timestamp = Date.now();
                bubble.dataset.timestamp = timestamp;
                
                // ÂàõÂª∫Â§¥ÂÉèÁªÑ
                const avatarGroup = document.createElement('div');
                avatarGroup.className = 'avatar-group';
                
                // ÂàõÂª∫Â§¥ÂÉè - Ê†πÊçÆÂèëÈÄÅËÄÖÁ°ÆÂÆöÂ§¥ÂÉè
                const avatar = document.createElement('img');
                avatar.className = 'avatar';
                
                if (chat.isGroup && senderName) {
                    // Áæ§ËÅä‰∏≠ÊâæÂà∞ÂØπÂ∫îÊàêÂëòÁöÑÂ§¥ÂÉè
                    const member = chat.members.find(m => m.name === senderName);
                    avatar.src = member?.avatar || defaultAvatar;
                } else {
                    // ÂçïËÅäÊàñÊ≤°ÊúâÊåáÂÆöÂèëÈÄÅËÄÖÔºå‰ΩøÁî®AIÂ§¥ÂÉè
                    avatar.src = chat.settings.aiAvatar || defaultAvatar;
                }
                
                avatarGroup.appendChild(avatar);
                
                // ÂàõÂª∫Êó∂Èó¥Êà≥
                const timestampEl = document.createElement('span');
                timestampEl.className = 'timestamp';
                timestampEl.textContent = formatTimestamp(timestamp);
                avatarGroup.appendChild(timestampEl);
                
                // ÂàõÂª∫ÂÜÖÂÆπ
                const content = document.createElement('div');
                content.className = 'content';
                content.textContent = messageContent;
                
                // ÁªÑË£ÖÊ∂àÊÅØ
                bubble.appendChild(avatarGroup);
                bubble.appendChild(content);
                wrapper.appendChild(bubble);
                
                // Ê∑ªÂä†Âà∞Ê∂àÊÅØÂÆπÂô®
                messagesContainer.insertBefore(wrapper, typingIndicator);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Á≠âÂæÖ‰∏ÄÂ∞èÊÆµÊó∂Èó¥Âêé"Êí§Âõû"
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Ê∑ªÂä†Ê∑°Âá∫Âä®Áîª
                wrapper.style.animation = 'fadeOut 0.5s ease-in-out forwards';
                
                // Á≠âÂæÖÂä®ÁîªÂÆåÊàêÂêéÁßªÈô§‰∏¥Êó∂Ê∂àÊÅØ
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // ÂàõÂª∫Êí§ÂõûÊ∂àÊÅØÂÖÉÁ¥†
                const recallElement = document.createElement('div');
                recallElement.className = 'recalled-message';
                const displayName = chat.isGroup && senderName ? senderName : (chat.name || 'ÂØπÊñπ');
                recallElement.textContent = `${displayName}Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ`;
                recallElement.dataset.timestamp = Date.now();
                
                // Â¶ÇÊûúÊúâÂéüÂßãÊ∂àÊÅØÂÜÖÂÆπÔºåÊòæÁ§∫ÂéüÊñá
                if (messageContent) {
                    const originalText = document.createElement('div');
                    originalText.textContent = `ÂéüÊñáÔºö${messageContent}`;
                    originalText.style.cssText = `
                        color: #999;
                        font-size: 12px;
                        text-align: center;
                        margin-top: 4px;
                    `;
                    recallElement.appendChild(originalText);
                }
                
                // ÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑÂåÖË£ÖÂô®Êù•ÂåÖÂê´Êí§ÂõûÊ∂àÊÅØ
                const recallWrapper = document.createElement('div');
                recallWrapper.className = 'message-wrapper system';
                recallWrapper.appendChild(recallElement);
                
                // Âú®ÂéüÊ∂àÊÅØÁöÑ‰ΩçÁΩÆÊèíÂÖ•Êí§ÂõûÊèêÁ§∫
                const parent = wrapper.parentNode;
                if (parent) {
                    parent.insertBefore(recallWrapper, wrapper);
                    wrapper.remove();
                }
                
                // Ê∑ªÂä†Âà∞ËÅäÂ§©ÂéÜÂè≤
                const recalledMsg = {
                    role: 'assistant',
                    type: 'recalled_message',
                    originalContent: messageContent,
                    senderName: senderName || (chat.isGroup ? 'Êú™Áü•' : chat.name),
                    timestamp: Date.now(),
                    originalTimestamp: timestamp // ‰øùÂ≠òÂéüÂßãÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥
                };
                
                chat.history.push(recalledMsg);
                await db.chats.put(chat);
                
                // Êõ¥Êñ∞ËÅäÂ§©ÂàóË°®
                renderChatList();
                return;
            }
            
            // Â¶ÇÊûú‰∏çÊòØÂΩìÂâçËÅäÂ§©ÔºåÂè™Ê∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
            const recalledMsg = {
                role: 'assistant',
                type: 'recalled_message',
                originalContent: messageContent,
                senderName: senderName || (chat.isGroup ? 'Êú™Áü•' : chat.name),
                timestamp: Date.now(),
                originalTimestamp: Date.now() - 1000 // ‰∏∫ÈùûÂÆûÊó∂Êí§ÂõûÊ∑ªÂä†‰∏Ä‰∏™‰º∞ËÆ°ÁöÑÂéüÂßãÊó∂Èó¥Êà≥
            };
            
            // Ê∑ªÂä†Âà∞ËÅäÂ§©ÂéÜÂè≤
            chat.history.push(recalledMsg);
            await db.chats.put(chat);
            
            // Êõ¥Êñ∞ËÅäÂ§©ÂàóË°®
            renderChatList();
        }
        
        // Ê∑ªÂä†Ê∑°Âá∫Âä®ÁîªÊ†∑Âºè
        const fadeOutStyle = document.createElement('style');
        fadeOutStyle.textContent = `
            @keyframes fadeOut {
                0% { opacity: 1; transform: translateY(0); }
                100% { opacity: 0; transform: translateY(10px); }
            }
        `;
        document.head.appendChild(fadeOutStyle);
        
        // @È´ò‰∫ÆÊòæÁ§∫ÂáΩÊï∞
        function highlightMentions(content, chat) {
            let highlightedContent = content;
            
            // Ëé∑ÂèñÊâÄÊúâÁæ§ÊàêÂëòÂêçÂ≠óÔºàÂåÖÊã¨Áî®Êà∑ÊòµÁß∞Ôºâ
            const allMembers = [...chat.members];
            const userNickname = chat.settings.myNickname || 'Êàë';
            allMembers.push({ name: userNickname });
            
            // ‰∏∫ÊØè‰∏™ÊàêÂëòÂêçÂ≠óÊ∑ªÂä†È´ò‰∫Æ
            allMembers.forEach(member => {
                const mentionPattern = new RegExp(`@${member.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}(?=\\s|$|<br>|&nbsp;)`, 'g');
                highlightedContent = highlightedContent.replace(mentionPattern, `<span class="mention-tag">@${member.name}</span>`);
            });
            
            return highlightedContent;
        }
        function enterSelectionMode(initialMsgTimestamp) { if (isSelectionMode) return; isSelectionMode = true; document.getElementById('chat-interface-screen').classList.add('selection-mode'); toggleMessageSelection(initialMsgTimestamp); }
        function exitSelectionMode() { if (!isSelectionMode) return; isSelectionMode = false; document.getElementById('chat-interface-screen').classList.remove('selection-mode'); selectedMessages.forEach(ts => { const bubble = document.querySelector(`.message-bubble[data-timestamp="${ts}"]`); if (bubble) bubble.classList.remove('selected'); }); selectedMessages.clear(); }
        function toggleMessageSelection(timestamp) { const bubble = document.querySelector(`.message-bubble[data-timestamp="${timestamp}"]`); if (!bubble) return; if (selectedMessages.has(timestamp)) { selectedMessages.delete(timestamp); bubble.classList.remove('selected'); } else { selectedMessages.add(timestamp); bubble.classList.add('selected'); } document.getElementById('selection-count').textContent = `Â∑≤ÈÄâ ${selectedMessages.size} Êù°`; if (selectedMessages.size === 0) exitSelectionMode(); }
        function addLongPressListener(element, callback) { let pressTimer; const startPress = (e) => { if(isSelectionMode) return; e.preventDefault(); pressTimer = window.setTimeout(() => callback(e), 500); }; const cancelPress = () => clearTimeout(pressTimer); element.addEventListener('mousedown', startPress); element.addEventListener('mouseup', cancelPress); element.addEventListener('mouseleave', cancelPress); element.addEventListener('touchstart', startPress, { passive: true }); element.addEventListener('touchend', cancelPress); element.addEventListener('touchmove', cancelPress); }
        async function handleListenTogetherClick() { const targetChatId = state.activeChatId; if (!targetChatId) return; if (!musicState.isActive) { startListenTogetherSession(targetChatId); return; } if (musicState.activeChatId === targetChatId) { document.getElementById('music-player-overlay').classList.add('visible'); } else { const oldChatName = state.chats[musicState.activeChatId]?.name || 'Êú™Áü•'; const newChatName = state.chats[targetChatId]?.name || 'ÂΩìÂâç'; const confirmed = await showCustomConfirm('ÂàáÊç¢Âê¨Ê≠åÂØπË±°', `ÊÇ®Ê≠£Âíå„Äå${oldChatName}„ÄçÂê¨Ê≠å„ÄÇË¶ÅÁªìÊùüÂπ∂ÂºÄÂßãÂíå„Äå${newChatName}„ÄçÁöÑÊñ∞‰ºöËØùÂêóÔºü`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await endListenTogetherSession(true); await new Promise(resolve => setTimeout(resolve, 50)); startListenTogetherSession(targetChatId); } } }
        async function startListenTogetherSession(chatId) { const chat = state.chats[chatId]; if (!chat) return; musicState.totalElapsedTime = chat.musicData.totalTime || 0; musicState.isActive = true; musicState.activeChatId = chatId; if (musicState.playlist.length > 0) { musicState.currentIndex = 0; } else { musicState.currentIndex = -1; } if(musicState.timerId) clearInterval(musicState.timerId); musicState.timerId = setInterval(() => { if (musicState.isPlaying) { musicState.totalElapsedTime++; updateElapsedTimeDisplay(); } }, 1000); updatePlayerUI(); updatePlaylistUI(); document.getElementById('music-player-overlay').classList.add('visible'); }
        async function endListenTogetherSession(saveState = true) { if (!musicState.isActive) return; const oldChatId = musicState.activeChatId; if (musicState.timerId) clearInterval(musicState.timerId); if (musicState.isPlaying) audioPlayer.pause(); if (saveState && oldChatId && state.chats[oldChatId]) { const chat = state.chats[oldChatId]; chat.musicData.totalTime = musicState.totalElapsedTime; await db.chats.put(chat); } musicState.isActive = false; musicState.activeChatId = null; musicState.totalElapsedTime = 0; musicState.timerId = null; document.getElementById('music-player-overlay').classList.remove('visible'); document.getElementById('music-playlist-panel').classList.remove('visible'); updateListenTogetherIcon(oldChatId, true); }
        function returnToChat() { document.getElementById('music-player-overlay').classList.remove('visible'); document.getElementById('music-playlist-panel').classList.remove('visible'); }
        function updateListenTogetherIcon(chatId, forceReset = false) { const iconImg = document.querySelector('#listen-together-btn img'); if(!iconImg) return; if(forceReset || !musicState.isActive || musicState.activeChatId !== chatId) { iconImg.src = 'https://i.postimg.cc/8kYShvrJ/90-UI-2.png'; iconImg.className = ''; return; } iconImg.src = 'https://i.postimg.cc/vBN7GnQ9/3-FC8-D1596-C5-CFB200-FCB1-D8-C3-A37-A370.png'; iconImg.classList.add('rotating'); if (musicState.isPlaying) iconImg.classList.remove('paused'); else iconImg.classList.add('paused'); }
        window.updateListenTogetherIconProxy = updateListenTogetherIcon;
        function updatePlayerUI() { updateListenTogetherIcon(musicState.activeChatId); updateElapsedTimeDisplay(); const titleEl = document.getElementById('music-player-song-title'); const artistEl = document.getElementById('music-player-artist'); const playPauseBtn = document.getElementById('music-play-pause-btn'); if (musicState.currentIndex > -1 && musicState.playlist.length > 0) { const track = musicState.playlist[musicState.currentIndex]; titleEl.textContent = track.name; artistEl.textContent = track.artist; } else { titleEl.textContent = 'ËØ∑Ê∑ªÂä†Ê≠åÊõ≤'; artistEl.textContent = '...'; } playPauseBtn.textContent = musicState.isPlaying ? '‚ùö‚ùö' : '‚ñ∂'; }
        function updateElapsedTimeDisplay() { const hours = (musicState.totalElapsedTime / 3600).toFixed(1); document.getElementById('music-time-counter').textContent = `Â∑≤Áªè‰∏ÄËµ∑Âê¨‰∫Ü${hours}Â∞èÊó∂`; }
        function updatePlaylistUI() { const playlistBody = document.getElementById('playlist-body'); playlistBody.innerHTML = ''; if (musicState.playlist.length === 0) { playlistBody.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">Êí≠ÊîæÂàóË°®ÊòØÁ©∫ÁöÑ~</p>'; return; } musicState.playlist.forEach((track, index) => { const item = document.createElement('div'); item.className = 'playlist-item'; if(index === musicState.currentIndex) item.classList.add('playing'); item.innerHTML = `<div class="playlist-item-info"><div class="title">${track.name}</div><div class="artist">${track.artist}</div></div><span class="delete-track-btn" data-index="${index}">&times;</span>`; item.querySelector('.playlist-item-info').addEventListener('click', () => playSong(index)); item.querySelector('.delete-track-btn').addEventListener('click', async (e) => { e.stopPropagation(); const confirmed = await showCustomConfirm('Âà†Èô§Ê≠åÊõ≤', `Á°ÆÂÆöË¶Å‰ªéÊí≠ÊîæÂàóË°®‰∏≠Âà†Èô§„Ää${track.name}„ÄãÂêóÔºü`); if(confirmed) deleteTrack(index); }); playlistBody.appendChild(item); }); }
        function playSong(index) { if (index < 0 || index >= musicState.playlist.length) return; musicState.currentIndex = index; const track = musicState.playlist[index]; if (track.isLocal && track.src instanceof Blob) { audioPlayer.src = URL.createObjectURL(track.src); } else if (!track.isLocal) { audioPlayer.src = track.src; } else { console.error('Êú¨Âú∞Ê≠åÊõ≤Ê∫êÈîôËØØ:', track); return; } audioPlayer.play(); updatePlaylistUI(); updatePlayerUI(); }
        function togglePlayPause() { if (audioPlayer.paused) { if (musicState.currentIndex === -1 && musicState.playlist.length > 0) { playSong(0); } else if (musicState.currentIndex > -1) { audioPlayer.play(); } } else { audioPlayer.pause(); } }
        function playNext() { if (musicState.playlist.length === 0) return; let nextIndex; switch(musicState.playMode) { case 'random': nextIndex = Math.floor(Math.random() * musicState.playlist.length); break; case 'single': playSong(musicState.currentIndex); return; case 'order': default: nextIndex = (musicState.currentIndex + 1) % musicState.playlist.length; break; } playSong(nextIndex); }
        function playPrev() { if (musicState.playlist.length === 0) return; const newIndex = (musicState.currentIndex - 1 + musicState.playlist.length) % musicState.playlist.length; playSong(newIndex); }
        function changePlayMode() { const modes = ['order', 'random', 'single']; const currentModeIndex = modes.indexOf(musicState.playMode); musicState.playMode = modes[(currentModeIndex + 1) % modes.length]; document.getElementById('music-mode-btn').textContent = {'order': 'È°∫Â∫è', 'random': 'ÈöèÊú∫', 'single': 'ÂçïÊõ≤'}[musicState.playMode]; }
        async function addSongFromURL() { const url = await showCustomPrompt("Ê∑ªÂä†ÁΩëÁªúÊ≠åÊõ≤", "ËØ∑ËæìÂÖ•Ê≠åÊõ≤ÁöÑURL", "", "url"); if (!url) return; const name = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÂêç"); if (!name) return; const artist = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÊâãÂêç"); if (!artist) return; musicState.playlist.push({ name, artist, src: url, isLocal: false }); await saveGlobalPlaylist(); updatePlaylistUI(); if(musicState.currentIndex === -1) { musicState.currentIndex = musicState.playlist.length - 1; updatePlayerUI(); } }
        async function addSongFromLocal(event) { const files = event.target.files; if (!files.length) return; for (const file of files) { const name = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÂêç", ""); if (name === null) continue; const artist = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÊâãÂêç", ""); if (artist === null) continue; musicState.playlist.push({ name, artist, src: file, isLocal: true }); } await saveGlobalPlaylist(); updatePlaylistUI(); if (musicState.currentIndex === -1 && musicState.playlist.length > 0) { musicState.currentIndex = 0; updatePlayerUI(); } event.target.value = null; }
        async function deleteTrack(index) { if (index < 0 || index >= musicState.playlist.length) return; const track = musicState.playlist[index]; const wasPlaying = musicState.isPlaying && musicState.currentIndex === index; if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src); musicState.playlist.splice(index, 1); await saveGlobalPlaylist(); if (musicState.playlist.length === 0) { if (musicState.isPlaying) audioPlayer.pause(); audioPlayer.src = ''; musicState.currentIndex = -1; musicState.isPlaying = false; } else { if (wasPlaying) { playNext(); } else { if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1); } } updatePlayerUI(); updatePlaylistUI(); }

        // --- Persona Preset functions ---
        const personaLibraryModal = document.getElementById('persona-library-modal');
        const personaEditorModal = document.getElementById('persona-editor-modal');
        const presetActionsModal = document.getElementById('preset-actions-modal');
        function openPersonaLibrary() { renderPersonaLibrary(); personaLibraryModal.classList.add('visible'); }
        function closePersonaLibrary() { personaLibraryModal.classList.remove('visible'); }
        function renderPersonaLibrary() { const grid = document.getElementById('persona-library-grid'); grid.innerHTML = ''; if (state.personaPresets.length === 0) { grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center; margin-top: 20px;">Á©∫Á©∫Â¶Ç‰πü~ ÁÇπÂáªÂè≥‰∏äËßí"Ê∑ªÂä†"Êù•ÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™‰∫∫ËÆæÈ¢ÑËÆæÂêßÔºÅ</p>'; return; } state.personaPresets.forEach(preset => { const item = document.createElement('div'); item.className = 'persona-preset-item'; item.style.backgroundImage = `url(${preset.avatar})`; item.dataset.presetId = preset.id; item.addEventListener('click', () => applyPersonaPreset(preset.id)); addLongPressListener(item, () => showPresetActions(preset.id)); grid.appendChild(item); }); }
        function showPresetActions(presetId) { editingPersonaPresetId = presetId; presetActionsModal.classList.add('visible'); }
        function hidePresetActions() { presetActionsModal.classList.remove('visible'); editingPersonaPresetId = null; }
        function applyPersonaPreset(presetId) { const preset = state.personaPresets.find(p => p.id === presetId); if (preset) { document.getElementById('my-avatar-preview').src = preset.avatar; document.getElementById('my-persona').value = preset.persona; } closePersonaLibrary(); }
        function openPersonaEditorForCreate() { editingPersonaPresetId = null; document.getElementById('persona-editor-title').textContent = 'Ê∑ªÂä†‰∫∫ËÆæÈ¢ÑËÆæ'; document.getElementById('preset-avatar-preview').src = defaultAvatar; document.getElementById('preset-persona-input').value = ''; personaEditorModal.classList.add('visible'); }
        function openPersonaEditorForEdit() { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (!preset) return; document.getElementById('persona-editor-title').textContent = 'ÁºñËæë‰∫∫ËÆæÈ¢ÑËÆæ'; document.getElementById('preset-avatar-preview').src = preset.avatar; document.getElementById('preset-persona-input').value = preset.persona; presetActionsModal.classList.remove('visible'); personaEditorModal.classList.add('visible'); }
        async function deletePersonaPreset() { const confirmed = await showCustomConfirm('Âà†Èô§È¢ÑËÆæ', 'Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰∫∫ËÆæÈ¢ÑËÆæÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ', { confirmButtonClass: 'btn-danger' }); if (confirmed && editingPersonaPresetId) { await db.personaPresets.delete(editingPersonaPresetId); state.personaPresets = state.personaPresets.filter(p => p.id !== editingPersonaPresetId); hidePresetActions(); renderPersonaLibrary(); } }
        function closePersonaEditor() { personaEditorModal.classList.remove('visible'); editingPersonaPresetId = null; }
        async function savePersonaPreset() { const avatar = document.getElementById('preset-avatar-preview').src; const persona = document.getElementById('preset-persona-input').value.trim(); if (avatar === defaultAvatar && !persona) { alert("Â§¥ÂÉèÂíå‰∫∫ËÆæ‰∏çËÉΩÈÉΩ‰∏∫Á©∫Âì¶ÔºÅ"); return; } if (editingPersonaPresetId) { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (preset) { preset.avatar = avatar; preset.persona = persona; await db.personaPresets.put(preset); } } else { const newPreset = { id: 'preset_' + Date.now(), avatar: avatar, persona: persona }; await db.personaPresets.add(newPreset); state.personaPresets.push(newPreset); } renderPersonaLibrary(); closePersonaEditor(); }

        // --- Battery Functions ---
        const batteryAlertModal = document.getElementById('battery-alert-modal');
        function showBatteryAlert(imageUrl, text) { clearTimeout(batteryAlertTimeout); document.getElementById('battery-alert-image').src = imageUrl; document.getElementById('battery-alert-text').textContent = text; batteryAlertModal.classList.add('visible'); const closeAlert = () => { batteryAlertModal.classList.remove('visible'); batteryAlertModal.removeEventListener('click', closeAlert); }; batteryAlertModal.addEventListener('click', closeAlert); batteryAlertTimeout = setTimeout(closeAlert, 2000); }
        function updateBatteryDisplay(battery) { const batteryContainer = document.getElementById('status-bar-battery'); const batteryLevelEl = batteryContainer.querySelector('.battery-level'); const batteryTextEl = batteryContainer.querySelector('.battery-text'); const level = Math.floor(battery.level * 100); batteryLevelEl.style.width = `${level}%`; batteryTextEl.textContent = `${level}%`; if (battery.charging) { batteryContainer.classList.add('charging'); } else { batteryContainer.classList.remove('charging'); } }
        function handleBatteryChange(battery) { updateBatteryDisplay(battery); const level = battery.level; if (!battery.charging) { if (level <= 0.4 && lastKnownBatteryLevel > 0.4 && !alertFlags.hasShown40) { showBatteryAlert('https://i.postimg.cc/T2yKJ0DV/40.jpg', 'ÊúâÁÇπÈ•ø‰∫ÜÔºåÂèØ‰ª•ÂéªÊâæÂÖÖÁîµÂô®ÊÉπ'); alertFlags.hasShown40 = true; } if (level <= 0.2 && lastKnownBatteryLevel > 0.2 && !alertFlags.hasShown20) { showBatteryAlert('https://i.postimg.cc/qB9zbKs9/20.jpg', 'Ëµ∂Á¥ßÁöÑÂÖÖÁîµÔºåË¶ÅÈ•øÊ≠ª‰∫Ü'); alertFlags.hasShown20 = true; } if (level <= 0.1 && lastKnownBatteryLevel > 0.1 && !alertFlags.hasShown10) { showBatteryAlert('https://i.postimg.cc/ThMMVfW4/10.jpg', 'Â∑≤Èòµ‰∫°ÔºåËøòÊúâ30ÁßíÁàÜÁÇ∏'); alertFlags.hasShown10 = true; } } if (level > 0.4) alertFlags.hasShown40 = false; if (level > 0.2) alertFlags.hasShown20 = false; if (level > 0.1) alertFlags.hasShown10 = false; lastKnownBatteryLevel = level; }
        async function initBatteryManager() { if ('getBattery' in navigator) { try { const battery = await navigator.getBattery(); lastKnownBatteryLevel = battery.level; handleBatteryChange(battery); battery.addEventListener('levelchange', () => handleBatteryChange(battery)); battery.addEventListener('chargingchange', () => { handleBatteryChange(battery); if (battery.charging) { showBatteryAlert('https://i.postimg.cc/3NDQ0dWG/image.jpg', 'Á™ùÁà±Ê≥•ÔºåÁîµÈáèÂêÉÈ•±È•±'); } }); } catch (err) { console.error("Êó†Ê≥ïËé∑ÂèñÁîµÊ±†‰ø°ÊÅØ:", err); document.querySelector('.battery-text').textContent = '·∞î·©ö'; } } else { console.log("ÊµèËßàÂô®‰∏çÊîØÊåÅÁîµÊ±†Áä∂ÊÄÅAPI„ÄÇ"); document.querySelector('.battery-text').textContent = '·∞î·©ö'; } }

        // ÈÄöËØùÂäüËÉΩÂÆûÁé∞
        function startCall(type) {
            if (!state.activeChatId) return;
            
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
            
            callState.isInCall = true;
            callState.callType = type;
            callState.activeChatId = state.activeChatId;
            callState.startTime = Date.now();
            callState.messages = [];
            callState.userInitiated = true; // Ê†áËÆ∞‰∏∫Áî®Êà∑‰∏ªÂä®ÂèëËµ∑
            
            // ËÆæÁΩÆÁïåÈù¢
            document.getElementById('call-contact-name').textContent = chat.name;
            document.getElementById('call-avatar').src = chat.settings.aiAvatar || defaultAvatar;
            
            // ÊòæÁ§∫ÈÄöËØùÁïåÈù¢
            document.getElementById('call-type-modal').classList.remove('visible');
            document.getElementById('call-overlay').classList.add('visible');
            
            // ÂºÄÂßãËÆ°Êó∂
            startCallTimer();
            
            // Ê∏ÖÁ©∫Ê∂àÊÅØÂå∫Âüü
            document.getElementById('call-messages').innerHTML = '';
        }
        
        function startCallTimer() {
            callState.timer = setInterval(() => {
                if (!callState.isInCall) return;
                
                const elapsed = Date.now() - callState.startTime;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                const timeString = 
                    String(hours).padStart(2, '0') + ':' +
                    String(minutes).padStart(2, '0') + ':' +
                    String(seconds).padStart(2, '0');
                
                document.getElementById('call-timer').textContent = timeString;
            }, 1000);
        }
        
        function endCall() {
            if (!callState.isInCall) return;
            
            callState.isInCall = false;
            clearInterval(callState.timer);
            
            // ÈöêËóèÈÄöËØùÁïåÈù¢
            document.getElementById('call-overlay').classList.remove('visible');
            document.getElementById('incoming-call-modal').classList.remove('visible');
            
            // Â∞ÜÈÄöËØùËÆ∞ÂΩïÊ∑ªÂä†Âà∞ËÅäÂ§©ÂéÜÂè≤
            if (callState.messages.length > 0) {
                addCallToHistory();
            }
            
            // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅÁî®‰∫éÁîüÊàêÂèçÂ∫î
            const currentChatId = callState.activeChatId;
            const currentCallType = callState.callType;
            const currentMessages = [...callState.messages];

            // ÈáçÁΩÆÁä∂ÊÄÅ
            callState = {
                isInCall: false,
                callType: null,
                activeChatId: null,
                startTime: null,
                timer: null,
                messages: [],
                userInitiated: false
            };

            // AIÂØπË¢´ÊåÇÊñ≠ÂÅöÂá∫ÂèçÂ∫îÔºà‰ΩøÁî®‰øùÂ≠òÁöÑÁä∂ÊÄÅÔºâ
            setTimeout(() => {
                generateCallReaction('hungup', currentChatId, currentCallType, currentMessages);
            }, Math.random() * 2000 + 1000);
        }
        
        async function addCallToHistory() {
            const chat = state.chats[callState.activeChatId];
            if (!chat) return;
            
            // ËÆ°ÁÆóÈÄöËØùÊó∂Èïø
            const callDuration = Date.now() - callState.startTime;
            const minutes = Math.floor(callDuration / 60000);
            const seconds = Math.floor((callDuration % 60000) / 1000);
            const durationText = `${minutes}ÂàÜ${seconds}Áßí`;
            
            // Â∞ÜÈÄöËØùÊ∂àÊÅØÊ∑ªÂä†Âà∞ËÅäÂ§©ËÆ∞ÂΩïÔºåËøáÊª§ÊéâÊèèÂÜôÈÉ®ÂàÜ
            for (const message of callState.messages) {
                // Ë∑≥ËøáÊèèÂÜôÈÉ®ÂàÜÔºåÂè™‰øùÂ≠òËßíËâ≤ÂíåÁî®Êà∑ÁöÑÂØπËØùÂÜÖÂÆπ
                if (message.isDescription) {
                    continue;
                }
                
                const callTypePrefix = callState.callType === 'video' ? '„ÄêËßÜÈ¢ëÈÄöËØù„Äë' : '„ÄêËØ≠Èü≥ÈÄöËØù„Äë';
                const content = `${callTypePrefix} ${message.content}`;
                
                chat.history.push({
                    role: message.role,
                    content: content,
                    timestamp: message.timestamp,
                    callType: callState.callType,
                    isCallMessage: true
                });
            }
            
            // Ê∑ªÂä†ÈÄöËØùÊó∂ÈïøÊèêÈÜí
            if (callState.messages.length > 0) {
                chat.history.push({
                    type: 'call_duration',
                    content: `ÈÄöËØùÊó∂ÈïøÔºö${durationText}`,
                    timestamp: Date.now(),
                    callType: callState.callType
                });
            }
            
            await db.chats.put(chat);
            
            // Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®Êü•ÁúãËøô‰∏™ËÅäÂ§©ÔºåÈáçÊñ∞Ê∏≤Êüì
            if (state.activeChatId === callState.activeChatId) {
                renderChatInterface(state.activeChatId);
            }
            renderChatList();
        }

        // ÊòæÁ§∫ÈÄöËØùÂä†ËΩΩÊåáÁ§∫Âô®
        function showCallTypingIndicator() {
            const messagesContainer = document.getElementById('call-messages');

            // ÂÖàÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÊåáÁ§∫Âô®ÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâ
            hideCallTypingIndicator();

            // ÂàõÂª∫Êñ∞ÁöÑÂä†ËΩΩÊåáÁ§∫Âô®
            const indicator = document.createElement('div');
            indicator.className = 'call-typing-indicator';
            indicator.id = 'call-typing-indicator';
            indicator.innerHTML = `
                <span>Ê≠£Âú®ÊÄùËÄÉ</span>
                <div class="call-typing-dots">
                    <div class="call-typing-dot"></div>
                    <div class="call-typing-dot"></div>
                    <div class="call-typing-dot"></div>
                </div>
            `;

            // Ê∑ªÂä†Âà∞Ê∂àÊÅØÂÆπÂô®ÁöÑÂ∫ïÈÉ®
            messagesContainer.appendChild(indicator);

            // ÊªöÂä®Âà∞Â∫ïÈÉ®ÊòæÁ§∫ÊåáÁ§∫Âô®
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ÈöêËóèÈÄöËØùÂä†ËΩΩÊåáÁ§∫Âô®
        function hideCallTypingIndicator() {
            const indicator = document.getElementById('call-typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function addCallMessage(role, content, isDescription = false) {
            // Â¶ÇÊûúÊòØAIÊ∂àÊÅØÔºåÂÖàÈöêËóèÂä†ËΩΩÊåáÁ§∫Âô®
            if (role === 'assistant') {
                hideCallTypingIndicator();
            }

            const message = {
                role: role,
                content: content,
                timestamp: Date.now(),
                isDescription: isDescription
            };

            callState.messages.push(message);

            // ÊòæÁ§∫Âú®ÈÄöËØùÁïåÈù¢
            const messagesContainer = document.getElementById('call-messages');
            const messageEl = document.createElement('div');

            if (isDescription) {
                messageEl.className = 'call-message description';
                messageEl.innerHTML = content; // ÂÖÅËÆ∏HTMLÊ†ºÂºèÂåñ
            } else {
                messageEl.className = `call-message ${role}`;
                messageEl.textContent = content;
            }

            messagesContainer.appendChild(messageEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        async function sendCallMessage() {
            const input = document.getElementById('call-input');
            const content = input.value.trim();
            if (!content) return;

            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
            addCallMessage('user', content);
            input.value = '';

            // ÊòæÁ§∫Âä†ËΩΩÊåáÁ§∫Âô®
            showCallTypingIndicator();

            // Ëß¶ÂèëAIÂõûÂ∫î
            setTimeout(() => {
                generateCallAiResponse(content);
            }, 1000);
        }
        
        async function generateCallAiResponse(userMessage) {
            const chat = state.chats[callState.activeChatId];
            if (!chat) return;
            
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) return;
            
            try {
                const isVideoCall = callState.callType === 'video';
                const characterName = chat ? chat.name : 'ËßíËâ≤';
                
                // Ëé∑Âèñ‰∏ä‰∏ãÊñáËÆ∞ÂøÜ
                const maxMemory = parseInt(chat.settings.maxMemory) || 10;
                const recentHistory = getHistoryByRounds(chat.history, maxMemory);
                
                // Ëé∑Âèñ‰∏ñÁïå‰π¶ÂÜÖÂÆπ
                let worldBookContent = '';
                if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
                    const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                        const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                        return worldBook && worldBook.content ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${worldBook.content}` : '';
                    }).filter(Boolean).join('');
                    if (linkedContents) {
                        worldBookContent = `\n\n# Ê†∏ÂøÉ‰∏ñÁïåËßÇËÆæÂÆö (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËÆæÂÆö)\n${linkedContents}\n`;
                    }
                }
                
                // Ëé∑ÂèñÊúÄÊñ∞ÁöÑ5Êù°ÂæÆÂçöÂä®ÊÄÅÂèäÂÖ∂ËØÑËÆ∫
                let weiboContext = '';
                try {
                    const latestPosts = await db.weiboPosts
                        .orderBy('timestamp')
                        .reverse()
                        .limit(5)
                        .toArray();
                        
                    if (latestPosts.length > 0) {
                        weiboContext = '\n\n# ÊúÄÊñ∞ÁöÑÂæÆÂçöÂä®ÊÄÅÔºàÂèØ‰Ωú‰∏∫ËØùÈ¢òÂèÇËÄÉÔºâ\n';
                        for (const post of latestPosts) {
                            const authorName = post.authorId === 'user' ? 'Áî®Êà∑' : 
                                (state.chats[post.authorId] ? state.chats[post.authorId].name : 'Êú™Áü•');
                            weiboContext += `\n[${authorName}]: ${post.content}`;
                            
                            // Ëé∑ÂèñËØ•Âä®ÊÄÅÁöÑËØÑËÆ∫
                            const comments = await db.weiboComments
                                .where('postId')
                                .equals(post.id)
                                .limit(3)
                                .toArray();
                                
                            if (comments.length > 0) {
                                weiboContext += '\n  ËØÑËÆ∫Ôºö';
                                for (const comment of comments) {
                                    const commentAuthor = comment.authorId === 'user' ? 'Áî®Êà∑' : 
                                        (state.chats[comment.authorId] ? state.chats[comment.authorId].name : 'Êú™Áü•');
                                    weiboContext += `\n    - ${commentAuthor}: ${comment.content}`;
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Ëé∑ÂèñÂæÆÂçöÂä®ÊÄÅÂ§±Ë¥•:', error);
                }
                
                // Ëé∑ÂèñÊú¨Ê¨°ÈÄöËØùÁöÑÂéÜÂè≤ËÆ∞ÂΩï
                const callHistory = callState.messages.map(msg => {
                    return {
                        role: msg.role,
                        content: msg.content
                    };
                }).slice(-5); // Âè™ÂèñÊúÄËøë5Êù°ÈÄöËØùËÆ∞ÂΩï
                
                const sceneInstructions = isVideoCall ? 
                    `\n\n# ËßÜÈ¢ëÈÄöËØùÁâπÊÆäËßÑÂàô
- ËøôÊòØËßÜÈ¢ëÈÄöËØùÔºå‰Ω†ÂèØ‰ª•ËøõË°åÂú∫ÊôØÊèèÂÜôÂíåÂä®‰ΩúÊèèÂÜô
- ‰Ω†ÁöÑÂõûÂ§çÂ∫îËØ•ÂåÖÂê´‰∏§ÈÉ®ÂàÜÔºöÂØπËØùÂÜÖÂÆπ + ÊèèÂÜôÂÜÖÂÆπ
- ÊèèÂÜôÈÉ®ÂàÜÁî®<desc>Ê†áÁ≠æÂåÖË£πÔºå‰ΩøÁî®Á¨¨‰∏â‰∫∫Áß∞ÊèèËø∞Âú∫ÊôØÂíåÂä®‰Ωú
- Âú®ÊèèÂÜô‰∏≠Áî®"${characterName}"Êù•Áß∞ÂëºËá™Â∑±ÔºåÁî®"‰Ω†"Êù•Áß∞ÂëºÁî®Êà∑
- ÊèèÂÜôË¶ÅÁîüÂä®ÂΩ¢Ë±°ÔºåËÆ©Áî®Êà∑ÊÑüÂèóÂà∞ËßÜÈ¢ëÈÄöËØùÁöÑÁúüÂÆûÊÑü
- ‰∏çË¶Å‰ΩøÁî®Êã¨Âè∑ÂåÖË£πÊèèÂÜôÈÉ®ÂàÜ
- Ê†ºÂºèÁ§∫‰æãÔºö‰Ω†Â•ΩÂïäÔºÅ<desc>Á™óÂ§ñÈò≥ÂÖâÊ≠£Â•ΩÔºå${characterName}Ê∏©ÂíåÂú∞ÁúãÁùÄÈïúÂ§¥ËøôËæπÁöÑ‰Ω†ÔºåÂò¥ËßíÂ∏¶ÁùÄÊ∑°Ê∑°ÁöÑÂæÆÁ¨ë</desc>` :
                    `\n\n# ËØ≠Èü≥ÈÄöËØùËßÑÂàô
- ËøôÊòØËØ≠Èü≥ÈÄöËØùÔºå‰Ω†‰ª¨Âú®ÂêÑËá™ÁöÑÂú∞ÊñπÈÄöËøáÊâãÊú∫ËøõË°åËøúÁ®ãÈÄöËØùÔºå‰∏çÊòØÈù¢ÂØπÈù¢
- Âè™ËÉΩËøõË°åËØ≠Èü≥ÂØπËØùÔºå‰∏çË¶ÅÊèèÂÜôÂä®‰ΩúÂíåÂú∫ÊôØÔºå‰∏çË¶ÅÂèëÂ±ïÁ∫ø‰∏ãËßÅÈù¢ÁöÑÂâßÊÉÖ
- ‰∏ìÊ≥®‰∫éËØ≠Ë®Ä‰∫§ÊµÅÔºåÂõûÂ§çË¶ÅËá™ÁÑ∂ÊµÅÁïÖ
- ÂèØ‰ª•Áî®ËØ≠Ê∞îËØçÂíåÂÅúÈ°øÊù•Ë°®ËææÊÉÖÊÑü
- ËÆ∞‰Ωè‰Ω†‰ª¨ÊòØÈÄöËøáÁîµËØù‰∫§ÊµÅÔºåÊó†Ê≥ïÁúãÂà∞ÂØπÊñπÔºå‰πü‰∏çÂú®Âêå‰∏Ä‰∏™Âú∞ÁÇπ`;
                
                const systemPrompt = `‰Ω†ÊòØ${characterName}ÔºåÊ≠£Âú®‰∏éÁî®Êà∑ËøõË°å${isVideoCall ? 'ËßÜÈ¢ë' : 'ËØ≠Èü≥'}ÈÄöËØù„ÄÇ${worldBookContent}${weiboContext}

# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºö
${chat.settings.aiPersona}

# ÈáçË¶ÅÊèêÈÜíÔºö
- ‰Ω†Áé∞Âú®Ê≠£Âú®ÈÄöËØù‰∏≠ÔºåËøôÊòØÂÆûÊó∂ÁöÑËØ≠Èü≥/ËßÜÈ¢ëÂØπËØù
- Ë¶ÅÂü∫‰∫é‰πãÂâçÁöÑËÅäÂ§©ÂéÜÂè≤ÂíåÊú¨Ê¨°ÈÄöËØùÁöÑ‰∏ä‰∏ãÊñáÊù•ÂõûÂ∫î
- ‰øùÊåÅËßíËâ≤ÁöÑËøûÁª≠ÊÄßÂíåËÆ∞ÂøÜ
- ÈÄöËØùÂ∫îËØ•ÊòØËÅäÂ§©ÁöÑËá™ÁÑ∂Âª∂Áª≠Ôºå‰∏çÊòØÂÖ®Êñ∞ÁöÑÂºÄÂßã

${sceneInstructions}

ËØ∑ÁªôÂá∫Ëá™ÁÑ∂ÁöÑÂõûÂ∫îÔºåË¶ÅÁÆÄÁü≠‰∏îÁ¨¶ÂêàÈÄöËØùÁöÑËäÇÂ•è„ÄÇ`;
                
                // ÊûÑÂª∫Ê∂àÊÅØÂéÜÂè≤ÔºåÂåÖÂê´ÊúÄËøëËÅäÂ§©ËÆ∞ÂΩïÂíåÊú¨Ê¨°ÈÄöËØùËÆ∞ÂΩï
                const messages = [
                    { role: 'system', content: systemPrompt }
                ];
                
                // Ê∑ªÂä†ÊúÄËøëÁöÑËÅäÂ§©ÂéÜÂè≤‰Ωú‰∏∫ËÉåÊôØ
                recentHistory.forEach(msg => {
                    if (msg.role === 'user') {
                        messages.push({ role: 'user', content: `[ËÅäÂ§©ÂéÜÂè≤] Áî®Êà∑ËØ¥Ôºö${msg.content}` });
                    } else if (msg.role === 'assistant') {
                        messages.push({ role: 'assistant', content: `[ËÅäÂ§©ÂéÜÂè≤] ${characterName}ËØ¥Ôºö${msg.content}` });
                    }
                });
                
                // Ê∑ªÂä†Êú¨Ê¨°ÈÄöËØùÁöÑÂéÜÂè≤
                if (callHistory.length > 0) {
                    messages.push({ role: 'user', content: `[Êú¨Ê¨°ÈÄöËØùÂºÄÂßã]` });
                    callHistory.forEach(msg => {
                        messages.push({
                            role: msg.role,
                            content: msg.role === 'user' ? `[ÈÄöËØù‰∏≠] Áî®Êà∑ËØ¥Ôºö${msg.content}` : `[ÈÄöËØù‰∏≠] ${characterName}ËØ¥Ôºö${msg.content}`
                        });
                    });
                }
                
                // Ê∑ªÂä†ÂΩìÂâçÁî®Êà∑Ê∂àÊÅØ
                messages.push({ role: 'user', content: `[ÈÄöËØù‰∏≠] Áî®Êà∑ÂàöÂàöËØ¥Ôºö${userMessage}` });

                // ‰ΩøÁî®Áªü‰∏ÄÁöÑAPIË∞ÉÁî®ÂáΩÊï∞Â§ÑÁêÜGeminiÂíåÂÖ∂‰ªñAPI
                const aiResponse = await callUnifiedAPIForCall(proxyUrl, apiKey, model, messages);

                if (aiResponse) {
                    if (isVideoCall && aiResponse.includes('<desc>')) {
                        // ËßÜÈ¢ëÈÄöËØùÔºöÂàÜÁ¶ªÂØπËØùÂíåÊèèÂÜôÈÉ®ÂàÜ
                        const parts = aiResponse.split('<desc>');
                        const dialogPart = parts[0].trim();
                        const descPart = parts[1] ? parts[1].replace('</desc>', '').trim() : '';

                        if (dialogPart) {
                            addCallMessage('assistant', dialogPart);
                        }
                        if (descPart) {
                            addCallMessage('assistant', `<span style="color: #000000; font-style: italic;">${descPart}</span>`, true);
                        }
                    } else {
                        // ËØ≠Èü≥ÈÄöËØùÊàñÊ≤°ÊúâÊèèÂÜôÁöÑËßÜÈ¢ëÈÄöËØù
                        addCallMessage('assistant', aiResponse);
                    }
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâËé∑ÂæóÂõûÂ∫îÔºå‰πüË¶ÅÈöêËóèÂä†ËΩΩÊåáÁ§∫Âô®
                    hideCallTypingIndicator();
                }
            } catch (error) {
                console.error('ÁîüÊàêÈÄöËØùAIÂõûÂ∫îÂ§±Ë¥•:', error);
                // Âá∫ÈîôÊó∂ÈöêËóèÂä†ËΩΩÊåáÁ§∫Âô®
                hideCallTypingIndicator();
            }
        }
        
        // AI‰∏ªÂä®ÊâìÁîµËØùÂäüËÉΩ - Âü∫‰∫éÊú¨ËΩÆËÅäÂ§©ÂÜÖÂÆπËß¶Âèë
        async function triggerAiCall() {
            // Âè™ÊúâÂú®ÊúâÊøÄÊ¥ªËÅäÂ§©‰∏î‰∏çÂú®ÈÄöËØù‰∏≠Êó∂ÊâçÂèØËÉΩËß¶Âèë
            if (!state.activeChatId || callState.isInCall) return;
            
            const chat = state.chats[state.activeChatId];
            if (!chat || chat.isGroup) return;
            
            // Ê£ÄÊü•ÊòØÂê¶ÂÖÅËÆ∏AI‰∏ªÂä®Êã®ÊâìÁîµËØù
            if (!chat.settings.aiCallEnabled) return;
            
            // Ê£ÄÊü•ÊúÄËøë3ËΩÆÂØπËØùÊòØÂê¶ÊúâÈÄöËØùÁõ∏ÂÖ≥ÂÜÖÂÆπ
            const recentHistory = getHistoryByRounds(chat.history, 3);
            const hasCallRelatedContent = recentHistory.some(msg => {
                const content = String(msg.content || '').toLowerCase();
                return content.includes('ÈÄöËØù') || content.includes('ÁîµËØù') || content.includes('ËßÜÈ¢ë') || 
                       content.includes('ËØ≠Èü≥') || content.includes('ÊâìÁªô') || content.includes('Áªô‰Ω†Êâì') ||
                       content.includes('ÊÉ≥Âê¨') || content.includes('ÊÉ≥Áúã') || content.includes('ËÅäËÅä') ||
                       content.includes('ÈÄö‰∏™ËØù') || content.includes('ËßÜÈ¢ëËÅä') || content.includes('ËØ≠Èü≥ËÅä') ||
                       content.includes('ÊâìÁîµËØù') || content.includes('Êù•Áîµ') || content.includes('Êé•ÁîµËØù');
            });
            
            // Âè™ÊúâÂú®ÊúÄËøë3ËΩÆÂØπËØù‰∏≠ÊèêÂà∞ÈÄöËØùÁõ∏ÂÖ≥ÂÜÖÂÆπÊó∂ÊâçÊúâ20%Ê¶ÇÁéáËß¶Âèë
            if (!hasCallRelatedContent || Math.random() > 0.2) return;
            
            // ÈöèÊú∫ÈÄâÊã©ÈÄöËØùÁ±ªÂûãÔºåÂ¶ÇÊûúÊèêÂà∞ËßÜÈ¢ëÁõ∏ÂÖ≥ÂÜÖÂÆπÔºåÂÄæÂêë‰∫éËßÜÈ¢ëÈÄöËØù
            const recentText = recentHistory.map(msg => String(msg.content || '')).join(' ').toLowerCase();
            let callType;
            if (recentText.includes('ËßÜÈ¢ë') || recentText.includes('Áúã')) {
                callType = Math.random() > 0.3 ? 'video' : 'voice'; // 70%Ê¶ÇÁéáËßÜÈ¢ë
            } else if (recentText.includes('ËØ≠Èü≥') || recentText.includes('Âê¨')) {
                callType = Math.random() > 0.3 ? 'voice' : 'video'; // 70%Ê¶ÇÁéáËØ≠Èü≥
            } else {
                callType = Math.random() > 0.5 ? 'voice' : 'video'; // ÈöèÊú∫
            }
            
            // ÊòæÁ§∫Êù•ÁîµÁïåÈù¢
            document.getElementById('incoming-call-type').textContent = callType === 'voice' ? 'ËØ≠Èü≥ÈÄöËØù' : 'ËßÜÈ¢ëÈÄöËØù';
            document.getElementById('incoming-call-name').textContent = chat.name;
            document.getElementById('incoming-call-avatar').src = chat.settings.aiAvatar || defaultAvatar;
            
            // ËÆæÁΩÆÊù•ÁîµÁä∂ÊÄÅ
            window.pendingCall = { chatId: state.activeChatId, callType };
            
            document.getElementById('incoming-call-modal').classList.add('visible');
            
            // 10ÁßíÂêéËá™Âä®ÊåÇÊñ≠
            setTimeout(() => {
                if (document.getElementById('incoming-call-modal').classList.contains('visible')) {
                    document.getElementById('incoming-call-modal').classList.remove('visible');
                    window.pendingCall = null;
                }
            }, 10000);
        }
        
        function answerIncomingCall() {
            if (!window.pendingCall) return;
            
            // ÂÖàÈöêËóèÊù•ÁîµÁïåÈù¢
            document.getElementById('incoming-call-modal').classList.remove('visible');
            
            // ÂàáÊç¢Âà∞ÂØπÂ∫îËÅäÂ§©
            state.activeChatId = window.pendingCall.chatId;
            showScreen('chat-interface-screen');
            renderChatInterface(state.activeChatId);
            
            // ËÆæÁΩÆ‰∏∫AI‰∏ªÂä®ÂèëËµ∑ÁöÑÈÄöËØùÔºåËÄåÈùûÁî®Êà∑‰∏ªÂä®
            const callType = window.pendingCall.callType;
            const chatId = window.pendingCall.chatId;
            
            // Ê∏ÖÁ©∫pendingÁä∂ÊÄÅ
            window.pendingCall = null;
            
            // ÂºÄÂßãÈÄöËØù
            const chat = state.chats[chatId];
            if (!chat) return;
            
            callState.isInCall = true;
            callState.callType = callType;
            callState.activeChatId = chatId;
            callState.startTime = Date.now();
            callState.messages = [];
            callState.userInitiated = false; // Ê†áËÆ∞‰∏∫AI‰∏ªÂä®ÂèëËµ∑
            
            // ËÆæÁΩÆÁïåÈù¢
            document.getElementById('call-contact-name').textContent = chat.name;
            document.getElementById('call-avatar').src = chat.settings.aiAvatar || defaultAvatar;
            
            // ÊòæÁ§∫ÈÄöËØùÁïåÈù¢
            document.getElementById('call-overlay').classList.add('visible');
            
            // ÂºÄÂßãËÆ°Êó∂
            startCallTimer();
            
            // Ê∏ÖÁ©∫Ê∂àÊÅØÂå∫Âüü
            document.getElementById('call-messages').innerHTML = '';

            // ÊòæÁ§∫Âä†ËΩΩÊåáÁ§∫Âô®
            showCallTypingIndicator();

            // AI‰∏ªÂä®ÂèëËµ∑ÈÄöËØùÊó∂ÔºåÂÖàËÆ©AIËØ¥‰∏ÄÂè•ÂºÄÂú∫ÁôΩ
            setTimeout(() => {
                generateAiCallOpening();
            }, 1000);
        }
        
        // AI‰∏ªÂä®ÈÄöËØùÁöÑÂºÄÂú∫ÁôΩ
        async function generateAiCallOpening() {
            const chat = state.chats[callState.activeChatId];
            if (!chat) return;
            
            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) return;
            
            try {
                const isVideoCall = callState.callType === 'video';
                const characterName = chat.name;
                
                // Ëé∑Âèñ‰∏ä‰∏ãÊñáËÆ∞ÂøÜ
                const maxMemory = parseInt(chat.settings.maxMemory) || 10;
                const recentHistory = getHistoryByRounds(chat.history, maxMemory);
                
                // Ëé∑Âèñ‰∏ñÁïå‰π¶ÂÜÖÂÆπ
                let worldBookContent = '';
                if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
                    const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                        const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                        return worldBook && worldBook.content ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${worldBook.content}` : '';
                    }).filter(Boolean).join('');
                    if (linkedContents) {
                        worldBookContent = `\n\n# Ê†∏ÂøÉ‰∏ñÁïåËßÇËÆæÂÆö (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËÆæÂÆö)\n${linkedContents}\n`;
                    }
                }
                
                const sceneInstructions = isVideoCall ? 
                    `\n\n# ËßÜÈ¢ëÈÄöËØùÁâπÊÆäËßÑÂàô
- ËøôÊòØËßÜÈ¢ëÈÄöËØùÔºå‰Ω†ÂèØ‰ª•ËøõË°åÂú∫ÊôØÊèèÂÜôÂíåÂä®‰ΩúÊèèÂÜô
- ‰Ω†ÁöÑÂõûÂ§çÂ∫îËØ•ÂåÖÂê´‰∏§ÈÉ®ÂàÜÔºöÂØπËØùÂÜÖÂÆπ + ÊèèÂÜôÂÜÖÂÆπ
- ÊèèÂÜôÈÉ®ÂàÜÁî®<desc>Ê†áÁ≠æÂåÖË£πÔºå‰ΩøÁî®Á¨¨‰∏â‰∫∫Áß∞ÊèèËø∞Âú∫ÊôØÂíåÂä®‰Ωú
- Âú®ÊèèÂÜô‰∏≠Áî®"${characterName}"Êù•Áß∞ÂëºËá™Â∑±ÔºåÁî®"‰Ω†"Êù•Áß∞ÂëºÁî®Êà∑
- ÊèèÂÜôË¶ÅÁîüÂä®ÂΩ¢Ë±°ÔºåËÆ©Áî®Êà∑ÊÑüÂèóÂà∞ËßÜÈ¢ëÈÄöËØùÁöÑÁúüÂÆûÊÑü
- ‰∏çË¶Å‰ΩøÁî®Êã¨Âè∑ÂåÖË£πÊèèÂÜôÈÉ®ÂàÜ` :
                    `\n\n# ËØ≠Èü≥ÈÄöËØùËßÑÂàô
- ËøôÊòØËØ≠Èü≥ÈÄöËØùÔºå‰Ω†‰ª¨Âú®ÂêÑËá™ÁöÑÂú∞ÊñπÈÄöËøáÊâãÊú∫ËøõË°åËøúÁ®ãÈÄöËØùÔºå‰∏çÊòØÈù¢ÂØπÈù¢
- Âè™ËÉΩËøõË°åËØ≠Èü≥ÂØπËØùÔºå‰∏çË¶ÅÊèèÂÜôÂä®‰ΩúÂíåÂú∫ÊôØÔºå‰∏çË¶ÅÂèëÂ±ïÁ∫ø‰∏ãËßÅÈù¢ÁöÑÂâßÊÉÖ
- ‰∏ìÊ≥®‰∫éËØ≠Ë®Ä‰∫§ÊµÅÔºåÂõûÂ§çË¶ÅËá™ÁÑ∂ÊµÅÁïÖ`;
                
                const systemPrompt = `‰Ω†ÊòØ${characterName}ÔºåÂàöÂàö‰∏ªÂä®ÁªôÁî®Êà∑Êâì‰∫Ü‰∏™${isVideoCall ? 'ËßÜÈ¢ë' : 'ËØ≠Èü≥'}ÁîµËØùÔºåÁî®Êà∑Êé•ÈÄö‰∫Ü„ÄÇ${worldBookContent}

# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºö
${chat.settings.aiPersona}

# ÈáçË¶ÅÊÉÖÂ¢ÉËØ¥ÊòéÔºö
- ‰Ω†‰∏ªÂä®ÁªôÁî®Êà∑ÊâìÁîµËØùÔºåÁé∞Âú®ÁîµËØùÂàöÊé•ÈÄö
- ËøôÊòØÂü∫‰∫é‰Ω†‰ª¨‰πãÂâçËÅäÂ§©ÂÜÖÂÆπÁöÑÂª∂Áª≠Ôºå‰∏çÊòØÂÖ®Êñ∞ÁöÑÂºÄÂßã
- ‰Ω†Ë¶ÅÂü∫‰∫é‰πãÂâçÁöÑËÅäÂ§©ÂéÜÂè≤ÔºåËá™ÁÑ∂Âú∞ÂºÄÂßãËøôÊ¨°ÈÄöËØù
- Ë¶ÅËØ¥‰∏ÄÂè•ÂêàÈÄÇÁöÑÂºÄÂú∫ÁôΩÔºåËß£Èáä‰∏∫‰ªÄ‰πàÊâìÁîµËØùËøáÊù•

${sceneInstructions}

ËØ∑ËØ¥‰∏ÄÂè•ÂºÄÂú∫ÁôΩÔºåË¶ÅÁÆÄÁü≠‰∏îÁ¨¶ÂêàÈÄöËØùÁöÑËäÇÂ•è„ÄÇ`;
                
                // ÊûÑÂª∫Ê∂àÊÅØÂéÜÂè≤
                const messages = [
                    { role: 'system', content: systemPrompt }
                ];
                
                // Ê∑ªÂä†ÊúÄËøëÁöÑËÅäÂ§©ÂéÜÂè≤‰Ωú‰∏∫ËÉåÊôØ
                recentHistory.forEach(msg => {
                    if (msg.role === 'user') {
                        messages.push({ role: 'user', content: `[ËÅäÂ§©ÂéÜÂè≤] Áî®Êà∑ËØ¥Ôºö${msg.content}` });
                    } else if (msg.role === 'assistant') {
                        messages.push({ role: 'assistant', content: `[ËÅäÂ§©ÂéÜÂè≤] ${characterName}ËØ¥Ôºö${msg.content}` });
                    }
                });
                
                messages.push({ role: 'user', content: `[ÈÄöËØùÊé•ÈÄö] Áî®Êà∑Êé•Âê¨‰∫Ü‰Ω†‰∏ªÂä®Êã®ÊâìÁöÑÁîµËØùÔºåËØ∑ËØ¥ÂºÄÂú∫ÁôΩ` });

                // ‰ΩøÁî®Áªü‰∏ÄÁöÑAPIË∞ÉÁî®ÂáΩÊï∞Â§ÑÁêÜGeminiÂíåÂÖ∂‰ªñAPI
                const aiResponse = await callUnifiedAPIForCall(proxyUrl, apiKey, model, messages);

                if (aiResponse) {
                    if (isVideoCall && aiResponse.includes('<desc>')) {
                        // ËßÜÈ¢ëÈÄöËØùÔºöÂàÜÁ¶ªÂØπËØùÂíåÊèèÂÜôÈÉ®ÂàÜ
                        const parts = aiResponse.split('<desc>');
                        const dialogPart = parts[0].trim();
                        const descPart = parts[1] ? parts[1].replace('</desc>', '').trim() : '';

                        if (dialogPart) {
                            addCallMessage('assistant', dialogPart);
                        }
                        if (descPart) {
                            addCallMessage('assistant', `<span style="color: #000000; font-style: italic;">${descPart}</span>`, true);
                        }
                    } else {
                        // ËØ≠Èü≥ÈÄöËØùÊàñÊ≤°ÊúâÊèèÂÜôÁöÑËßÜÈ¢ëÈÄöËØù
                        addCallMessage('assistant', aiResponse);
                    }
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâËé∑ÂæóÂõûÂ∫îÔºå‰πüË¶ÅÈöêËóèÂä†ËΩΩÊåáÁ§∫Âô®
                    hideCallTypingIndicator();
                }
            } catch (error) {
                console.error('ÁîüÊàêAIÈÄöËØùÂºÄÂú∫ÁôΩÂ§±Ë¥•:', error);
                // Âá∫ÈîôÊó∂ÈöêËóèÂä†ËΩΩÊåáÁ§∫Âô®
                hideCallTypingIndicator();
            }
        }
        
        function declineIncomingCall() {
            document.getElementById('incoming-call-modal').classList.remove('visible');
            window.pendingCall = null;
        }
        
        // ÁîüÊàêAIÂØπÈÄöËØùÁä∂ÊÄÅÁöÑÂèçÂ∫î
        async function generateCallReaction(action, chatId = null, callType = null, callMessages = []) {
            // ‰ΩøÁî®‰º†ÂÖ•ÁöÑchatIdÊàñÂΩìÂâçÊ¥ªË∑ÉÁöÑchatId
            const targetChatId = chatId || state.activeChatId;
            if (!targetChatId) return;

            const chat = state.chats[targetChatId];
            if (!chat || chat.isGroup) return;

            // Âè™ÂØπË¢´ÊåÇÊñ≠ÂÅöÂá∫ÂèçÂ∫î
            if (action !== 'hungup') return;

            const { proxyUrl, apiKey, model } = state.apiConfig;
            if (!proxyUrl || !apiKey || !model) return;

            try {
                // Ëé∑Âèñ‰∏ä‰∏ãÊñáËÆ∞ÂøÜ
                const maxMemory = parseInt(chat.settings.maxMemory) || 10;
                const recentHistory = getHistoryByRounds(chat.history, maxMemory);

                // Ëé∑Âèñ‰∏ñÁïå‰π¶ÂÜÖÂÆπ
                let worldBookContent = '';
                if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
                    const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                        const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                        return worldBook && worldBook.content ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${worldBook.content}` : '';
                    }).filter(Boolean).join('');
                    if (linkedContents) {
                        worldBookContent = `\n\n# Ê†∏ÂøÉ‰∏ñÁïåËßÇËÆæÂÆö (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËÆæÂÆö)\n${linkedContents}\n`;
                    }
                }

                // Ëé∑ÂèñÊú¨Ê¨°ÈÄöËØùÁöÑÂÜÖÂÆπÊÄªÁªì
                const callSummary = callMessages.length > 0 ?
                    callMessages.map(msg => `${msg.role === 'user' ? 'Áî®Êà∑' : chat.name}: ${msg.content}`).join('\n') :
                    'ÂàöÊâçËøõË°å‰∫Ü‰∏ÄÊ¨°ÁÆÄÁü≠ÁöÑÈÄöËØù';
                
                const systemPrompt = `‰Ω†ÊòØ${chat.name}Ôºå‰Ω†ÁöÑ‰∫∫ËÆæÔºö${chat.settings.aiPersona}${worldBookContent}

# ÈáçË¶ÅÊÉÖÂ¢ÉËØ¥ÊòéÔºö
- ‰Ω†ÂàöÂàöÂíåÁî®Êà∑ËøõË°å‰∫Ü‰∏ÄÊ¨°${callType === 'video' ? 'ËßÜÈ¢ë' : 'ËØ≠Èü≥'}ÈÄöËØù
- Áé∞Âú®ÈÄöËØùÂ∑≤ÁªèÁªìÊùü/Ë¢´ÊåÇÊñ≠‰∫Ü
- ‰Ω†‰ª¨Áé∞Âú®ÂõûÂà∞‰∫ÜÊ≠£Â∏∏ÁöÑÊâãÊú∫ËÅäÂ§©Ê®°ÂºèÔºàÂèëÈÄÅÊñáÂ≠óÊ∂àÊÅØÔºâ
- Ëøô‰∏çÂÜçÊòØÈÄöËØùÔºåËÄåÊòØÊôÆÈÄöÁöÑËÅäÂ§©ÂØπËØù

# ÂàöÊâçÁöÑÈÄöËØùÂÜÖÂÆπÔºö
${callSummary}

# ÂΩìÂâçÁä∂ÊÄÅÔºö
- ÈÄöËØùÂ∑≤ÁªìÊùüÔºåÁé∞Âú®ÊòØÊâãÊú∫ËÅäÂ§©
- ‰Ω†Ë¶ÅÈÄöËøáÊñáÂ≠óÊ∂àÊÅØÂØπÂàöÊâçÁöÑÈÄöËØùË¢´ÊåÇÊñ≠ÂÅöÂá∫ÂèçÂ∫î
- Ë¶ÅÊÑèËØÜÂà∞‰Ω†‰ª¨Áé∞Âú®ÊòØÂú®ÂèëÈÄÅÊñáÂ≠óÊ∂àÊÅØÔºå‰∏çÊòØÂú®ÈÄöËØù

Ë¶ÅÊ±ÇÔºö
1. ÊòéÁ°ÆÊÑèËØÜÂà∞ÈÄöËØùÂ∑≤ÁªèÁªìÊùüÔºåÁé∞Âú®ÊòØÂú®ÂèëÈÄÅËÅäÂ§©Ê∂àÊÅØ
2. Âü∫‰∫éÂàöÊâçÁöÑÈÄöËØùÂÜÖÂÆπÂíå‰Ω†‰ª¨ÁöÑËÅäÂ§©ÂéÜÂè≤ÂÅöÂá∫ÂèçÂ∫î
3. ÂõûÂ§çË¶ÅÁ¨¶Âêà‰Ω†ÁöÑ‰∫∫ËÆæÂíåÊÄßÊ†º
4. ÂèØ‰ª•Ë°®ËææÁêÜËß£„ÄÅÂÖ≥ÂøÉ„ÄÅÂ§±ËêΩ„ÄÅË∞É‰æÉÁ≠âÊÉÖÊÑü
5. ÂõûÂ§çË¶ÅÁÆÄÁü≠Ëá™ÁÑ∂ÔºåÂÉèÁúüÂÆûÁöÑËÅäÂ§©Ê∂àÊÅØ
6. ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÔºåÂåÖÂê´1-3Êù°Ê∂àÊÅØ

JSONËæìÂá∫Ê†ºÂºèÁ§∫‰æã:
["ÂàöÊâçËÅäÂæóÂæàÂºÄÂøÉÂë¢~", "‰∏ãÊ¨°ÂÜçËÅäÂêß"]`;

                // ÊûÑÂª∫Ê∂àÊÅØÂéÜÂè≤ÔºåÂåÖÂê´ÊúÄËøëËÅäÂ§©ËÆ∞ÂΩï
                const messages = [
                    { role: 'system', content: systemPrompt }
                ];
                
                // Ê∑ªÂä†ÊúÄËøëÁöÑËÅäÂ§©ÂéÜÂè≤‰Ωú‰∏∫ËÉåÊôØ
                recentHistory.forEach(msg => {
                    if (msg.role === 'user') {
                        messages.push({ role: 'user', content: `[ËÅäÂ§©ÂéÜÂè≤] Áî®Êà∑ËØ¥Ôºö${msg.content}` });
                    } else if (msg.role === 'assistant') {
                        messages.push({ role: 'assistant', content: `[ËÅäÂ§©ÂéÜÂè≤] ${chat.name}ËØ¥Ôºö${msg.content}` });
                    }
                });
                
                messages.push({ role: 'user', content: `ÈÄöËØùÂàöÂàöË¢´ÊåÇÊñ≠‰∫ÜÔºåÁé∞Âú®ÂõûÂà∞‰∫ÜÊâãÊú∫ËÅäÂ§©Ê®°ÂºèÔºåËØ∑ÈÄöËøáÊñáÂ≠óÊ∂àÊÅØÂÅöÂá∫ÂèçÂ∫î` });

                // ‰ΩøÁî®Áªü‰∏ÄÁöÑAPIË∞ÉÁî®ÂáΩÊï∞Â§ÑÁêÜGeminiÂíåÂÖ∂‰ªñAPI
                const aiResponse = await callUnifiedAPIForCall(proxyUrl, apiKey, model, messages);
                
                if (aiResponse) {
                    const messagesArray = parseAiResponse(aiResponse);
                    
                    for (const msgData of messagesArray) {
                        const aiMessage = { 
                            role: 'assistant', 
                            content: String(msgData), 
                            timestamp: Date.now() 
                        };
                        
                        chat.history.push(aiMessage);
                        await db.chats.put(chat);
                        
                        // Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®Êü•ÁúãËøô‰∏™ËÅäÂ§©ÔºåÊ∑ªÂä†Ê∂àÊÅØ
                        if (state.activeChatId === targetChatId && document.getElementById('chat-interface-screen').classList.contains('active')) {
                            appendMessage(aiMessage, chat);
                        }
                        
                        // Âª∂Ëøü‰∏Ä‰∏ãÂÜçÂèëÈÄÅ‰∏ã‰∏ÄÊù°
                        await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 500));
                    }
                    
                    renderChatList();
                }
            } catch (error) {
                console.error('ÁîüÊàêÈÄöËØùÂèçÂ∫îÂ§±Ë¥•:', error);
            }
        }


        // ‰∏ªÈ¢òÂàáÊç¢ÂäüËÉΩ
        let selectedTheme = '';
        
        window.selectThemeStyle = function(theme) {
            // ÁßªÈô§ÊâÄÊúâÈÄâÈ°πÁöÑactiveÁ±ª
            document.querySelectorAll('.theme-style-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // ‰∏∫ÂΩìÂâçÈÄâ‰∏≠ÈÄâÈ°πÊ∑ªÂä†activeÁ±ª
            document.querySelector(`.theme-style-option[data-theme="${theme}"]`).classList.add('active');
            
            // ‰øùÂ≠òÈÄâ‰∏≠ÁöÑ‰∏ªÈ¢ò‰ΩÜ‰∏çÁ´ãÂç≥Â∫îÁî®
            selectedTheme = theme;
            
            // ÊòæÁ§∫È¢ÑËßàÊïàÊûú
            showToast(`Â∑≤ÈÄâÊã©${theme === 'simple' ? 'ÁÆÄÁ∫¶È£é' : 'ÂèØÁà±È£é'}‰∏ªÈ¢òÔºåÁÇπÂáª"Á°ÆËÆ§Â∫îÁî®‰∏ªÈ¢ò"ÁîüÊïà`, 'info');
        }
        
        // Â∫îÁî®ÈÄâ‰∏≠ÁöÑ‰∏ªÈ¢ò
        window.applySelectedTheme = function() {
            if (!selectedTheme) {
                showToast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™‰∏ªÈ¢ò', 'warning');
                return;
            }
            
            // Â∫îÁî®‰∏ªÈ¢ò
            document.body.setAttribute('data-theme', selectedTheme);
            
            // Ê∑ªÂä†ÂèØÁà±È£éÊ†∑ÂºèÁ±ª
            if (selectedTheme === 'cute') {
                document.body.classList.add('cute-theme');
            } else {
                document.body.classList.remove('cute-theme');
            }
            
            // ÂàáÊç¢Á≠âÂæÖÂõûÂ§çÊåâÈíÆÁöÑÂõæÁâá
            const waitReplyBtn = document.getElementById('wait-reply-btn');
            const waitReplyImg = waitReplyBtn ? waitReplyBtn.querySelector('img') : null;
            if (waitReplyImg) {
                if (selectedTheme === 'cute') {
                    waitReplyImg.src = 'https://i.postimg.cc/HxmLGLfk/IMG-5103.png';
                } else {
                    waitReplyImg.src = 'https://i.postimg.cc/qzdckrGy/image.png';
                }
            }
            
            // ‰øùÂ≠ò‰∏ªÈ¢òËÆæÁΩÆÂà∞Dexie
            db.userProfiles.put({
                id: 'theme_style',
                type: 'theme',
                data: selectedTheme,
                timestamp: Date.now()
            });
            
            // ÊòæÁ§∫‰∏ªÈ¢òÂàáÊç¢ÊàêÂäüÊèêÁ§∫
            showToast(`Â∑≤ÊàêÂäüÂ∫îÁî®${selectedTheme === 'simple' ? 'ÁÆÄÁ∫¶È£é' : 'ÂèØÁà±È£é'}‰∏ªÈ¢ò`, 'success');
        }
        
        // ÂàùÂßãÂåñ‰∏ªÈ¢ò
        async function initThemeStyle() {
            // ‰ªéDexieËé∑Âèñ‰øùÂ≠òÁöÑ‰∏ªÈ¢ò
            const savedThemeData = await db.userProfiles.get('theme_style');
            const savedTheme = savedThemeData ? savedThemeData.data : 'simple';
            
            // Â∫îÁî®‰∏ªÈ¢ò
            document.body.setAttribute('data-theme', savedTheme);
            
            // Ê∑ªÂä†ÂèØÁà±È£éÊ†∑ÂºèÁ±ª
            if (savedTheme === 'cute') {
                document.body.classList.add('cute-theme');
            } else {
                document.body.classList.remove('cute-theme');
            }
            
            // ÂàáÊç¢Á≠âÂæÖÂõûÂ§çÊåâÈíÆÁöÑÂõæÁâá
            const waitReplyBtn = document.getElementById('wait-reply-btn');
            const waitReplyImg = waitReplyBtn ? waitReplyBtn.querySelector('img') : null;
            if (waitReplyImg) {
                if (savedTheme === 'cute') {
                    waitReplyImg.src = 'https://i.postimg.cc/HxmLGLfk/IMG-5103.png';
                } else {
                    waitReplyImg.src = 'https://i.postimg.cc/qzdckrGy/image.png';
                }
            }
            
            // Ê†áËÆ∞ÂΩìÂâçÈÄâ‰∏≠ÁöÑ‰∏ªÈ¢òÈÄâÈ°π
            const activeOption = document.querySelector(`.theme-style-option[data-theme="${savedTheme}"]`);
            if (activeOption) {
                activeOption.classList.add('active');
            }
            
            // ËÆæÁΩÆÂΩìÂâçÈÄâ‰∏≠ÁöÑ‰∏ªÈ¢ò
            selectedTheme = savedTheme;
        }
        
        async function init() {
            await loadAllDataFromDB();
            
            // ÂàùÂßãÂåñ‰∏ªÈ¢ò
            await initThemeStyle();
            
            // Â∞ÜÂÖ≥ÈîÆÂèòÈáèÊö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
            window.state = state;
            window.db = db;
            window.isWeiboSelectionMode = isWeiboSelectionMode;
            window.selectedWeiboPosts = selectedWeiboPosts;
            window.exitWeiboSelectionMode = exitWeiboSelectionMode;
            
            updateClock(); setInterval(updateClock, 1000 * 30);
            applyGlobalWallpaper();
            applyIconPosition();
            applyBorderlessMode();
            initBatteryManager();
            
            document.getElementById('back-to-list-btn').addEventListener('click', () => { exitSelectionMode(); state.activeChatId = null; showScreen('chat-list-screen'); });
            document.getElementById('add-chat-btn').addEventListener('click', async () => { const name = await showCustomPrompt('ÂàõÂª∫Êñ∞ËÅäÂ§©', 'ËØ∑ËæìÂÖ•TaÁöÑÂêçÂ≠ó'); if (name && name.trim()) { const newChatId = 'chat_' + Date.now(); const newChat = { id: newChatId, name: name.trim(), isGroup: false, settings: { aiPersona: '‰Ω†ÊòØË∞ÅÂëÄ„ÄÇ', myPersona: 'ÊàëÊòØË∞ÅÂëÄ„ÄÇ', maxMemory: 10, aiAvatar: defaultAvatar, myAvatar: defaultAvatar, background: '', theme: 'default', linkedWorldBookIds: [], aiCallEnabled: true }, history: [], musicData: { totalTime: 0 } }; state.chats[newChatId] = newChat; await db.chats.put(newChat); renderChatList(); } });
            document.getElementById('add-group-chat-btn').addEventListener('click', async () => { const numStr = await showCustomPrompt('ÂàõÂª∫Áæ§ËÅä', 'ËØ∑ËæìÂÖ•Áæ§ÊàêÂëòÊï∞Èáè (2-20)'); const num = parseInt(numStr); if (!num || num < 2 || num > 20) { alert('ËØ∑ËæìÂÖ•2Âà∞20‰πãÈó¥ÁöÑÊúâÊïàÊï∞Â≠óÔºÅ'); return; } const name = await showCustomPrompt('ËÆæÁΩÆÁæ§Âêç', 'ËØ∑ËæìÂÖ•Áæ§ËÅäÁöÑÂêçÂ≠ó'); if (name && name.trim()) { const newChatId = 'group_' + Date.now(); const members = []; for (let i = 1; i <= num; i++) members.push({ id: `member_${i}`, name: `ÊàêÂëò${i}`, avatar: defaultGroupMemberAvatar, persona: '‰∏Ä‰∏™Ë∑ØËøáÁöÑÁæ§ÊàêÂëò„ÄÇ' }); const newGroupChat = { id: newChatId, name: name.trim(), isGroup: true, members: members, settings: { myPersona: 'ÊàëÊòØË∞ÅÂëÄ„ÄÇ', myNickname: 'Êàë', maxMemory: 10, groupAvatar: defaultGroupAvatar, myAvatar: defaultMyGroupAvatar, background: '', theme: 'default', linkedWorldBookIds: [] }, history: [], musicData: { totalTime: 0 } }; state.chats[newChatId] = newGroupChat; await db.chats.put(newGroupChat); renderChatList(); } });
            
            document.getElementById('transfer-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.add('visible'));
        document.getElementById('transfer-cancel-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.remove('visible'));
        document.getElementById('transfer-confirm-btn').addEventListener('click', sendUserTransfer);
        
        // ËΩ¨Ë¥¶Á°ÆËÆ§ÂØπËØùÊ°Ü‰∫ã‰ª∂
        document.getElementById('transfer-accept-btn').addEventListener('click', acceptTransfer);
        document.getElementById('transfer-reject-btn').addEventListener('click', rejectTransfer);
        document.getElementById('transfer-confirm-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('transfer-confirm-modal')) {
                document.getElementById('transfer-confirm-modal').classList.remove('visible');
                currentTransferMsg = null;
            }
        });

            document.getElementById('listen-together-btn').addEventListener('click', handleListenTogetherClick);
            document.getElementById('music-exit-btn').addEventListener('click', () => endListenTogetherSession(true));
            document.getElementById('music-return-btn').addEventListener('click', returnToChat);
            document.getElementById('music-play-pause-btn').addEventListener('click', togglePlayPause);
            document.getElementById('music-next-btn').addEventListener('click', playNext);
            document.getElementById('music-prev-btn').addEventListener('click', playPrev);
            document.getElementById('music-mode-btn').addEventListener('click', changePlayMode);
            document.getElementById('music-playlist-btn').addEventListener('click', () => { updatePlaylistUI(); document.getElementById('music-playlist-panel').classList.add('visible'); });
            document.getElementById('close-playlist-btn').addEventListener('click', () => document.getElementById('music-playlist-panel').classList.remove('visible'));
            document.getElementById('add-song-url-btn').addEventListener('click', addSongFromURL);
            document.getElementById('add-song-local-btn').addEventListener('click', () => document.getElementById('local-song-upload-input').click());
            document.getElementById('local-song-upload-input').addEventListener('change', addSongFromLocal);
            audioPlayer.addEventListener('ended', playNext);
            audioPlayer.addEventListener('pause', () => { if(musicState.isActive) { musicState.isPlaying = false; updatePlayerUI(); } });
            audioPlayer.addEventListener('play', () => { if(musicState.isActive) { musicState.isPlaying = true; updatePlayerUI(); } });
            
const chatInput = document.getElementById('chat-input');

// Ê∑ªÂä†ÈáçÊñ∞ÁîüÊàêÊåâÈíÆÁõëÂê¨Âô®
document.getElementById('regenerate-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    
    // ÊâæÂà∞Âπ∂Âà†Èô§ÊúÄÂêé‰∏ÄÁªÑAIÊ∂àÊÅØ
    for (let i = chat.history.length - 1; i >= 0; i--) {
        if (chat.history[i].role === 'assistant') {
            chat.history.splice(i, 1);
        } else {
            break;
        }
    }
    
    // ‰øùÂ≠òÊõ¥Êñ∞ÂêéÁöÑËÅäÂ§©ËÆ∞ÂΩï
    await db.chats.put(chat);
    
    // ÈáçÊñ∞Ê∏≤ÊüìËÅäÂ§©ÁïåÈù¢
    renderChatInterface(state.activeChatId);
    
    // Ëß¶ÂèëÊñ∞ÁöÑAIÂõûÂ§ç
    triggerAiResponse();
});

            // ÈÄöËØùÂäüËÉΩ‰∫ã‰ª∂ÁõëÂê¨
            document.getElementById('call-btn').addEventListener('click', () => {
                if (!state.activeChatId) return;
                document.getElementById('call-type-modal').classList.add('visible');
            });
            
            document.getElementById('start-voice-call').addEventListener('click', () => {
                startCall('voice');
            });
            
            document.getElementById('start-video-call').addEventListener('click', () => {
                startCall('video');
            });
            
            document.getElementById('cancel-call').addEventListener('click', () => {
                document.getElementById('call-type-modal').classList.remove('visible');
            });
            
            document.getElementById('call-send-btn').addEventListener('click', sendCallMessage);
            document.getElementById('call-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendCallMessage();
                }
            });
            
            document.getElementById('call-hangup-btn').addEventListener('click', endCall);
            document.getElementById('answer-call').addEventListener('click', answerIncomingCall);
            document.getElementById('decline-call').addEventListener('click', declineIncomingCall);
            
            // ÊØè30ÁßíÊ£ÄÊü•ÊòØÂê¶Ëß¶ÂèëAIÊù•ÁîµÔºàÂü∫‰∫éÊúÄËøëÂØπËØùÂÜÖÂÆπÔºâ
            setInterval(() => {
                if (Object.keys(state.chats).length > 0) {
                    triggerAiCall();
                }
            }, 30000);

            document.getElementById('send-btn').addEventListener('click', async () => { const content = chatInput.value.trim(); if (!content || !state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); 
            
            // Ë∞ÉÊï¥AIÂøÉÁéá
            adjustHeartrateForMessage(content, true);
            
            chatInput.value = ''; chatInput.style.height = 'auto'; chatInput.focus(); });
            document.getElementById('wait-reply-btn').addEventListener('click', triggerAiResponse);
                    chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('send-btn').click(); } });
        chatInput.addEventListener('input', () => { chatInput.style.height = 'auto'; chatInput.style.height = (chatInput.scrollHeight) + 'px'; });
        
        // @ÂäüËÉΩÂÆûÁé∞
        let mentionDropdown = document.getElementById('mention-dropdown');
        let selectedMentionIndex = -1;
        let mentionStart = -1;
        let mentionQuery = '';
        
        function showMentionDropdown(members, query = '') {
            const filtered = members.filter(member => 
                member.name.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filtered.length === 0) {
                hideMentionDropdown();
                return;
            }
            
            mentionDropdown.innerHTML = filtered.map((member, index) => 
                `<div class="mention-item" data-index="${index}" data-name="${member.name}">
                    <img src="${member.avatar}" alt="${member.name}" class="mention-avatar">
                    <span class="mention-name">${member.name}</span>
                </div>`
            ).join('');
            
            selectedMentionIndex = -1;
            mentionDropdown.style.display = 'block';
            
            // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
            mentionDropdown.querySelectorAll('.mention-item').forEach(item => {
                item.addEventListener('click', () => {
                    insertMention(item.dataset.name);
                });
            });
        }
        
        function hideMentionDropdown() {
            mentionDropdown.style.display = 'none';
            selectedMentionIndex = -1;
            mentionStart = -1;
            mentionQuery = '';
        }
        
        function insertMention(name) {
            const currentValue = chatInput.value;
            const beforeMention = currentValue.substring(0, mentionStart);
            const afterMention = currentValue.substring(chatInput.selectionStart);
            
            chatInput.value = beforeMention + `@${name} ` + afterMention;
            chatInput.focus();
            
            const newCursorPos = beforeMention.length + name.length + 2;
            chatInput.setSelectionRange(newCursorPos, newCursorPos);
            
            hideMentionDropdown();
        }
        
        function updateMentionSelection(direction) {
            const items = mentionDropdown.querySelectorAll('.mention-item');
            if (items.length === 0) return;
            
            // ÁßªÈô§ÂΩìÂâçÈÄâ‰∏≠Áä∂ÊÄÅ
            if (selectedMentionIndex >= 0) {
                items[selectedMentionIndex].classList.remove('selected');
            }
            
            // Êõ¥Êñ∞ÈÄâ‰∏≠Á¥¢Âºï
            if (direction === 'down') {
                selectedMentionIndex = selectedMentionIndex < items.length - 1 ? selectedMentionIndex + 1 : 0;
            } else {
                selectedMentionIndex = selectedMentionIndex > 0 ? selectedMentionIndex - 1 : items.length - 1;
            }
            
            // Ê∑ªÂä†Êñ∞ÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
            items[selectedMentionIndex].classList.add('selected');
            items[selectedMentionIndex].scrollIntoView({ block: 'nearest' });
        }
        
        // ËæìÂÖ•Ê°Ü@ÂäüËÉΩÁõëÂê¨
        chatInput.addEventListener('input', (e) => {
            const chat = state.chats[state.activeChatId];
            if (!chat || !chat.isGroup) {
                hideMentionDropdown();
                return;
            }
            
            const cursorPos = chatInput.selectionStart;
            const textBeforeCursor = chatInput.value.substring(0, cursorPos);
            const atIndex = textBeforeCursor.lastIndexOf('@');
            
            if (atIndex === -1 || (atIndex > 0 && textBeforeCursor[atIndex - 1] !== ' ' && atIndex !== 0)) {
                hideMentionDropdown();
                return;
            }
            
            const queryAfterAt = textBeforeCursor.substring(atIndex + 1);
            if (queryAfterAt.includes(' ')) {
                hideMentionDropdown();
                return;
            }
            
            mentionStart = atIndex;
            mentionQuery = queryAfterAt;
            showMentionDropdown(chat.members, queryAfterAt);
        });
        
        // ÈîÆÁõòÂØºËà™
        chatInput.addEventListener('keydown', (e) => {
            if (mentionDropdown.style.display === 'none') return;
            
            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    updateMentionSelection('down');
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    updateMentionSelection('up');
                    break;
                case 'Enter':
                    if (selectedMentionIndex >= 0) {
                        e.preventDefault();
                        const selectedItem = mentionDropdown.querySelectorAll('.mention-item')[selectedMentionIndex];
                        insertMention(selectedItem.dataset.name);
                    }
                    break;
                case 'Escape':
                    hideMentionDropdown();
                    break;
            }
        });
        
        // ÁÇπÂáªËæìÂÖ•Ê°ÜÂ§ñÈÉ®ÈöêËóè‰∏ãÊãâÊ°Ü
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#chat-input-container')) {
                hideMentionDropdown();
            }
        });
        

            document.getElementById('wallpaper-upload-input').addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if(file) {
                    // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÔºàÈôêÂà∂‰∏∫10MBÔºâ
                    if (file.size > 10 * 1024 * 1024) {
                        alert('Êñá‰ª∂Â§™Â§ßÔºÅËØ∑ÈÄâÊã©Â∞è‰∫é10MBÁöÑÂõæÁâá„ÄÇ');
                        return;
                    }

                    try {
                        const dataUrl = await new Promise((res, rej) => {
                            const reader = new FileReader();
                            reader.onload = () => res(reader.result);
                            reader.onerror = () => rej(reader.error);
                            reader.readAsDataURL(file);
                        });

                        // ‰øùÂ≠òÂà∞DexieÊï∞ÊçÆÂ∫ìËÄå‰∏çÊòØÂÜÖÂ≠ò
                        await db.wallpapers.put({
                            id: 'current_wallpaper',
                            type: 'custom',
                            data: dataUrl,
                            timestamp: Date.now()
                        });

                        newWallpaperBase64 = dataUrl;
                        await renderWallpaperScreen();
                    } catch (error) {
                        console.error('Â£ÅÁ∫∏‰∏ä‰º†Â§±Ë¥•:', error);
                        alert('Â£ÅÁ∫∏‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ');
                    }
                }
            });
            document.getElementById('save-wallpaper-btn').addEventListener('click', async () => {
                try {
                    // ‰ªéDexieËé∑ÂèñÂΩìÂâçÂ£ÅÁ∫∏
                    const wallpaperData = await db.wallpapers.get('current_wallpaper');
                    if (wallpaperData && wallpaperData.data) {
                        state.globalSettings.wallpaper = wallpaperData.data;
                        await db.globalSettings.put(state.globalSettings);
                        applyGlobalWallpaper();
                        newWallpaperBase64 = null;
                        alert('Â£ÅÁ∫∏Â∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ');
                        showScreen('home-screen');
                    } else {
                        alert('ËØ∑ÂÖà‰∏ä‰º†‰∏ÄÂº†Êñ∞Â£ÅÁ∫∏„ÄÇ');
                    }
                } catch (error) {
                    console.error('Â£ÅÁ∫∏‰øùÂ≠òÂ§±Ë¥•:', error);
                    alert('Â£ÅÁ∫∏‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ');
                }
            });
            
            document.getElementById('save-icon-position-btn').addEventListener('click', async () => {
                const iconPosition = document.getElementById('icon-position').value;
                state.globalSettings.iconPosition = iconPosition;
                await db.globalSettings.put(state.globalSettings);
                applyIconPosition();
                showToast('ÂõæÊ†á‰ΩçÁΩÆÂ∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ', 'success');
            });
            
            // ‰øùÂ≠òÂ≠óÂè∑ËÆæÁΩÆ
            document.getElementById('save-font-size-btn').addEventListener('click', async () => {
                const fontSize = document.getElementById('font-size-select').value;
                state.globalSettings.fontSize = fontSize;
                await db.globalSettings.put(state.globalSettings);
                applyFontSize();
                showToast('Â≠óÂè∑ËÆæÁΩÆÂ∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ', 'success');
            });

            // Êó†ËæπÊ°ÜÊ®°ÂºèÂºÄÂÖ≥‰∫ã‰ª∂ÁõëÂê¨Âô®
            document.getElementById('borderless-mode-toggle').addEventListener('change', async (event) => {
                const borderlessMode = event.target.checked;
                state.globalSettings.borderlessMode = borderlessMode;
                await db.globalSettings.put(state.globalSettings);
                applyBorderlessMode();
                showToast(borderlessMode ? 'Êó†ËæπÊ°ÜÊ®°ÂºèÂ∑≤ÂºÄÂêØÔºÅ' : 'Êó†ËæπÊ°ÜÊ®°ÂºèÂ∑≤ÂÖ≥Èó≠ÔºÅ', 'success');
            });

            // Ëá™ÂÆö‰πâÊ†∑Âºè‰∫ã‰ª∂ÁõëÂê¨Âô®
            document.getElementById('apply-custom-styles-btn').addEventListener('click', async () => {
                const customCSS = document.getElementById('custom-bubble-css').value;
                const customFontUrl = document.getElementById('custom-font-url').value;
                const customFontFamily = document.getElementById('custom-font-family').value;

                state.globalSettings.customBubbleCSS = customCSS;
                state.globalSettings.customFontUrl = customFontUrl;
                state.globalSettings.customFontFamily = customFontFamily;

                await db.globalSettings.put(state.globalSettings);
                applyCustomStyles();
                showToast('Ëá™ÂÆö‰πâÊ†∑ÂºèÂ∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ', 'success');
            });

            document.getElementById('reset-custom-styles-btn').addEventListener('click', async () => {
                const confirmed = await showCustomConfirm('ÈáçÁΩÆÊ†∑Âºè', 'Á°ÆÂÆöË¶ÅÈáçÁΩÆ‰∏∫ÈªòËÆ§ËÅäÂ§©Ê∞îÊ≥°Ê†∑ÂºèÂêóÔºü', { confirmButtonClass: 'btn-danger' });
                if (confirmed) {
                    state.globalSettings.customBubbleCSS = '';
                    state.globalSettings.customFontUrl = '';
                    state.globalSettings.customFontFamily = '';

                    await db.globalSettings.put(state.globalSettings);
                    applyCustomStyles();

                    // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
                    document.getElementById('custom-bubble-css').value = '';
                    document.getElementById('custom-font-url').value = '';
                    document.getElementById('custom-font-family').value = '';

                    showToast('Ê†∑ÂºèÂ∑≤ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÔºÅ', 'success');
                }
            });

            document.getElementById('preview-custom-styles-btn').addEventListener('click', () => {
                previewCustomStyles();
            });
            
            // Ëá™ÂÆö‰πâÂõæÊ†á‰∫ã‰ª∂ÁõëÂê¨Âô®
            document.getElementById('reset-all-icons-btn').addEventListener('click', async () => {
                const confirmed = await showCustomConfirm('ÈáçÁΩÆÂõæÊ†á', 'Á°ÆÂÆöË¶ÅÂ∞ÜÊâÄÊúâÂõæÊ†áÈáçÁΩÆ‰∏∫ÈªòËÆ§ÂõæÊ†áÂêóÔºü', { confirmButtonClass: 'btn-danger' });
                if (confirmed) {
                    state.globalSettings.customIcons = {};
                    await db.globalSettings.put(state.globalSettings);
                    applyCustomIcons();
                    renderCustomIconsGrid();
                    showToast('ÊâÄÊúâÂõæÊ†áÂ∑≤ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÔºÅ', 'success');
                }
            });
            
            // Ëá™ÂÆö‰πâÂõæÊ†áÂºπÁ™ó‰∫ã‰ª∂ÁõëÂê¨Âô®
            document.getElementById('use-url-btn').addEventListener('click', () => {
                const urlGroup = document.getElementById('url-input-group');
                urlGroup.style.display = urlGroup.style.display === 'none' ? 'block' : 'none';
            });
            
            document.getElementById('preview-url-btn').addEventListener('click', () => {
                const url = document.getElementById('icon-url-input').value.trim();
                if (!url) {
                    showToast('ËØ∑ËæìÂÖ•ÂõæÁâáURL', 'error');
                    return;
                }
                
                const newPreview = document.getElementById('new-icon-preview');
                const noPreviewText = document.getElementById('no-preview-text');
                
                // ÊµãËØïÂõæÁâáÊòØÂê¶ËÉΩÂä†ËΩΩ
                const testImg = new Image();
                testImg.onload = () => {
                    newPreview.src = url;
                    newPreview.style.display = 'block';
                    noPreviewText.style.display = 'none';
                    currentIconPreview = url;
                    showToast('URLÂõæÁâáÈ¢ÑËßàÊàêÂäüÔºÅ', 'success');
                };
                testImg.onerror = () => {
                    showToast('Êó†Ê≥ïÂä†ËΩΩËØ•URLÁöÑÂõæÁâáÔºåËØ∑Ê£ÄÊü•ÈìæÊé•', 'error');
                };
                testImg.src = url;
            });
            
            document.getElementById('icon-file-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const newPreview = document.getElementById('new-icon-preview');
                    const noPreviewText = document.getElementById('no-preview-text');
                    
                    newPreview.src = e.target.result;
                    newPreview.style.display = 'block';
                    noPreviewText.style.display = 'none';
                    currentIconPreview = e.target.result;
                    
                    // Ê∏ÖÁ©∫URLËæìÂÖ•Ê°Ü
                    document.getElementById('icon-url-input').value = '';
                    document.getElementById('url-input-group').style.display = 'none';
                };
                reader.readAsDataURL(file);
                event.target.value = null;
            });
            
            document.getElementById('cancel-icon-btn').addEventListener('click', () => {
                document.getElementById('custom-icon-modal').classList.remove('visible');
                currentEditingIcon = null;
                currentIconPreview = null;
            });
            
            document.getElementById('save-icon-btn').addEventListener('click', async () => {
                if (!currentEditingIcon || !currentIconPreview) {
                    showToast('ËØ∑ÂÖàÈÄâÊã©‰∏ÄÂº†ÂõæÁâá', 'error');
                    return;
                }
                
                // ÂàùÂßãÂåñcustomIconsÂØπË±°ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
                if (!state.globalSettings.customIcons) {
                    state.globalSettings.customIcons = {};
                }
                
                // ‰øùÂ≠òËá™ÂÆö‰πâÂõæÊ†á
                state.globalSettings.customIcons[currentEditingIcon.id] = currentIconPreview;
                await db.globalSettings.put(state.globalSettings);
                
                // Â∫îÁî®ÂõæÊ†áÊõ¥Êîπ
                applyCustomIcons();
                renderCustomIconsGrid();
                
                // ‰øùÂ≠òÂõæÊ†áÂêçÁß∞Áî®‰∫éÊèêÁ§∫
                const iconName = currentEditingIcon.name;
                
                // ÂÖ≥Èó≠ÂºπÁ™ó
                document.getElementById('custom-icon-modal').classList.remove('visible');
                currentEditingIcon = null;
                currentIconPreview = null;
                
                showToast(`${iconName}ÂõæÊ†áÂ∑≤Êõ¥Êñ∞ÔºÅ`, 'success');
            });
            document.getElementById('save-api-settings-btn').addEventListener('click', async () => { state.apiConfig.proxyUrl = document.getElementById('proxy-url').value.trim(); state.apiConfig.apiKey = document.getElementById('api-key').value.trim(); state.apiConfig.model = document.getElementById('model-select').value; await db.apiConfig.put(state.apiConfig); alert('APIËÆæÁΩÆÂ∑≤‰øùÂ≠ò!'); });
            
            // GeminiÁõ¥ËøûËÆæÁΩÆÊåâÈíÆ
            document.getElementById('set-gemini-direct-btn').addEventListener('click', () => {
                document.getElementById('proxy-url').value = 'https://generativelanguage.googleapis.com/v1beta';
                showToast('Â∑≤ËÆæÁΩÆGeminiÁõ¥ËøûÂú∞ÂùÄÔºåËØ∑Â°´ÂÜôGoogle AI StudioÁöÑAPI Key', 'success');
            });
            document.getElementById('fetch-models-btn').addEventListener('click', async () => { 
                const url = document.getElementById('proxy-url').value.trim(); 
                const key = document.getElementById('api-key').value.trim(); 
                if (!url || !key) return alert('ËØ∑ÂÖàÂ°´ÂÜôÂèç‰ª£Âú∞ÂùÄÂíåÂØÜÈí•'); 
                
                try { 
                    const isGemini = url.includes('generativelanguage.googleapis.com');
                    let apiUrl;
                    let headers;
                    
                    if (isGemini) {
                        // Gemini API
                        apiUrl = `${url}/models?key=${key}`;
                        headers = {};
                    } else {
                        // OpenAI compatible API
                        apiUrl = `${url}/v1/models`;
                        headers = { 'Authorization': `Bearer ${key}` };
                    }
                    
                    const response = await fetch(apiUrl, { headers }); 
                    if (!response.ok) throw new Error('Êó†Ê≥ïËé∑ÂèñÊ®°ÂûãÂàóË°®'); 
                    const data = await response.json(); 
                    const modelSelect = document.getElementById('model-select'); 
                    modelSelect.innerHTML = ''; 
                    
                    let models;
                    if (isGemini) {
                        // Gemini API ËøîÂõûÁöÑÊòØ { models: [...] }
                        models = data.models || [];
                    } else {
                        // OpenAI API ËøîÂõûÁöÑÊòØ { data: [...] }
                        models = data.data || [];
                    }
                    
                    if (models.length === 0) {
                        alert('Êú™ÊâæÂà∞‰ªª‰ΩïÂèØÁî®Ê®°Âûã');
                        return;
                    }
                    
                    models.forEach(model => { 
                        const option = document.createElement('option'); 
                        // Gemini models Êúâ name Â±ûÊÄßÔºåOpenAI models Êúâ id Â±ûÊÄß
                        const modelId = model.name || model.id;
                        // ÂØπ‰∫é GeminiÔºåÊèêÂèñÂÆûÈôÖÁöÑÊ®°ÂûãÂêçÔºàÂéªÊéâ models/ ÂâçÁºÄÔºâ
                        const displayName = isGemini ? modelId.replace('models/', '') : modelId;
                        option.value = displayName; 
                        option.textContent = displayName; 
                        if(displayName === state.apiConfig.model) option.selected = true; 
                        modelSelect.appendChild(option); 
                    }); 
                    alert(`Ê®°ÂûãÂàóË°®Â∑≤Êõ¥Êñ∞ÔºåÊâæÂà∞ ${models.length} ‰∏™Ê®°Âûã`); 
                } catch (error) { 
                    if (error.message.includes('CORS')) {
                        alert('Áî±‰∫éÊµèËßàÂô®Ë∑®ÂüüÈôêÂà∂ÔºåÊó†Ê≥ïÁõ¥Êé•Ëé∑ÂèñGeminiÊ®°ÂûãÂàóË°®„ÄÇËØ∑ÊâãÂä®ËæìÂÖ•Ê®°ÂûãÂêçÔºåÂ¶ÇÔºögemini-1.5-flash„ÄÅgemini-1.5-pro Á≠â');
                        // ‰∏∫GeminiÊ∑ªÂä†Â∏∏Áî®Ê®°Âûã
                        if (url.includes('generativelanguage.googleapis.com')) {
                            const modelSelect = document.getElementById('model-select');
                            modelSelect.innerHTML = '';
                            const commonGeminiModels = [
                                'gemini-1.5-flash',
                                'gemini-1.5-pro',
                                'gemini-1.0-pro'
                            ];
                            commonGeminiModels.forEach(modelName => {
                                const option = document.createElement('option');
                                option.value = modelName;
                                option.textContent = modelName;
                                if(modelName === state.apiConfig.model) option.selected = true;
                                modelSelect.appendChild(option);
                            });
                        }
                    } else {
                        alert(`ÊãâÂèñÊ®°ÂûãÂ§±Ë¥•: ${error.message}`); 
                    }
                } 
            });
            document.getElementById('add-world-book-btn').addEventListener('click', async () => { const name = await showCustomPrompt('ÂàõÂª∫‰∏ñÁïå‰π¶', 'ËØ∑ËæìÂÖ•‰π¶Âêç'); if (name && name.trim()) { const newBook = { id: 'wb_' + Date.now(), name: name.trim(), content: '' }; await db.worldBooks.add(newBook); state.worldBooks.push(newBook); renderWorldBookScreen(); openWorldBookEditor(newBook.id); } });
            
            
            document.getElementById('save-world-book-btn').addEventListener('click', async () => { if (!editingWorldBookId) return; const book = state.worldBooks.find(wb => wb.id === editingWorldBookId); if (book) { const newName = document.getElementById('world-book-name-input').value.trim(); if (!newName) { alert('‰π¶Âêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ'); return; } book.name = newName; book.content = document.getElementById('world-book-content-input').value; await db.worldBooks.put(book); document.getElementById('world-book-editor-title').textContent = newName; editingWorldBookId = null; renderWorldBookScreen(); showScreen('world-book-screen'); } });
            
            document.getElementById('chat-messages').addEventListener('click', (e) => { 
                // Â§ÑÁêÜÁî®Êà∑ÂèëÈÄÅÁöÑÂõæÁâáÁÇπÂáªÊîæÂ§ß
                const userImage = e.target.closest('.message-bubble.user .chat-image');
                if (userImage) {
                    showImageViewer(userImage.src);
                    return;
                }
                
                const aiImage = e.target.closest('.ai-generated-image'); 
                if (aiImage) { 
                    const description = aiImage.dataset.description; 
                    if (description) showCustomAlert('ÁÖßÁâáÊèèËø∞', description); 
                    return; 
                } 
                
                const voiceMessage = e.target.closest('.voice-message-body'); 
                if (voiceMessage) { 
                    const voiceContainer = voiceMessage.closest('.voice-message-container'); 
                    if (voiceContainer) { 
                        const textContent = voiceContainer.querySelector('.voice-text-content'); 
                        if (textContent) { 
                            textContent.classList.toggle('visible'); 
                        } 
                    } 
                    return; 
                } 
            });
            
            const chatSettingsModal = document.getElementById('chat-settings-modal');
            const worldBookSelectBox = document.querySelector('.custom-multiselect .select-box');
            const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
            
                // ËÆ∞ÂøÜÊåÇËΩΩÁõ∏ÂÖ≥ÂÖÉÁ¥†
    const memoryMountSelectBox = document.querySelector('#memory-mount-multiselect .select-box');
    const memoryMountCheckboxesContainer = document.getElementById('memory-mount-checkboxes-container');
    
    // Êô∫ËÉΩËÆ∞ÂøÜÂÖ±‰∫´Áõ∏ÂÖ≥ÂÖÉÁ¥†
    const memorySharingSelectBox = document.querySelector('#memory-sharing-multiselect .select-box');
    const memorySharingCheckboxesContainer = document.getElementById('memory-sharing-checkboxes-container');
            
            function updateWorldBookSelectionDisplay() { const checkedBoxes = worldBookCheckboxesContainer.querySelectorAll('input:checked'); const displayText = document.querySelector('.selected-options-text'); if (checkedBoxes.length === 0) { displayText.textContent = '-- ÁÇπÂáªÈÄâÊã© --'; } else if (checkedBoxes.length > 2) { displayText.textContent = `Â∑≤ÈÄâÊã© ${checkedBoxes.length} È°π`; } else { displayText.textContent = Array.from(checkedBoxes).map(cb => cb.parentElement.textContent.trim()).join(', '); } }
            
            function updateMemoryMountSelectionDisplay() { 
                const checkedBoxes = memoryMountCheckboxesContainer.querySelectorAll('input:checked'); 
                const displayText = memoryMountSelectBox.querySelector('.selected-options-text'); 
                if (checkedBoxes.length === 0) { 
                    displayText.textContent = '-- ÁÇπÂáªÈÄâÊã© --'; 
                } else if (checkedBoxes.length > 2) { 
                    displayText.textContent = `Â∑≤ÈÄâÊã© ${checkedBoxes.length} ‰∏™ËÅäÂ§©`; 
                } else { 
                    displayText.textContent = Array.from(checkedBoxes).map(cb => cb.parentElement.textContent.trim()).join(', '); 
                } 
            }
            
            function updateMemorySharingSelectionDisplay() { 
                const checkedBoxes = memorySharingCheckboxesContainer.querySelectorAll('input:checked'); 
                const displayText = memorySharingSelectBox.querySelector('.selected-options-text'); 
                if (checkedBoxes.length === 0) { 
                    displayText.textContent = '-- ÁÇπÂáªÈÄâÊã© --'; 
                } else if (checkedBoxes.length > 2) { 
                    displayText.textContent = `Â∑≤ÈÄâÊã© ${checkedBoxes.length} ‰∏™ËÅäÂ§©`; 
                } else { 
                    displayText.textContent = Array.from(checkedBoxes).map(cb => cb.parentElement.textContent.trim()).join(', '); 
                } 
            }
            
            worldBookSelectBox.addEventListener('click', (e) => { e.stopPropagation(); worldBookCheckboxesContainer.classList.toggle('visible'); worldBookSelectBox.classList.toggle('expanded'); });
            worldBookCheckboxesContainer.addEventListener('change', updateWorldBookSelectionDisplay);
            
            memoryMountSelectBox.addEventListener('click', (e) => { e.stopPropagation(); memoryMountCheckboxesContainer.classList.toggle('visible'); memoryMountSelectBox.classList.toggle('expanded'); });
            memoryMountCheckboxesContainer.addEventListener('change', updateMemoryMountSelectionDisplay);
            
            memorySharingSelectBox.addEventListener('click', (e) => { e.stopPropagation(); memorySharingCheckboxesContainer.classList.toggle('visible'); memorySharingSelectBox.classList.toggle('expanded'); });
            memorySharingCheckboxesContainer.addEventListener('change', updateMemorySharingSelectionDisplay);
            
            window.addEventListener('click', (e) => { 
                if (!document.querySelector('.custom-multiselect').contains(e.target)) { 
                    worldBookCheckboxesContainer.classList.remove('visible'); 
                    worldBookSelectBox.classList.remove('expanded'); 
                }
                if (!document.querySelector('#memory-mount-multiselect').contains(e.target)) {
                    memoryMountCheckboxesContainer.classList.remove('visible');
                    memoryMountSelectBox.classList.remove('expanded');
                }
                if (!document.querySelector('#memory-sharing-multiselect').contains(e.target)) {
                    memorySharingCheckboxesContainer.classList.remove('visible');
                    memorySharingSelectBox.classList.remove('expanded');
                }
            });
            document.getElementById('chat-settings-btn').addEventListener('click', () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const isGroup = chat.isGroup; document.getElementById('chat-name-group').style.display = 'block'; document.getElementById('chat-name-input').value = chat.name; document.getElementById('my-persona-group').style.display = 'block'; document.getElementById('my-persona').value = chat.settings.myPersona; document.getElementById('my-avatar-group').style.display = 'block'; document.getElementById('my-avatar-preview').src = chat.settings.myAvatar || (isGroup ? defaultMyGroupAvatar : defaultAvatar); 
            
            // Âä†ËΩΩÊà≥‰∏ÄÊà≥ÂêéÁºÄËÆæÁΩÆ
            document.getElementById('my-poke-suffix').value = chat.settings.myPokeSuffix || '';
            document.getElementById('ai-poke-suffix').value = chat.settings.aiPokeSuffix || '';
            
            // ËÆæÁΩÆÊà≥‰∏ÄÊà≥ÂêéÁºÄÁªÑÁöÑÊòæÈöêÔºàÁæ§ËÅäÂíåÁßÅËÅäÈÉΩÊòæÁ§∫Ôºâ
            document.getElementById('poke-suffix-group').style.display = 'block';
            document.getElementById('ai-poke-suffix-group').style.display = isGroup ? 'none' : 'block';
            
            document.getElementById('my-group-nickname-group').style.display = isGroup ? 'block' : 'none'; document.getElementById('group-avatar-group').style.display = isGroup ? 'block' : 'none'; document.getElementById('group-members-group').style.display = isGroup ? 'block' : 'none'; document.getElementById('ai-persona-group').style.display = isGroup ? 'none' : 'block'; document.getElementById('ai-avatar-group').style.display = isGroup ? 'none' : 'block'; 
            
            // ËÅäÂ§©Ê®°ÂºèËÆæÁΩÆÂØπÊâÄÊúâËÅäÂ§©Á±ªÂûãÈÉΩÂèØÁî®ÔºåÂåÖÊã¨Áæ§ËÅä
            document.getElementById('chat-mode-group').style.display = 'block'; const container = document.getElementById('posting-times-container');
    container.innerHTML = '';

    const addButton = document.createElement('button');
    addButton.type = 'button';
    addButton.className = 'add-time-btn';
    addButton.textContent = '+ Ê∑ªÂä†Êó∂Èó¥ÁÇπ';
    container.appendChild(addButton); // Âä†ËΩΩÂæÆÂçöËÆæÁΩÆ
    document.getElementById('weibo-enabled').checked = chat.settings.weiboEnabled || false;
    document.getElementById('weibo-frequency').value = chat.settings.weiboFrequency || 'low';

    addButton.addEventListener('click', () => {
        const timeInputGroup = document.createElement('div');
        timeInputGroup.className = 'time-input-group';
        timeInputGroup.innerHTML = `
            <input type="time" class="posting-time-input">
            <button type="button" class="remove-time-btn">√ó</button>
        `;
        container.insertBefore(timeInputGroup, addButton);
        
        timeInputGroup.querySelector('.remove-time-btn').addEventListener('click', () => {
            timeInputGroup.remove();
        });
    });

    // Âä†ËΩΩÂêéÂè∞‰∫íÂä®ËÆæÁΩÆ
    document.getElementById('background-interaction-enabled').checked = chat.settings.backgroundInteractionEnabled || false;
    document.getElementById('background-chat-frequency').value = chat.settings.backgroundChatFrequency || 'low';
    document.getElementById('background-weibo-frequency').value = chat.settings.backgroundWeiboFrequency || 'low';
    document.getElementById('background-chat-enabled').checked = chat.settings.backgroundChatEnabled !== false; // ÈªòËÆ§ÂºÄÂêØ
    document.getElementById('background-weibo-enabled').checked = chat.settings.backgroundWeiboEnabled !== false; // ÈªòËÆ§ÂºÄÂêØ

                // Âä†ËΩΩÊó∂Èó¥ÊèêÁ§∫ËØçËÆæÁΩÆ
            document.getElementById('time-awareness-enabled').checked = chat.settings.timeAwarenessEnabled !== false; // ÈªòËÆ§ÂºÄÂêØ
            
            // Âä†ËΩΩAI‰∏ªÂä®Êã®ÊâìÁîµËØùËÆæÁΩÆ
            document.getElementById('ai-call-enabled').checked = chat.settings.aiCallEnabled !== false; // ÈªòËÆ§ÂºÄÂêØ
            
            // Âä†ËΩΩAIÂøÉÁéáÁõëÊµãËÆæÁΩÆ
            document.getElementById('ai-heartrate-enabled').checked = chat.settings.aiHeartrateEnabled || false;
            
            // Âä†ËΩΩÂπ∂ÂèëËÅäÂ§©ËÆæÁΩÆ
            document.getElementById('concurrent-chat-enabled').checked = chat.settings.concurrentChatEnabled !== false; // ÈªòËÆ§ÂºÄÂêØ
            
            // Âä†ËΩΩËÅäÂ§©Ê®°ÂºèËÆæÁΩÆ
            const chatMode = chat.settings.chatMode || 'online'; // ÈªòËÆ§‰∏∫Á∫ø‰∏äÊ®°Âºè
            if (chatMode === 'online') {
                document.getElementById('chat-mode-online').checked = true;
            } else {
                document.getElementById('chat-mode-offline').checked = true;
            }
            
            // Âä†ËΩΩÁ∫ø‰∏ãÊ®°ÂºèÂ≠óÊï∞ÈôêÂà∂ËÆæÁΩÆ
            document.getElementById('offline-mode-min-length').value = chat.settings.offlineModeMinLength || 50;
            document.getElementById('offline-mode-max-length').value = chat.settings.offlineModeMaxLength || 100;
            
            // ÊéßÂà∂Â≠óÊï∞ÈôêÂà∂ËæìÂÖ•Ê°ÜÁöÑÊòæÁ§∫/ÈöêËóè
            function toggleOfflineLengthControl() {
                const offlineLengthControl = document.getElementById('offline-length-control');
                const isOfflineMode = document.getElementById('chat-mode-offline').checked;
                offlineLengthControl.style.display = isOfflineMode ? 'flex' : 'none';
            }
            
            // ÂàùÂßãÂåñÊòæÁ§∫Áä∂ÊÄÅ
            toggleOfflineLengthControl();
            
            // Ê∑ªÂä†Ê®°ÂºèÂàáÊç¢‰∫ã‰ª∂ÁõëÂê¨
            document.getElementById('chat-mode-online').addEventListener('change', toggleOfflineLengthControl);
            document.getElementById('chat-mode-offline').addEventListener('change', toggleOfflineLengthControl);

            // Ê∑ªÂä†Â≠óÊï∞ËåÉÂõ¥È™åËØÅ
            function validateLengthRange() {
                const minInput = document.getElementById('offline-mode-min-length');
                const maxInput = document.getElementById('offline-mode-max-length');
                const minValue = parseInt(minInput.value);
                const maxValue = parseInt(maxInput.value);

                if (minValue >= maxValue) {
                    // Â¶ÇÊûúÊúÄÂ∞èÂÄºÂ§ß‰∫éÁ≠â‰∫éÊúÄÂ§ßÂÄºÔºåËá™Âä®Ë∞ÉÊï¥
                    if (minInput === document.activeElement) {
                        // Â¶ÇÊûúÊ≠£Âú®ÁºñËæëÊúÄÂ∞èÂÄºÔºåË∞ÉÊï¥ÊúÄÂ§ßÂÄº
                        maxInput.value = minValue + 20;
                    } else {
                        // Â¶ÇÊûúÊ≠£Âú®ÁºñËæëÊúÄÂ§ßÂÄºÔºåË∞ÉÊï¥ÊúÄÂ∞èÂÄº
                        minInput.value = Math.max(20, maxValue - 20);
                    }
                }
            }

            document.getElementById('offline-mode-min-length').addEventListener('input', validateLengthRange);
            document.getElementById('offline-mode-max-length').addEventListener('input', validateLengthRange);

    // ÊòæÁ§∫/ÈöêËóèËÆæÁΩÆÈÄâÈ°π
    const weiboFrequencySettings = document.getElementById('weibo-frequency-settings');
    const backgroundInteractionSettings = document.getElementById('background-interaction-frequency-settings');
    
    weiboFrequencySettings.style.display = chat.settings.weiboEnabled ? 'block' : 'none';
    backgroundInteractionSettings.style.display = chat.settings.backgroundInteractionEnabled ? 'block' : 'none';

    // ÂæÆÂçöÂêØÁî®Áä∂ÊÄÅÂèòÂåñÁõëÂê¨
    document.getElementById('weibo-enabled').addEventListener('change', function() {
        weiboFrequencySettings.style.display = this.checked ? 'block' : 'none';
    });

    // ÂêéÂè∞‰∫íÂä®ÂêØÁî®Áä∂ÊÄÅÂèòÂåñÁõëÂê¨
    document.getElementById('background-interaction-enabled').addEventListener('change', function() {
        backgroundInteractionSettings.style.display = this.checked ? 'block' : 'none';
    });

    addButton.addEventListener('click', () => {
        const timeInputGroup = document.createElement('div');
        timeInputGroup.className = 'time-input-group';
        timeInputGroup.innerHTML = `
            <input type="time" class="posting-time-input">
            <button type="button" class="remove-time-btn">√ó</button>
        `;
        container.insertBefore(timeInputGroup, addButton);
        
        timeInputGroup.querySelector('.remove-time-btn').addEventListener('click', () => {
            timeInputGroup.remove();
        });
    });

    if (chat.settings.weiboPostingTimes && chat.settings.weiboPostingTimes.length > 0) {
        chat.settings.weiboPostingTimes.forEach(time => {
            const timeInputGroup = document.createElement('div');
            timeInputGroup.className = 'time-input-group';
            timeInputGroup.innerHTML = `
                <input type="time" class="posting-time-input" value="${time}">
                <button type="button" class="remove-time-btn">√ó</button>
            `;
            container.insertBefore(timeInputGroup, addButton);
            
            timeInputGroup.querySelector('.remove-time-btn').addEventListener('click', () => {
                timeInputGroup.remove();
            });
        });
    }worldBookCheckboxesContainer.innerHTML = ''; const linkedIds = chat.settings.linkedWorldBookIds || []; if (state.worldBooks.length === 0) { worldBookCheckboxesContainer.innerHTML = '<p style="color: #888; text-align: center; margin: 10px 0;">Ê≤°ÊúâÂèØÁî®ÁöÑ‰∏ñÁïå‰π¶</p>'; } else { state.worldBooks.forEach(book => { const isChecked = linkedIds.includes(book.id); const label = document.createElement('label'); label.innerHTML = `<input type="checkbox" value="${book.id}" ${isChecked ? 'checked' : ''}> ${book.name}`; worldBookCheckboxesContainer.appendChild(label); }); } updateWorldBookSelectionDisplay();
    
    // ÂàùÂßãÂåñËÆ∞ÂøÜÊåÇËΩΩËÆæÁΩÆ
    document.getElementById('memory-mount-enabled').checked = chat.settings.memoryMountEnabled || false;
    document.getElementById('memory-mount-count').value = chat.settings.memoryMountCount || 10;
    
    // ÊòæÁ§∫/ÈöêËóèËÆ∞ÂøÜÊåÇËΩΩËÆæÁΩÆ
    const memoryMountSettings = document.getElementById('memory-mount-settings');
    memoryMountSettings.style.display = chat.settings.memoryMountEnabled ? 'block' : 'none';
    
    // ËÆ∞ÂøÜÊåÇËΩΩÂêØÁî®Áä∂ÊÄÅÂèòÂåñÁõëÂê¨
    document.getElementById('memory-mount-enabled').addEventListener('change', function() {
        memoryMountSettings.style.display = this.checked ? 'block' : 'none';
    });
    
    // Â°´ÂÖÖÂèØÊåÇËΩΩÁöÑËÅäÂ§©ÂàóË°®
    memoryMountCheckboxesContainer.innerHTML = '';
    const mountedChatIds = chat.settings.memoryMountChatIds || [];
    const availableChats = Object.values(state.chats).filter(c => c.id !== state.activeChatId);
    
    if (availableChats.length === 0) {
        memoryMountCheckboxesContainer.innerHTML = '<p style="color: #888; text-align: center; margin: 10px 0;">Ê≤°ÊúâÂÖ∂‰ªñÂèØÁî®ÁöÑËÅäÂ§©</p>';
    } else {
        availableChats.forEach(otherChat => {
            const isChecked = mountedChatIds.includes(otherChat.id);
            const chatType = otherChat.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]';
            const label = document.createElement('label');
            label.innerHTML = `<input type="checkbox" value="${otherChat.id}" ${isChecked ? 'checked' : ''}> ${chatType} ${otherChat.name}`;
            memoryMountCheckboxesContainer.appendChild(label);
        });
    }
    updateMemoryMountSelectionDisplay();
    
    // ÂàùÂßãÂåñÊô∫ËÉΩËÆ∞ÂøÜÂÖ±‰∫´ËÆæÁΩÆ
    document.getElementById('memory-sharing-enabled').checked = chat.settings.memorySharing?.enabled || false;
    document.getElementById('share-mood').checked = chat.settings.memorySharing?.categories?.mood !== false;
    document.getElementById('share-events').checked = chat.settings.memorySharing?.categories?.events !== false;
    document.getElementById('share-interests').checked = chat.settings.memorySharing?.categories?.interests !== false;
    document.getElementById('share-plans').checked = chat.settings.memorySharing?.categories?.plans !== false;
    document.getElementById('sharing-threshold').value = chat.settings.memorySharing?.threshold || 0.6;
    document.getElementById('threshold-value').textContent = chat.settings.memorySharing?.threshold || 0.6;
    
    // ÊòæÁ§∫/ÈöêËóèÊô∫ËÉΩËÆ∞ÂøÜÂÖ±‰∫´ËÆæÁΩÆ
    const memorySharingSettings = document.getElementById('memory-sharing-settings');
    memorySharingSettings.style.display = chat.settings.memorySharing?.enabled ? 'block' : 'none';
    
    // Êô∫ËÉΩËÆ∞ÂøÜÂÖ±‰∫´ÂêØÁî®Áä∂ÊÄÅÂèòÂåñÁõëÂê¨
    document.getElementById('memory-sharing-enabled').addEventListener('change', function() {
        memorySharingSettings.style.display = this.checked ? 'block' : 'none';
    });
    
    // ÈòàÂÄºÊªëÂùóÂèòÂåñÁõëÂê¨
    document.getElementById('sharing-threshold').addEventListener('input', function() {
        document.getElementById('threshold-value').textContent = this.value;
    });
    
    // Â°´ÂÖÖÂèØÂÖ±‰∫´ÁöÑËÅäÂ§©ÂàóË°®
    const memorySharingCheckboxesContainer = document.getElementById('memory-sharing-checkboxes-container');
    const memorySharingSelectBox = document.querySelector('#memory-sharing-multiselect .select-box');
    
    memorySharingCheckboxesContainer.innerHTML = '';
    const sharedChatIds = chat.settings.memorySharing?.chatIds || [];
    const availableChatsForSharing = Object.values(state.chats).filter(c => c.id !== state.activeChatId);
    
    if (availableChatsForSharing.length === 0) {
        memorySharingCheckboxesContainer.innerHTML = '<p style="color: #888; text-align: center; margin: 10px 0;">Ê≤°ÊúâÂÖ∂‰ªñÂèØÁî®ÁöÑËÅäÂ§©</p>';
    } else {
        availableChatsForSharing.forEach(otherChat => {
            const isChecked = sharedChatIds.includes(otherChat.id);
            const chatType = otherChat.isGroup ? '[Áæ§ËÅä]' : '[ÁßÅËÅä]';
            const label = document.createElement('label');
            label.innerHTML = `<input type="checkbox" value="${otherChat.id}" ${isChecked ? 'checked' : ''}> ${chatType} ${otherChat.name}`;
            memorySharingCheckboxesContainer.appendChild(label);
        });
    }
    updateMemorySharingSelectionDisplay(); const bgPreview = document.getElementById('bg-preview'); const removeBgBtn = document.getElementById('remove-bg-btn'); if (chat.settings.background) { bgPreview.src = chat.settings.background; bgPreview.style.display = 'block'; removeBgBtn.style.display = 'inline-block'; } else { bgPreview.style.display = 'none'; removeBgBtn.style.display = 'none'; } if (isGroup) { document.getElementById('my-group-nickname-input').value = chat.settings.myNickname || ''; document.getElementById('group-avatar-preview').src = chat.settings.groupAvatar || defaultGroupAvatar; renderGroupMemberSettings(chat.members); } else { document.getElementById('ai-persona').value = chat.settings.aiPersona; document.getElementById('ai-avatar-preview').src = chat.settings.aiAvatar || defaultAvatar; } document.getElementById('max-memory').value = chat.settings.maxMemory; const currentTheme = chat.settings.theme || 'default'; const themeRadio = document.querySelector(`input[name="theme-select"][value="${currentTheme}"]`); if (themeRadio) themeRadio.checked = true; chatSettingsModal.classList.add('visible'); });
            function renderGroupMemberSettings(members) { 
                const container = document.getElementById('group-members-settings'); 
                container.innerHTML = ''; 
                
                // Ê∑ªÂä†Áé∞ÊúâÊàêÂëò
                members.forEach(member => { 
                    const div = document.createElement('div'); 
                    div.className = 'member-editor'; 
                    div.dataset.memberId = member.id; 
                    div.innerHTML = `<img src="${member.avatar}" alt="${member.name}"><div class="member-name">${member.name}</div>`; 
                    div.addEventListener('click', () => openMemberEditor(member.id)); 
                    container.appendChild(div); 
                }); 
                
                // Ê∑ªÂä†ÈÇÄËØ∑ÊåâÈíÆ
                const addBtn = document.createElement('div');
                addBtn.className = 'member-action-btn';
                addBtn.id = 'add-group-member-btn';
                addBtn.innerHTML = `<div class="btn-avatar">+</div><div class="btn-label">ÈÇÄËØ∑</div>`;
                container.appendChild(addBtn);
                
                // Ê∑ªÂä†ÁßªÈô§ÊåâÈíÆ
                const removeBtn = document.createElement('div');
                removeBtn.className = 'member-action-btn';
                removeBtn.id = 'remove-group-member-btn';
                removeBtn.innerHTML = `<div class="btn-avatar">-</div><div class="btn-label">ÁßªÈô§</div>`;
                container.appendChild(removeBtn);
            }
            function openMemberEditor(memberId) { editingMemberId = memberId; const chat = state.chats[state.activeChatId]; const member = chat.members.find(m => m.id === memberId); document.getElementById('member-name-input').value = member.name; document.getElementById('member-persona-input').value = member.persona; document.getElementById('member-avatar-preview').src = member.avatar; document.getElementById('member-settings-modal').classList.add('visible'); }
            document.getElementById('cancel-member-settings-btn').addEventListener('click', () => { document.getElementById('member-settings-modal').classList.remove('visible'); editingMemberId = null; });
            document.getElementById('save-member-settings-btn').addEventListener('click', () => { if (!editingMemberId) return; const chat = state.chats[state.activeChatId]; const member = chat.members.find(m => m.id === editingMemberId); member.name = document.getElementById('member-name-input').value; member.persona = document.getElementById('member-persona-input').value; member.avatar = document.getElementById('member-avatar-preview').src; renderGroupMemberSettings(chat.members); document.getElementById('member-settings-modal').classList.remove('visible'); });
            
            // Ê∑ªÂä†Áæ§ÊàêÂëòÁÆ°ÁêÜÂäüËÉΩ - ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâò
            document.addEventListener('click', async (e) => {
                if (e.target.closest('#add-group-member-btn')) {
                    if (!state.activeChatId) return;
                    const chat = state.chats[state.activeChatId];
                    if (!chat.isGroup) return;
                    
                    const memberName = await showCustomPrompt('Ê∑ªÂä†Áæ§ÊàêÂëò', 'ËØ∑ËæìÂÖ•Êñ∞ÊàêÂëòÁöÑÂêçÂ≠ó');
                    if (memberName && memberName.trim()) {
                        const newMember = {
                            id: `member_${Date.now()}`,
                            name: memberName.trim(),
                            avatar: defaultGroupMemberAvatar,
                            persona: '‰∏Ä‰∏™Êñ∞Âä†ÂÖ•ÁöÑÁæ§ÊàêÂëò„ÄÇ'
                        };
                        chat.members.push(newMember);
                        await db.chats.put(chat);
                        renderGroupMemberSettings(chat.members);
                        showToast(`${memberName} Â∑≤Âä†ÂÖ•Áæ§ËÅäÔºÅ`, 'success');
                    }
                }
                
                if (e.target.closest('#remove-group-member-btn')) {
                    if (!state.activeChatId) return;
                    const chat = state.chats[state.activeChatId];
                    if (!chat.isGroup || chat.members.length <= 2) {
                        showToast('Áæ§ËÅäËá≥Â∞ëÈúÄË¶Å‰øùÁïô2ÂêçÊàêÂëò', 'error');
                        return;
                    }
                    
                    // ÂàõÂª∫ÊàêÂëòÈÄâÊã©ÂàóË°®ÔºåÂåÖÂê´Â§¥ÂÉè
                    const memberOptions = chat.members.map(member => 
                        `<label style="display: flex; align-items: center; margin: 8px 0; cursor: pointer; padding: 8px; border-radius: 8px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='transparent'">
                            <input type="radio" name="member-select" value="${member.id}" style="margin-right: 12px;">
                            <img src="${member.avatar}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 12px;">
                            <span style="font-size: 14px; color: #333;">${member.name}</span>
                        </label>`
                    ).join('');
                    
                    const modalBodyContent = `
                        <p style="margin-bottom: 15px; color: #333;">ËØ∑ÈÄâÊã©Ë¶ÅÁßªÈô§ÁöÑÊàêÂëòÔºö</p>
                        <div style="max-height: 250px; overflow-y: auto; padding: 5px 0;">
                            ${memberOptions}
                        </div>
                    `;
                    
                    modalTitle.textContent = 'ÁßªÈô§Áæ§ÊàêÂëò';
                    modalBody.innerHTML = modalBodyContent;
                    modalCancelBtn.style.display = 'block';
                    modalConfirmBtn.textContent = 'Á°ÆÂÆöÁßªÈô§';
                    modalConfirmBtn.classList.add('btn-danger');
                    
                    modalConfirmBtn.onclick = async () => {
                        const selectedRadio = document.querySelector('input[name="member-select"]:checked');
                        if (!selectedRadio) {
                            showToast('ËØ∑ÈÄâÊã©Ë¶ÅÁßªÈô§ÁöÑÊàêÂëò', 'error');
                            return;
                        }
                        
                        const memberId = selectedRadio.value;
                        const memberIndex = chat.members.findIndex(m => m.id === memberId);
                        if (memberIndex !== -1) {
                            const removedMember = chat.members[memberIndex];
                            chat.members.splice(memberIndex, 1);
                            await db.chats.put(chat);
                            renderGroupMemberSettings(chat.members);
                            showToast(`${removedMember.name} Â∑≤Á¶ªÂºÄÁæ§ËÅä`, 'success');
                        }
                        hideCustomModal();
                    };
                    
                    showCustomModal();
                }
            });
            
            document.getElementById('reset-theme-btn').addEventListener('click', () => { document.getElementById('theme-default').checked = true; });
            document.getElementById('cancel-chat-settings-btn').addEventListener('click', () => { chatSettingsModal.classList.remove('visible'); });
            document.getElementById('save-chat-settings-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const newName = document.getElementById('chat-name-input').value.trim(); if (!newName) return alert('Â§áÊ≥®Âêç/Áæ§Âêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ'); chat.name = newName; const selectedThemeRadio = document.querySelector('input[name="theme-select"]:checked'); chat.settings.theme = selectedThemeRadio ? selectedThemeRadio.value : 'default'; chat.settings.myPersona = document.getElementById('my-persona').value; chat.settings.myAvatar = document.getElementById('my-avatar-preview').src; 
            
            // ‰øùÂ≠òÊà≥‰∏ÄÊà≥ÂêéÁºÄ
            chat.settings.myPokeSuffix = document.getElementById('my-poke-suffix').value.trim();
            chat.settings.aiPokeSuffix = document.getElementById('ai-poke-suffix').value.trim();
            
            const checkedBooks = document.querySelectorAll('#world-book-checkboxes-container input[type="checkbox"]:checked'); chat.settings.linkedWorldBookIds = Array.from(checkedBooks).map(cb => cb.value); if (chat.isGroup) { chat.settings.myNickname = document.getElementById('my-group-nickname-input').value.trim(); chat.settings.groupAvatar = document.getElementById('group-avatar-preview').src; } else { chat.settings.aiPersona = document.getElementById('ai-persona').value; chat.settings.aiAvatar = document.getElementById('ai-avatar-preview').src; } chat.settings.maxMemory = parseInt(document.getElementById('max-memory').value) || 10; // ‰øùÂ≠òÂæÆÂçöËÆæÁΩÆ
            chat.settings.weiboEnabled = document.getElementById('weibo-enabled').checked;
            chat.settings.weiboFrequency = document.getElementById('weibo-frequency').value;

            // ‰øùÂ≠òÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
            const timeInputs = document.querySelectorAll('.posting-time-input');
            chat.settings.weiboPostingTimes = Array.from(timeInputs).map(input => input.value).filter(Boolean);
            
            // ‰øùÂ≠òÂêéÂè∞‰∫íÂä®ËÆæÁΩÆ
            chat.settings.backgroundInteractionEnabled = document.getElementById('background-interaction-enabled').checked;
            chat.settings.backgroundChatFrequency = document.getElementById('background-chat-frequency').value;
            chat.settings.backgroundWeiboFrequency = document.getElementById('background-weibo-frequency').value;
            chat.settings.backgroundChatEnabled = document.getElementById('background-chat-enabled').checked;
            chat.settings.backgroundWeiboEnabled = document.getElementById('background-weibo-enabled').checked;
            // ‰øùÂ≠òÊó∂Èó¥ÊèêÁ§∫ËØçËÆæÁΩÆ
            chat.settings.timeAwarenessEnabled = document.getElementById('time-awareness-enabled').checked;
            // ‰øùÂ≠òAI‰∏ªÂä®Êã®ÊâìÁîµËØùËÆæÁΩÆ
            chat.settings.aiCallEnabled = document.getElementById('ai-call-enabled').checked;
            // ‰øùÂ≠òAIÂøÉÁéáÁõëÊµãËÆæÁΩÆ
            chat.settings.aiHeartrateEnabled = document.getElementById('ai-heartrate-enabled').checked;
            
            // ‰øùÂ≠òÂπ∂ÂèëËÅäÂ§©ËÆæÁΩÆ
            chat.settings.concurrentChatEnabled = document.getElementById('concurrent-chat-enabled').checked;
            
            // ‰øùÂ≠òËÅäÂ§©Ê®°ÂºèËÆæÁΩÆ
            const selectedChatMode = document.querySelector('input[name="chat-mode"]:checked');
            chat.settings.chatMode = selectedChatMode ? selectedChatMode.value : 'online';
            
            // ‰øùÂ≠òÁ∫ø‰∏ãÊ®°ÂºèÂ≠óÊï∞ÈôêÂà∂ËÆæÁΩÆ
            const offlineModeMinLength = parseInt(document.getElementById('offline-mode-min-length').value);
            const offlineModeMaxLength = parseInt(document.getElementById('offline-mode-max-length').value);
            chat.settings.offlineModeMinLength = Math.max(20, Math.min(800, offlineModeMinLength || 50));
            chat.settings.offlineModeMaxLength = Math.max(50, Math.min(1000, offlineModeMaxLength || 100));

            // Á°Æ‰øùÊúÄÂ∞èÂÄº‰∏çÂ§ß‰∫éÊúÄÂ§ßÂÄº
            if (chat.settings.offlineModeMinLength > chat.settings.offlineModeMaxLength) {
                chat.settings.offlineModeMinLength = chat.settings.offlineModeMaxLength - 20;
            }
            
            // ‰øùÂ≠òËÆ∞ÂøÜÊåÇËΩΩËÆæÁΩÆ
            chat.settings.memoryMountEnabled = document.getElementById('memory-mount-enabled').checked;
            chat.settings.memoryMountCount = parseInt(document.getElementById('memory-mount-count').value) || 10;
            const checkedMemoryChats = document.querySelectorAll('#memory-mount-checkboxes-container input[type="checkbox"]:checked');
            chat.settings.memoryMountChatIds = Array.from(checkedMemoryChats).map(cb => cb.value);
            
            // ‰øùÂ≠òÊô∫ËÉΩËÆ∞ÂøÜÂÖ±‰∫´ËÆæÁΩÆ
            chat.settings.memorySharing = {
                enabled: document.getElementById('memory-sharing-enabled').checked,
                chatIds: Array.from(document.querySelectorAll('#memory-sharing-checkboxes-container input[type="checkbox"]:checked')).map(cb => cb.value),
                categories: {
                    mood: document.getElementById('share-mood').checked,
                    events: document.getElementById('share-events').checked,
                    interests: document.getElementById('share-interests').checked,
                    plans: document.getElementById('share-plans').checked
                },
                threshold: parseFloat(document.getElementById('sharing-threshold').value) || 0.6
            };
            
            await db.chats.put(chat);
            chatSettingsModal.classList.remove('visible'); renderChatInterface(state.activeChatId); renderChatList(); 
            
            // ÈáçÊñ∞ÂàùÂßãÂåñAIËá™Âä®ÂèëÂ∏ÉÁ≥ªÁªü
            await initAiPostingSystem();
            
            // ÈáçÊñ∞ÂàùÂßãÂåñÂêéÂè∞‰∫íÂä®Á≥ªÁªü
            initBackgroundInteractionSystem();
        });
            document.getElementById('clear-chat-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const confirmed = await showCustomConfirm('Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï', 'Ê≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§Ê≠§ËÅäÂ§©ÁöÑÊâÄÊúâÊ∂àÊÅØÔºåÊó†Ê≥ïÊÅ¢Â§ç„ÄÇÁ°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÂêóÔºü', { confirmButtonClass: 'btn-danger' }); if (confirmed) { chat.history = []; await db.chats.put(chat); renderChatInterface(state.activeChatId); renderChatList(); chatSettingsModal.classList.remove('visible'); } });
            const setupFileUpload = (inputId, callback) => { document.getElementById(inputId).addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); callback(dataUrl); event.target.value = null; } }); };
            setupFileUpload('ai-avatar-input', (base64) => document.getElementById('ai-avatar-preview').src = base64);
            setupFileUpload('my-avatar-input', (base64) => document.getElementById('my-avatar-preview').src = base64);
            setupFileUpload('group-avatar-input', (base64) => document.getElementById('group-avatar-preview').src = base64);
            setupFileUpload('member-avatar-input', (base64) => document.getElementById('member-avatar-preview').src = base64);
            setupFileUpload('bg-input', (base64) => { if(state.activeChatId) { state.chats[state.activeChatId].settings.background = base64; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = base64; bgPreview.style.display = 'block'; document.getElementById('remove-bg-btn').style.display = 'inline-block'; } });
            setupFileUpload('preset-avatar-input', (base64) => document.getElementById('preset-avatar-preview').src = base64);
            document.getElementById('remove-bg-btn').addEventListener('click', () => { if (state.activeChatId) { state.chats[state.activeChatId].settings.background = ''; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = ''; bgPreview.style.display = 'none'; document.getElementById('remove-bg-btn').style.display = 'none'; } });

            const stickerPanel = document.getElementById('sticker-panel');
            document.getElementById('open-sticker-panel-btn').addEventListener('click', () => { renderStickerPanel(); stickerPanel.classList.add('visible'); });
            document.getElementById('close-sticker-panel-btn').addEventListener('click', () => stickerPanel.classList.remove('visible'));
            document.getElementById('add-sticker-btn').addEventListener('click', async () => { const url = await showCustomPrompt("Ê∑ªÂä†Ë°®ÊÉÖ(URL)", "ËØ∑ËæìÂÖ•Ë°®ÊÉÖÂåÖÁöÑÂõæÁâáURL"); if (!url || !url.trim().startsWith('http')) return url && alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑURL (‰ª•httpÂºÄÂ§¥)"); const name = await showCustomPrompt("ÂëΩÂêçË°®ÊÉÖ", "ËØ∑‰∏∫Ëøô‰∏™Ë°®ÊÉÖÂëΩÂêç (‰æãÂ¶ÇÔºöÂºÄÂøÉ„ÄÅÁñëÊÉë)"); if (name && name.trim()) { const newSticker = { id: 'sticker_' + Date.now(), url: url.trim(), name: name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); renderStickerPanel(); } else if (name !== null) alert("Ë°®ÊÉÖÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ"); });
            document.getElementById('upload-sticker-btn').addEventListener('click', () => document.getElementById('sticker-upload-input').click());
            document.getElementById('sticker-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = async () => { const base64Url = reader.result; const name = await showCustomPrompt("ÂëΩÂêçË°®ÊÉÖ", "ËØ∑‰∏∫Ëøô‰∏™Ë°®ÊÉÖÂëΩÂêç (‰æãÂ¶ÇÔºöÂ•ΩËÄ∂„ÄÅÁñëÊÉë)"); if (name && name.trim()) { const newSticker = { id: 'sticker_' + Date.now(), url: base64Url, name: name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); renderStickerPanel(); } else if (name !== null) alert("Ë°®ÊÉÖÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ"); }; event.target.value = null; });
            document.getElementById('upload-image-btn').addEventListener('click', () => document.getElementById('image-upload-input').click());
            document.getElementById('image-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file || !state.activeChatId) return; const reader = new FileReader(); reader.onload = async (e) => { const base64Url = e.target.result; 
                // ËÆ∞ÂΩïÁî®Êà∑ÊúÄËøë‰∏ä‰º†ÁöÑÂõæÁâá
                recentUserUploadedImage = base64Url;
                
                const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: [{ type: 'image_url', image_url: { url: base64Url } }], timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); }; reader.readAsDataURL(file); event.target.value = null; });
            document.getElementById('voice-message-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const text = await showCustomPrompt("ÂèëÈÄÅËØ≠Èü≥", "ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥ËØ¥ÁöÑÂÜÖÂÆπÔºö"); if (text && text.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'voice_message', content: text.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
            
            document.getElementById('send-photo-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const description = await showCustomPrompt("ÂèëÈÄÅÁÖßÁâá", "ËØ∑Áî®ÊñáÂ≠óÊèèËø∞ÊÇ®Ë¶ÅÂèëÈÄÅÁöÑÁÖßÁâáÔºö"); if (description && description.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'user_photo', content: description.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
            
            // Persona Preset Event Listeners
            document.getElementById('open-persona-library-btn').addEventListener('click', openPersonaLibrary);
            document.getElementById('close-persona-library-btn').addEventListener('click', closePersonaLibrary);
            document.getElementById('add-persona-preset-btn').addEventListener('click', openPersonaEditorForCreate);
            document.getElementById('cancel-persona-editor-btn').addEventListener('click', closePersonaEditor);
            document.getElementById('save-persona-preset-btn').addEventListener('click', savePersonaPreset);
            document.getElementById('preset-action-edit').addEventListener('click', openPersonaEditorForEdit);
            document.getElementById('preset-action-delete').addEventListener('click', deletePersonaPreset);
            document.getElementById('preset-action-cancel').addEventListener('click', hidePresetActions);


            // Selection Event Listeners
            document.getElementById('selection-cancel-btn').addEventListener('click', exitSelectionMode);
            document.getElementById('selection-delete-btn').addEventListener('click', async () => { if (selectedMessages.size === 0) return; const confirmed = await showCustomConfirm('Âà†Èô§Ê∂àÊÅØ', `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedMessages.size} Êù°Ê∂àÊÅØÂêóÔºü`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { const chat = state.chats[state.activeChatId]; chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp)); await db.chats.put(chat); renderChatInterface(state.activeChatId); renderChatList(); } });
            
            // ÂæÆÂçöÁõ∏ÂÖ≥‰∫ã‰ª∂ÁõëÂê¨
            document.getElementById('post-weibo-btn').addEventListener('click', () => {
                document.getElementById('post-weibo-modal').classList.add('visible');
            });

            // ÂæÆÂçöÂõæÁâá‰∏ä‰º†ÂäüËÉΩ
            document.getElementById('add-weibo-photo').addEventListener('click', () => {
                document.getElementById('weibo-image-input').click();
            });

            document.getElementById('weibo-image-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('weibo-preview-img').src = e.target.result;
                    document.getElementById('weibo-image-preview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            });

            document.getElementById('remove-weibo-image').addEventListener('click', () => {
                document.getElementById('weibo-image-preview').style.display = 'none';
                document.getElementById('weibo-image-input').value = '';
            });

            document.querySelector('#post-weibo-modal .cancel').addEventListener('click', () => {
                document.getElementById('post-weibo-modal').classList.remove('visible');
                document.getElementById('weibo-content').value = '';
            });

            document.querySelector('#post-weibo-modal .save').addEventListener('click', async () => {
                const content = document.getElementById('weibo-content').value.trim();
                const visibility = document.getElementById('post-visibility').value;
                
                if (!content) {
                    showToast('ËØ∑ËæìÂÖ•ÂÜÖÂÆπ', 'error');
                    return;
                }
                
                // Á¶ÅÁî®ÂèëÂ∏ÉÊåâÈíÆÔºåÈò≤Ê≠¢ÈáçÂ§çÁÇπÂáª
                const saveBtn = document.querySelector('#post-weibo-modal .save');
                const originalText = saveBtn.textContent;
                saveBtn.textContent = 'ÂèëÂ∏É‰∏≠...';
                saveBtn.disabled = true;
                
                try {
                    // Ëé∑ÂèñÂõæÁâáÔºàÂ¶ÇÊûúÊúâÔºâ
                    const imagePreview = document.getElementById('weibo-image-preview');
                    const imageUrl = imagePreview.style.display !== 'none' ? 
                        document.getElementById('weibo-preview-img').src : null;
                    
                    const success = await publishPost(content, visibility, imageUrl);
                    if (success) {
                        document.getElementById('post-weibo-modal').classList.remove('visible');
                        document.getElementById('weibo-content').value = '';
                        document.getElementById('weibo-image-preview').style.display = 'none';
                        document.getElementById('weibo-image-input').value = '';
                        // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                        showToast('ÂèëÂ∏ÉÊàêÂäüÔºÅ', 'success');
                    } else {
                        showToast('ÂèëÂ∏ÉÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï', 'error');
                    }
                } catch (error) {
                    console.error('ÂèëÂ∏ÉÂæÆÂçöÂ§±Ë¥•:', error);
                    showToast('ÂèëÂ∏ÉÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï', 'error');
                } finally {
                    // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                }
            });

            // ÂæÆÂçö‰∏ªÈ¢òËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨
            document.getElementById('weibo-theme-btn').addEventListener('click', async () => {
                // ÊòæÁ§∫‰∏ªÈ¢òËÆæÁΩÆÂºπÁ™ó
                document.getElementById('weibo-theme-modal').classList.add('visible');

                // ‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩ‰øùÂ≠òÁöÑÂæÆÂçöËÆæÁΩÆ
                let weiboSettings = null;
                try {
                    weiboSettings = await db.weiboSettings.get('main');
                } catch (error) {
                    console.log('Âä†ËΩΩÂæÆÂçöËÆæÁΩÆÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ËÆæÁΩÆ');
                }

                // ÂàùÂßãÂåñÈÄèÊòéÂ∫¶ÊªëÂùóÁöÑÂÄº
                const savedOpacity = weiboSettings?.cardOpacity || 1.0;
                const opacitySlider = document.getElementById('card-opacity-slider');
                const opacityValue = document.getElementById('card-opacity-value');
                opacitySlider.value = savedOpacity;
                opacityValue.textContent = savedOpacity;

                // ÊÅ¢Â§ç‰øùÂ≠òÁöÑ‰∏ªÈ¢òÈÄâÊã©
                const savedTheme = weiboSettings?.theme || 'white';
                document.querySelectorAll('#weibo-theme-modal .theme-dot').forEach(dot => {
                    dot.classList.remove('active');
                });
                const savedThemeDot = document.querySelector(`#weibo-theme-modal .theme-dot[data-theme="${savedTheme}"]`);
                if (savedThemeDot) {
                    savedThemeDot.classList.add('active');
                }

                // ÊÅ¢Â§ç‰øùÂ≠òÁöÑËÉåÊôØÂõæÁâáÈ¢ÑËßà
                const savedBackground = weiboSettings?.backgroundImage;
                const bgPreview = document.getElementById('weibo-bg-preview');
                if (savedBackground) {
                    bgPreview.style.backgroundImage = `url(${savedBackground})`;
                    bgPreview.textContent = '';
                    document.getElementById('remove-weibo-bg-btn').style.display = 'inline-block';
                } else {
                    bgPreview.style.backgroundImage = 'none';
                    bgPreview.textContent = 'ÁÇπÂáª‰∏ãÊñπ‰∏ä‰º†ËÉåÊôØÂõæÁâá';
                    document.getElementById('remove-weibo-bg-btn').style.display = 'none';
                }
            });

            document.querySelector('#weibo-theme-modal .cancel').addEventListener('click', () => {
                document.getElementById('weibo-theme-modal').classList.remove('visible');
            });

            document.querySelector('#weibo-theme-modal .save').addEventListener('click', async () => {
                // Â∫îÁî®‰∏ªÈ¢òËÆæÁΩÆ
                const activeTheme = document.querySelector('#weibo-theme-modal .theme-dot.active');
                let theme = 'white';
                if (activeTheme) {
                    theme = activeTheme.dataset.theme;
                    document.body.setAttribute('data-weibo-theme', theme);
                }

                // Â∫îÁî®ËÉåÊôØËÆæÁΩÆ
                const bgPreview = document.getElementById('weibo-bg-preview');
                const bgImage = bgPreview.style.backgroundImage;
                let backgroundImage = null;
                if (bgImage && bgImage !== 'none') {
                    document.getElementById('weibo-screen').style.backgroundImage = bgImage;
                    document.getElementById('weibo-screen').style.backgroundSize = 'cover';
                    document.getElementById('weibo-screen').style.backgroundPosition = 'center';
                    backgroundImage = bgImage.slice(5, -2); // ÁßªÈô§ url("...") ÂåÖË£Ö
                } else {
                    document.getElementById('weibo-screen').style.backgroundImage = 'none';
                }

                // Â∫îÁî®Âä®ÊÄÅÂç°ÁâáÈÄèÊòéÂ∫¶ËÆæÁΩÆ
                const opacity = document.getElementById('card-opacity-slider').value;
                applyWeiboCardOpacity(opacity);

                // ‰øùÂ≠òÊâÄÊúâËÆæÁΩÆÂà∞DexieÊï∞ÊçÆÂ∫ì
                const weiboSettings = {
                    id: 'main',
                    theme: theme,
                    backgroundImage: backgroundImage,
                    cardOpacity: opacity
                };

                try {
                    await db.weiboSettings.put(weiboSettings);
                    showToast('ÂæÆÂçö‰∏ªÈ¢òËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ', 'success');
                } catch (error) {
                    console.error('‰øùÂ≠òÂæÆÂçöËÆæÁΩÆÂ§±Ë¥•:', error);
                    showToast('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
                }

                document.getElementById('weibo-theme-modal').classList.remove('visible');
            });

            // ÂæÆÂçöËÉåÊôØ‰∏ä‰º†
            document.getElementById('weibo-bg-upload-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const bgPreview = document.getElementById('weibo-bg-preview');
                    bgPreview.style.backgroundImage = `url(${e.target.result})`;
                    bgPreview.textContent = '';
                    document.getElementById('remove-weibo-bg-btn').style.display = 'inline-block';
                };
                reader.readAsDataURL(file);
            });

            document.getElementById('remove-weibo-bg-btn').addEventListener('click', () => {
                const bgPreview = document.getElementById('weibo-bg-preview');
                bgPreview.style.backgroundImage = 'none';
                bgPreview.textContent = 'ÁÇπÂáª‰∏ãÊñπ‰∏ä‰º†ËÉåÊôØÂõæÁâá';
                document.getElementById('remove-weibo-bg-btn').style.display = 'none';
                // Ê∏ÖÈô§Êñá‰ª∂ËæìÂÖ•
                document.getElementById('weibo-bg-upload-input').value = '';
            });

            // Áî®Êà∑ËµÑÊñôÂç°‰∫ã‰ª∂ÁõëÂê¨
            document.querySelector('#weibo-profile-modal .cancel').addEventListener('click', () => {
                document.getElementById('weibo-profile-modal').classList.remove('visible');

                // ÈáçÁΩÆÊñá‰ª∂ËæìÂÖ•
                document.getElementById('user-profile-bg-input').value = '';
            });

            document.querySelector('#weibo-profile-modal .save').addEventListener('click', async () => {
                const name = document.getElementById('profile-name-input').value.trim();
                const signature = document.getElementById('profile-signature-input').value.trim();
                const email = document.getElementById('profile-email-input').value.trim();
                const avatar = document.getElementById('profile-avatar-preview').src;
                
                // Ëé∑ÂèñÁ§æ‰∫§‰∏ªÈ°µËÉåÊôØ
                const bgPreview = document.getElementById('user-profile-bg-preview');
                const socialBackground = bgPreview.style.backgroundImage ? 
                    bgPreview.style.backgroundImage.slice(5, -2) : null; // ÁßªÈô§ url("...") ÂåÖË£Ö
                
                if (!name) {
                    showToast('ËØ∑ËæìÂÖ•ÊòµÁß∞', 'error');
                    return;
                }
                
                // ‰øùÂ≠òÁî®Êà∑ËµÑÊñô
                const profile = {
                    name,
                    signature,
                    email,
                    avatar,
                    socialBackground
                };
                await db.userProfiles.put({
                    id: 'weibo_user_profile',
                    type: 'weibo_profile',
                    data: profile,
                    timestamp: Date.now()
                });

                // Êõ¥Êñ∞ÁºìÂ≠ò
                userProfileCache = profile;
                
                document.getElementById('weibo-profile-modal').classList.remove('visible');
                showToast('ËµÑÊñô‰øùÂ≠òÊàêÂäüÔºÅ', 'success');
                
                // ÈáçÊñ∞Ê∏≤ÊüìÊó∂Èó¥Á∫ø‰ª•Êõ¥Êñ∞ÊòæÁ§∫
                if (window.renderWeiboTimelineProxy) {
                    window.renderWeiboTimelineProxy();
                }
            });

            // Áî®Êà∑Â§¥ÂÉè‰∏ä‰º†
            document.getElementById('profile-avatar-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('profile-avatar-preview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            });

            // Áî®Êà∑Á§æ‰∫§‰∏ªÈ°µËÉåÊôØ‰∏ä‰º†
            document.getElementById('user-profile-bg-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('user-profile-bg-preview');
                    preview.style.backgroundImage = `url(${e.target.result})`;
                    preview.textContent = '';
                    document.getElementById('remove-user-profile-bg-btn').style.display = 'block';
                };
                reader.readAsDataURL(file);
            });

            // ÁßªÈô§Áî®Êà∑Á§æ‰∫§‰∏ªÈ°µËÉåÊôØ
            document.getElementById('remove-user-profile-bg-btn').addEventListener('click', () => {
                const preview = document.getElementById('user-profile-bg-preview');
                preview.style.backgroundImage = '';
                preview.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                preview.textContent = 'ÈªòËÆ§Ê∏êÂèòËÉåÊôØ';
                document.getElementById('remove-user-profile-bg-btn').style.display = 'none';
                document.getElementById('user-profile-bg-input').value = '';
            });

            // AIËµÑÊñôÂç°‰∫ã‰ª∂ÁõëÂê¨
            document.querySelector('#ai-profile-modal .cancel').addEventListener('click', () => {
                document.getElementById('ai-profile-modal').classList.remove('visible');

                // ÈáçÁΩÆÊñá‰ª∂ËæìÂÖ•
                document.getElementById('ai-profile-bg-input').value = '';
            });

            document.querySelector('#ai-profile-modal .save').addEventListener('click', async () => {
                if (!window.state || !window.db) {
                    showToast('Á≥ªÁªüÊú™ÂàùÂßãÂåñ', 'error');
                    return;
                }
                
                const aiId = document.getElementById('ai-profile-modal').dataset.aiId;
                if (!aiId || !window.state.chats[aiId]) {
                    showToast('AI‰ø°ÊÅØ‰∏çÂ≠òÂú®', 'error');
                    return;
                }
                
                const chat = window.state.chats[aiId];
                const name = document.getElementById('ai-profile-name-input').value.trim();
                const signature = document.getElementById('ai-profile-signature-input').value.trim();
                const persona = document.getElementById('ai-profile-persona-input').value.trim();
                const avatar = document.getElementById('ai-profile-avatar-preview').src;
                
                if (!name) {
                    showToast('ËØ∑ËæìÂÖ•ÊòµÁß∞', 'error');
                    return;
                }
                
                // Ëé∑ÂèñÁ§æ‰∫§‰∏ªÈ°µËÉåÊôØ
                const bgPreview = document.getElementById('ai-profile-bg-preview');
                const socialBackground = bgPreview.style.backgroundImage ? 
                    bgPreview.style.backgroundImage.slice(5, -2) : null; // ÁßªÈô§ url("...") ÂåÖË£Ö
                
                // Êõ¥Êñ∞AIËµÑÊñô
                chat.name = name;
                chat.settings.aiAvatar = avatar;
                chat.settings.aiSignature = signature;
                chat.settings.aiPersona = persona;
                chat.settings.socialBackground = socialBackground;
                
                // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                await window.db.chats.put(chat);
                
                document.getElementById('ai-profile-modal').classList.remove('visible');
                showToast('AIËµÑÊñô‰øùÂ≠òÊàêÂäüÔºÅ', 'success');
                
                // ÈáçÊñ∞Ê∏≤ÊüìÊó∂Èó¥Á∫ø‰ª•Êõ¥Êñ∞ÊòæÁ§∫
                if (window.renderWeiboTimelineProxy) {
                    window.renderWeiboTimelineProxy();
                }
            });

            // AIÂ§¥ÂÉè‰∏ä‰º†
            document.getElementById('ai-profile-avatar-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('ai-profile-avatar-preview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            });

            // AIÁ§æ‰∫§‰∏ªÈ°µËÉåÊôØ‰∏ä‰º†
            document.getElementById('ai-profile-bg-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('ai-profile-bg-preview');
                    preview.style.backgroundImage = `url(${e.target.result})`;
                    preview.textContent = '';
                    document.getElementById('remove-ai-profile-bg-btn').style.display = 'block';
                };
                reader.readAsDataURL(file);
            });

            // ÁßªÈô§AIÁ§æ‰∫§‰∏ªÈ°µËÉåÊôØ
            document.getElementById('remove-ai-profile-bg-btn').addEventListener('click', () => {
                const preview = document.getElementById('ai-profile-bg-preview');
                preview.style.backgroundImage = '';
                preview.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                preview.textContent = 'ÈªòËÆ§Ê∏êÂèòËÉåÊôØ';
                document.getElementById('remove-ai-profile-bg-btn').style.display = 'none';
                document.getElementById('ai-profile-bg-input').value = '';
            });

            // ÂæÆÂçöÂØºËà™ÂàáÊç¢
            document.querySelectorAll('.weibo-nav .nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    // Â¶ÇÊûúÊ≠£Âú®ÈÄâÊã©Ê®°ÂºèÔºåÂÖàÈÄÄÂá∫
                    if (isWeiboSelectionMode) {
                        exitWeiboSelectionMode();
                    }
                    
                    document.querySelectorAll('.weibo-nav .nav-item').forEach(i => 
                        i.classList.remove('active'));
                    e.target.classList.add('active');
                    renderWeiboTimeline(e.target.textContent === '‚Çç^À∂ ‚ï∏ñ•¶  ‚ï∏Àµ^‚Çé‚üÜ' ? 'mine' : 'all');
                });
            });

            // ÂæÆÂçöÂ§öÈÄâÂ∑•ÂÖ∑Ê†è‰∫ã‰ª∂ÁõëÂê¨
            document.getElementById('weibo-selection-cancel').addEventListener('click', () => {
                exitWeiboSelectionMode();
            });

            document.getElementById('weibo-selection-delete').addEventListener('click', () => {
                deleteSelectedWeiboPosts();
            });

            document.getElementById('weibo-enabled').addEventListener('change', function() {
                const frequencySettings = document.getElementById('weibo-frequency-settings');
                frequencySettings.style.display = this.checked ? 'block' : 'none';
            });

            // ÊµãËØïAIÂèëÂ∏ÉÊåâÈíÆ
            document.getElementById('test-ai-posting-btn').addEventListener('click', async () => {
                if (!state.activeChatId) {
                    alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©ÂØπË±°');
                    return;
                }
                
                const chat = state.chats[state.activeChatId];
                if (!chat.settings.weiboEnabled) {
                    alert('ËØ∑ÂÖàÂêØÁî®ÂæÆÂçöÂäüËÉΩ');
                    return;
                }
                
                // Ê£ÄÊü•APIÈÖçÁΩÆ
                const { proxyUrl, apiKey, model } = state.apiConfig;
                if (!proxyUrl || !apiKey || !model) {
                    alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂÆåÊï¥ÁöÑÂèç‰ª£Âú∞ÂùÄ„ÄÅÂØÜÈí•ÂíåÊ®°Âûã');
                    return;
                }
                
                // Ê£ÄÊü•ËßíËâ≤ËÆæÂÆö
                if (!chat.settings.aiPersona || chat.settings.aiPersona.trim() === '') {
                    alert('ËØ∑ÂÖàËÆæÁΩÆAIËßíËâ≤ÁöÑ‰∫∫ËÆæÔºåËøôÊ†∑AIÊâçËÉΩÁîüÊàêÁ¨¶ÂêàËßíËâ≤ÁöÑÂä®ÊÄÅÂÜÖÂÆπ');
                    return;
                }
                
                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                const testBtn = document.getElementById('test-ai-posting-btn');
                const originalText = testBtn.textContent;
                testBtn.textContent = 'ÊµãËØï‰∏≠...';
                testBtn.disabled = true;
                
                try {
                    console.log('ÂºÄÂßãAIÂèëÂ∏ÉÊµãËØï...');
                    console.log('APIÈÖçÁΩÆ:', {
                        proxyUrl: state.apiConfig.proxyUrl,
                        model: state.apiConfig.model,
                        hasApiKey: !!state.apiConfig.apiKey
                    });
                    
                    const content = await generateAiPostContent(chat);
                    console.log('ÁîüÊàêÁöÑÂÜÖÂÆπ:', content);
                    
                    await publishAiPost(state.activeChatId, content);
                    alert('AIÂèëÂ∏ÉÊµãËØïÊàêÂäüÔºÅËØ∑Êü•ÁúãÂæÆÂçöÊó∂Èó¥Á∫ø„ÄÇ');
                } catch (error) {
                    console.error('AIÂèëÂ∏ÉÊµãËØïÂ§±Ë¥•:', error);
                    console.error('ÈîôËØØËØ¶ÊÉÖ:', {
                        name: error.name,
                        message: error.message,
                        stack: error.stack
                    });
                    
                    // Ê†πÊçÆÈîôËØØÁ±ªÂûãÊèê‰æõ‰∏çÂêåÁöÑÊèêÁ§∫
                    let errorMessage = error.message;
                    if (error.message.includes('APIÈÖçÁΩÆ‰∏çÂÆåÊï¥')) {
                        errorMessage = 'ËØ∑Ê£ÄÊü•APIËÆæÁΩÆ‰∏≠ÁöÑÂèç‰ª£Âú∞ÂùÄ„ÄÅÂØÜÈí•ÂíåÊ®°ÂûãÈÖçÁΩÆ';
                    } else if (error.message.includes('ÁΩëÁªúËøûÊé•Â§±Ë¥•')) {
                        errorMessage = 'ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Âèç‰ª£Âú∞ÂùÄÊòØÂê¶Ê≠£Á°ÆÊàñÁΩëÁªúËøûÊé•';
                    } else if (error.message.includes('ËØ∑Ê±ÇË∂ÖÊó∂')) {
                        errorMessage = 'ËØ∑Ê±ÇË∂ÖÊó∂Ôºà90ÁßíÔºâÔºåËØ∑Ê£ÄÊü•Ôºö\n1. ÁΩëÁªúËøûÊé•ÊòØÂê¶Á®≥ÂÆö\n2. APIÊúçÂä°ÊòØÂê¶Ê≠£Â∏∏\n3. ÊòØÂê¶‰ΩøÁî®‰∫ÜÊ≠£Á°ÆÁöÑAPIÂú∞ÂùÄ';
                    } else if (error.message.includes('ÊúçÂä°Âô®ÂÜÖÈÉ®ÈîôËØØ')) {
                        errorMessage = 'ÊúçÂä°Âô®ÂÜÖÈÉ®ÈîôËØØÔºåÂèØËÉΩÊòØÂèç‰ª£ÊúçÂä°Âô®ÈóÆÈ¢òÔºåËØ∑Á®çÂêéÈáçËØï';
                    } else if (error.message.includes('APIÂØÜÈí•Êó†Êïà')) {
                        errorMessage = 'APIÂØÜÈí•Êó†ÊïàÊàñÂ∑≤ËøáÊúüÔºåËØ∑Ê£ÄÊü•ÂØÜÈí•ËÆæÁΩÆ';
                    } else if (error.message.includes('CORS')) {
                        errorMessage = 'CORSË∑®ÂüüÈîôËØØÔºåËØ∑‰ΩøÁî®HTTPÊúçÂä°Âô®ËøêË°åÊ≠§Êñá‰ª∂';
                    } else if (error.name === 'AbortError') {
                        errorMessage = 'ËØ∑Ê±ÇË¢´ÂèñÊ∂àÔºàË∂ÖÊó∂ÔºâÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂíåAPIÊúçÂä°Áä∂ÊÄÅ';
                    } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        errorMessage = 'ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Ôºö\n1. Âèç‰ª£Âú∞ÂùÄÊòØÂê¶Ê≠£Á°Æ\n2. ÁΩëÁªúËøûÊé•ÊòØÂê¶Ê≠£Â∏∏\n3. ÊòØÂê¶ÊúâÈò≤ÁÅ´Â¢ôÈòªÊ≠¢ËØ∑Ê±Ç';
                    }
                    
                    alert(`AIÂèëÂ∏ÉÊµãËØïÂ§±Ë¥•:\n\n${errorMessage}\n\nÂ¶ÇÈúÄÊõ¥Â§ö‰ø°ÊÅØÔºåËØ∑Êü•ÁúãÊµèËßàÂô®ÊéßÂà∂Âè∞ÔºàF12Ôºâ„ÄÇ`);
                } finally {
                    // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                    testBtn.textContent = originalText;
                    testBtn.disabled = false;
                }
            });

            // Âú®init()ÂáΩÊï∞‰∏≠Ê∑ªÂä†‰ª•‰∏ã‰ª£Á†ÅÔºö

            // Ê∑ªÂä†Êó∂Èó¥ÁÇπÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            document.querySelector('.add-time-btn').addEventListener('click', () => {
                const timeInputGroup = document.createElement('div');
                timeInputGroup.className = 'time-input-group';
                timeInputGroup.innerHTML = `
                    <input type="time" class="posting-time-input">
                    <button type="button" class="remove-time-btn">√ó</button>
                `;
                
                const container = document.getElementById('posting-times-container');
                const addButton = container.querySelector('.add-time-btn');
                container.insertBefore(timeInputGroup, addButton);

                // Ê∑ªÂä†Âà†Èô§ÊåâÈíÆ‰∫ã‰ª∂
                timeInputGroup.querySelector('.remove-time-btn').addEventListener('click', () => {
                    timeInputGroup.remove();
                });
            });

            // Âú®‰øùÂ≠òËÅäÂ§©ËÆæÁΩÆÊó∂‰øùÂ≠òÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
            document.getElementById('save-chat-settings-btn').addEventListener('click', async () => {
                if (!state.activeChatId) return;
                const chat = state.chats[state.activeChatId];
                if (!chat) return;
                
                // ‰øùÂ≠òÂæÆÂçöËÆæÁΩÆ
                chat.settings.weiboEnabled = document.getElementById('weibo-enabled').checked;
                chat.settings.weiboFrequency = document.getElementById('weibo-frequency').value;
                
                // ‰øùÂ≠òÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
                const timeInputs = document.querySelectorAll('.posting-time-input');
                chat.settings.weiboPostingTimes = Array.from(timeInputs).map(input => input.value).filter(Boolean);
            });

            // Âú®Âä†ËΩΩËÅäÂ§©ËÆæÁΩÆÊó∂Âä†ËΩΩÂ∑≤‰øùÂ≠òÁöÑÊó∂Èó¥ÁÇπ
            document.getElementById('chat-settings-btn').addEventListener('click', () => {
                // ...existing load code...
                
                // Âä†ËΩΩÂæÆÂçöËÆæÁΩÆ
                const chat = state.chats[state.activeChatId];
                document.getElementById('weibo-enabled').checked = chat.settings.weiboEnabled || false;
                document.getElementById('weibo-frequency').value = chat.settings.weiboFrequency || 'low';
                
                // Âä†ËΩΩÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
                const container = document.getElementById('posting-times-container');
                container.innerHTML = ''; // Ê∏ÖÁ©∫Áé∞ÊúâÁöÑÊó∂Èó¥ËæìÂÖ•Ê°Ü
                
                            if (chat.settings.weiboPostingTimes && chat.settings.weiboPostingTimes.length > 0) {
                chat.settings.weiboPostingTimes.forEach(time => {
                    // Ê†ºÂºèÂåñÊó∂Èó¥‰∏∫ HH:mm Ê†ºÂºè
                    const formattedTime = time.includes(':') && time.split(':').length === 2 ? time : '00:00';
                    
                    const timeInputGroup = document.createElement('div');
                    timeInputGroup.className = 'time-input-group';
                    timeInputGroup.innerHTML = `
                        <input type="time" class="posting-time-input" value="${formattedTime}">
                        <button type="button" class="remove-time-btn">√ó</button>
                    `;
                    container.appendChild(timeInputGroup);
                    
                    timeInputGroup.querySelector('.remove-time-btn').addEventListener('click', () => {
                        timeInputGroup.remove();
                    });
                });
            }
                
                // Ê∑ªÂä†"Ê∑ªÂä†Êó∂Èó¥ÁÇπ"ÊåâÈíÆ
                const addButton = document.createElement('button');
                addButton.type = 'button';
                addButton.className = 'add-time-btn';
                addButton.textContent = '+ Ê∑ªÂä†Êó∂Èó¥ÁÇπ';
                container.appendChild(addButton);
                
                // ...rest of existing load code...
            });
            function init() {
                // ...existing code...
                
                // Ê∑ªÂä†Êó∂Èó¥ÁÇπÊåâÈíÆÁöÑ‰∫ã‰ª∂ÁõëÂê¨
                document.body.addEventListener('click', (e) => {
                    if (e.target.classList.contains('add-time-btn')) {
                        const timeInputGroup = document.createElement('div');
                        timeInputGroup.className = 'time-input-group';
                        timeInputGroup.innerHTML = `
                            <input type="time" class="posting-time-input">
                            <button type="button" class="remove-time-btn">√ó</button>
                        `;
                        
                        const container = e.target.closest('#posting-times-container');
                        container.insertBefore(timeInputGroup, e.target);
                        
                        // ‰∏∫Êñ∞Ê∑ªÂä†ÁöÑÂà†Èô§ÊåâÈíÆÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
                        timeInputGroup.querySelector('.remove-time-btn').addEventListener('click', () => {
                            timeInputGroup.remove();
                        });
                    }
                });

                // ...rest of existing init code...
            }

            showScreen('home-screen');
            
            // ÂàùÂßãÂåñAIËá™Âä®ÂèëÂ∏ÉÁ≥ªÁªü
            await initAiPostingSystem();
            
            // È°µÈù¢ÂèØËßÅÊÄßÊ£ÄÊµãÔºåÁ°Æ‰øùÂêéÂè∞‰πüËÉΩÊ≠£Â∏∏ËÆ°Êó∂
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    // È°µÈù¢ÈáçÊñ∞ÂèØËßÅÊó∂ÔºåÊ£ÄÊü•ÊòØÂê¶ÊúâÈîôËøáÁöÑÂèëÂ∏ÉÊó∂Èó¥ÁÇπ
                    checkAiPostingTimes();
                }
            });
        }
        init();

        // Â∫îÁî®‰øùÂ≠òÁöÑÂæÆÂçöËÆæÁΩÆ
        async function applyWeiboSettings() {
            // ‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩ‰øùÂ≠òÁöÑÂæÆÂçöËÆæÁΩÆ
            let weiboSettings = null;
            try {
                weiboSettings = await db.weiboSettings.get('main');
            } catch (error) {
                console.log('Âä†ËΩΩÂæÆÂçöËÆæÁΩÆÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ËÆæÁΩÆ');
            }

            // Â∫îÁî®‰∏ªÈ¢òËÆæÁΩÆ
            const savedTheme = weiboSettings?.theme || 'white';
            document.body.setAttribute('data-weibo-theme', savedTheme);

            // Â∫îÁî®‰øùÂ≠òÁöÑËÉåÊôØÂõæÁâá
            const savedBackground = weiboSettings?.backgroundImage;
            if (savedBackground) {
                const weiboScreen = document.getElementById('weibo-screen');
                if (weiboScreen) {
                    weiboScreen.style.backgroundImage = `url(${savedBackground})`;
                    weiboScreen.style.backgroundSize = 'cover';
                    weiboScreen.style.backgroundPosition = 'center';
                }
            }

            // Â∫îÁî®‰øùÂ≠òÁöÑÈÄèÊòéÂ∫¶ËÆæÁΩÆ
            const savedOpacity = weiboSettings?.cardOpacity || 1.0;
            applyWeiboCardOpacity(savedOpacity);
        }

        applyWeiboSettings();
        // Êï∞ÊçÆË°®ÁªìÊûÑ - ÂÆåÊï¥Â§á‰ªΩÊâÄÈúÄÁöÑÊâÄÊúâÊï∞ÊçÆ
const fullBackupStores = {
    chats: '&id, isGroup',
    worldBooks: '&id, name',
    personaPresets: '&id',
    apiConfig: '&id',
    globalSettings: '&id',
    userStickers: '&id, url, name',
    musicLibrary: '&id',
    weiboPosts: '&id, authorId, timestamp, visibility',
    weiboComments: '&id, postId, authorId, timestamp',
    weiboLikes: '[postId+authorId], postId, authorId',
    weiboReposts: '&id, originalPostId, authorId, timestamp'
};

// ÂàùÂßãÂåñ"Â§á‰ªΩ‰∏ìÁî®Êï∞ÊçÆÂ∫ìËøûÊé•"
const backupDB = new Dexie('GeminiChatDB');  // ‚Üê Êîπ‰∏∫‰Ω†ÂéüÈ°πÁõÆÁöÑÂ∫ìÂêçÔºà‰øùÊåÅ‰∏ÄËá¥Ôºâ
backupDB.version(1).stores(fullBackupStores);

// ÂØºÂá∫
document.getElementById('export-full-backup-btn').addEventListener('click', async () => {
    const result = {};
    for (const store in fullBackupStores) {
        result[store] = await backupDB[store].toArray();
    }
    const blob = new Blob([JSON.stringify(result, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Phone Chat-Â§á‰ªΩ.json';
    a.click();
    URL.revokeObjectURL(url);
});

let importFile = null;

document.getElementById('import-full-backup-btn').addEventListener('click', () => {
    document.getElementById('import-full-backup-input').click();
});

document.getElementById('import-full-backup-input').addEventListener('change', (event) => {
    importFile = event.target.files[0];
    if (importFile) {
        document.getElementById('import-confirm-modal').classList.add('visible');
    }
});

document.getElementById('cancel-import-btn').addEventListener('click', () => {
    importFile = null;
    document.getElementById('import-confirm-modal').classList.remove('visible');
});

document.getElementById('confirm-import-btn').addEventListener('click', async () => {
    document.getElementById('import-confirm-modal').classList.remove('visible');

    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const json = JSON.parse(e.target.result);

            for (const store in fullBackupStores) {
                if (json[store]) {
                    await backupDB[store].clear();
for (const item of json[store]) {
    await backupDB[store].add(item);
}
                }
            }

            alert('‚úÖ ÂØºÂÖ•ÊàêÂäüÔºÅÂª∫ËÆÆÂà∑Êñ∞È°µÈù¢‰ª•Á°Æ‰øùËÆæÁΩÆÁîüÊïà„ÄÇ');
        } catch (err) {
            alert('‚ùå ÂØºÂÖ•Â§±Ë¥•Ôºö' + err.message);
        }
    };
    reader.readAsText(importFile);
});

// ÂæÆÂçö‰∏ªÈ¢òÂàáÊç¢‰∫ã‰ª∂ÁõëÂê¨Âô®
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('theme-dot')) {
        const theme = e.target.dataset.theme;
        
        // ÁßªÈô§ÊâÄÊúâ‰∏ªÈ¢òÁÇπÁöÑactiveÁ±ª
        document.querySelectorAll('.theme-dot').forEach(dot => {
            dot.classList.remove('active');
        });
        
        // ‰∏∫ÂΩìÂâçÁÇπÂáªÁöÑ‰∏ªÈ¢òÁÇπÊ∑ªÂä†activeÁ±ª
        e.target.classList.add('active');
        
        // ËÆæÁΩÆbodyÁöÑdata-weibo-themeÂ±ûÊÄß
        document.body.setAttribute('data-weibo-theme', theme);
        
        // ÈáçÊñ∞Ê∏≤ÊüìÂæÆÂçöÊó∂Èó¥Á∫ø‰ª•Â∫îÁî®Êñ∞‰∏ªÈ¢ò
        if (document.getElementById('weibo-screen').classList.contains('active')) {
            renderWeiboTimeline();
        }
    }
    
});

// ÂàùÂßãÂåñÂæÆÂçö‰∏ªÈ¢òÈÄâÊã©Âô®
// Â∫îÁî®ÂæÆÂçöÂç°ÁâáÈÄèÊòéÂ∫¶
function applyWeiboCardOpacity(opacity) {
    // Ëé∑ÂèñÊâÄÊúâÂæÆÂçöÂç°ÁâáÂπ∂Â∫îÁî®ÈÄèÊòéÂ∫¶
    const posts = document.querySelectorAll('.weibo-post');
    posts.forEach(post => {
        post.style.opacity = opacity;
    });
    
    // ‰øùÂ≠òËÆæÁΩÆÂà∞CSSÂèòÈáèÔºå‰ª•‰æøÊñ∞Ê∏≤ÊüìÁöÑÂç°Áâá‰πüËÉΩÂ∫îÁî®
    document.documentElement.style.setProperty('--weibo-card-opacity', opacity);
}



            // ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÂ§ÑÁêÜÂä®ÊÄÅÊ∑ªÂä†ÁöÑÊó∂Èó¥ÁÇπÊåâÈíÆ
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-time-btn')) {
                    const timeInputGroup = document.createElement('div');
                    timeInputGroup.className = 'time-input-group';
                    timeInputGroup.innerHTML = `
                        <input type="time" class="posting-time-input">
                        <button type="button" class="remove-time-btn">√ó</button>
                    `;
                    
                    const container = e.target.closest('#posting-times-container');
                    if (container) {
                        container.insertBefore(timeInputGroup, e.target);
                    }
                }
                
                if (e.target.classList.contains('remove-time-btn')) {
                    e.target.closest('.time-input-group').remove();
                }
            });
        
        // ÂàùÂßãÂåñÁî®Êà∑ËµÑÊñô
        async function initUserProfile() {
            const savedProfileData = await db.userProfiles.get('weibo_user_profile');
            if (!savedProfileData) {
                // Â¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òÁöÑÁî®Êà∑ËµÑÊñôÔºåËÆæÁΩÆÈªòËÆ§ÂÄº
                const defaultProfile = {
                    name: 'ÊàëÁöÑÂæÆÂçö',
                    signature: 'ÂàÜ‰∫´ÁîüÊ¥ª‰∏≠ÁöÑÁæéÂ•ΩÁû¨Èó¥',
                    email: '',
                    avatar: 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg'
                };
                await db.userProfiles.put({
                    id: 'weibo_user_profile',
                    type: 'weibo_profile',
                    data: defaultProfile,
                    timestamp: Date.now()
                });
                userProfileCache = defaultProfile;
            } else {
                userProfileCache = savedProfileData.data;
            }
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        async function initializeApp() {
            await initUserProfile();
            await loadApiConfigs();
        }

        // ÂêØÂä®ÂàùÂßãÂåñ
        initializeApp();

        // Á§æ‰∫§‰∏ªÈ°µÁõ∏ÂÖ≥ÂáΩÊï∞
        function showSocialProfileSafe(authorId) {
            try {
                showSocialProfile(authorId);
            } catch (error) {
                console.error('ÊòæÁ§∫Á§æ‰∫§‰∏ªÈ°µÂ§±Ë¥•:', error);
                showToast('Êó†Ê≥ïÊòæÁ§∫Á§æ‰∫§‰∏ªÈ°µ', 'error');
            }
        }

        async function showSocialProfile(authorId) {
            const modal = document.getElementById('social-profile-modal');
            const avatar = document.getElementById('social-profile-avatar');
            const name = document.getElementById('social-profile-name');
            const signature = document.getElementById('social-profile-signature');
            const followersEl = document.getElementById('social-profile-followers');
            const followingEl = document.getElementById('social-profile-following');
            const postsCountEl = document.getElementById('social-profile-posts-count');
            const postsList = document.getElementById('social-profile-posts-list');

            let profile;
            let posts = [];

            if (authorId === 'user') {
                // Áî®Êà∑ËµÑÊñô
                profile = userProfileCache;

                // Ëé∑ÂèñÁî®Êà∑ÁöÑÂæÆÂçö
                posts = await db.weiboPosts
                    .where('authorId')
                    .equals('user')
                    .reverse()
                    .sortBy('timestamp');

            } else {
                // AIËßíËâ≤ËµÑÊñô
                const chat = state.chats[authorId];
                if (!chat) {
                    showToast('ËßíËâ≤‰ø°ÊÅØ‰∏çÂ≠òÂú®', 'error');
                    return;
                }

                profile = {
                    name: chat.name,
                    signature: chat.settings.aiSignature || 'Ëøô‰∏™‰∫∫ÂæàÊáíÔºå‰ªÄ‰πàÈÉΩÊ≤°Áïô‰∏ã',
                    avatar: chat.settings.aiAvatar || 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg'
                };

                // Ëé∑ÂèñAIÁöÑÂæÆÂçö
                posts = await db.weiboPosts
                    .where('authorId')
                    .equals(authorId)
                    .reverse()
                    .sortBy('timestamp');
            }

            // ËÆæÁΩÆÁ§æ‰∫§‰∏ªÈ°µËÉåÊôØ
            const socialBg = modal.querySelector('.social-profile-bg');
            if (authorId === 'user') {
                if (userProfileCache.socialBackground) {
                    socialBg.style.backgroundImage = `url(${userProfileCache.socialBackground})`;
                } else {
                    socialBg.style.backgroundImage = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                }
            } else {
                const chat = state.chats[authorId];
                if (chat && chat.settings.socialBackground) {
                    socialBg.style.backgroundImage = `url(${chat.settings.socialBackground})`;
                } else {
                    socialBg.style.backgroundImage = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                }
            }

            // Â°´ÂÖÖËµÑÊñô‰ø°ÊÅØ
            avatar.src = profile.avatar;
            name.textContent = profile.name;
            signature.textContent = profile.signature;

            // ÁîüÊàêÂêàÁêÜÁöÑÁ≤â‰∏ùÂíåÂÖ≥Ê≥®Êï∞
            const postsCount = posts.length;
            let followersCount, followingCount;

            if (authorId === 'user') {
                // Áî®Êà∑ÁöÑÁ≤â‰∏ùÊï∞ - Ê†πÊçÆ‰∫∫ËÆæ"Â∞èÂ§ú"ÔºåÂ∫îËØ•Êúâ‰∏ÄÂÆöÁ≤â‰∏ùÂü∫Á°Ä
                const baseFollowers = 150 + Math.floor(Math.random() * 200); // 150-350Âü∫Á°ÄÁ≤â‰∏ù
                followersCount = Math.max(baseFollowers, Math.floor(postsCount * (8 + Math.random() * 15))); // ÊØèÊù°ÂæÆÂçöÂ∏¶Êù•8-23‰∏™Á≤â‰∏ù
                followingCount = Math.max(50, Math.floor(postsCount * (2 + Math.random() * 4))); // ÂÖ≥Ê≥®Êï∞Áõ∏ÂØπËæÉÂ∞ë
            } else {
                // AIËßíËâ≤Á≤â‰∏ùÊï∞ - Ê†πÊçÆ‰∫∫ËÆæÁ±ªÂûãÁîüÊàêÂêàÁêÜÁöÑÁ≤â‰∏ùÊï∞Èáè
                const chat = state.chats[authorId];
                const persona = (chat?.settings?.aiPersona || '').toLowerCase();

                let baseFollowers, followerMultiplier;

                // Ê†πÊçÆËßíËâ≤‰∫∫ËÆæÁ±ªÂûãË∞ÉÊï¥Á≤â‰∏ùÂü∫Êï∞ÂíåÂÄçÊï∞
                if (persona.includes('‰∏ªÊí≠') || persona.includes('ÁΩëÁ∫¢') || persona.includes('up‰∏ª') ||
                    persona.includes('Âçö‰∏ª') || persona.includes('Áõ¥Êí≠') || persona.includes('ÁΩëÁªú‰∏ªÊí≠') ||
                    persona.includes('Ê∏∏Êàè‰∏ªÊí≠') || persona.includes('ÁæéÂ¶ÜÂçö‰∏ª') || persona.includes('Êó∂Â∞öÂçö‰∏ª')) {
                    // ‰∏ªÊí≠/ÁΩëÁ∫¢Á±ªÂûã - È´òÁ≤â‰∏ùÂü∫Êï∞
                    baseFollowers = 8000 + Math.floor(Math.random() * 12000); // 8K-20KÂü∫Á°ÄÁ≤â‰∏ù
                    followerMultiplier = [50, 80]; // ÊØèÊù°ÂæÆÂçöÂ∏¶Êù•50-130‰∏™Á≤â‰∏ù
                } else if (persona.includes('ÊòéÊòü') || persona.includes('Ëâ∫‰∫∫') || persona.includes('ÊºîÂëò') ||
                          persona.includes('Ê≠åÊâã') || persona.includes('ÂÅ∂ÂÉè') || persona.includes('Áà±Ë±Ü')) {
                    // ÊòéÊòüÁ±ªÂûã - Ë∂ÖÈ´òÁ≤â‰∏ùÂü∫Êï∞
                    baseFollowers = 50000 + Math.floor(Math.random() * 100000); // 50K-150KÂü∫Á°ÄÁ≤â‰∏ù
                    followerMultiplier = [100, 200]; // ÊØèÊù°ÂæÆÂçöÂ∏¶Êù•100-300‰∏™Á≤â‰∏ù
                } else if (persona.includes('Â∞èËçâ') || persona.includes('ÊôÆÈÄö‰∫∫') || persona.includes('Â≠¶Áîü') ||
                          persona.includes('‰∏äÁè≠Êóè') || persona.includes('Á§æÁïú') || persona.includes('ÊâìÂ∑•‰∫∫') ||
                          persona.includes('Êñ∞‰∫∫') || persona.includes('ËêåÊñ∞')) {
                    // Â∞èËçâ/ÊôÆÈÄö‰∫∫Á±ªÂûã - ‰ΩéÁ≤â‰∏ùÂü∫Êï∞
                    baseFollowers = 50 + Math.floor(Math.random() * 150); // 50-200Âü∫Á°ÄÁ≤â‰∏ù
                    followerMultiplier = [3, 8]; // ÊØèÊù°ÂæÆÂçöÂ∏¶Êù•3-11‰∏™Á≤â‰∏ù
                } else if (persona.includes('‰∏ìÂÆ∂') || persona.includes('ÊïôÊéà') || persona.includes('ËÄÅÂ∏à') ||
                          persona.includes('ÂåªÁîü') || persona.includes('ÂæãÂ∏à') || persona.includes('‰ΩúÂÆ∂') ||
                          persona.includes('Áü•ËØÜÂàÜÂ≠ê') || persona.includes('Â≠¶ËÄÖ')) {
                    // ‰∏ì‰∏ö‰∫∫Â£´Á±ªÂûã - ‰∏≠Á≠âÁ≤â‰∏ùÂü∫Êï∞
                    baseFollowers = 2000 + Math.floor(Math.random() * 3000); // 2K-5KÂü∫Á°ÄÁ≤â‰∏ù
                    followerMultiplier = [20, 35]; // ÊØèÊù°ÂæÆÂçöÂ∏¶Êù•20-55‰∏™Á≤â‰∏ù
                } else if (persona.includes('ÁΩëÁªúËææ‰∫∫') || persona.includes('kol') || persona.includes('ÊÑèËßÅÈ¢ÜË¢ñ') ||
                          persona.includes('Â§ßv') || persona.includes('Áü•Âêç') || persona.includes('ÊúâÂêç')) {
                    // ÁΩëÁªúËææ‰∫∫Á±ªÂûã - È´òÁ≤â‰∏ùÂü∫Êï∞
                    baseFollowers = 15000 + Math.floor(Math.random() * 25000); // 15K-40KÂü∫Á°ÄÁ≤â‰∏ù
                    followerMultiplier = [60, 100]; // ÊØèÊù°ÂæÆÂçöÂ∏¶Êù•60-160‰∏™Á≤â‰∏ù
                } else if (persona.includes('‰ºÅ‰∏öÂÆ∂') || persona.includes('ceo') || persona.includes('ËÄÅÊùø') ||
                          persona.includes('Âàõ‰∏öËÄÖ') || persona.includes('ÂïÜ‰∫∫')) {
                    // ‰ºÅ‰∏öÂÆ∂Á±ªÂûã - ‰∏≠È´òÁ≤â‰∏ùÂü∫Êï∞
                    baseFollowers = 5000 + Math.floor(Math.random() * 10000); // 5K-15KÂü∫Á°ÄÁ≤â‰∏ù
                    followerMultiplier = [30, 50]; // ÊØèÊù°ÂæÆÂçöÂ∏¶Êù•30-80‰∏™Á≤â‰∏ù
                } else {
                    // ÈªòËÆ§Á±ªÂûã - ‰∏≠Á≠âÁ≤â‰∏ùÂü∫Êï∞
                    baseFollowers = 500 + Math.floor(Math.random() * 1000); // 500-1500Âü∫Á°ÄÁ≤â‰∏ù
                    followerMultiplier = [15, 25]; // ÊØèÊù°ÂæÆÂçöÂ∏¶Êù•15-40‰∏™Á≤â‰∏ù
                }

                followersCount = Math.max(baseFollowers, Math.floor(postsCount * (followerMultiplier[0] + Math.random() * (followerMultiplier[1] - followerMultiplier[0]))));
                followingCount = Math.max(30, Math.floor(followersCount * (0.05 + Math.random() * 0.15))); // ÂÖ≥Ê≥®Êï∞‰∏∫Á≤â‰∏ùÊï∞ÁöÑ5%-20%
            }

            // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
            followersEl.textContent = `${followersCount} Á≤â‰∏ù`;
            followingEl.textContent = `${followingCount} ÂÖ≥Ê≥®`;
            postsCountEl.textContent = `${postsCount} ÂæÆÂçö`;

            // Â°´ÂÖÖÊúÄËøëÂä®ÊÄÅ
            postsList.innerHTML = '';
            if (posts.length === 0) {
                postsList.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">ÊöÇÊó†Âä®ÊÄÅ</div>';
            } else {
                posts.slice(0, 10).forEach(post => {
                    const postItem = document.createElement('div');
                    postItem.className = 'social-profile-post-item';

                    const postContent = document.createElement('div');
                    postContent.className = 'social-profile-post-content';
                    postContent.textContent = post.content;

                    const postTime = document.createElement('div');
                    postTime.className = 'social-profile-post-time';
                    postTime.textContent = new Date(post.timestamp).toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });

                    postItem.appendChild(postContent);
                    postItem.appendChild(postTime);
                    postsList.appendChild(postItem);
                });
            }

            // Â≠òÂÇ®ÂΩìÂâçÊü•ÁúãÁöÑÁî®Êà∑IDÔºå‰æõÁºñËæëÂäüËÉΩ‰ΩøÁî®
            modal.dataset.currentAuthorId = authorId;
            modal.dataset.posts = JSON.stringify(posts);

            // ÂàùÂßãÂåñÊ†áÁ≠æÈ°µ‰∫ã‰ª∂
            initSocialProfileTabs(modal);

            // ÊòæÁ§∫Ê®°ÊÄÅÂºπÁ™ó
            modal.style.display = 'block';
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);

            // Ê∑ªÂä†ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠ÂäüËÉΩ
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeSocialProfile();
                }
            };
        }

        function initSocialProfileTabs(modal) {
            const tabs = modal.querySelectorAll('.social-profile-tab');
            const postsList = modal.querySelector('#social-profile-posts-list');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // ÁßªÈô§ÊâÄÊúâactiveÁ±ª
                    tabs.forEach(t => t.classList.remove('active'));
                    // Ê∑ªÂä†ÂΩìÂâçactiveÁ±ª
                    tab.classList.add('active');

                    const tabType = tab.dataset.tab;
                    const posts = JSON.parse(modal.dataset.posts || '[]');

                    if (tabType === 'posts') {
                        // ÊòæÁ§∫Âä®ÊÄÅ
                        showSocialProfilePosts(postsList, posts);
                    } else if (tabType === 'photos') {
                        // ÊòæÁ§∫Áõ∏ÂÜå
                        showSocialProfilePhotos(postsList, posts);
                    }
                });
            });
        }

        function showSocialProfilePosts(container, posts) {
            container.innerHTML = '';
            if (posts.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">ÊöÇÊó†Âä®ÊÄÅ</div>';
            } else {
                // ÊòæÁ§∫ÊâÄÊúâÂä®ÊÄÅÔºå‰∏çÈôêÂà∂Êï∞ÈáèÔºåÁ°Æ‰øùÊúâË∂≥Â§üÂÜÖÂÆπÊªöÂä®
                posts.forEach(post => {
                    const postItem = document.createElement('div');
                    postItem.className = 'social-profile-post-item';

                    const postContent = document.createElement('div');
                    postContent.className = 'social-profile-post-content';
                    postContent.textContent = post.content;

                    const postTime = document.createElement('div');
                    postTime.className = 'social-profile-post-time';
                    postTime.textContent = new Date(post.timestamp).toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });

                    postItem.appendChild(postContent);
                    postItem.appendChild(postTime);
                    container.appendChild(postItem);
                });

                // Â¶ÇÊûúÂä®ÊÄÅËæÉÂ∞ëÔºåÊ∑ªÂä†‰∏Ä‰∫õÂç†‰ΩçÂÜÖÂÆπÁ°Æ‰øùÂèØ‰ª•ÊªöÂä®ÊµãËØï
                if (posts.length < 8) {
                    for (let i = 0; i < 10; i++) {
                        const testItem = document.createElement('div');
                        testItem.className = 'social-profile-post-item';
                        testItem.innerHTML = `
                            <div class="social-profile-post-content">ÊµãËØïÂä®ÊÄÅÂÜÖÂÆπ ${i + 1} - ËøôÊòØ‰∏ÄÊù°Áî®‰∫éÊµãËØïÊªöÂä®ÂäüËÉΩÁöÑÂä®ÊÄÅÂÜÖÂÆπ</div>
                            <div class="social-profile-post-time">2024-01-${String(i + 1).padStart(2, '0')}</div>
                        `;
                        container.appendChild(testItem);
                    }
                }
            }
        }

        function showSocialProfilePhotos(container, posts) {
            container.innerHTML = '';

            // ÊèêÂèñÊâÄÊúâÂåÖÂê´ÂõæÁâáÁöÑÂæÆÂçö
            const photoPosts = posts.filter(post => post.images && post.images.length > 0);

            if (photoPosts.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">ÊöÇÊó†ÂõæÁâá</div>';
            } else {
                const photoGrid = document.createElement('div');
                photoGrid.style.cssText = 'display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; padding: 10px;';

                photoPosts.forEach(post => {
                    post.images.forEach(imageUrl => {
                        const photoItem = document.createElement('div');
                        photoItem.style.cssText = 'aspect-ratio: 1; overflow: hidden; border-radius: 8px; cursor: pointer;';

                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
                        img.onclick = () => showImageViewer(imageUrl);

                        photoItem.appendChild(img);
                        photoGrid.appendChild(photoItem);
                    });
                });

                container.appendChild(photoGrid);
            }
        }

        function closeSocialProfile() {
            const modal = document.getElementById('social-profile-modal');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        function editSocialProfile() {
            const modal = document.getElementById('social-profile-modal');
            const authorId = modal.dataset.currentAuthorId;

            closeSocialProfile();

            if (authorId === 'user') {
                // ÊâìÂºÄÁî®Êà∑ËµÑÊñôÁºñËæëÂºπÁ™ó
                document.getElementById('weibo-profile-modal').classList.add('visible');

                // Âä†ËΩΩÂΩìÂâçÁî®Êà∑ËµÑÊñôÂà∞ÁºñËæëË°®Âçï
                document.getElementById('profile-name-input').value = userProfileCache.name || 'ÊàëÁöÑÂæÆÂçö';
                document.getElementById('profile-signature-input').value = userProfileCache.signature || 'ÂàÜ‰∫´ÁîüÊ¥ª‰∏≠ÁöÑÁæéÂ•ΩÁû¨Èó¥';
                document.getElementById('profile-email-input').value = userProfileCache.email || '';
                document.getElementById('profile-avatar-preview').src = userProfileCache.avatar || 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';

                // Âä†ËΩΩÁî®Êà∑ÁöÑÁ§æ‰∫§‰∏ªÈ°µËÉåÊôØ
                const userBgPreview = document.getElementById('user-profile-bg-preview');
                if (userProfileCache.socialBackground) {
                    userBgPreview.style.backgroundImage = `url(${userProfileCache.socialBackground})`;
                    userBgPreview.textContent = '';
                    document.getElementById('remove-user-profile-bg-btn').style.display = 'block';
                } else {
                    userBgPreview.style.backgroundImage = '';
                    userBgPreview.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    userBgPreview.textContent = 'ÈªòËÆ§Ê∏êÂèòËÉåÊôØ';
                    document.getElementById('remove-user-profile-bg-btn').style.display = 'none';
                }

            } else {
                // ÊâìÂºÄAIËµÑÊñôÁºñËæëÂºπÁ™ó
                const aiModal = document.getElementById('ai-profile-modal');
                aiModal.dataset.aiId = authorId;
                aiModal.classList.add('visible');

                // Âä†ËΩΩAIËµÑÊñôÂà∞ÁºñËæëË°®Âçï
                const chat = state.chats[authorId];
                if (chat) {
                    document.getElementById('ai-profile-name-input').value = chat.name || '';
                    document.getElementById('ai-profile-signature-input').value = chat.settings.aiSignature || '';
                    document.getElementById('ai-profile-persona-input').value = chat.settings.aiPersona || '';
                    document.getElementById('ai-profile-avatar-preview').src = chat.settings.aiAvatar || 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';

                    // Âä†ËΩΩAIÁöÑÁ§æ‰∫§‰∏ªÈ°µËÉåÊôØ
                    const aiBgPreview = document.getElementById('ai-profile-bg-preview');
                    if (chat.settings.socialBackground) {
                        aiBgPreview.style.backgroundImage = `url(${chat.settings.socialBackground})`;
                        aiBgPreview.textContent = '';
                        document.getElementById('remove-ai-profile-bg-btn').style.display = 'block';
                    } else {
                        aiBgPreview.style.backgroundImage = '';
                        aiBgPreview.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                        aiBgPreview.textContent = 'ÈªòËÆ§Ê∏êÂèòËÉåÊôØ';
                        document.getElementById('remove-ai-profile-bg-btn').style.display = 'none';
                    }
                }
            }
        }

        // Â∞ÜÂáΩÊï∞Êö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
        window.showSocialProfileSafe = showSocialProfileSafe;
        window.showSocialProfile = showSocialProfile;
        window.closeSocialProfile = closeSocialProfile;
        window.editSocialProfile = editSocialProfile;
        
        // Ê∑ªÂä†ÊµãËØïAPIËøûÊé•ÂäüËÉΩ
        document.addEventListener('DOMContentLoaded', () => {
            const testConnectionBtn = document.getElementById('test-api-connection-btn');
            if (testConnectionBtn) {
                testConnectionBtn.addEventListener('click', async () => {
                    const url = document.getElementById('proxy-url').value.trim();
                    const key = document.getElementById('api-key').value.trim();
                    const model = document.getElementById('model-select').value;
                    
                    if (!url || !key) {
                        alert('ËØ∑ÂÖàÂ°´ÂÜôÂèç‰ª£Âú∞ÂùÄÂíåÂØÜÈí•');
                        return;
                    }
                    
                    if (!model) {
                        alert('ËØ∑ÂÖàÈÄâÊã©Ê®°Âûã');
                        return;
                    }
                    
                    const testBtn = document.getElementById('test-api-connection-btn');
                    const originalText = testBtn.textContent;
                    testBtn.textContent = 'ÊµãËØï‰∏≠...';
                    testBtn.disabled = true;
                    
                    try {
                        console.log('ÂºÄÂßãÊµãËØïAPIËøûÊé•...', { url, model });
                        
                        // ÊµãËØï1ÔºöÊúÄÁÆÄÂçïÁöÑËØ∑Ê±Ç
                        console.log('ÊµãËØï1ÔºöÊúÄÁÆÄÂçïÁöÑËØ∑Ê±Ç');
                        const simpleRequest = {
                            model: model,
                            messages: [
                                { role: 'user', content: 'hi' }
                            ],
                            stream: false
                        };
                        
                        const response1 = await fetch(`${url}/v1/chat/completions`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${key}`
                            },
                            body: JSON.stringify(simpleRequest)
                        });
                        
                        console.log('ÊµãËØï1ÂìçÂ∫îÁä∂ÊÄÅ:', response1.status, response1.statusText);
                        
                        if (!response1.ok) {
                            const errorText = await response1.text();
                            console.error('ÊµãËØï1Â§±Ë¥•:', errorText);
                            throw new Error(`ÊµãËØï1Â§±Ë¥• (${response1.status}): ${errorText}`);
                        }
                        
                        const data1 = await response1.json();
                        console.log('ÊµãËØï1ÊàêÂäü:', data1);
                        
                        // ÊµãËØï2Ôºö‰∏éÂæÆÂçöÂäüËÉΩÁõ∏ÂêåÁöÑËØ∑Ê±ÇÊ†ºÂºè
                        console.log('ÊµãËØï2ÔºöÂæÆÂçöÂäüËÉΩÊ†ºÂºè');
                        const weiboRequest = {
                            model: model,
                            messages: [
                                { role: 'system', content: '‰Ω†ÊòØÊµãËØïËßíËâ≤„ÄÇ' },
                                { role: 'user', content: 'ËØ∑ÁÆÄÂçïÂõûÂ§ç„ÄÇ' }
                            ],
                            temperature: 0.7,
                            stream: false
                        };
                        
                        const response2 = await fetch(`${url}/v1/chat/completions`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${key}`
                            },
                            body: JSON.stringify(weiboRequest)
                        });
                        
                        console.log('ÊµãËØï2ÂìçÂ∫îÁä∂ÊÄÅ:', response2.status, response2.statusText);
                        
                        if (!response2.ok) {
                            const errorText = await response2.text();
                            console.error('ÊµãËØï2Â§±Ë¥•:', errorText);
                            throw new Error(`ÊµãËØï2Â§±Ë¥• (${response2.status}): ${errorText}`);
                        }
                        
                        const data2 = await response2.json();
                        console.log('ÊµãËØï2ÊàêÂäü:', data2);
                        
                        alert('‚úÖ ÊâÄÊúâÊµãËØïÈÉΩÊàêÂäü‰∫ÜÔºÅ\n\nÊµãËØï1ÂìçÂ∫î: ' + data1.choices[0].message.content + '\n\nÊµãËØï2ÂìçÂ∫î: ' + data2.choices[0].message.content);
                        
                    } catch (error) {
                        console.error('APIËøûÊé•ÊµãËØïÂ§±Ë¥•:', error);
                        let errorMessage = error.message;
                        
                        if (error.message.includes('Failed to fetch')) {
                            errorMessage = 'ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Âèç‰ª£Âú∞ÂùÄÊòØÂê¶Ê≠£Á°Æ';
                        } else if (error.name === 'AbortError') {
                            errorMessage = 'ËØ∑Ê±ÇË∂ÖÊó∂ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñÁ®çÂêéÈáçËØï';
                        } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                            errorMessage = 'ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Âèç‰ª£Âú∞ÂùÄÊòØÂê¶Ê≠£Á°ÆÊàñÁΩëÁªúËøûÊé•';
                        }
                        
                        alert(`‚ùå APIËøûÊé•ÊµãËØïÂ§±Ë¥•:\n${errorMessage}`);
                    } finally {
                        testBtn.textContent = originalText;
                        testBtn.disabled = false;
                    }
                });
            }
        });

        // ÂÖ®Â±ÄË∞ÉËØïÂáΩÊï∞ÔºåÊñπ‰æøÂú®ÊéßÂà∂Âè∞ÊµãËØï
        window.debugAPI = async function() {
            const { proxyUrl, apiKey, model } = state.apiConfig;
            console.log('ÂΩìÂâçAPIÈÖçÁΩÆ:', { proxyUrl, apiKey: apiKey ? '***' : 'Êú™ËÆæÁΩÆ', model });
            
            if (!proxyUrl || !apiKey || !model) {
                console.error('APIÈÖçÁΩÆ‰∏çÂÆåÊï¥');
                return;
            }
            
            try {
                console.log('ÂºÄÂßãË∞ÉËØïAPI...');
                
                // ÊúÄÁÆÄÂçïÁöÑËØ∑Ê±Ç
                const request = {
                    model: model,
                    messages: [
                        { role: 'user', content: 'test' }
                    ],
                    stream: false
                };
                
                console.log('ÂèëÈÄÅËØ∑Ê±Ç:', JSON.stringify(request, null, 2));
                
                const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'User-Agent': 'Phone Chat/1.0'
                    },
                    body: JSON.stringify(request)
                });
                
                console.log('ÂìçÂ∫îÁä∂ÊÄÅ:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIÈîôËØØ:', errorText);
                    return;
                }
                
                const data = await response.json();
                console.log('APIÊàêÂäü:', data);
                
            } catch (error) {
                console.error('Ë∞ÉËØïÂ§±Ë¥•:', error);
            }
        };
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñÁî®Êà∑ËµÑÊñô
        
        // ============= APIÈÖçÁΩÆÁÆ°ÁêÜÂäüËÉΩ =============
        let savedApiConfigs = [];

        // ‰ªéDexieÂä†ËΩΩAPIÈÖçÁΩÆ
        async function loadApiConfigs() {
            const configs = await db.apiConfigs.toArray();
            savedApiConfigs = configs.map(config => config.data);
        }

        // ‰øùÂ≠òAPIÈÖçÁΩÆÂà∞Dexie
        async function saveApiConfigs() {
            // Ê∏ÖÁ©∫Áé∞ÊúâÈÖçÁΩÆ
            await db.apiConfigs.clear();
            // ‰øùÂ≠òÊñ∞ÈÖçÁΩÆ
            for (const config of savedApiConfigs) {
                await db.apiConfigs.put({
                    id: config.id,
                    name: config.name,
                    data: config,
                    timestamp: config.updatedAt || Date.now()
                });
            }
        }
        
        // ‰øùÂ≠òÂΩìÂâçÈÖçÁΩÆ
        document.getElementById('save-current-config-btn').addEventListener('click', async () => {
            const configName = document.getElementById('config-name-input').value.trim();
            if (!configName) {
                alert('ËØ∑ËæìÂÖ•ÈÖçÁΩÆÂêçÁß∞');
                return;
            }
            
            const proxyUrl = document.getElementById('proxy-url').value.trim();
            const apiKey = document.getElementById('api-key').value.trim();
            const model = document.getElementById('model-select').value;
            const temperature = document.getElementById('temperature-slider').value;
            
            if (!proxyUrl || !apiKey || !model) {
                alert('ËØ∑ÂÖàÂÆåÊï¥Â°´ÂÜôAPIÈÖçÁΩÆ‰ø°ÊÅØ');
                return;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ÂêåÂêçÈÖçÁΩÆ
            const existingIndex = savedApiConfigs.findIndex(config => config.name === configName);
            if (existingIndex !== -1) {
                if (!confirm(`ÈÖçÁΩÆ"${configName}"Â∑≤Â≠òÂú®ÔºåÊòØÂê¶Ë¶ÜÁõñÔºü`)) {
                    return;
                }
                savedApiConfigs[existingIndex] = {
                    id: savedApiConfigs[existingIndex].id,
                    name: configName,
                    proxyUrl,
                    apiKey,
                    model,
                    temperature: parseFloat(temperature),
                    createdAt: savedApiConfigs[existingIndex].createdAt,
                    updatedAt: Date.now()
                };
            } else {
                const newConfig = {
                    id: `config_${Date.now()}`,
                    name: configName,
                    proxyUrl,
                    apiKey,
                    model,
                    temperature: parseFloat(temperature),
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                savedApiConfigs.push(newConfig);
            }
            
            await saveApiConfigs();
            document.getElementById('config-name-input').value = '';
            renderSavedConfigs();
            showToast('ÈÖçÁΩÆ‰øùÂ≠òÊàêÂäüÔºÅ', 'success');
        });
        
        // Ê∏ÖÁ©∫ÊâÄÊúâÈÖçÁΩÆ
        document.getElementById('clear-all-configs-btn').addEventListener('click', async () => {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ÊâÄÊúâ‰øùÂ≠òÁöÑÈÖçÁΩÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) {
                savedApiConfigs = [];
                await db.apiConfigs.clear();
                renderSavedConfigs();
                showToast('ÊâÄÊúâÈÖçÁΩÆÂ∑≤Ê∏ÖÁ©∫', 'info');
            }
        });
        
        // Ê∏≤Êüì‰øùÂ≠òÁöÑÈÖçÁΩÆÂàóË°®
        function renderSavedConfigs() {
            const container = document.getElementById('saved-configs-container');
            const noConfigsMessage = document.getElementById('no-configs-message');
            
            if (savedApiConfigs.length === 0) {
                container.innerHTML = '';
                noConfigsMessage.style.display = 'block';
                return;
            }
            
            noConfigsMessage.style.display = 'none';
            container.innerHTML = '';
            
            // Ëé∑ÂèñÂΩìÂâçÈÖçÁΩÆÁî®‰∫éÊ†áËÆ∞ÊøÄÊ¥ªÁä∂ÊÄÅ
            const currentProxyUrl = document.getElementById('proxy-url').value.trim();
            const currentApiKey = document.getElementById('api-key').value.trim();
            const currentModel = document.getElementById('model-select').value;
            
            savedApiConfigs.forEach(config => {
                // Âà§Êñ≠ÊòØÂê¶‰∏∫ÂΩìÂâçÊøÄÊ¥ªÁöÑÈÖçÁΩÆ
                const isActive = config.proxyUrl === currentProxyUrl && 
                               config.apiKey === currentApiKey && 
                               config.model === currentModel;
                
                const configCard = document.createElement('div');
                configCard.className = `config-card${isActive ? ' active' : ''}`;
                configCard.innerHTML = `
                    <div class="config-header">
                        <div class="config-name">
                            <span style="font-size: 16px;">${getConfigIcon(config.name)}</span>
                            <span>${config.name}</span>
                            ${isActive ? '<span style="color: #667eea; font-size: 12px; font-weight: normal;">(ÂΩìÂâç‰ΩøÁî®)</span>' : ''}
                        </div>
                        <div class="config-actions">
                            <button class="config-action-btn" onclick="editConfigName('${config.id}')" title="ÈáçÂëΩÂêç">
                                <span style="font-size: 14px;">‚úèÔ∏è</span>
                            </button>
                            <button class="config-action-btn" onclick="deleteConfig('${config.id}')" title="Âà†Èô§">
                                <span style="font-size: 14px; color: #ff6b6b;">üóëÔ∏è</span>
                            </button>
                        </div>
                    </div>
                    <div class="config-details">
                        <div class="config-detail-item">
                            <span class="config-detail-label">URL:</span>
                            <span class="config-detail-value" title="${config.proxyUrl}">${config.proxyUrl}</span>
                        </div>
                        <div class="config-detail-item">
                            <span class="config-detail-label">ÂØÜÈí•:</span>
                            <span class="config-detail-value" title="${config.apiKey}">‚óè‚óè‚óè‚óè‚óè‚óè${config.apiKey && config.apiKey.length >= 6 ? config.apiKey.slice(-6) : (config.apiKey || 'Êú™ËÆæÁΩÆ')}</span>
                        </div>
                        <div class="config-detail-item">
                            <span class="config-detail-label">Ê®°Âûã:</span>
                            <span class="config-detail-value" title="${config.model}">${config.model}</span>
                        </div>
                        <div class="config-detail-item">
                            <span class="config-detail-label">Ê∏©Â∫¶:</span>
                            <span class="config-detail-value">${config.temperature}</span>
                        </div>
                    </div>
                    <button class="config-use-btn" onclick="applyConfig('${config.id}')" ${isActive ? 'disabled' : ''}>
                        ${isActive ? '‚úì ÂΩìÂâç‰ΩøÁî®‰∏≠' : 'üöÄ ‰ΩøÁî®Ê≠§ÈÖçÁΩÆ'}
                    </button>
                `;
                container.appendChild(configCard);
            });
        }
        
        // Ê†πÊçÆÈÖçÁΩÆÂêçÁß∞ËøîÂõûÂêàÈÄÇÁöÑÂõæÊ†á
        function getConfigIcon(name) {
            const nameLower = name.toLowerCase();
            if (nameLower.includes('openai') || nameLower.includes('gpt')) return 'ü§ñ';
            if (nameLower.includes('gemini') || nameLower.includes('google')) return 'üíé';
            if (nameLower.includes('claude') || nameLower.includes('anthropic')) return 'üß†';
            if (nameLower.includes('azure')) return '‚òÅÔ∏è';
            if (nameLower.includes('local') || nameLower.includes('Êú¨Âú∞')) return 'üè†';
            if (nameLower.includes('proxy') || nameLower.includes('‰ª£ÁêÜ')) return 'üåê';
            return '‚öôÔ∏è';
        }
        
        // Â∫îÁî®ÈÖçÁΩÆ
        window.applyConfig = function(configId) {
            const config = savedApiConfigs.find(c => c.id === configId);
            if (!config) return;
            
            // Â∫îÁî®ÈÖçÁΩÆÂà∞Ë°®Âçï
            document.getElementById('proxy-url').value = config.proxyUrl;
            document.getElementById('api-key').value = config.apiKey;
            document.getElementById('model-select').value = config.model;
            document.getElementById('temperature-slider').value = config.temperature;
            document.getElementById('temperature-value').textContent = config.temperature;
            
            // Êõ¥Êñ∞ÂΩìÂâç‰ΩøÁî®ÁöÑÈÖçÁΩÆ
            state.apiConfig = {
                proxyUrl: config.proxyUrl,
                apiKey: config.apiKey,
                model: config.model,
                temperature: config.temperature
            };
            
            // ÈáçÊñ∞Ê∏≤ÊüìÈÖçÁΩÆÂàóË°®‰ª•Êõ¥Êñ∞ÊøÄÊ¥ªÁä∂ÊÄÅ
            renderSavedConfigs();
            showToast(`Â∑≤ÂàáÊç¢Âà∞ÈÖçÁΩÆ"${config.name}"`, 'success');
        };
        
        // Âà†Èô§ÈÖçÁΩÆ
        window.deleteConfig = async function(configId) {
            const config = savedApiConfigs.find(c => c.id === configId);
            if (!config) return;

            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÖçÁΩÆ"${config.name}"ÂêóÔºü`)) {
                savedApiConfigs = savedApiConfigs.filter(c => c.id !== configId);
                await saveApiConfigs();
                renderSavedConfigs();
                showToast(`ÈÖçÁΩÆ"${config.name}"Â∑≤Âà†Èô§`, 'info');
            }
        };
        
        // ÈáçÂëΩÂêçÈÖçÁΩÆ
        window.editConfigName = async function(configId) {
            const config = savedApiConfigs.find(c => c.id === configId);
            if (!config) return;
            
            const newName = await showCustomPrompt('ÈáçÂëΩÂêçÈÖçÁΩÆ', `ËØ∑ËæìÂÖ•Êñ∞ÁöÑÈÖçÁΩÆÂêçÁß∞Ôºö`, config.name);
            if (newName && newName.trim() && newName.trim() !== config.name) {
                // Ê£ÄÊü•ÊòØÂê¶ÈáçÂêç
                if (savedApiConfigs.some(c => c.name === newName.trim() && c.id !== configId)) {
                    alert('ÈÖçÁΩÆÂêçÁß∞Â∑≤Â≠òÂú®ÔºåËØ∑‰ΩøÁî®ÂÖ∂‰ªñÂêçÁß∞');
                    return;
                }
                
                config.name = newName.trim();
                config.updatedAt = Date.now();
                await saveApiConfigs();
                renderSavedConfigs();
                showToast('ÈÖçÁΩÆÂêçÁß∞Â∑≤Êõ¥Êñ∞', 'success');
            }
        };
        
        // È°µÈù¢Âä†ËΩΩÊó∂Ê∏≤ÊüìÂ∑≤‰øùÂ≠òÁöÑÈÖçÁΩÆ
        renderSavedConfigs();
        
        // ============= Áî®Êà∑Ë∫´‰ªΩ‰øùÊä§ÊµãËØïÂäüËÉΩ =============
        // ÊµãËØïÂáΩÊï∞ÔºöÈ™åËØÅAIÊòØÂê¶‰ºö‰º™ÈÄ†Áî®Êà∑Ë∫´‰ªΩ
        window.testUserIdentityProtection = function() {
            console.log('üîí Áî®Êà∑Ë∫´‰ªΩ‰øùÊä§ÂäüËÉΩÊµãËØï');
            
            // Ê®°Êãü‰∏Ä‰∏™Áæ§ËÅäÂØπË±°
            const testChat = {
                isGroup: true,
                settings: {
                    myNickname: 'ÊµãËØïÁî®Êà∑'
                },
                members: [
                    { name: 'ÊµãËØïÁî®Êà∑', avatar: '/avatar1.jpg' },
                    { name: 'AIÂä©Êâã', avatar: '/avatar2.jpg' }
                ]
            };
            
            // Ê®°ÊãüAIÂ∞ùËØï‰ΩøÁî®Áî®Êà∑Ë∫´‰ªΩÂèëÈÄÅÁöÑÊ∂àÊÅØÊï∞ÁªÑ
            const testMessages = [
                { name: 'ÊµãËØïÁî®Êà∑', message: 'ËøôÊòØAI‰º™ÈÄ†ÁöÑÁî®Êà∑ÂèëË®Ä' },
                { name: 'Êàë', message: 'Ëøô‰πüÊòØAI‰º™ÈÄ†ÁöÑÁî®Êà∑ÂèëË®Ä' },
                { name: 'AIÂä©Êâã', message: 'ËøôÊòØÊ≠£Â∏∏ÁöÑAIÂèëË®Ä' },
                { name: 'ÊµãËØïÁî®Êà∑', type: 'change_avatar', avatar_url: '/fake_avatar.jpg' },
                { name: 'Êàë', type: 'voice_message', content: 'ËøôÊòØ‰º™ÈÄ†ÁöÑÁî®Êà∑ËØ≠Èü≥' }
            ];
            
            console.log('ÂéüÂßãÊµãËØïÊ∂àÊÅØ:', testMessages);
            
            // Ê®°Êãü‰øùÊä§ÈÄªËæë
            const filteredMessages = [];
            for (const msgData of testMessages) {
                // ËøôÊòØÂÆûÈôÖ‰ª£Á†Å‰∏≠ÁöÑ‰øùÊä§ÈÄªËæë
                if (testChat.isGroup && msgData.name) {
                    const userNickname = testChat.settings.myNickname || 'Êàë';
                    if (msgData.name === userNickname || msgData.name === 'Êàë') {
                        console.warn('‚úÖ ÊàêÂäüÈòªÊ≠¢AI‰º™ÈÄ†Áî®Êà∑Ë∫´‰ªΩ:', msgData);
                        continue; // Ë∑≥ËøáËøôÊù°Ê∂àÊÅØÔºå‰∏çÊ∑ªÂä†Âà∞ÁªìÊûúÊï∞ÁªÑ
                    }
                }
                filteredMessages.push(msgData);
            }
            
            console.log('ËøáÊª§ÂêéÁöÑÊ∂àÊÅØ:', filteredMessages);
            console.log(`‚úÖ ÊµãËØïÂÆåÊàê: ÊàêÂäüÈòªÊ≠¢‰∫Ü ${testMessages.length - filteredMessages.length} Êù°‰º™ÈÄ†Ê∂àÊÅØ`);
            console.log(`üõ°Ô∏è ‰øùÊä§Áä∂ÊÄÅ: ${testMessages.length - filteredMessages.length > 0 ? 'Ê≠£Â∏∏Â∑•‰Ωú' : 'ÈúÄË¶ÅÊ£ÄÊü•'}`);
            
            return {
                original: testMessages,
                filtered: filteredMessages,
                blocked: testMessages.length - filteredMessages.length
            };
        };
        
        
        // Êñ∞ÁöÑÂπ∂ÂèëÁâàÊú¨ÁöÑ triggerAiResponse
        async function triggerAiResponse() {
            if (!state.activeChatId) return;
            
            const chatId = state.activeChatId;
            const chat = state.chats[chatId];
            const { proxyUrl, apiKey, model } = state.apiConfig;
            
            if (!proxyUrl || !apiKey || !model) {
                alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂèç‰ª£Âú∞ÂùÄ„ÄÅÂØÜÈí•Âπ∂ÈÄâÊã©Ê®°Âûã„ÄÇ');
                return;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÂêØÁî®Âπ∂ÂèëÊ®°Âºè
            if (chat && chat.settings.concurrentChatEnabled !== false) {
                // ‰ΩøÁî®Âπ∂ÂèëÁÆ°ÁêÜÂô®Â§ÑÁêÜËØ∑Ê±Ç
                return await window.concurrentChatManager.startRequest(
                    chatId,
                    'chat',
                    executeAiResponse,
                    chatId
                );
            } else {
                // ÂõûÈÄÄÂà∞‰º†ÁªüÁöÑ‰∏≤Ë°åÊ®°Âºè
                return await executeAiResponse(null, chatId);
            }
        }
        
    });
    </script>


</body></html>

